<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Various information about engineering and computing things. Just tid-bits from an enthusiast"><meta name=author content="Brian Sidebotham"><link href=https://www.valvers.com/open-software/raspberry-pi/bare-metal-programming-in-c-part-4/ rel=canonical><link href=../bare-metal-programming-in-c-part-3/ rel=prev><link href=../bare-metal-programming-in-c-part-5/ rel=next><link rel=icon href=../../../assets/favicon.png><meta name=generator content="mkdocs-1.4.2, mkdocs-material-9.0.12"><title>BMC Part 4 - Interrupts - valvers.com</title><link rel=stylesheet href=../../../assets/stylesheets/main.0d440cfe.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.2505c338.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../valvers-assets/extra.css><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#bmc-part-4-interrupts class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../.. title=valvers.com class="md-header__button md-logo" aria-label=valvers.com data-md-component=logo> <img src=https://www.gravatar.com/avatar/8db3007cd3103d9ff42e90cc95dc7213 alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> valvers.com </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> BMC Part 4 - Interrupts </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/valvers/valvers.website.src title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../../denford-orac/ class=md-tabs__link> Denford orac </a> </li> <li class=md-tabs__item> <a href=../../../engineering/ class=md-tabs__link> Engineering </a> </li> <li class=md-tabs__item> <a href=../../ class="md-tabs__link md-tabs__link--active"> Open software </a> </li> <li class=md-tabs__item> <a href=../../../random/ class=md-tabs__link> Random </a> </li> <li class=md-tabs__item> <a href=../../../v6manta/ class=md-tabs__link> V6manta </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title=valvers.com class="md-nav__button md-logo" aria-label=valvers.com data-md-component=logo> <img src=https://www.gravatar.com/avatar/8db3007cd3103d9ff42e90cc95dc7213 alt=logo> </a> valvers.com </label> <div class=md-nav__source> <a href=https://github.com/valvers/valvers.website.src title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> Home </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2> <div class="md-nav__link md-nav__link--index "> <a href=../../../denford-orac/ >Denford orac</a> <label for=__nav_2> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Denford orac </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../denford-orac/2009-04-06-my-denford-orac/ class=md-nav__link> 2009 04 06 my denford orac </a> </li> <li class=md-nav__item> <a href=../../../denford-orac/2012-02-17-uprated-spindle-motor/ class=md-nav__link> 2012 02 17 uprated spindle motor </a> </li> <li class=md-nav__item> <a href=../../../denford-orac/2012-03-22-gathering-some-information/ class=md-nav__link> 2012 03 22 gathering some information </a> </li> <li class=md-nav__item> <a href=../../../denford-orac/2012-09-27-750w-motor-sourced/ class=md-nav__link> 2012 09 27 750w motor sourced </a> </li> <li class=md-nav__item> <a href=../../../denford-orac/2012-10-01-motor-doesnt-fit/ class=md-nav__link> 2012 10 01 motor doesnt fit </a> </li> <li class=md-nav__item> <a href=../../../denford-orac/2012-10-10-drill-head-disassembly/ class=md-nav__link> 2012 10 10 drill head disassembly </a> </li> <li class=md-nav__item> <a href=../../../denford-orac/2012-10-13-more-quill-dismantling/ class=md-nav__link> 2012 10 13 more quill dismantling </a> </li> <li class=md-nav__item> <a href=../../../denford-orac/2012-10-17-drill-spindle-is-apart/ class=md-nav__link> 2012 10 17 drill spindle is apart </a> </li> <li class=md-nav__item> <a href=../../../denford-orac/2012-10-29-removing-electrical-cabinet/ class=md-nav__link> 2012 10 29 removing electrical cabinet </a> </li> <li class=md-nav__item> <a href=../../../denford-orac/2012-10-31-tested-the-drill-head-above-the-lathe/ class=md-nav__link> 2012 10 31 tested the drill head above the lathe </a> </li> <li class=md-nav__item> <a href=../../../denford-orac/2012-11-02-rebuild-of-an-orac/ class=md-nav__link> 2012 11 02 rebuild of an orac </a> </li> <li class=md-nav__item> <a href=../../../denford-orac/2013-03-13-new-motor-fitted/ class=md-nav__link> 2013 03 13 new motor fitted </a> </li> <li class=md-nav__item> <a href=../../../denford-orac/2020-06-28-denford-orac-machinekit-controller/ class=md-nav__link> Denford Orac Machinekit Controller </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <div class="md-nav__link md-nav__link--index "> <a href=../../../engineering/ >Engineering</a> <label for=__nav_3> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Engineering </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../engineering/an-and-jic-fittings/ class=md-nav__link> AN and JIC Fittings </a> </li> <li class=md-nav__item> <a href=../../../engineering/bolt-dimensions/ class=md-nav__link> Bolt Dimensions </a> </li> <li class=md-nav__item> <a href=../../../engineering/linuxcnc/ class=md-nav__link> LinuxCNC </a> </li> <li class=md-nav__item> <a href=../../../engineering/making-a-cyr-wheel/ class=md-nav__link> Making a Cyr Wheel </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4 checked> <div class="md-nav__link md-nav__link--index "> <a href=../../ >Open software</a> <label for=__nav_4> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=true> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Open software </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../android-car-dash/ class=md-nav__link> Android car dash </a> </li> <li class=md-nav__item> <a href=../../logging-with-gcc/ class=md-nav__link> Logging with gcc </a> </li> <li class=md-nav__item> <a href=../../posix-shell-scripting/ class=md-nav__link> Posix Shell Scripting </a> </li> <li class=md-nav__item> <a href=../../rpi-cm4-linuxcnc/ class=md-nav__link> RPI CM4 Linux CNC </a> </li> <li class=md-nav__item> <a href=../../working-with-the-screen-command/ class=md-nav__link> Working with the Screen Command </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_7> <label class=md-nav__link for=__nav_4_7 id=__nav_4_7_label tabindex=0> Arduino <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_7_label aria-expanded=false> <label class=md-nav__title for=__nav_4_7> <span class="md-nav__icon md-icon"></span> Arduino </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../arduino/esp32-mqtt-tutorial/ class=md-nav__link> ESP32 MQTT Tutorial </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_8> <label class=md-nav__link for=__nav_4_8 id=__nav_4_8_label tabindex=0> Aws <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_8_label aria-expanded=false> <label class=md-nav__title for=__nav_4_8> <span class="md-nav__icon md-icon"></span> Aws </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../aws/aws-lambda-getting-started/ class=md-nav__link> AWS Lambda Getting Started </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_9> <label class=md-nav__link for=__nav_4_9 id=__nav_4_9_label tabindex=0> Gcc <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_9_label aria-expanded=false> <label class=md-nav__title for=__nav_4_9> <span class="md-nav__icon md-icon"></span> Gcc </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../gcc/weak-function-attributes/ class=md-nav__link> Weak Function Attributes </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_10> <label class=md-nav__link for=__nav_4_10 id=__nav_4_10_label tabindex=0> Python <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_10_label aria-expanded=false> <label class=md-nav__title for=__nav_4_10> <span class="md-nav__icon md-icon"></span> Python </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../python/pylab/ class=md-nav__link> Pylab </a> </li> <li class=md-nav__item> <a href=../../python/the-lethality-of-default-arguments-in-python/ class=md-nav__link> The Lethality of Default Arguments in Python </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_11 checked> <label class=md-nav__link for=__nav_4_11 id=__nav_4_11_label tabindex=0> Raspberry pi <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_11_label aria-expanded=true> <label class=md-nav__title for=__nav_4_11> <span class="md-nav__icon md-icon"></span> Raspberry pi </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../bare-metal-programming-in-c-card/ class=md-nav__link> BMC Card Scripts </a> </li> <li class=md-nav__item> <a href=../bare-metal-programming-in-c-compiler/ class=md-nav__link> BMC Compiler </a> </li> <li class=md-nav__item> <a href=../bare-metal-programming-in-c-firmware/ class=md-nav__link> BMC Firmware </a> </li> <li class=md-nav__item> <a href=../bare-metal-programming-in-c-part-1/ class=md-nav__link> BMC Part 1 - Getting Started </a> </li> <li class=md-nav__item> <a href=../bare-metal-programming-in-c-part-2/ class=md-nav__link> BMC Part 2 - The C Runtime </a> </li> <li class=md-nav__item> <a href=../bare-metal-programming-in-c-part-3/ class=md-nav__link> BMC Part 3 - CMake Build System </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> BMC Part 4 - Interrupts <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> BMC Part 4 - Interrupts </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#reference-material class=md-nav__link> Reference Material </a> </li> <li class=md-nav__item> <a href=#the-code class=md-nav__link> The Code </a> </li> <li class=md-nav__item> <a href=#interrupts class=md-nav__link> Interrupts </a> </li> <li class=md-nav__item> <a href=#processor-modes class=md-nav__link> Processor Modes </a> </li> <li class=md-nav__item> <a href=#coding-interrupt-handlers class=md-nav__link> Coding Interrupt Handlers </a> </li> <li class=md-nav__item> <a href=#coding-vector-tables class=md-nav__link> Coding Vector Tables </a> <nav class=md-nav aria-label="Coding Vector Tables"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#its-all-relative class=md-nav__link> It's all relative </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#the-interrupt-controller class=md-nav__link> The Interrupt Controller </a> </li> <li class=md-nav__item> <a href=#the-arm-timer-peripheral class=md-nav__link> The ARM Timer Peripheral </a> </li> <li class=md-nav__item> <a href=#rpi-4-interrupts class=md-nav__link> RPI 4 Interrupts </a> <nav class=md-nav aria-label="RPI 4 Interrupts"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#documentation class=md-nav__link> Documentation </a> </li> <li class=md-nav__item> <a href=#register-map class=md-nav__link> Register Map </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../bare-metal-programming-in-c-part-5/ class=md-nav__link> Part 5 - Graphics (Basic) </a> </li> <li class=md-nav__item> <a href=../bare-metal-programming-in-c/ class=md-nav__link> Raspberry-Pi Bare Metal Tutorial </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_12> <label class=md-nav__link for=__nav_4_12 id=__nav_4_12_label tabindex=0> Saltstack <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_12_label aria-expanded=false> <label class=md-nav__title for=__nav_4_12> <span class="md-nav__icon md-icon"></span> Saltstack </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../saltstack/building-a-centos8-salt-master/ class=md-nav__link> Building a CentOS8 Salt Master </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_13> <label class=md-nav__link for=__nav_4_13 id=__nav_4_13_label tabindex=0> Webstacks <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_13_label aria-expanded=false> <label class=md-nav__title for=__nav_4_13> <span class="md-nav__icon md-icon"></span> Webstacks </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../webstacks/using-reactjs-and-bulma/ class=md-nav__link> Using ReactJS and Bulma </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5> <div class="md-nav__link md-nav__link--index "> <a href=../../../random/ >Random</a> <label for=__nav_5> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Random </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../random/mortgage/ class=md-nav__link> Mortgage </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6> <div class="md-nav__link md-nav__link--index "> <a href=../../../v6manta/ >V6manta</a> <label for=__nav_6> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> V6manta </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_2> <label class=md-nav__link for=__nav_6_2 id=__nav_6_2_label tabindex=0> 2003 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_2_label aria-expanded=false> <label class=md-nav__title for=__nav_6_2> <span class="md-nav__icon md-icon"></span> 2003 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../v6manta/2003/2003-07-28-/ class=md-nav__link> 2003 07 28 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2003/2003-07-28-brought-a-1.8s-berlinetta/ class=md-nav__link> 2003 07 28 brought a 1.8s berlinetta </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2003/2003-07-28-stage-rally-opel-manta/ class=md-nav__link> 2003 07 28 stage rally opel manta </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2003/2003-08-12-/ class=md-nav__link> 2003 08 12 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2003/2003-08-13-/ class=md-nav__link> 2003 08 13 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2003/2003-08-23-/ class=md-nav__link> 2003 08 23 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2003/2003-09-11-/ class=md-nav__link> 2003 09 11 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2003/2003-09-28-/ class=md-nav__link> 2003 09 28 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2003/2003-10-07-/ class=md-nav__link> 2003 10 07 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2003/2003-10-09-/ class=md-nav__link> 2003 10 09 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2003/2003-11-04-/ class=md-nav__link> 2003 11 04 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2003/2003-12-16-/ class=md-nav__link> 2003 12 16 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_3> <label class=md-nav__link for=__nav_6_3 id=__nav_6_3_label tabindex=0> 2004 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_3_label aria-expanded=false> <label class=md-nav__title for=__nav_6_3> <span class="md-nav__icon md-icon"></span> 2004 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-01-06-/ class=md-nav__link> 2004 01 06 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-01-07-/ class=md-nav__link> 2004 01 07 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-01-26-/ class=md-nav__link> 2004 01 26 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-01-29-/ class=md-nav__link> 2004 01 29 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-02-09-/ class=md-nav__link> 2004 02 09 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-02-13-/ class=md-nav__link> 2004 02 13 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-02-19-/ class=md-nav__link> 2004 02 19 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-04-20-finally-got-around-to-the-manta/ class=md-nav__link> 2004 04 20 finally got around to the manta </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-06-17-/ class=md-nav__link> 2004 06 17 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-06-18-/ class=md-nav__link> 2004 06 18 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-06-21-/ class=md-nav__link> 2004 06 21 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-07-26-/ class=md-nav__link> 2004 07 26 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-08-09-/ class=md-nav__link> 2004 08 09 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-08-10-/ class=md-nav__link> 2004 08 10 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-09-03-/ class=md-nav__link> 2004 09 03 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-09-27-/ class=md-nav__link> 2004 09 27 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-10-07-/ class=md-nav__link> 2004 10 07 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-10-08-/ class=md-nav__link> 2004 10 08 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-10-11-/ class=md-nav__link> 2004 10 11 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-10-13-/ class=md-nav__link> 2004 10 13 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-10-15-/ class=md-nav__link> 2004 10 15 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-10-18-/ class=md-nav__link> 2004 10 18 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-10-21-/ class=md-nav__link> 2004 10 21 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-10-22-/ class=md-nav__link> 2004 10 22 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-10-29-/ class=md-nav__link> 2004 10 29 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-11-01-/ class=md-nav__link> 2004 11 01 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-12-10-were-back/ class=md-nav__link> 2004 12 10 were back </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_4> <label class=md-nav__link for=__nav_6_4 id=__nav_6_4_label tabindex=0> 2005 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_4_label aria-expanded=false> <label class=md-nav__title for=__nav_6_4> <span class="md-nav__icon md-icon"></span> 2005 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../v6manta/2005/2005-05-16-/ class=md-nav__link> 2005 05 16 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2005/2005-08-04-done-something/ class=md-nav__link> 2005 08 04 done something </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2005/2005-08-08-/ class=md-nav__link> 2005 08 08 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2005/2005-08-10-/ class=md-nav__link> 2005 08 10 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2005/2005-08-25-/ class=md-nav__link> 2005 08 25 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2005/2005-08-31-/ class=md-nav__link> 2005 08 31 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2005/2005-09-05-/ class=md-nav__link> 2005 09 05 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2005/2005-09-19-/ class=md-nav__link> 2005 09 19 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2005/2005-09-22-/ class=md-nav__link> 2005 09 22 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2005/2005-09-23-/ class=md-nav__link> 2005 09 23 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2005/2005-11-01-/ class=md-nav__link> 2005 11 01 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2005/2005-11-03-/ class=md-nav__link> 2005 11 03 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_5> <label class=md-nav__link for=__nav_6_5 id=__nav_6_5_label tabindex=0> 2007 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_5_label aria-expanded=false> <label class=md-nav__title for=__nav_6_5> <span class="md-nav__icon md-icon"></span> 2007 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../v6manta/2007/2007-10-20-/ class=md-nav__link> 2007 10 20 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2007/2007-10-20-perspex-windows/ class=md-nav__link> 2007 10 20 perspex windows </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2007/2007-11-13-getting-it-ready-to-paint.../ class=md-nav__link> 2007 11 13 getting it ready to paint... </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2007/2007-11-21-almost-started-painting/ class=md-nav__link> 2007 11 21 almost started painting </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2007/2007-11-28-underneath-is-complete/ class=md-nav__link> 2007 11 28 underneath is complete </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2007/2007-12-04-painting-the-inside-and-engine-bay/ class=md-nav__link> 2007 12 04 painting the inside and engine bay </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_6> <label class=md-nav__link for=__nav_6_6 id=__nav_6_6_label tabindex=0> 2008 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6_6> <span class="md-nav__icon md-icon"></span> 2008 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-01-14-painting-the-shell-orange/ class=md-nav__link> 2008 01 14 painting the shell orange </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-01-16-out-of-the-booth/ class=md-nav__link> 2008 01 16 out of the booth </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-01-23-rear-axle-trial-fitting/ class=md-nav__link> 2008 01 23 rear axle trial fitting </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-02-24-painted-the-nextel-and-checked-for-wheel-clearance/ class=md-nav__link> 2008 02 24 painted the nextel and checked for wheel clearance </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-03-15-front-suspension-build/ class=md-nav__link> 2008 03 15 front suspension build </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-03-19-suspension-bushes-are-always-wrong/ class=md-nav__link> 2008 03 19 suspension bushes are always wrong </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-03-22-diff-bearings-need-replacing/ class=md-nav__link> 2008 03 22 diff bearings need replacing </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-04-08-fitted-the-rear-windows-and-steering-column/ class=md-nav__link> 2008 04 08 fitted the rear windows and steering column </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-04-12-shimmed-up-the-diff%2C-and-fitted-the-clocks/ class=md-nav__link> 2008 04 12 shimmed up the diff, and fitted the clocks </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-04-16-rebuilt-the-gearbox-so-i-get-gear-selection/ class=md-nav__link> 2008 04 16 rebuilt the gearbox so i get gear selection </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-07-08-its-on-its-wheels-at-last/ class=md-nav__link> 2008 07 08 its on its wheels at last </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-09-02-rebuilt-oil-pump--started-headwork/ class=md-nav__link> 2008 09 02 rebuilt oil pump started headwork </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-09-04-some-more-headwork/ class=md-nav__link> 2008 09 04 some more headwork </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-09-25-even-more-headwork/ class=md-nav__link> 2008 09 25 even more headwork </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-11-09-engine--transmission-fitted/ class=md-nav__link> 2008 11 09 engine transmission fitted </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-11-16-engine--gearbox-mounted--steering-column-fitted/ class=md-nav__link> 2008 11 16 engine gearbox mounted steering column fitted </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-12-14-stripping-the-x25xe-v6-bottom-end/ class=md-nav__link> 2008 12 14 stripping the x25xe v6 bottom end </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_7> <label class=md-nav__link for=__nav_6_7 id=__nav_6_7_label tabindex=0> 2009 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_7_label aria-expanded=false> <label class=md-nav__title for=__nav_6_7> <span class="md-nav__icon md-icon"></span> 2009 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../v6manta/2009/2009-06-24-making-the-dry-sump-pan/ class=md-nav__link> 2009 06 24 making the dry sump pan </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2009/2009-10-05-trialling-the-throttle-bodies--a-few-more-bits-painted/ class=md-nav__link> 2009 10 05 trialling the throttle bodies a few more bits painted </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2009/2009-12-18-flywheel-and-clutch/ class=md-nav__link> 2009 12 18 flywheel and clutch </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_8> <label class=md-nav__link for=__nav_6_8 id=__nav_6_8_label tabindex=0> 2010 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_8_label aria-expanded=false> <label class=md-nav__title for=__nav_6_8> <span class="md-nav__icon md-icon"></span> 2010 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-01-23-done-the-handbrake--sliders/ class=md-nav__link> 2010 01 23 done the handbrake sliders </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-01-27-started-building-the-v6-heads-up/ class=md-nav__link> 2010 01 27 started building the v6 heads up </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-01-30-picked-up-another-v6/ class=md-nav__link> 2010 01 30 picked up another v6 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-02-01-exhaust-manifolds/ class=md-nav__link> 2010 02 01 exhaust manifolds </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-02-02-starting-the-v6-build/ class=md-nav__link> 2010 02 02 starting the v6 build </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-02-03-cylinder-head-bolts-torque/ class=md-nav__link> 2010 02 03 cylinder head bolts torque </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-02-03-ordered-the-exhaust-manifold-flanges/ class=md-nav__link> 2010 02 03 ordered the exhaust manifold flanges </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-02-06-building-the-v6/ class=md-nav__link> 2010 02 06 building the v6 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-02-07-building-the-v6/ class=md-nav__link> 2010 02 07 building the v6 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-02-14-building-the-v6/ class=md-nav__link> 2010 02 14 building the v6 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-03-22-gearbox-sealed-and-release-bearing-fitted/ class=md-nav__link> 2010 03 22 gearbox sealed and release bearing fitted </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-04-03-started-on-the-manifolds/ class=md-nav__link> 2010 04 03 started on the manifolds </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-04-05-finished-a-manifold/ class=md-nav__link> 2010 04 05 finished a manifold </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-04-07-started-the-second-manifold/ class=md-nav__link> 2010 04 07 started the second manifold </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-04-11-need-a-todo-list/ class=md-nav__link> 2010 04 11 need a todo list </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-04-21-ticking-off-the-boxes/ class=md-nav__link> 2010 04 21 ticking off the boxes </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-04-26-nearly-finished-the-second-manifold/ class=md-nav__link> 2010 04 26 nearly finished the second manifold </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-05-09-got-the-car-rolling/ class=md-nav__link> 2010 05 09 got the car rolling </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-05-11-rolling-road-day/ class=md-nav__link> 2010 05 11 rolling road day </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-05-31-back-from-germany/ class=md-nav__link> 2010 05 31 back from germany </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-06-01-sumps-off/ class=md-nav__link> 2010 06 01 sumps off </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-06-06-done-most-of-the-bits-on-the-v6/ class=md-nav__link> 2010 06 06 done most of the bits on the v6 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-06-12-getting-ready-to-bolt-it-back-in/ class=md-nav__link> 2010 06 12 getting ready to bolt it back in </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-06-19-almost-ready-to-go-back-in/ class=md-nav__link> 2010 06 19 almost ready to go back in </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-09-22-lack-of-updates/ class=md-nav__link> 2010 09 22 lack of updates </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-09-26-few-little-bits/ class=md-nav__link> 2010 09 26 few little bits </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-10-09-v6-oil-problems..../ class=md-nav__link> 2010 10 09 v6 oil problems.... </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-10-12-starting-putting-the-engine-back-together/ class=md-nav__link> 2010 10 12 starting putting the engine back together </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-10-23-v6-is-broke/ class=md-nav__link> 2010 10 23 v6 is broke </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-10-24-stripping-the-v6/ class=md-nav__link> 2010 10 24 stripping the v6 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-10-25-v6-problem/ class=md-nav__link> 2010 10 25 v6 problem </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-11-03-picked-up-a-replacement-v6/ class=md-nav__link> 2010 11 03 picked up a replacement v6 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-12-12-been-busy-building/ class=md-nav__link> 2010 12 12 been busy building </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_9> <label class=md-nav__link for=__nav_6_9 id=__nav_6_9_label tabindex=0> 2011 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_9_label aria-expanded=false> <label class=md-nav__title for=__nav_6_9> <span class="md-nav__icon md-icon"></span> 2011 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../v6manta/2011/2011-01-01-finally-driven-the-manta-again-today/ class=md-nav__link> 2011 01 01 finally driven the manta again today </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2011/2011-03-13-fitting-some-new-seats/ class=md-nav__link> 2011 03 13 fitting some new seats </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2011/2011-03-13-the-manta-got-mapped/ class=md-nav__link> 2011 03 13 the manta got mapped </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2011/2011-03-25-went-to-brands-hatch/ class=md-nav__link> 2011 03 25 went to brands hatch </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2011/2011-09-04-started-work-on-the-2011-rebuild/ class=md-nav__link> 2011 09 04 started work on the 2011 rebuild </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2011/2011-09-10-built-some-more-of-the-frame/ class=md-nav__link> 2011 09 10 built some more of the frame </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2011/2011-09-14-started-work-on-the-new-sump-pan/ class=md-nav__link> 2011 09 14 started work on the new sump pan </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2011/2011-09-15-more-subframe-work/ class=md-nav__link> 2011 09 15 more subframe work </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2011/2011-09-17-gearbox-back-together/ class=md-nav__link> 2011 09 17 gearbox back together </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2011/2011-09-25-getting-ready-to-spray-the-engine-bay-again.../ class=md-nav__link> 2011 09 25 getting ready to spray the engine bay again... </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2011/2011-10-16-moving-along-with-the-rebuild/ class=md-nav__link> 2011 10 16 moving along with the rebuild </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2011/2011-10-18-painted-the-engine-bay/ class=md-nav__link> 2011 10 18 painted the engine bay </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2011/2011-11-15-dry-sump-work.../ class=md-nav__link> 2011 11 15 dry sump work... </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_10> <label class=md-nav__link for=__nav_6_10 id=__nav_6_10_label tabindex=0> 2012 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_10_label aria-expanded=false> <label class=md-nav__title for=__nav_6_10> <span class="md-nav__icon md-icon"></span> 2012 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-01-09-dry-sump-pan-is-welded/ class=md-nav__link> 2012 01 09 dry sump pan is welded </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-01-27-more-dry-sump-work/ class=md-nav__link> 2012 01 27 more dry sump work </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-02-21-engine-is-back-in.../ class=md-nav__link> 2012 02 21 engine is back in... </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-02-24-took-the-engine-back-out-again/ class=md-nav__link> 2012 02 24 took the engine back out again </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-02-27-engine-back-in-again/ class=md-nav__link> 2012 02 27 engine back in again </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-03-14-mostly-plumbed-back-in/ class=md-nav__link> 2012 03 14 mostly plumbed back in </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-04-04-started-her-up-again/ class=md-nav__link> 2012 04 04 started her up again </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-04-16-ready-for-a-test-drive/ class=md-nav__link> 2012 04 16 ready for a test drive </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-05-09-clutch-release-bearing-failure/ class=md-nav__link> 2012 05 09 clutch release bearing failure </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-05-17-stripping-the-t5-gearbox/ class=md-nav__link> 2012 05 17 stripping the t5 gearbox </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-10-13-rebuilt-the-gearbox/ class=md-nav__link> 2012 10 13 rebuilt the gearbox </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-11-11-finally-the-engines-back-in/ class=md-nav__link> 2012 11 11 finally the engines back in </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-11-14-nearly-back-together/ class=md-nav__link> 2012 11 14 nearly back together </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-11-25-the-finishing-touches/ class=md-nav__link> 2012 11 25 the finishing touches </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-11-28-finally-the-v6-manta-up-a-running-again/ class=md-nav__link> 2012 11 28 finally the v6 manta up a running again </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-12-30-virtually-back-on-the-road/ class=md-nav__link> 2012 12 30 virtually back on the road </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_11> <label class=md-nav__link for=__nav_6_11 id=__nav_6_11_label tabindex=0> 2013 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_11_label aria-expanded=false> <label class=md-nav__title for=__nav_6_11> <span class="md-nav__icon md-icon"></span> 2013 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../v6manta/2013/2013-01-10-driven-the-manta-again/ class=md-nav__link> 2013 01 10 driven the manta again </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2013/2013-01-15-had-a-great-blast-in-the-manta/ class=md-nav__link> 2013 01 15 had a great blast in the manta </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#reference-material class=md-nav__link> Reference Material </a> </li> <li class=md-nav__item> <a href=#the-code class=md-nav__link> The Code </a> </li> <li class=md-nav__item> <a href=#interrupts class=md-nav__link> Interrupts </a> </li> <li class=md-nav__item> <a href=#processor-modes class=md-nav__link> Processor Modes </a> </li> <li class=md-nav__item> <a href=#coding-interrupt-handlers class=md-nav__link> Coding Interrupt Handlers </a> </li> <li class=md-nav__item> <a href=#coding-vector-tables class=md-nav__link> Coding Vector Tables </a> <nav class=md-nav aria-label="Coding Vector Tables"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#its-all-relative class=md-nav__link> It's all relative </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#the-interrupt-controller class=md-nav__link> The Interrupt Controller </a> </li> <li class=md-nav__item> <a href=#the-arm-timer-peripheral class=md-nav__link> The ARM Timer Peripheral </a> </li> <li class=md-nav__item> <a href=#rpi-4-interrupts class=md-nav__link> RPI 4 Interrupts </a> <nav class=md-nav aria-label="RPI 4 Interrupts"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#documentation class=md-nav__link> Documentation </a> </li> <li class=md-nav__item> <a href=#register-map class=md-nav__link> Register Map </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=bmc-part-4-interrupts>BMC Part 4 - Interrupts<a class=headerlink href=#bmc-part-4-interrupts title="Permanent link">&para;</a></h1> <p>In this tutorial, we're going to look at using interrupts to generate the LED flash. Interrupts are an essential ingredient in embedded programming. We're going to investigate the BCM2835/6 interrupt process and implement an interrupt for the ARM Timer peripheral to blink the LED. I appreciate that blinking an LED is probably starting to get boring, but small steps are the way to learn a big system, and learning how to handle interrupts will be enough of a learning curve without having to change what we're doing at the same time. In the next tutorial we'll move away from blinking an LED.</p> <h2 id=reference-material>Reference Material<a class=headerlink href=#reference-material title="Permanent link">&para;</a></h2> <p>We need some reading material for this tutorial - this is how I put the tutorial together, by reading and studying the manuals available for the processor. Yes there's a lot of text and more than one manual - but that's the only way you learn!</p> <p>The material that's useful:</p> <ul> <li><a href=http://infocenter.arm.com/help/topic/com.arm.doc.ddi0301h/DDI0301H_arm1176jzfs_r0p7_trm.pdf>ARM1176JZF-S Technical Reference Manual</a></li> <li><a href=http://www.raspberrypi.org/wp-content/uploads/2012/02/BCM2835-ARM-Peripherals.pdf>BCM2385 ARM Peripherals</a></li> <li><a href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.ddi0406c/index.html">ARMv6 Architecture Reference Manual</a> This requires agreeing to an NDA to get hold of the PDF version of the document, but it's at least free and easy to get! This document also describes the ARMv7 architecture which the Cortex A7 uses in the BCM2836 (Raspberry-pi 2)</li> </ul> <p>All of those documents, and an ARM instruction set reference are useful for this tutorial.</p> <h2 id=the-code>The Code<a class=headerlink href=#the-code title="Permanent link">&para;</a></h2> <p>The code for the tutorial is hosted on <a href=https://github.com/BrianSidebotham/arm-tutorial-rpi>GitHub</a>. The best thing to do to get the code is to clone the repo if you haven't already. Otherwise you can <a href=https://github.com/BrianSidebotham/arm-tutorial-rpi/archive/master.zip>grab the zip</a> of the latest code instead - but you won't be able to get fixes when they're released! ;)</p> <p>Some of the code that's specific to the tutorial and differs from the last tutorial will be discussed here.</p> <p>This tutorial only uses the <code>part-4/armc-013</code> folder.</p> <h2 id=interrupts>Interrupts<a class=headerlink href=#interrupts title="Permanent link">&para;</a></h2> <p>Let's get straight what an interrupt is. In terms of the ARM processor we're using an interrupt is simply a type of exception. An exception in the processor causes the PC (Program Counter) to be set to a pre-defined value. This pre-defined value will cause code execution to be interrupted and for code execution to run an exception handler put the pre-defined position. At the end of this exception handler control is generally returned to the previously executing code. Exception handlers should be quick and concise as they can occur frequently and obviously take time away from the main code.</p> <p>Interrupt signals are generally created by hardware. The exception we all know, possibly without realising it is the reset signal. If we strobe the reset line the PC is set to 0 and execution starts from this address. Reset is a bit special though, there's no way to return from the reset exception! All other exceptions can be returned from because the previous PC value has been saved.</p> <p>Although I've stated above that when resetting a processor, execution starts at address 0, this is not always correct. For example in many processors that support bootloaders the reset value can be different so that the application code starts at address 0 and the bootloader code starts somewhere else. Upon strobing the reset line execution will start at the reset vector, which can be different to 0. The important thing here is simply the term <em>vector</em>. A vector is a value that will be loaded into the processors PC when a given condition occurs.</p> <p>Each exception type has a vector, and these vectors reside next to each other in memory in what's termed the vector table. See, it's all pretty easy really! The base address of the vector table is 0. Vector tables come in a few varieties, either each vector is simply a value to be loaded into the PC to start execution at a linker-determined position, or else the vector is code that will be executed straight away without any need to do another PC load.</p> <p>For the ARMv6 architecture the vector table is at memory address 0 and is organised like below, from section A2.6 of the ARM Architecture Reference Manual covering ARMv5 and ARMv6. Please note, that on the ARM documentation website all you'll see is a reference to ARMv6-M or ARMv5. ARMv6-M is for the Cortex-M range of processors which are designed to be more heavily embedded than the application processors (The Cortex-A range), so make sure you get the ARMv5 document which also covers the ARMv6 architecture (which is what the ARM1176JZF-S is).</p> <p>For the Raspberry-pi 2 which uses the Cortex A7 processor the same table can be found in the ARMv7 reference manual in section B1.8.1 (Table B1-3). It is essentially the same.</p> <table> <thead> <tr> <th align=center>Exception Type</th> <th align=center>Mode</th> <th align=center>VE</th> <th align=center>Normal Address</th> <th align=center>High Vector Address</th> </tr> </thead> <tbody> <tr> <td align=center>Reset</td> <td align=center>Supervisor</td> <td align=center></td> <td align=center>0x00</td> <td align=center>0xFFFF0000</td> </tr> <tr> <td align=center>Undefined Instruction</td> <td align=center>Undefined</td> <td align=center></td> <td align=center>0x04</td> <td align=center>0xFFFF0004</td> </tr> <tr> <td align=center>Software Interrupt (SWI)</td> <td align=center>Supervisor</td> <td align=center></td> <td align=center>0x08</td> <td align=center>0xFFFF0008</td> </tr> <tr> <td align=center>Prefetch Abort</td> <td align=center>Abort</td> <td align=center></td> <td align=center>0x0C</td> <td align=center>0xFFFF000C</td> </tr> <tr> <td align=center>Data Abort</td> <td align=center>Abort</td> <td align=center></td> <td align=center>0x10</td> <td align=center>0xFFFF0010</td> </tr> <tr> <td align=center>IRQ (Interrupt)</td> <td align=center>IRQ</td> <td align=center>0</td> <td align=center>0x18</td> <td align=center>0xFFFF0018</td> </tr> <tr> <td align=center>IRQ (Interrupt)</td> <td align=center>IRQ</td> <td align=center>1</td> <td align=center>Implementation Defined</td> <td align=center></td> </tr> <tr> <td align=center>FIQ (Fast Interrupt)</td> <td align=center>FIQ</td> <td align=center>0</td> <td align=center>0x1C</td> <td align=center>0xFFFF001C</td> </tr> <tr> <td align=center>FIQ (Fast Interrupt)</td> <td align=center>FIQ</td> <td align=center>1</td> <td align=center>Implementation Defined</td> <td align=center></td> </tr> </tbody> </table> <p>As you can see, as we've been discussing, the reset vector is at address 0. The next vector is for us to deal with an undefined instruction exception, an unlikely scenario, but something we can at least trap and debug at some point. Following that we have the Software Interrupt, Pre-fetch abort, Data Abort, IRQ (Interrupt) and FIQ (Fast Interrupt) exception vectors. The vectors are sequential except between Data Abort and IRQ where there is an 4-byte gap. The note above the table in the document reads:</p> <blockquote> <p><strong>NOTE</strong>: The normal vector at address 0x00000014 and the high vector at address 0xFFFF0014 are reserved for future expansion.</p> </blockquote> <p>Vectors are only 4-bytes (one 32-bit instruction) apart. We know therefore the reset vector is simply going to be a branch instruction to the start of our actual code so that the undefined instruction exception can be implemented too. In fact, each of these vectors is simply a branch instruction to a handler somewhere else in memory.</p> <p>The Normal Address is what we're interested in on the Raspberry-Pi. The High Vector Address is selected in hardware, and that hardware doesn't exist, so the vectors reside at the normal addresses. It's useful, as I've said before to have another place to start executing code if we need a different application installed such as another bootloader or something. We can ignore the High Vector Addresses.</p> <p>Then we have the Mode column - this is going to be very important. If we look at the vector table, the mode listed for the reset vector is Supervisor.</p> <h2 id=processor-modes>Processor Modes<a class=headerlink href=#processor-modes title="Permanent link">&para;</a></h2> <p>Further back in section A2.2 of the ARM Architecture Reference Manual the documentation covers processors modes. When the processor is reset it is running in Supervisor mode, which is known as a privileged mode. From this operating mode we can write to most of the processors registers and can also change the processors current mode. The only mode that cannot change modes is User - this is designed to execute applications, whereas the privileged modes are meant for operating system tasks.</p> <p>There is basically a mode per exception. As was mentioned previously we start at the reset vector in Supervisor mode, so far all of our code has operating in that single mode. However, when an exception occurs the processor changes mode to the exception-specific mode. The mode can also be changed in software too if necessary.</p> <p>The next section of the Architecture Reference Manual describes the registers available. This is again, another important section. Look at Figure A2-1 (Register Organization) and you'll see something interesting...</p> <p><img alt="ARMv5 Figure A2-1" src=/img/bare-metal-programming-in-c/part-4-armv5-figure-a2-1-register-organization.png></p> <p>As seen by the small icon and note at the bottom of the table, some of the registers are mode-specific. This can be useful, for example in the Fast Interrupt exception a lot of registers have been replaced by mode-specific registers. This means that we can use these registers without fear of altering the behaviour of code that was operating in User or Supervisor mode before the Fast Interrupt Exception occurred.</p> <p>Normally, the first thing we would need to do in an interrupt handler would be to save the registers we're going to use and the last thing we'd do in an interrupt handler would be to restore those registers values to what they were before the interrupt handler executed. The code like this at the start of a function or interrupt handler is called the prologue and the code at the end of the function or handler is known as the epilogue.</p> <p>The shadow register implementation means that many times there's no need to save and restore registers in a Fast Interrupt service routine.</p> <h2 id=coding-interrupt-handlers>Coding Interrupt Handlers<a class=headerlink href=#coding-interrupt-handlers title="Permanent link">&para;</a></h2> <p>Providing interrupt handlers can be a bit tricky. It's generally entirely non-portable and you'll have to read the manual for your toolchain in order to understand how to write them. This generally involves informing the compiler that a function you declare should be used to handle a type of interrupt. The toolchain can them fill the vector table with the necessary information. The vector table is usually present in the linker script which defines the memory layout of the target device. because normally these vectors are read-only.</p> <p>For gcc and ld we can look at the gcc manual on function attributes relating to ARM. <a href=https://gcc.gnu.org/onlinedocs/gcc/Function-Attributes.html>https://gcc.gnu.org/onlinedocs/gcc/Function-Attributes.html</a></p> <p>It reads:</p> <blockquote> <p>Use this attribute on the ARC, ARM, AVR, CR16, ... ports to indicate that the specified function is an interrupt handler. The compiler generates function entry and exit sequences suitable for use in an interrupt handler when this attribute is present.</p> <p>NOTE, for the ARM, you can specify the kind of interrupt to be handled by adding an optional parameter to the interrupt attribute like this: <code>void f () __attribute__ ((interrupt ("IRQ")));</code></p> <p>Permissible values for this parameter are: IRQ, FIQ, SWI, ABORT and UNDEF.</p> </blockquote> <p>The parameter options align well with the vector table we got from the manual. Reset is an ABORT type, and everything else has a parameter available.</p> <p>Therefore to write a very basic "undefined instruction" handler we can define declare and implement our handler like this:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=cm>/**</span>
<a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=cm>    @brief The undefined instruction interrupt handler</span>
<a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a>
<a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=cm>    If an undefined instruction is encountered, the CPU will start</span>
<a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=cm>    executing this function. Just trap here as a debug solution.</span>
<a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=cm>*/</span>
<a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=kt>void</span><span class=w> </span><span class=n>__attribute__</span><span class=p>((</span><span class=n>interrupt</span><span class=p>(</span><span class=s>&quot;UNDEF&quot;</span><span class=p>)))</span><span class=w> </span><span class=n>undefined_instruction_vector</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=p>{</span>
<a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=w>    </span><span class=k>while</span><span class=p>(</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=p>)</span>
<a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=w>    </span><span class=p>{</span>
<a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a><span class=w>        </span><span class=cm>/* Do Nothing! */</span>
<a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a><span class=p>}</span>
</code></pre></div> <p>While it looks like this is useless code, it is actually pretty useful. We can set a breakpoint on the while(1) and debug whilst looking out for this breakpoint to trip. Usually then we can do some stack unwinding (manually!) to find where the source of the undefined instruction.</p> <h2 id=coding-vector-tables>Coding Vector Tables<a class=headerlink href=#coding-vector-tables title="Permanent link">&para;</a></h2> <p>A strange title that, Coding Vector Tables. With many embedded processors there's no coding or runtime setup of vector tables - instead the vector table is defined in the linker script and the toolchain fills in those locations with the address or jump instruction necessary to execute the relevant handler.</p> <p>The Raspberry-Pi vector table is extremely small, and it can be like this because some extra work is required in the Interrupt handler compared to more embedded processors such as the Cortex M range. No matter what the Interrupt source is, the same function is called. Inside the Interrupt handler we must work out what the source of the interrupt was before handling that interrupt. Essentially you end up with a large switch structure inside the interrupt handler. You can of course call other functions from the interrupt handler, but again think about the cost of the prologue and epilogue before you do!</p> <p>When the raspberry-pi starts running our code, as we've discovered earlier in the turotials it loads the code from the SD card to RAM at address 0x00008000 and then starts executing the code. So how can we possibly code the vector table and get the correct jump instructions into the vector table?</p> <p>Well, everything is in RAM and that's the key - this is read/write memory and in supervisor mode we can write to any location we want. So at runtime when our code is being executed we can overwrite the vector table at runtime. All we need is a vector table to write.</p> <p>Let's have a look at what needs to be done to implement the vector table. It's easiest if we drop down to assembler to do this. It really could do with being done as the very first thing in our code anyway so it's setup right from the start.</p> <p>Here is some modified assembler for our _statup: label which is where our linker knows we want to start execution. The linker makes sure this is at the start of our binary:</p> <p>At fist, I thought this was going to be easy - we just hard-code some values into a table and copy that table to the start of RAM where the vector table resides. Here's some initial code:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a>_start:
<a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a>    ldr pc, =_reset_
<a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a>    ldr pc, =undefined_instruction_vector
<a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a>    ldr pc, =software_interrupt_vector
<a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a>    ldr pc, =prefetch_abort_vector
<a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a>    ldr pc, =_reset_
<a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a>    ldr pc, =_reset_
<a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a>    ldr pc, =interrupt_vector
<a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a>    ldr pc, =fast_interrupt_vector
<a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a>
<a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a>_reset_:
<a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a>    // Copy the vector table to the active table at 0x00000000
<a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a>    ldr     r0, =_start
<a id=__codelineno-1-14 name=__codelineno-1-14 href=#__codelineno-1-14></a>    ldr     r1, #0x0000
<a id=__codelineno-1-15 name=__codelineno-1-15 href=#__codelineno-1-15></a>    ldmia   r0!,{r2, r3, r4, r5, r6, r7, r8, r9}
<a id=__codelineno-1-16 name=__codelineno-1-16 href=#__codelineno-1-16></a>    stmia   r1!,{r2, r3, r4, r5, r6, r7, r8, r9}
</code></pre></div> <p>There are only a few assembler instructions here, so don't panic! The labels refer to C functions that have been implemented with the correct attributes for each exception type. See the file <code>rpi-interrupts.c</code> to see these C functions.</p> <p>The Loading of addresses to a register with LDR is documented <a href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.dui0473c/Bgbbfgia.html">here</a></p> <p><em>reset</em> and undefined_instruction_vector, etc. are the labels used as the function addresses. So we have a table at the very start of our code. A neat side-effect of having this table right at the start of our code is that the first thing we do is run the reset vector code which jumps to the <em>reset</em> label and starts the execution of our code, thus jumping the vector table we don't want it to try and execute. Excellent!</p> <p>The ldmia and stmia instructions can load and store 32 bytes of data at a time, so are quick at shifting data about. Each register can load a 4-byte (32-bit) value, so using eight registers lets us move 32-bytes, and there are 8 32-bit vectors in our table, so one load and one store instruction later we've moved the whole of our vector table to <code>0x00000000</code>.</p> <p>See the documentation for this on the <a href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.dui0068b/BABEFCIB.html">ARM website</a></p> <p>But, before we go too much further, let me show you why this doesn't work!</p> <h3 id=its-all-relative>It's all relative<a class=headerlink href=#its-all-relative title="Permanent link">&para;</a></h3> <p>Compilation of the vector table is successful, but as always just a successful compilation doesn't get you a working application. Earlier in the tutorials I introduced the online disassembler - a great tool, but there's something else in our toolchain's toolbag already, objdump!</p> <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=gp>[~]$ </span>arm-none-eabi-objdump<span class=w> </span>--help
</code></pre></div> <p>That's your friend, and even more friendly is running this from the build directory of the <code>part-4/armc-013/</code> tutorial folder once you've built the tutorial:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=gp>[~]$ </span>arm-none-eabi-objdump<span class=w> </span>-S<span class=w> </span>armc-013<span class=w> </span>&gt;<span class=w> </span>armc-013.disasm
</code></pre></div> <p>This tells objdump to disassemble the executable and we then redirect objdumps output to the <code>armc-013.diasm</code> file which we can then look at in a text editor. Here's what we get at the start of that file with the vector table implementation I described above:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a>Disassembly of section .text:
<a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a>
<a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a>00008000 &lt;_start&gt;:
<a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a>    8000:   e59ff064    ldr pc, [pc, #100]  ; 806c &lt;_enable_interrupts+0x10&gt;
<a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a>    8004:   e59ff064    ldr pc, [pc, #100]  ; 8070 &lt;_enable_interrupts+0x14&gt;
<a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a>    8008:   e59ff064    ldr pc, [pc, #100]  ; 8074 &lt;_enable_interrupts+0x18&gt;
<a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a>    800c:   e59ff064    ldr pc, [pc, #100]  ; 8078 &lt;_enable_interrupts+0x1c&gt;
<a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a>    8010:   e59ff054    ldr pc, [pc, #84]   ; 806c &lt;_enable_interrupts+0x10&gt;
<a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a>    8014:   e59ff050    ldr pc, [pc, #80]   ; 806c &lt;_enable_interrupts+0x10&gt;
<a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a>    8018:   e59ff05c    ldr pc, [pc, #92]   ; 807c &lt;_enable_interrupts+0x20&gt;
<a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a>    801c:   e59ff05c    ldr pc, [pc, #92]   ; 8080 &lt;_enable_interrupts+0x24&gt;
<a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a>
<a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a>00008020 &lt;_reset_&gt;:
<a id=__codelineno-4-14 name=__codelineno-4-14 href=#__codelineno-4-14></a>    8020:   e3a00902    mov r0, #32768  ; 0x8000
</code></pre></div> <p>Hmmm, well that doesn't look right, what we'd expect from the first line is an equivalent of <code>ldr pc, #0x8020</code> which is the <em>reset</em> label is. The toolchain appears to be loading a value far away from where we'd expect. Further down the file we can find the location <code>0x806C</code>:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a>0000805c &lt;_enable_interrupts&gt;:
<a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a>    805c:   e10f0000    mrs r0, CPSR
<a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a>    8060:   e3c00080    bic r0, r0, #128    ; 0x80
<a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a>    8064:   e121f000    msr CPSR_c, r0
<a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a>    8068:   e1a0f00e    mov pc, lr
<a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a>    806c:   00008020    .word   0x00008020
<a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a>    8070:   000085e8    .word   0x000085e8
<a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a>    8074:   000085f4    .word   0x000085f4
<a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a>    8078:   00008600    .word   0x00008600
<a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a>    807c:   00008628    .word   0x00008628
<a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a>    8080:   0000869c    .word   0x0000869c
</code></pre></div> <p>Some light at the end of the tunnel, the compiler has inserted some constants which are being loaded into the PC so actually, loading the PC with the value at PC + 0x6C is correct for the vector because the value at that location is <code>0x8020</code> which is the location of the <em>reset</em> label.</p> <p>Again, we think this could work after all. But of course, it doesn't. The first part of our code now moves the code from 0x8000 to 0x0000 and the constants have not moved from <code>0x806C</code> to <code>0x006C</code>; Neither can we move these constants easily either because the compiler inserts these at the next available space, there's no position we can predict.</p> <p>The answer is to keep everything relative, but to create some constants of our own. We can keep these constants relative to the LDR PC instruction so that the relative offset still works. We need to create a table of constant addresses after the vector table loads. This way we can copy both tables and the constants will still be in the same position relative to the LDR instructions.</p> <p>Let's set that up:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a>_start:
<a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a>    ldr pc, _reset_h
<a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a>    ldr pc, _undefined_instruction_vector_h
<a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a>    ldr pc, _software_interrupt_vector_h
<a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a>    ldr pc, _prefetch_abort_vector_h
<a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a>    ldr pc, _data_abort_vector_h
<a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a>    ldr pc, _unused_handler_h
<a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a>    ldr pc, _interrupt_vector_h
<a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a>    ldr pc, _fast_interrupt_vector_h
<a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a>
<a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a>_reset_h:                           .word   _reset_
<a id=__codelineno-6-12 name=__codelineno-6-12 href=#__codelineno-6-12></a>_undefined_instruction_vector_h:    .word   undefined_instruction_vector
<a id=__codelineno-6-13 name=__codelineno-6-13 href=#__codelineno-6-13></a>_software_interrupt_vector_h:       .word   software_interrupt_vector
<a id=__codelineno-6-14 name=__codelineno-6-14 href=#__codelineno-6-14></a>_prefetch_abort_vector_h:           .word   prefetch_abort_vector
<a id=__codelineno-6-15 name=__codelineno-6-15 href=#__codelineno-6-15></a>_data_abort_vector_h:               .word   data_abort_vector
<a id=__codelineno-6-16 name=__codelineno-6-16 href=#__codelineno-6-16></a>_unused_handler_h:                  .word   _reset_
<a id=__codelineno-6-17 name=__codelineno-6-17 href=#__codelineno-6-17></a>_interrupt_vector_h:                .word   interrupt_vector
<a id=__codelineno-6-18 name=__codelineno-6-18 href=#__codelineno-6-18></a>_fast_interrupt_vector_h:           .word   fast_interrupt_vector
<a id=__codelineno-6-19 name=__codelineno-6-19 href=#__codelineno-6-19></a>
<a id=__codelineno-6-20 name=__codelineno-6-20 href=#__codelineno-6-20></a>_reset_:
<a id=__codelineno-6-21 name=__codelineno-6-21 href=#__codelineno-6-21></a>
<a id=__codelineno-6-22 name=__codelineno-6-22 href=#__codelineno-6-22></a>    mov     r0, #0x8000
<a id=__codelineno-6-23 name=__codelineno-6-23 href=#__codelineno-6-23></a>    mov     r1, #0x0000
<a id=__codelineno-6-24 name=__codelineno-6-24 href=#__codelineno-6-24></a>    ldmia   r0!,{r2, r3, r4, r5, r6, r7, r8, r9}
<a id=__codelineno-6-25 name=__codelineno-6-25 href=#__codelineno-6-25></a>    stmia   r1!,{r2, r3, r4, r5, r6, r7, r8, r9}
<a id=__codelineno-6-26 name=__codelineno-6-26 href=#__codelineno-6-26></a>    ldmia   r0!,{r2, r3, r4, r5, r6, r7, r8, r9}
<a id=__codelineno-6-27 name=__codelineno-6-27 href=#__codelineno-6-27></a>    stmia   r1!,{r2, r3, r4, r5, r6, r7, r8, r9}
</code></pre></div> <p>Note that we've now had to double the amount of data we copy so that we get the constants copied along with the relative PC loads of those constants. This feels like a bit of a cludge but as objdump will show us, this gets the job done and relocates the vector table as required.</p> <p>The vector table now references the labels directly suffixed to the vector table itself and so the relative position remains constant so long as both are copied as-is.</p> <p>The output of <code>objdump -S</code> shows us the workable solution:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a>Disassembly of section .text:
<a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a>
<a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a>00008000 &lt;_start&gt;:
<a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a>    8000:   e59ff018    ldr pc, [pc, #24]   ; 8020 &lt;_reset_h&gt;
<a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a>    8004:   e59ff018    ldr pc, [pc, #24]   ; 8024 &lt;_undefined_instruction_vector_h&gt;
<a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a>    8008:   e59ff018    ldr pc, [pc, #24]   ; 8028 &lt;_software_interrupt_vector_h&gt;
<a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a>    800c:   e59ff018    ldr pc, [pc, #24]   ; 802c &lt;_prefetch_abort_vector_h&gt;
<a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a>    8010:   e59ff018    ldr pc, [pc, #24]   ; 8030 &lt;_data_abort_vector_h&gt;
<a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a>    8014:   e59ff018    ldr pc, [pc, #24]   ; 8034 &lt;_unused_handler_h&gt;
<a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a>    8018:   e59ff018    ldr pc, [pc, #24]   ; 8038 &lt;_interrupt_vector_h&gt;
<a id=__codelineno-7-11 name=__codelineno-7-11 href=#__codelineno-7-11></a>    801c:   e59ff018    ldr pc, [pc, #24]   ; 803c &lt;_fast_interrupt_vector_h&gt;
<a id=__codelineno-7-12 name=__codelineno-7-12 href=#__codelineno-7-12></a>
<a id=__codelineno-7-13 name=__codelineno-7-13 href=#__codelineno-7-13></a>00008020 &lt;_reset_h&gt;:
<a id=__codelineno-7-14 name=__codelineno-7-14 href=#__codelineno-7-14></a>    8020:   00008040    .word   0x00008040
<a id=__codelineno-7-15 name=__codelineno-7-15 href=#__codelineno-7-15></a>
<a id=__codelineno-7-16 name=__codelineno-7-16 href=#__codelineno-7-16></a>00008024 &lt;_undefined_instruction_vector_h&gt;:
<a id=__codelineno-7-17 name=__codelineno-7-17 href=#__codelineno-7-17></a>    8024:   000085f8    .word   0x000085f8
<a id=__codelineno-7-18 name=__codelineno-7-18 href=#__codelineno-7-18></a>
<a id=__codelineno-7-19 name=__codelineno-7-19 href=#__codelineno-7-19></a>00008028 &lt;_software_interrupt_vector_h&gt;:
<a id=__codelineno-7-20 name=__codelineno-7-20 href=#__codelineno-7-20></a>    8028:   00008604    .word   0x00008604
<a id=__codelineno-7-21 name=__codelineno-7-21 href=#__codelineno-7-21></a>
<a id=__codelineno-7-22 name=__codelineno-7-22 href=#__codelineno-7-22></a>0000802c &lt;_prefetch_abort_vector_h&gt;:
<a id=__codelineno-7-23 name=__codelineno-7-23 href=#__codelineno-7-23></a>    802c:   00008610    .word   0x00008610
<a id=__codelineno-7-24 name=__codelineno-7-24 href=#__codelineno-7-24></a>
<a id=__codelineno-7-25 name=__codelineno-7-25 href=#__codelineno-7-25></a>00008030 &lt;_data_abort_vector_h&gt;:
<a id=__codelineno-7-26 name=__codelineno-7-26 href=#__codelineno-7-26></a>    8030:   00008624    .word   0x00008624
<a id=__codelineno-7-27 name=__codelineno-7-27 href=#__codelineno-7-27></a>
<a id=__codelineno-7-28 name=__codelineno-7-28 href=#__codelineno-7-28></a>00008034 &lt;_unused_handler_h&gt;:
<a id=__codelineno-7-29 name=__codelineno-7-29 href=#__codelineno-7-29></a>    8034:   00008040    .word   0x00008040
<a id=__codelineno-7-30 name=__codelineno-7-30 href=#__codelineno-7-30></a>
<a id=__codelineno-7-31 name=__codelineno-7-31 href=#__codelineno-7-31></a>00008038 &lt;_interrupt_vector_h&gt;:
<a id=__codelineno-7-32 name=__codelineno-7-32 href=#__codelineno-7-32></a>    8038:   00008638    .word   0x00008638
<a id=__codelineno-7-33 name=__codelineno-7-33 href=#__codelineno-7-33></a>
<a id=__codelineno-7-34 name=__codelineno-7-34 href=#__codelineno-7-34></a>0000803c &lt;_fast_interrupt_vector_h&gt;:
<a id=__codelineno-7-35 name=__codelineno-7-35 href=#__codelineno-7-35></a>    803c:   000086ac    .word   0x000086ac
<a id=__codelineno-7-36 name=__codelineno-7-36 href=#__codelineno-7-36></a>
<a id=__codelineno-7-37 name=__codelineno-7-37 href=#__codelineno-7-37></a>00008040 &lt;_reset_&gt;:
<a id=__codelineno-7-38 name=__codelineno-7-38 href=#__codelineno-7-38></a>    8040:   e3a00902    mov r0, #32768  ; 0x8000
</code></pre></div> <p>You can go ahead and see that the armc-013 tutorial is in fact using this solution to provide the exception vector table at run time.</p> <h2 id=the-interrupt-controller>The Interrupt Controller<a class=headerlink href=#the-interrupt-controller title="Permanent link">&para;</a></h2> <p>So now we have the exception vectors tied to our exception handlers (which are implemented in C) but the processor still doesn't know when to interrupt.</p> <p>Interrupts on a processor are enabled per interrupt source and then globally enabled and disabled. This way we can select which interrupt sources we're interested in and also whether to allow interrupts or not. Sometimes we want to temporarily disable interrupts to guard a non-atomic memory operation if the same memory is used in an interrupt handler for example.</p> <p>The Raspberry-Pi ARM has an interrupt controller where we can set up the enable and disable the interrupt sources we're interested in. From the <a href=http://www.raspberrypi.org/wp-content/uploads/2012/02/BCM2835-ARM-Peripherals.pdf>BCM2835 ARM peripherals datasheet</a> we can see section 7 describe the interrupt controller present.</p> <p>The documentation here is a bit lacking - but see the section that says ARM peripherals interrupts table. These are basically the interrupt sources we have control over.</p> <p>We're blinking an LED and so we just want to capture the ARM Timer interrupt source. In the tutorial code, we will map a C structure to the address of the interrupt controller to give us access to the registers.</p> <p>This is how we define the struct for the interrupt controller registers and implement an instance at the base address, again this information is from section 7.5 of the document above:</p> <p>In <code>rpi-interrupts.h</code>:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=cm>/** @brief See Section 7.5 of the BCM2835 ARM Peripherals documentation, the base</span>
<a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=cm>    address of the controller is actually xxxxB000, but there is a 0x200 offset</span>
<a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a><span class=cm>    to the first addressable register for the interrupt controller, so offset the</span>
<a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a><span class=cm>    base to the first register */</span>
<a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a><span class=cp>#define RPI_INTERRUPT_CONTROLLER_BASE   ( PERIPHERAL_BASE + 0xB200 )</span>
<a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a>
<a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a><span class=cm>/** @brief The interrupt controller memory mapped register set */</span>
<a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a><span class=k>typedef</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a><span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>IRQ_basic_pending</span><span class=p>;</span>
<a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a><span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>IRQ_pending_1</span><span class=p>;</span>
<a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a><span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>IRQ_pending_2</span><span class=p>;</span>
<a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a><span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>FIQ_control</span><span class=p>;</span>
<a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a><span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>Enable_IRQs_1</span><span class=p>;</span>
<a id=__codelineno-8-14 name=__codelineno-8-14 href=#__codelineno-8-14></a><span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>Enable_IRQs_2</span><span class=p>;</span>
<a id=__codelineno-8-15 name=__codelineno-8-15 href=#__codelineno-8-15></a><span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>Enable_Basic_IRQs</span><span class=p>;</span>
<a id=__codelineno-8-16 name=__codelineno-8-16 href=#__codelineno-8-16></a><span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>Disable_IRQs_1</span><span class=p>;</span>
<a id=__codelineno-8-17 name=__codelineno-8-17 href=#__codelineno-8-17></a><span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>Disable_IRQs_2</span><span class=p>;</span>
<a id=__codelineno-8-18 name=__codelineno-8-18 href=#__codelineno-8-18></a><span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>Disable_Basic_IRQs</span><span class=p>;</span>
<a id=__codelineno-8-19 name=__codelineno-8-19 href=#__codelineno-8-19></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=n>rpi_irq_controller_t</span><span class=p>;</span>
</code></pre></div> <p>and in <code>rpi-interrupts.c</code>:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=cm>/** @brief The BCM2835 Interupt controller peripheral at it&#39;s base address */</span>
<a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a><span class=k>static</span><span class=w> </span><span class=n>rpi_irq_controller_t</span><span class=o>*</span><span class=w> </span><span class=n>rpiIRQController</span><span class=w> </span><span class=o>=</span>
<a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a><span class=w>        </span><span class=p>(</span><span class=n>rpi_irq_controller_t</span><span class=o>*</span><span class=p>)</span><span class=n>RPI_INTERRUPT_CONTROLLER_BASE</span><span class=p>;</span>
<a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a>
<a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a>
<a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a><span class=cm>/**</span>
<a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a><span class=cm>    @brief Return the IRQ Controller register set</span>
<a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a><span class=cm>*/</span>
<a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a><span class=n>rpi_irq_controller_t</span><span class=o>*</span><span class=w> </span><span class=nf>RPI_GetIrqController</span><span class=p>(</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=p>)</span>
<a id=__codelineno-9-10 name=__codelineno-9-10 href=#__codelineno-9-10></a><span class=p>{</span>
<a id=__codelineno-9-11 name=__codelineno-9-11 href=#__codelineno-9-11></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>rpiIRQController</span><span class=p>;</span>
<a id=__codelineno-9-12 name=__codelineno-9-12 href=#__codelineno-9-12></a><span class=p>}</span>
</code></pre></div> <h2 id=the-arm-timer-peripheral>The ARM Timer Peripheral<a class=headerlink href=#the-arm-timer-peripheral title="Permanent link">&para;</a></h2> <p>The ARM timer is in the Basic interrupt set. So to tell the processor we want to enable interrupts from the ARM Timer peripheral we set the relevant bit in the Basic Interrupt enable register:</p> <p>Also in rpi-interrupts.h:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=cm>/** @brief Bits in the Enable_Basic_IRQs register to enable various interrupts.</span>
<a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=cm>    See the BCM2835 ARM Peripherals manual, section 7.5 */</span>
<a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a><span class=cp>#define RPI_BASIC_ARM_TIMER_IRQ         (1 &lt;&lt; 0)</span>
<a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a><span class=cp>#define RPI_BASIC_ARM_MAILBOX_IRQ       (1 &lt;&lt; 1)</span>
<a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a><span class=cp>#define RPI_BASIC_ARM_DOORBELL_0_IRQ    (1 &lt;&lt; 2)</span>
<a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a><span class=cp>#define RPI_BASIC_ARM_DOORBELL_1_IRQ    (1 &lt;&lt; 3)</span>
<a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a><span class=cp>#define RPI_BASIC_GPU_0_HALTED_IRQ      (1 &lt;&lt; 4)</span>
<a id=__codelineno-10-8 name=__codelineno-10-8 href=#__codelineno-10-8></a><span class=cp>#define RPI_BASIC_GPU_1_HALTED_IRQ      (1 &lt;&lt; 5)</span>
<a id=__codelineno-10-9 name=__codelineno-10-9 href=#__codelineno-10-9></a><span class=cp>#define RPI_BASIC_ACCESS_ERROR_1_IRQ    (1 &lt;&lt; 6)</span>
<a id=__codelineno-10-10 name=__codelineno-10-10 href=#__codelineno-10-10></a><span class=cp>#define RPI_BASIC_ACCESS_ERROR_0_IRQ    (1 &lt;&lt; 7)</span>
</code></pre></div> <p>and in our main C code to enable the ARM Timer IRQ:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=cm>/* Enable the timer interrupt IRQ */</span>
<a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a><span class=n>RPI_GetIrqController</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>Enable_Basic_IRQs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>RPI_BASIC_ARM_TIMER_IRQ</span><span class=p>;</span>
</code></pre></div> <p>The ARM Timer interrupt source is now enabled. However, the processor still needs to have interrupts globally enabled for any interrupt to execute the Interrupt handler, and the ARM Timer peripheral also needs to be enabled and configured to generate the interrupts!</p> <p>The ARM Timer peripheral is documented in the same <a href=http://www.raspberrypi.org/wp-content/uploads/2012/02/BCM2835-ARM-Peripherals.pdf>BCM2835 ARM peripherals datasheet</a> in section 14.</p> <p>Again, we map the peripherals register set to a C struct to give us access to the registers:</p> <p>In rpi-armtimer.h:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=cm>/** @brief See the documentation for the ARM side timer (Section 14 of the</span>
<a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a><span class=cm>    BCM2835 Peripherals PDF) */</span>
<a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a><span class=cp>#define RPI_ARMTIMER_BASE               ( PERIPHERAL_BASE + 0xB400 )</span>
<a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a>
<a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a><span class=cm>/** @brief 0 : 16-bit counters - 1 : 23-bit counter */</span>
<a id=__codelineno-12-6 name=__codelineno-12-6 href=#__codelineno-12-6></a><span class=cp>#define RPI_ARMTIMER_CTRL_23BIT         ( 1 &lt;&lt; 1 )</span>
<a id=__codelineno-12-7 name=__codelineno-12-7 href=#__codelineno-12-7></a>
<a id=__codelineno-12-8 name=__codelineno-12-8 href=#__codelineno-12-8></a><span class=cp>#define RPI_ARMTIMER_CTRL_PRESCALE_1    ( 0 &lt;&lt; 2 )</span>
<a id=__codelineno-12-9 name=__codelineno-12-9 href=#__codelineno-12-9></a><span class=cp>#define RPI_ARMTIMER_CTRL_PRESCALE_16   ( 1 &lt;&lt; 2 )</span>
<a id=__codelineno-12-10 name=__codelineno-12-10 href=#__codelineno-12-10></a><span class=cp>#define RPI_ARMTIMER_CTRL_PRESCALE_256  ( 2 &lt;&lt; 2 )</span>
<a id=__codelineno-12-11 name=__codelineno-12-11 href=#__codelineno-12-11></a>
<a id=__codelineno-12-12 name=__codelineno-12-12 href=#__codelineno-12-12></a><span class=cm>/** @brief 0 : Timer interrupt disabled - 1 : Timer interrupt enabled */</span>
<a id=__codelineno-12-13 name=__codelineno-12-13 href=#__codelineno-12-13></a><span class=cp>#define RPI_ARMTIMER_CTRL_INT_ENABLE    ( 1 &lt;&lt; 5 )</span>
<a id=__codelineno-12-14 name=__codelineno-12-14 href=#__codelineno-12-14></a><span class=cp>#define RPI_ARMTIMER_CTRL_INT_DISABLE   ( 0 &lt;&lt; 5 )</span>
<a id=__codelineno-12-15 name=__codelineno-12-15 href=#__codelineno-12-15></a>
<a id=__codelineno-12-16 name=__codelineno-12-16 href=#__codelineno-12-16></a><span class=cm>/** @brief 0 : Timer disabled - 1 : Timer enabled */</span>
<a id=__codelineno-12-17 name=__codelineno-12-17 href=#__codelineno-12-17></a><span class=cp>#define RPI_ARMTIMER_CTRL_ENABLE        ( 1 &lt;&lt; 7 )</span>
<a id=__codelineno-12-18 name=__codelineno-12-18 href=#__codelineno-12-18></a><span class=cp>#define RPI_ARMTIMER_CTRL_DISABLE       ( 0 &lt;&lt; 7 )</span>
<a id=__codelineno-12-19 name=__codelineno-12-19 href=#__codelineno-12-19></a>
<a id=__codelineno-12-20 name=__codelineno-12-20 href=#__codelineno-12-20></a><span class=cm>/** @brief Section 14.2 of the BCM2835 Peripherals documentation details</span>
<a id=__codelineno-12-21 name=__codelineno-12-21 href=#__codelineno-12-21></a><span class=cm>    the register layout for the ARM side timer */</span>
<a id=__codelineno-12-22 name=__codelineno-12-22 href=#__codelineno-12-22></a><span class=k>typedef</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-12-23 name=__codelineno-12-23 href=#__codelineno-12-23></a>
<a id=__codelineno-12-24 name=__codelineno-12-24 href=#__codelineno-12-24></a><span class=w>    </span><span class=cm>/** The timer load register sets the time for the timer to count down.</span>
<a id=__codelineno-12-25 name=__codelineno-12-25 href=#__codelineno-12-25></a><span class=cm>        This value is loaded into the timer value register after the load</span>
<a id=__codelineno-12-26 name=__codelineno-12-26 href=#__codelineno-12-26></a><span class=cm>        register has been written or if the timer-value register has counted</span>
<a id=__codelineno-12-27 name=__codelineno-12-27 href=#__codelineno-12-27></a><span class=cm>        down to 0. */</span>
<a id=__codelineno-12-28 name=__codelineno-12-28 href=#__codelineno-12-28></a><span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>Load</span><span class=p>;</span>
<a id=__codelineno-12-29 name=__codelineno-12-29 href=#__codelineno-12-29></a>
<a id=__codelineno-12-30 name=__codelineno-12-30 href=#__codelineno-12-30></a><span class=w>    </span><span class=cm>/** This register holds the current timer value and is counted down when</span>
<a id=__codelineno-12-31 name=__codelineno-12-31 href=#__codelineno-12-31></a><span class=cm>        the counter is running. It is counted down each timer clock until the</span>
<a id=__codelineno-12-32 name=__codelineno-12-32 href=#__codelineno-12-32></a><span class=cm>        value 0 is reached. Then the value register is re-loaded from the</span>
<a id=__codelineno-12-33 name=__codelineno-12-33 href=#__codelineno-12-33></a><span class=cm>        timer load register and the interrupt pending bit is set. The timer</span>
<a id=__codelineno-12-34 name=__codelineno-12-34 href=#__codelineno-12-34></a><span class=cm>        count down speed is set by the timer pre-divide register. */</span>
<a id=__codelineno-12-35 name=__codelineno-12-35 href=#__codelineno-12-35></a><span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>Value</span><span class=p>;</span>
<a id=__codelineno-12-36 name=__codelineno-12-36 href=#__codelineno-12-36></a>
<a id=__codelineno-12-37 name=__codelineno-12-37 href=#__codelineno-12-37></a><span class=w>    </span><span class=cm>/** The standard SP804 timer control register consist of 8 bits but in the</span>
<a id=__codelineno-12-38 name=__codelineno-12-38 href=#__codelineno-12-38></a><span class=cm>        BCM implementation there are more control bits for the extra features.</span>
<a id=__codelineno-12-39 name=__codelineno-12-39 href=#__codelineno-12-39></a><span class=cm>        Control bits 0-7 are identical to the SP804 bits, albeit some</span>
<a id=__codelineno-12-40 name=__codelineno-12-40 href=#__codelineno-12-40></a><span class=cm>        functionality of the SP804 is not implemented. All new control bits</span>
<a id=__codelineno-12-41 name=__codelineno-12-41 href=#__codelineno-12-41></a><span class=cm>        start from bit 8 upwards. */</span>
<a id=__codelineno-12-42 name=__codelineno-12-42 href=#__codelineno-12-42></a><span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>Control</span><span class=p>;</span>
<a id=__codelineno-12-43 name=__codelineno-12-43 href=#__codelineno-12-43></a>
<a id=__codelineno-12-44 name=__codelineno-12-44 href=#__codelineno-12-44></a><span class=w>    </span><span class=cm>/** The timer IRQ clear register is write only. When writing this register</span>
<a id=__codelineno-12-45 name=__codelineno-12-45 href=#__codelineno-12-45></a><span class=cm>        the interrupt-pending bit is cleared. When reading this register it</span>
<a id=__codelineno-12-46 name=__codelineno-12-46 href=#__codelineno-12-46></a><span class=cm>        returns 0x544D5241 which is the ASCII reversed value for &quot;ARMT&quot;. */</span>
<a id=__codelineno-12-47 name=__codelineno-12-47 href=#__codelineno-12-47></a><span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>IRQClear</span><span class=p>;</span>
<a id=__codelineno-12-48 name=__codelineno-12-48 href=#__codelineno-12-48></a>
<a id=__codelineno-12-49 name=__codelineno-12-49 href=#__codelineno-12-49></a><span class=w>    </span><span class=cm>/** The raw IRQ register is a read-only register. It shows the status of</span>
<a id=__codelineno-12-50 name=__codelineno-12-50 href=#__codelineno-12-50></a><span class=cm>        the interrupt pending bit. 0 : The interrupt pending bits is clear.</span>
<a id=__codelineno-12-51 name=__codelineno-12-51 href=#__codelineno-12-51></a><span class=cm>        1 : The interrupt pending bit is set.</span>
<a id=__codelineno-12-52 name=__codelineno-12-52 href=#__codelineno-12-52></a>
<a id=__codelineno-12-53 name=__codelineno-12-53 href=#__codelineno-12-53></a><span class=cm>        The interrupt pending bits is set each time the value register is</span>
<a id=__codelineno-12-54 name=__codelineno-12-54 href=#__codelineno-12-54></a><span class=cm>        counted down to zero. The interrupt pending bit can not by itself</span>
<a id=__codelineno-12-55 name=__codelineno-12-55 href=#__codelineno-12-55></a><span class=cm>        generates interrupts. Interrupts can only be generated if the</span>
<a id=__codelineno-12-56 name=__codelineno-12-56 href=#__codelineno-12-56></a><span class=cm>        interrupt enable bit is set. */</span>
<a id=__codelineno-12-57 name=__codelineno-12-57 href=#__codelineno-12-57></a><span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>RAWIRQ</span><span class=p>;</span>
<a id=__codelineno-12-58 name=__codelineno-12-58 href=#__codelineno-12-58></a>
<a id=__codelineno-12-59 name=__codelineno-12-59 href=#__codelineno-12-59></a><span class=w>    </span><span class=cm>/** The masked IRQ register is a read-only register. It shows the status</span>
<a id=__codelineno-12-60 name=__codelineno-12-60 href=#__codelineno-12-60></a><span class=cm>        of the interrupt signal. It is simply a logical AND of the interrupt</span>
<a id=__codelineno-12-61 name=__codelineno-12-61 href=#__codelineno-12-61></a><span class=cm>        pending bit and the interrupt enable bit. 0 : Interrupt line not</span>
<a id=__codelineno-12-62 name=__codelineno-12-62 href=#__codelineno-12-62></a><span class=cm>        asserted. 1 :Interrupt line is asserted, (the interrupt pending and</span>
<a id=__codelineno-12-63 name=__codelineno-12-63 href=#__codelineno-12-63></a><span class=cm>        the interrupt enable bit are set.)  */</span>
<a id=__codelineno-12-64 name=__codelineno-12-64 href=#__codelineno-12-64></a><span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>MaskedIRQ</span><span class=p>;</span>
<a id=__codelineno-12-65 name=__codelineno-12-65 href=#__codelineno-12-65></a>
<a id=__codelineno-12-66 name=__codelineno-12-66 href=#__codelineno-12-66></a><span class=w>    </span><span class=cm>/** This register is a copy of the timer load register. The difference is</span>
<a id=__codelineno-12-67 name=__codelineno-12-67 href=#__codelineno-12-67></a><span class=cm>        that a write to this register does not trigger an immediate reload of</span>
<a id=__codelineno-12-68 name=__codelineno-12-68 href=#__codelineno-12-68></a><span class=cm>        the timer value register. Instead the timer load register value is</span>
<a id=__codelineno-12-69 name=__codelineno-12-69 href=#__codelineno-12-69></a><span class=cm>        only accessed if the value register has finished counting down to</span>
<a id=__codelineno-12-70 name=__codelineno-12-70 href=#__codelineno-12-70></a><span class=cm>        zero. */</span>
<a id=__codelineno-12-71 name=__codelineno-12-71 href=#__codelineno-12-71></a><span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>Reload</span><span class=p>;</span>
<a id=__codelineno-12-72 name=__codelineno-12-72 href=#__codelineno-12-72></a>
<a id=__codelineno-12-73 name=__codelineno-12-73 href=#__codelineno-12-73></a><span class=w>    </span><span class=cm>/** The Pre-divider register is not present in the SP804. The pre-divider</span>
<a id=__codelineno-12-74 name=__codelineno-12-74 href=#__codelineno-12-74></a><span class=cm>        register is 10 bits wide and can be written or read from. This</span>
<a id=__codelineno-12-75 name=__codelineno-12-75 href=#__codelineno-12-75></a><span class=cm>        register has been added as the SP804 expects a 1MHz clock which we do</span>
<a id=__codelineno-12-76 name=__codelineno-12-76 href=#__codelineno-12-76></a><span class=cm>        not have. Instead the pre-divider takes the APB clock and divides it</span>
<a id=__codelineno-12-77 name=__codelineno-12-77 href=#__codelineno-12-77></a><span class=cm>        down according to:</span>
<a id=__codelineno-12-78 name=__codelineno-12-78 href=#__codelineno-12-78></a>
<a id=__codelineno-12-79 name=__codelineno-12-79 href=#__codelineno-12-79></a><span class=cm>        timer_clock = apb_clock/(pre_divider+1)</span>
<a id=__codelineno-12-80 name=__codelineno-12-80 href=#__codelineno-12-80></a>
<a id=__codelineno-12-81 name=__codelineno-12-81 href=#__codelineno-12-81></a><span class=cm>        The reset value of this register is 0x7D so gives a divide by 126. */</span>
<a id=__codelineno-12-82 name=__codelineno-12-82 href=#__codelineno-12-82></a><span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>PreDivider</span><span class=p>;</span>
<a id=__codelineno-12-83 name=__codelineno-12-83 href=#__codelineno-12-83></a>
<a id=__codelineno-12-84 name=__codelineno-12-84 href=#__codelineno-12-84></a><span class=w>    </span><span class=cm>/** The free running counter is not present in the SP804. The free running</span>
<a id=__codelineno-12-85 name=__codelineno-12-85 href=#__codelineno-12-85></a><span class=cm>        counter is a 32 bits wide read only register. The register is enabled</span>
<a id=__codelineno-12-86 name=__codelineno-12-86 href=#__codelineno-12-86></a><span class=cm>        by setting bit 9 of the Timer control register. The free running</span>
<a id=__codelineno-12-87 name=__codelineno-12-87 href=#__codelineno-12-87></a><span class=cm>        counter is incremented immediately after it is enabled. The timer can</span>
<a id=__codelineno-12-88 name=__codelineno-12-88 href=#__codelineno-12-88></a><span class=cm>        not be reset but when enabled, will always increment and roll-over.</span>
<a id=__codelineno-12-89 name=__codelineno-12-89 href=#__codelineno-12-89></a>
<a id=__codelineno-12-90 name=__codelineno-12-90 href=#__codelineno-12-90></a><span class=cm>        The free running counter is also running from the APB clock and has</span>
<a id=__codelineno-12-91 name=__codelineno-12-91 href=#__codelineno-12-91></a><span class=cm>        its own clock pre-divider controlled by bits 16-23 of the timer</span>
<a id=__codelineno-12-92 name=__codelineno-12-92 href=#__codelineno-12-92></a><span class=cm>        control register.</span>
<a id=__codelineno-12-93 name=__codelineno-12-93 href=#__codelineno-12-93></a>
<a id=__codelineno-12-94 name=__codelineno-12-94 href=#__codelineno-12-94></a><span class=cm>        This register will be halted too if bit 8 of the control register is</span>
<a id=__codelineno-12-95 name=__codelineno-12-95 href=#__codelineno-12-95></a><span class=cm>        set and the ARM is in Debug Halt mode. */</span>
<a id=__codelineno-12-96 name=__codelineno-12-96 href=#__codelineno-12-96></a><span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>FreeRunningCounter</span><span class=p>;</span>
<a id=__codelineno-12-97 name=__codelineno-12-97 href=#__codelineno-12-97></a>
<a id=__codelineno-12-98 name=__codelineno-12-98 href=#__codelineno-12-98></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=n>rpi_arm_timer_t</span><span class=p>;</span>
</code></pre></div> <p>and the same in <code>rpi-armtimer.c</code>:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=k>static</span><span class=w> </span><span class=n>rpi_arm_timer_t</span><span class=o>*</span><span class=w> </span><span class=n>rpiArmTimer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>rpi_arm_timer_t</span><span class=o>*</span><span class=p>)</span><span class=n>RPI_ARMTIMER_BASE</span><span class=p>;</span>
<a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a>
<a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a><span class=n>rpi_arm_timer_t</span><span class=o>*</span><span class=w> </span><span class=nf>RPI_GetArmTimer</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a><span class=p>{</span>
<a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>rpiArmTimer</span><span class=p>;</span>
<a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a><span class=p>}</span>
</code></pre></div> <p>Then, we can setup the ARM Timer peripheral from the main C code with something like:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=cm>/* Setup the system timer interrupt */</span>
<a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a><span class=cm>/* Timer frequency = Clk/256 * 0x400 */</span>
<a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a><span class=n>RPI_GetArmTimer</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>Load</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x400</span><span class=p>;</span>
<a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a>
<a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a><span class=cm>/* Setup the ARM Timer */</span>
<a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a><span class=n>RPI_GetArmTimer</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>Control</span><span class=w> </span><span class=o>=</span>
<a id=__codelineno-14-7 name=__codelineno-14-7 href=#__codelineno-14-7></a><span class=w>        </span><span class=n>RPI_ARMTIMER_CTRL_23BIT</span><span class=w> </span><span class=o>|</span>
<a id=__codelineno-14-8 name=__codelineno-14-8 href=#__codelineno-14-8></a><span class=w>        </span><span class=n>RPI_ARMTIMER_CTRL_ENABLE</span><span class=w> </span><span class=o>|</span>
<a id=__codelineno-14-9 name=__codelineno-14-9 href=#__codelineno-14-9></a><span class=w>        </span><span class=n>RPI_ARMTIMER_CTRL_INT_ENABLE</span><span class=w> </span><span class=o>|</span>
<a id=__codelineno-14-10 name=__codelineno-14-10 href=#__codelineno-14-10></a><span class=w>        </span><span class=n>RPI_ARMTIMER_CTRL_PRESCALE_256</span><span class=p>;</span>
</code></pre></div> <p>As documented the load register is the value loaded into the timer each time the timer elapses. This value is loaded into the Value register either when the register is written, or else when the Value register has counted down to 0. The timer decrements the Value register at a frequency dervied from the system clock.</p> <p>When the Value register reaches 0 the Value register is re-loaded with the Load value and the interrupt pending bit is set.</p> <p>It's at this point our interrupt handler should get called. The bits in the Control register that we're setting should be reasonably self-explanatory. Although the documentation says <code>CTRL_23BIT</code> I suspect (as do others) that this is a typo and it's meant to read <code>CTRL_32BIT</code>!</p> <p>All that's left after configuring the ARM Timer and the Interrupt controller is to globally enable interrupts. This is a function that I wrote in assembler again because the instructions to enable the registers are not available through any C instructions:</p> <p>In armc-013-start.S:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a>_enable_interrupts:
<a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a>    mrs     r0, cpsr
<a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a>    bic     r0, r0, #0x80
<a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a>    msr     cpsr_c, r0
<a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a>    cpsie   i
<a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a>
<a id=__codelineno-15-7 name=__codelineno-15-7 href=#__codelineno-15-7></a>    mov     pc, lr
</code></pre></div> <p>This code is pretty straight forward. Section A1.1.3 of the ARM ARM describes the Status registers in the processor and describes the Current Program Status Register (CPSR). Some information is covered in this section and of important note is "The CPSR is accessed with special instructions".</p> <p>Section A2.5 of the ARM ARM describes the format of the CPSR register in more detail and details the exact layout of the CPSR register.</p> <p>Section A2.5.6 describes the interrupt disable bits, and that gets us the last bit of information we need.</p> <p><img alt=CSPR src=/img/bare-metal-programming-in-c/part-4-cpsr-armv7a-v7r.png></p> <p>Section A4.1.38 MRS describes the Move Program Status Register to general purpose register instruction which is the special instruction referred to in Section A1.1.3 of the manual.</p> <p><img alt=MSR src=/img/bare-metal-programming-in-c/part-4-msr-instruction.png></p> <p>So, we copy the contents of the Current Program Status Register into R0.</p> <p>Then we clear bit 7 ( Remember <code>(1 &lt;&lt; 7) == 0x80</code> ) in the R0 to enable interrupts. Section A2.5.6 and A2.5 gave us the details for that instruction.</p> <p>Then we copy r0 back to the Current Program Status Register which is the point at which interrupts become enabled.</p> <p>Finally we load the Program Counter with the Link Register contents to return from enabling interrupts.</p> <p>The last thing to do is to write something in the interrupt handler to deal with toggling the LED and to clear the interrupt pending bit. Clearing the interrupt pending bit for the ARM Timer is essential otherwise the processor will not know we have dealt with that interrupt and as soon as it exits from the interrupt handler it will immediately enter it again because the interrupt pending bit of an enabled interrupt source is still set.</p> <p>The interrupt handler is in rpi-interrupts.c:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=kt>void</span><span class=w> </span><span class=n>__attribute__</span><span class=p>((</span><span class=n>interrupt</span><span class=p>(</span><span class=s>&quot;IRQ&quot;</span><span class=p>)))</span><span class=w> </span><span class=n>interrupt_vector</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a><span class=p>{</span>
<a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>lit</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
<a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a>
<a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=w> </span><span class=n>RPI_GetArmTimer</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>MaskedIRQ</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-16-6 name=__codelineno-16-6 href=#__codelineno-16-6></a><span class=w>        </span><span class=cm>/* Clear the ARM Timer interrupt - it&#39;s the only interrupt we have</span>
<a id=__codelineno-16-7 name=__codelineno-16-7 href=#__codelineno-16-7></a><span class=cm>           enabled, so we want don&#39;t have to work out which interrupt source</span>
<a id=__codelineno-16-8 name=__codelineno-16-8 href=#__codelineno-16-8></a><span class=cm>           caused us to interrupt */</span>
<a id=__codelineno-16-9 name=__codelineno-16-9 href=#__codelineno-16-9></a><span class=w>        </span><span class=n>RPI_GetArmTimer</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>IRQClear</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
<a id=__codelineno-16-10 name=__codelineno-16-10 href=#__codelineno-16-10></a><span class=w>        </span><span class=cm>/* Flip the LED */</span>
<a id=__codelineno-16-11 name=__codelineno-16-11 href=#__codelineno-16-11></a><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=w> </span><span class=n>lit</span><span class=w> </span><span class=p>)</span>
<a id=__codelineno-16-12 name=__codelineno-16-12 href=#__codelineno-16-12></a><span class=w>        </span><span class=p>{</span>
<a id=__codelineno-16-13 name=__codelineno-16-13 href=#__codelineno-16-13></a><span class=w>            </span><span class=n>RPI_SetGpioHi</span><span class=p>(</span><span class=w> </span><span class=n>LED_GPIO</span><span class=w> </span><span class=p>);</span>
<a id=__codelineno-16-14 name=__codelineno-16-14 href=#__codelineno-16-14></a><span class=w>            </span><span class=n>lit</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
<a id=__codelineno-16-15 name=__codelineno-16-15 href=#__codelineno-16-15></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-16-16 name=__codelineno-16-16 href=#__codelineno-16-16></a><span class=w>        </span><span class=k>else</span>
<a id=__codelineno-16-17 name=__codelineno-16-17 href=#__codelineno-16-17></a><span class=w>        </span><span class=p>{</span>
<a id=__codelineno-16-18 name=__codelineno-16-18 href=#__codelineno-16-18></a><span class=w>            </span><span class=n>RPI_SetGpioLo</span><span class=p>(</span><span class=w> </span><span class=n>LED_GPIO</span><span class=w> </span><span class=p>);</span>
<a id=__codelineno-16-19 name=__codelineno-16-19 href=#__codelineno-16-19></a><span class=w>            </span><span class=n>lit</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
<a id=__codelineno-16-20 name=__codelineno-16-20 href=#__codelineno-16-20></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-16-21 name=__codelineno-16-21 href=#__codelineno-16-21></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-16-22 name=__codelineno-16-22 href=#__codelineno-16-22></a><span class=p>}</span>
</code></pre></div> <p>Simples! Our main code now has no code in the main <code>while(1) {}</code> loop because everything is being done in the interrupt handler. In <em>part-4/armc-013/armc-013.c</em>:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=kt>void</span><span class=w> </span><span class=nf>kernel_main</span><span class=p>(</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>r0</span><span class=p>,</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>r1</span><span class=p>,</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>atags</span><span class=w> </span><span class=p>)</span>
<a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a><span class=p>{</span>
<a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a><span class=w>    </span><span class=cm>/* Write 1 to the LED init nibble in the Function Select GPIO</span>
<a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a><span class=cm>       peripheral register to enable LED pin as an output */</span>
<a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a><span class=w>    </span><span class=n>RPI_SetGpioPinFunction</span><span class=p>(</span><span class=w> </span><span class=n>LED_GPIO</span><span class=p>,</span><span class=w> </span><span class=n>FS_OUTPUT</span><span class=w> </span><span class=p>);</span>
<a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a><span class=w>    </span><span class=n>RPI_SetGpioHi</span><span class=p>(</span><span class=w> </span><span class=n>LED_GPIO</span><span class=w> </span><span class=p>);</span>
<a id=__codelineno-17-7 name=__codelineno-17-7 href=#__codelineno-17-7></a>
<a id=__codelineno-17-8 name=__codelineno-17-8 href=#__codelineno-17-8></a><span class=cp>#ifdef RPI4</span>
<a id=__codelineno-17-9 name=__codelineno-17-9 href=#__codelineno-17-9></a><span class=w>    </span><span class=n>gic400_init</span><span class=p>(</span><span class=mh>0xFF840000UL</span><span class=p>);</span>
<a id=__codelineno-17-10 name=__codelineno-17-10 href=#__codelineno-17-10></a><span class=cp>#endif</span>
<a id=__codelineno-17-11 name=__codelineno-17-11 href=#__codelineno-17-11></a>
<a id=__codelineno-17-12 name=__codelineno-17-12 href=#__codelineno-17-12></a><span class=w>    </span><span class=n>RPI_EnableARMTimerInterrupt</span><span class=p>();</span>
<a id=__codelineno-17-13 name=__codelineno-17-13 href=#__codelineno-17-13></a>
<a id=__codelineno-17-14 name=__codelineno-17-14 href=#__codelineno-17-14></a><span class=w>    </span><span class=cm>/* Setup the system timer interrupt</span>
<a id=__codelineno-17-15 name=__codelineno-17-15 href=#__codelineno-17-15></a><span class=cm>       Timer frequency = Clk/256 * 0x400</span>
<a id=__codelineno-17-16 name=__codelineno-17-16 href=#__codelineno-17-16></a>
<a id=__codelineno-17-17 name=__codelineno-17-17 href=#__codelineno-17-17></a><span class=cm>       NOTE: If the system decides to alter the clock, the frequency of these</span>
<a id=__codelineno-17-18 name=__codelineno-17-18 href=#__codelineno-17-18></a><span class=cm>             interrupts will also change. The system timer remains consistent.</span>
<a id=__codelineno-17-19 name=__codelineno-17-19 href=#__codelineno-17-19></a><span class=cm>    */</span>
<a id=__codelineno-17-20 name=__codelineno-17-20 href=#__codelineno-17-20></a><span class=cp>#if defined ( RPI4 )</span>
<a id=__codelineno-17-21 name=__codelineno-17-21 href=#__codelineno-17-21></a><span class=w>    </span><span class=n>RPI_GetArmTimer</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>Load</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x4000</span><span class=p>;</span>
<a id=__codelineno-17-22 name=__codelineno-17-22 href=#__codelineno-17-22></a><span class=cp>#else</span>
<a id=__codelineno-17-23 name=__codelineno-17-23 href=#__codelineno-17-23></a><span class=w>    </span><span class=n>RPI_GetArmTimer</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>Load</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x400</span><span class=p>;</span>
<a id=__codelineno-17-24 name=__codelineno-17-24 href=#__codelineno-17-24></a><span class=cp>#endif</span>
<a id=__codelineno-17-25 name=__codelineno-17-25 href=#__codelineno-17-25></a>
<a id=__codelineno-17-26 name=__codelineno-17-26 href=#__codelineno-17-26></a><span class=w>    </span><span class=cm>/* Setup the ARM Timer */</span>
<a id=__codelineno-17-27 name=__codelineno-17-27 href=#__codelineno-17-27></a><span class=w>    </span><span class=n>RPI_GetArmTimer</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>Control</span><span class=w> </span><span class=o>=</span>
<a id=__codelineno-17-28 name=__codelineno-17-28 href=#__codelineno-17-28></a><span class=w>            </span><span class=n>RPI_ARMTIMER_CTRL_23BIT</span><span class=w> </span><span class=o>|</span>
<a id=__codelineno-17-29 name=__codelineno-17-29 href=#__codelineno-17-29></a><span class=w>            </span><span class=n>RPI_ARMTIMER_CTRL_ENABLE</span><span class=w> </span><span class=o>|</span>
<a id=__codelineno-17-30 name=__codelineno-17-30 href=#__codelineno-17-30></a><span class=w>            </span><span class=n>RPI_ARMTIMER_CTRL_INT_ENABLE</span><span class=w> </span><span class=o>|</span>
<a id=__codelineno-17-31 name=__codelineno-17-31 href=#__codelineno-17-31></a><span class=w>            </span><span class=n>RPI_ARMTIMER_CTRL_PRESCALE_256</span><span class=p>;</span>
<a id=__codelineno-17-32 name=__codelineno-17-32 href=#__codelineno-17-32></a>
<a id=__codelineno-17-33 name=__codelineno-17-33 href=#__codelineno-17-33></a><span class=w>    </span><span class=cm>/* Enable interrupts! */</span>
<a id=__codelineno-17-34 name=__codelineno-17-34 href=#__codelineno-17-34></a><span class=w>    </span><span class=n>_enable_interrupts</span><span class=p>();</span>
<a id=__codelineno-17-35 name=__codelineno-17-35 href=#__codelineno-17-35></a>
<a id=__codelineno-17-36 name=__codelineno-17-36 href=#__codelineno-17-36></a><span class=w>    </span><span class=cm>/* Never exit as there is no OS to exit to! */</span>
<a id=__codelineno-17-37 name=__codelineno-17-37 href=#__codelineno-17-37></a>
<a id=__codelineno-17-38 name=__codelineno-17-38 href=#__codelineno-17-38></a><span class=w>    </span><span class=k>while</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<a id=__codelineno-17-39 name=__codelineno-17-39 href=#__codelineno-17-39></a><span class=w>    </span><span class=p>{</span>
<a id=__codelineno-17-40 name=__codelineno-17-40 href=#__codelineno-17-40></a>
<a id=__codelineno-17-41 name=__codelineno-17-41 href=#__codelineno-17-41></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-17-42 name=__codelineno-17-42 href=#__codelineno-17-42></a><span class=p>}</span>
</code></pre></div> <p>We now have interrupts up and working and in the exceptions you can do different things with the LED to use them to debug any nasty situations. We'll get onto JTAG debug in a future tutorial, but the next tutorial has to be the mailbox and GPU to get something more interesting happening, and what's more interesting than graphics!?</p> <h2 id=rpi-4-interrupts>RPI 4 Interrupts<a class=headerlink href=#rpi-4-interrupts title="Permanent link">&para;</a></h2> <p>The Raspberry pi 4 was another shift in architecture. It features a common General Interrupt Controller (GIC) which is a v2 GIC-400 peripheral. This was added to considerably improve the performance of virtualisation. Running Containers on a RPI4 is much more efficient compared to earlier models. Thankfully, the RPI foundation have said this will be the last revision of the same RPI format. It's a nightmare trying to support all of these model differences in a basic tutorial!</p> <p>The same interrupt controller as the rest of the Broadcom BCM SoCs is still in place and is configured in the same way, except the interrupt line from that controller is fed into the GIC.</p> <p>At reset this means the interrupt signal will not be routed to the CPU running code in order to be able to respond to the interrupt. We will have to add RPI4-specific code which allows us to configure the GIC peripheral to pass the interrupt signal on to one of the CPU cores. As we're not doing any multi-core work at the moment we can configure the GIC to route all interrupt signals to <code>CPU0</code> which has our interrupt service routines.</p> <p>To find where the peripheral is located in memory - we turn to the linux source code:</p> <p>Knowing that the RPI4 uses the BCM2711 (linked in the kernel source code as <a href=https://github.com/raspberrypi/linux/blob/rpi-4.19.y/arch/arm/boot/dts/bcm2838.dtsi>BCM2838</a> ) processor, in keeping with the RPI series helps:</p> <p>An excerpt from the device tree for the BCM2838 shows the GIC, along with the other interrupt controller:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a>soc {
<a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a>  ranges = &lt;0x7e000000  0x0 0xfe000000  0x01800000&gt;,
<a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a>           &lt;0x7c000000  0x0 0xfc000000  0x02000000&gt;,
<a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a>           &lt;0x40000000  0x0 0xff800000  0x00800000&gt;;
<a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a>  /* Emulate a contiguous 30-bit address range for DMA */
<a id=__codelineno-18-6 name=__codelineno-18-6 href=#__codelineno-18-6></a>  dma-ranges = &lt;0xc0000000  0x0 0x00000000  0x3c000000&gt;;
<a id=__codelineno-18-7 name=__codelineno-18-7 href=#__codelineno-18-7></a>
<a id=__codelineno-18-8 name=__codelineno-18-8 href=#__codelineno-18-8></a>  /delete-node/ interrupt-controller@7e00f300;
<a id=__codelineno-18-9 name=__codelineno-18-9 href=#__codelineno-18-9></a>  /delete-node/ v3d@7ec00000;
<a id=__codelineno-18-10 name=__codelineno-18-10 href=#__codelineno-18-10></a>
<a id=__codelineno-18-11 name=__codelineno-18-11 href=#__codelineno-18-11></a>  local_intc: local_intc@40000000 {
<a id=__codelineno-18-12 name=__codelineno-18-12 href=#__codelineno-18-12></a>      compatible = &quot;brcm,bcm2836-l1-intc&quot;;
<a id=__codelineno-18-13 name=__codelineno-18-13 href=#__codelineno-18-13></a>      reg = &lt;0x40000000 0x100&gt;;
<a id=__codelineno-18-14 name=__codelineno-18-14 href=#__codelineno-18-14></a>  };
<a id=__codelineno-18-15 name=__codelineno-18-15 href=#__codelineno-18-15></a>
<a id=__codelineno-18-16 name=__codelineno-18-16 href=#__codelineno-18-16></a>  gicv2: gic400@40041000 {
<a id=__codelineno-18-17 name=__codelineno-18-17 href=#__codelineno-18-17></a>      interrupt-controller;
<a id=__codelineno-18-18 name=__codelineno-18-18 href=#__codelineno-18-18></a>      #interrupt-cells = &lt;3&gt;;
<a id=__codelineno-18-19 name=__codelineno-18-19 href=#__codelineno-18-19></a>      compatible = &quot;arm,gic-400&quot;;
<a id=__codelineno-18-20 name=__codelineno-18-20 href=#__codelineno-18-20></a>      reg =    &lt;0x40041000 0x1000&gt;,
<a id=__codelineno-18-21 name=__codelineno-18-21 href=#__codelineno-18-21></a>            &lt;0x40042000 0x2000&gt;,
<a id=__codelineno-18-22 name=__codelineno-18-22 href=#__codelineno-18-22></a>            &lt;0x40044000 0x2000&gt;,
<a id=__codelineno-18-23 name=__codelineno-18-23 href=#__codelineno-18-23></a>            &lt;0x40046000 0x2000&gt;;
<a id=__codelineno-18-24 name=__codelineno-18-24 href=#__codelineno-18-24></a>      interrupts = &lt;GIC_PPI 9 (GIC_CPU_MASK_SIMPLE(4) |
<a id=__codelineno-18-25 name=__codelineno-18-25 href=#__codelineno-18-25></a>                               IRQ_TYPE_LEVEL_HIGH)&gt;;
<a id=__codelineno-18-26 name=__codelineno-18-26 href=#__codelineno-18-26></a>  };
</code></pre></div> <p>The physical address is <code>0x40041000</code> - but we can see from the device tree configuration just above that the physical address <code>0x40000000</code> is mapped to <code>0xFF800000</code> so the GIC400 is available to us at <code>0xFF841000</code> - it has four sets of registers define by the <code>reg</code> tag.</p> <p>In order for <code>CPU0</code> to receive any interrupt signals, we're going to have to go ahead and configure this peripheral.</p> <p>In keeping with this tutorial series, let's not get bogged down with trying to over-complicate a driver. All we want to do is configure this peripheral from it's reset state to send all interrupts to <code>CPU0</code>.</p> <h3 id=documentation>Documentation<a class=headerlink href=#documentation title="Permanent link">&para;</a></h3> <p>There is <a href=https://static.docs.arm.com/ddi0471/a/DDI0471A_gic400_r0p0_trm.pdf>GIC-400 documentation</a> available from ARM.</p> <p>There is also the <a href=https://developer.arm.com/docs/ihi0048/b/arm-generic-interrupt-controller-architecture-version-20-architecture-specification>ARM GIC Architecture documentation</a> to consider too.</p> <p>There's a lot of information around secure and non-secure access to the GIC. For now, we don't need to delve too deep. Our task is simple - get interrupts routed to <code>CPU0</code>.</p> <h3 id=register-map>Register Map<a class=headerlink href=#register-map title="Permanent link">&para;</a></h3> <p>The GIC-400 register map is available under the <code>Programmer's Model</code> section of the <a href=https://static.docs.arm.com/ddi0471/a/DDI0471A_gic400_r0p0_trm.pdf>CoreLink-400 Generic Interrupt Controller documentation</a>.</p> <p>The Register Map is divided up into function blocks. The functional blocks are defined in section 3.2 as:</p> <ul> <li><strong>GICD_</strong> Distributor</li> <li><strong>GICC_</strong> CPU Interfaces</li> <li><strong>GICH_</strong> Virtual Interface control blocks</li> <li><strong>GICV_</strong> Virtual CPU Interfaces</li> </ul> <p>We're not interested in the Virtual blocks, but we are of course interested in the other blocks.</p> <p>The functional block offsets are shown in the table and align with the device tree reg tags above.</p> <table> <thead> <tr> <th>Offset</th> <th>Block</th> </tr> </thead> <tbody> <tr> <td><code>0x0000 - 0x0FFF</code></td> <td>Reserved</td> </tr> <tr> <td><code>0x1000 - 0x1FFF</code></td> <td>Distributor (<strong>GICD_</strong>)</td> </tr> <tr> <td><code>0x2000 - 0x2FFF</code></td> <td>CPU Interfaces (<strong>GICC_</strong>)</td> </tr> <tr> <td><code>0x4000 - 0x4FFF</code></td> <td>Virtual interface control for the process that is performing the access</td> </tr> <tr> <td><code>0x5000 - 0x5FFF</code></td> <td>Virtual interface control for the processor selected by address bits 11:9</td> </tr> </tbody> </table> <p>Later on in the same section is breakdown of all registers in those blocks. It's this information that can be put into code. Then, in order to do a simple enablement of the peripheral, we will configure all available interrupts to be enabled and routed to <code>CPU0</code>.</p> <p>We have a function that initialises this peripheral in the new <code>gic-400.c</code> file. This file is not rpi-specific because gic-400 interrupt controllers are used by a lot of different SoCs.</p> <p>This function is conditionally called immediately before configuring the ARM Timer peripheral and the global enabling of interrupts.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=p>...</span>
<a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a><span class=cp>#ifdef RPI4</span>
<a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a><span class=w>    </span><span class=n>gic400_init</span><span class=p>(</span><span class=mh>0xFF840000UL</span><span class=p>);</span>
<a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a><span class=cp>#endif</span>
<a id=__codelineno-19-5 name=__codelineno-19-5 href=#__codelineno-19-5></a>
<a id=__codelineno-19-6 name=__codelineno-19-6 href=#__codelineno-19-6></a><span class=w>    </span><span class=n>RPI_EnableARMTimerInterrupt</span><span class=p>();</span>
<a id=__codelineno-19-7 name=__codelineno-19-7 href=#__codelineno-19-7></a><span class=p>...</span>
</code></pre></div> <p>We should obviously make this code better, but for now we just know that we need to initialise this controller to get any interrupts working.</p> <p>When you're ready head over to <a href=https://www.valvers.com/embedded-linux/raspberry-pi/step05-bare-metal-programming-in-c-pt5>Part 5</a></p> </article> </div> </div> <a href=# class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </a> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2002-2020 Brian Sidebotham </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/squidfunk target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a> <a href=https://gitter.im/squidfunk/mkdocs-material target=_blank rel=noopener title=gitter.im class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 384 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M66.4 322.5H16V0h50.4v322.5zM166.9 76.1h-50.4V512h50.4V76.1zm100.6 0h-50.4V512h50.4V76.1zM368 76h-50.4v247H368V76z"/></svg> </a> <a href=https://hub.docker.com/r/squidfunk/mkdocs-material/ target=_blank rel=noopener title=hub.docker.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 640 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M349.9 236.3h-66.1v-59.4h66.1v59.4zm0-204.3h-66.1v60.7h66.1V32zm78.2 144.8H362v59.4h66.1v-59.4zm-156.3-72.1h-66.1v60.1h66.1v-60.1zm78.1 0h-66.1v60.1h66.1v-60.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1l-13.3-8.9zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm-78.1-72.1h-66.1v60.1h66.1v-60.1z"/></svg> </a> <a href=https://pypi.org/project/mkdocs-material/ target=_blank rel=noopener title=pypi.org class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6zM286.2 404c11.1 0 20.1 9.1 20.1 20.3 0 11.3-9 20.4-20.1 20.4-11 0-20.1-9.2-20.1-20.4.1-11.3 9.1-20.3 20.1-20.3zM167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4zm-6.7-142.6c-11.1 0-20.1-9.1-20.1-20.3.1-11.3 9-20.4 20.1-20.4 11 0 20.1 9.2 20.1 20.4s-9 20.3-20.1 20.3z"/></svg> </a> <a href=https://twitter.com/squidfunk target=_blank rel=noopener title=twitter.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": ["content.code.annotate", "content.tooltips", "navigation.indexes", "navigation.sections", "navigation.tabs", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../../assets/javascripts/workers/search.db81ec45.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../../assets/javascripts/bundle.4b2c34cd.min.js></script> <script src=../../../valvers-assets/extra.js></script> </body> </html>