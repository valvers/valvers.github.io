<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Various information about engineering and computing things. Just tid-bits from an enthusiast"><meta name=author content="Brian Sidebotham"><link href=https://www.valvers.com/open-software/raspberry-pi/bare-metal-programming-in-c-part-2/ rel=canonical><link href=../bare-metal-programming-in-c-part-1/ rel=prev><link href=../bare-metal-programming-in-c-part-3/ rel=next><link rel=icon href=../../../assets/favicon.png><meta name=generator content="mkdocs-1.4.2, mkdocs-material-9.0.12"><title>BMC Part 2 - The C Runtime - valvers.com</title><link rel=stylesheet href=../../../assets/stylesheets/main.0d440cfe.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.2505c338.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#bmc-part-2-the-c-runtime class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../.. title=valvers.com class="md-header__button md-logo" aria-label=valvers.com data-md-component=logo> <img src=https://www.gravatar.com/avatar/8db3007cd3103d9ff42e90cc95dc7213 alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> valvers.com </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> BMC Part 2 - The C Runtime </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/valvers/valvers.website.src title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../../denford-orac/ class=md-tabs__link> Denford orac </a> </li> <li class=md-tabs__item> <a href=../../../engineering/ class=md-tabs__link> Engineering </a> </li> <li class=md-tabs__item> <a href=../../ class="md-tabs__link md-tabs__link--active"> Open software </a> </li> <li class=md-tabs__item> <a href=../../../random/ class=md-tabs__link> Random </a> </li> <li class=md-tabs__item> <a href=../../../v6manta/ class=md-tabs__link> V6manta </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title=valvers.com class="md-nav__button md-logo" aria-label=valvers.com data-md-component=logo> <img src=https://www.gravatar.com/avatar/8db3007cd3103d9ff42e90cc95dc7213 alt=logo> </a> valvers.com </label> <div class=md-nav__source> <a href=https://github.com/valvers/valvers.website.src title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> Home </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2> <div class="md-nav__link md-nav__link--index "> <a href=../../../denford-orac/ >Denford orac</a> <label for=__nav_2> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Denford orac </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../denford-orac/2009-04-06-my-denford-orac/ class=md-nav__link> 2009 04 06 my denford orac </a> </li> <li class=md-nav__item> <a href=../../../denford-orac/2012-02-17-uprated-spindle-motor/ class=md-nav__link> 2012 02 17 uprated spindle motor </a> </li> <li class=md-nav__item> <a href=../../../denford-orac/2012-03-22-gathering-some-information/ class=md-nav__link> 2012 03 22 gathering some information </a> </li> <li class=md-nav__item> <a href=../../../denford-orac/2012-09-27-750w-motor-sourced/ class=md-nav__link> 2012 09 27 750w motor sourced </a> </li> <li class=md-nav__item> <a href=../../../denford-orac/2012-10-01-motor-doesnt-fit/ class=md-nav__link> 2012 10 01 motor doesnt fit </a> </li> <li class=md-nav__item> <a href=../../../denford-orac/2012-10-10-drill-head-disassembly/ class=md-nav__link> 2012 10 10 drill head disassembly </a> </li> <li class=md-nav__item> <a href=../../../denford-orac/2012-10-13-more-quill-dismantling/ class=md-nav__link> 2012 10 13 more quill dismantling </a> </li> <li class=md-nav__item> <a href=../../../denford-orac/2012-10-17-drill-spindle-is-apart/ class=md-nav__link> 2012 10 17 drill spindle is apart </a> </li> <li class=md-nav__item> <a href=../../../denford-orac/2012-10-29-removing-electrical-cabinet/ class=md-nav__link> 2012 10 29 removing electrical cabinet </a> </li> <li class=md-nav__item> <a href=../../../denford-orac/2012-10-31-tested-the-drill-head-above-the-lathe/ class=md-nav__link> 2012 10 31 tested the drill head above the lathe </a> </li> <li class=md-nav__item> <a href=../../../denford-orac/2012-11-02-rebuild-of-an-orac/ class=md-nav__link> 2012 11 02 rebuild of an orac </a> </li> <li class=md-nav__item> <a href=../../../denford-orac/2013-03-13-new-motor-fitted/ class=md-nav__link> 2013 03 13 new motor fitted </a> </li> <li class=md-nav__item> <a href=../../../denford-orac/2020-06-28-denford-orac-machinekit-controller/ class=md-nav__link> Denford Orac Machinekit Controller </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <div class="md-nav__link md-nav__link--index "> <a href=../../../engineering/ >Engineering</a> <label for=__nav_3> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Engineering </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../engineering/an-and-jic-fittings/ class=md-nav__link> AN and JIC Fittings </a> </li> <li class=md-nav__item> <a href=../../../engineering/bolt-dimensions/ class=md-nav__link> Bolt Dimensions </a> </li> <li class=md-nav__item> <a href=../../../engineering/linuxcnc/ class=md-nav__link> LinuxCNC </a> </li> <li class=md-nav__item> <a href=../../../engineering/making-a-cyr-wheel/ class=md-nav__link> Making a Cyr Wheel </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4 checked> <div class="md-nav__link md-nav__link--index "> <a href=../../ >Open software</a> <label for=__nav_4> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=true> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Open software </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../android-car-dash/ class=md-nav__link> Android car dash </a> </li> <li class=md-nav__item> <a href=../../logging-with-gcc/ class=md-nav__link> Logging with gcc </a> </li> <li class=md-nav__item> <a href=../../posix-shell-scripting/ class=md-nav__link> Posix Shell Scripting </a> </li> <li class=md-nav__item> <a href=../../rpi-cm4-linuxcnc/ class=md-nav__link> RPI CM4 Linux CNC </a> </li> <li class=md-nav__item> <a href=../../working-with-the-screen-command/ class=md-nav__link> Working with the Screen Command </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_7> <label class=md-nav__link for=__nav_4_7 id=__nav_4_7_label tabindex=0> Arduino <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_7_label aria-expanded=false> <label class=md-nav__title for=__nav_4_7> <span class="md-nav__icon md-icon"></span> Arduino </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../arduino/esp32-mqtt-tutorial/ class=md-nav__link> ESP32 MQTT Tutorial </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_8> <label class=md-nav__link for=__nav_4_8 id=__nav_4_8_label tabindex=0> Aws <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_8_label aria-expanded=false> <label class=md-nav__title for=__nav_4_8> <span class="md-nav__icon md-icon"></span> Aws </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../aws/aws-lambda-getting-started/ class=md-nav__link> AWS Lambda Getting Started </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_9> <label class=md-nav__link for=__nav_4_9 id=__nav_4_9_label tabindex=0> Gcc <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_9_label aria-expanded=false> <label class=md-nav__title for=__nav_4_9> <span class="md-nav__icon md-icon"></span> Gcc </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../gcc/weak-function-attributes/ class=md-nav__link> Weak Function Attributes </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_10> <label class=md-nav__link for=__nav_4_10 id=__nav_4_10_label tabindex=0> Python <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_10_label aria-expanded=false> <label class=md-nav__title for=__nav_4_10> <span class="md-nav__icon md-icon"></span> Python </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../python/pylab/ class=md-nav__link> Pylab </a> </li> <li class=md-nav__item> <a href=../../python/the-lethality-of-default-arguments-in-python/ class=md-nav__link> The Lethality of Default Arguments in Python </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_11 checked> <label class=md-nav__link for=__nav_4_11 id=__nav_4_11_label tabindex=0> Raspberry pi <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_11_label aria-expanded=true> <label class=md-nav__title for=__nav_4_11> <span class="md-nav__icon md-icon"></span> Raspberry pi </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../bare-metal-programming-in-c-card/ class=md-nav__link> BMC Card Scripts </a> </li> <li class=md-nav__item> <a href=../bare-metal-programming-in-c-compiler/ class=md-nav__link> BMC Compiler </a> </li> <li class=md-nav__item> <a href=../bare-metal-programming-in-c-firmware/ class=md-nav__link> BMC Firmware </a> </li> <li class=md-nav__item> <a href=../bare-metal-programming-in-c-part-1/ class=md-nav__link> BMC Part 1 - Getting Started </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> BMC Part 2 - The C Runtime <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> BMC Part 2 - The C Runtime </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#understanding-the-c-runtime-startup class=md-nav__link> Understanding the C-Runtime Startup </a> <nav class=md-nav aria-label="Understanding the C-Runtime Startup"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#part-2armc-04 class=md-nav__link> part-2/armc-04 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#part-2armc05c class=md-nav__link> part-2/armc05.c </a> </li> <li class=md-nav__item> <a href=#part-2armc-06c class=md-nav__link> part-2/armc-06.c </a> </li> <li class=md-nav__item> <a href=#part-2armc-07 class=md-nav__link> part-2/armc-07 </a> </li> <li class=md-nav__item> <a href=#sections-and-c-startup class=md-nav__link> Sections and C Startup </a> </li> <li class=md-nav__item> <a href=#armc-08-starts class=md-nav__link> armc-08-start.S </a> </li> <li class=md-nav__item> <a href=#armc-08-cstartupc class=md-nav__link> armc-08-cstartup.c </a> </li> <li class=md-nav__item> <a href=#armc-08c class=md-nav__link> armc-08.c </a> </li> <li class=md-nav__item> <a href=#the-c-library-stubs class=md-nav__link> The C-Library stubs </a> </li> <li class=md-nav__item> <a href=#armc-09-cstubsc class=md-nav__link> armc-09-cstubs.c </a> </li> <li class=md-nav__item> <a href=#armc-09-starts class=md-nav__link> armc-09-start.S </a> </li> <li class=md-nav__item> <a href=#armc-09-cstartupc class=md-nav__link> armc-09-cstartup.c </a> </li> <li class=md-nav__item> <a href=#part-2armc-09c class=md-nav__link> part-2/armc-09.c </a> </li> <li class=md-nav__item> <a href=#part-3 class=md-nav__link> Part 3 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../bare-metal-programming-in-c-part-3/ class=md-nav__link> BMC Part 3 - CMake Build System </a> </li> <li class=md-nav__item> <a href=../bare-metal-programming-in-c-part-4/ class=md-nav__link> BMC Part 4 - Interrupts </a> </li> <li class=md-nav__item> <a href=../bare-metal-programming-in-c-part-5/ class=md-nav__link> Part 5 - Graphics (Basic) </a> </li> <li class=md-nav__item> <a href=../bare-metal-programming-in-c/ class=md-nav__link> Raspberry-Pi Bare Metal Tutorial </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_12> <label class=md-nav__link for=__nav_4_12 id=__nav_4_12_label tabindex=0> Saltstack <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_12_label aria-expanded=false> <label class=md-nav__title for=__nav_4_12> <span class="md-nav__icon md-icon"></span> Saltstack </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../saltstack/building-a-centos8-salt-master/ class=md-nav__link> Building a CentOS8 Salt Master </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_13> <label class=md-nav__link for=__nav_4_13 id=__nav_4_13_label tabindex=0> Webstacks <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_13_label aria-expanded=false> <label class=md-nav__title for=__nav_4_13> <span class="md-nav__icon md-icon"></span> Webstacks </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../webstacks/using-reactjs-and-bulma/ class=md-nav__link> Using ReactJS and Bulma </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5> <div class="md-nav__link md-nav__link--index "> <a href=../../../random/ >Random</a> <label for=__nav_5> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Random </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../random/mortgage/ class=md-nav__link> Mortgage </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6> <div class="md-nav__link md-nav__link--index "> <a href=../../../v6manta/ >V6manta</a> <label for=__nav_6> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> V6manta </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_2> <label class=md-nav__link for=__nav_6_2 id=__nav_6_2_label tabindex=0> 2003 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_2_label aria-expanded=false> <label class=md-nav__title for=__nav_6_2> <span class="md-nav__icon md-icon"></span> 2003 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../v6manta/2003/2003-07-28-/ class=md-nav__link> 2003 07 28 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2003/2003-07-28-brought-a-1.8s-berlinetta/ class=md-nav__link> 2003 07 28 brought a 1.8s berlinetta </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2003/2003-07-28-stage-rally-opel-manta/ class=md-nav__link> 2003 07 28 stage rally opel manta </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2003/2003-08-12-/ class=md-nav__link> 2003 08 12 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2003/2003-08-13-/ class=md-nav__link> 2003 08 13 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2003/2003-08-23-/ class=md-nav__link> 2003 08 23 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2003/2003-09-11-/ class=md-nav__link> 2003 09 11 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2003/2003-09-28-/ class=md-nav__link> 2003 09 28 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2003/2003-10-07-/ class=md-nav__link> 2003 10 07 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2003/2003-10-09-/ class=md-nav__link> 2003 10 09 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2003/2003-11-04-/ class=md-nav__link> 2003 11 04 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2003/2003-12-16-/ class=md-nav__link> 2003 12 16 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_3> <label class=md-nav__link for=__nav_6_3 id=__nav_6_3_label tabindex=0> 2004 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_3_label aria-expanded=false> <label class=md-nav__title for=__nav_6_3> <span class="md-nav__icon md-icon"></span> 2004 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-01-06-/ class=md-nav__link> 2004 01 06 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-01-07-/ class=md-nav__link> 2004 01 07 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-01-26-/ class=md-nav__link> 2004 01 26 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-01-29-/ class=md-nav__link> 2004 01 29 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-02-09-/ class=md-nav__link> 2004 02 09 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-02-13-/ class=md-nav__link> 2004 02 13 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-02-19-/ class=md-nav__link> 2004 02 19 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-04-20-finally-got-around-to-the-manta/ class=md-nav__link> 2004 04 20 finally got around to the manta </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-06-17-/ class=md-nav__link> 2004 06 17 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-06-18-/ class=md-nav__link> 2004 06 18 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-06-21-/ class=md-nav__link> 2004 06 21 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-07-26-/ class=md-nav__link> 2004 07 26 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-08-09-/ class=md-nav__link> 2004 08 09 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-08-10-/ class=md-nav__link> 2004 08 10 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-09-03-/ class=md-nav__link> 2004 09 03 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-09-27-/ class=md-nav__link> 2004 09 27 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-10-07-/ class=md-nav__link> 2004 10 07 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-10-08-/ class=md-nav__link> 2004 10 08 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-10-11-/ class=md-nav__link> 2004 10 11 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-10-13-/ class=md-nav__link> 2004 10 13 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-10-15-/ class=md-nav__link> 2004 10 15 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-10-18-/ class=md-nav__link> 2004 10 18 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-10-21-/ class=md-nav__link> 2004 10 21 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-10-22-/ class=md-nav__link> 2004 10 22 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-10-29-/ class=md-nav__link> 2004 10 29 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-11-01-/ class=md-nav__link> 2004 11 01 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-12-10-were-back/ class=md-nav__link> 2004 12 10 were back </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_4> <label class=md-nav__link for=__nav_6_4 id=__nav_6_4_label tabindex=0> 2005 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_4_label aria-expanded=false> <label class=md-nav__title for=__nav_6_4> <span class="md-nav__icon md-icon"></span> 2005 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../v6manta/2005/2005-05-16-/ class=md-nav__link> 2005 05 16 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2005/2005-08-04-done-something/ class=md-nav__link> 2005 08 04 done something </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2005/2005-08-08-/ class=md-nav__link> 2005 08 08 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2005/2005-08-10-/ class=md-nav__link> 2005 08 10 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2005/2005-08-25-/ class=md-nav__link> 2005 08 25 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2005/2005-08-31-/ class=md-nav__link> 2005 08 31 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2005/2005-09-05-/ class=md-nav__link> 2005 09 05 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2005/2005-09-19-/ class=md-nav__link> 2005 09 19 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2005/2005-09-22-/ class=md-nav__link> 2005 09 22 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2005/2005-09-23-/ class=md-nav__link> 2005 09 23 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2005/2005-11-01-/ class=md-nav__link> 2005 11 01 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2005/2005-11-03-/ class=md-nav__link> 2005 11 03 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_5> <label class=md-nav__link for=__nav_6_5 id=__nav_6_5_label tabindex=0> 2007 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_5_label aria-expanded=false> <label class=md-nav__title for=__nav_6_5> <span class="md-nav__icon md-icon"></span> 2007 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../v6manta/2007/2007-10-20-/ class=md-nav__link> 2007 10 20 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2007/2007-10-20-perspex-windows/ class=md-nav__link> 2007 10 20 perspex windows </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2007/2007-11-13-getting-it-ready-to-paint.../ class=md-nav__link> 2007 11 13 getting it ready to paint... </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2007/2007-11-21-almost-started-painting/ class=md-nav__link> 2007 11 21 almost started painting </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2007/2007-11-28-underneath-is-complete/ class=md-nav__link> 2007 11 28 underneath is complete </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2007/2007-12-04-painting-the-inside-and-engine-bay/ class=md-nav__link> 2007 12 04 painting the inside and engine bay </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_6> <label class=md-nav__link for=__nav_6_6 id=__nav_6_6_label tabindex=0> 2008 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6_6> <span class="md-nav__icon md-icon"></span> 2008 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-01-14-painting-the-shell-orange/ class=md-nav__link> 2008 01 14 painting the shell orange </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-01-16-out-of-the-booth/ class=md-nav__link> 2008 01 16 out of the booth </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-01-23-rear-axle-trial-fitting/ class=md-nav__link> 2008 01 23 rear axle trial fitting </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-02-24-painted-the-nextel-and-checked-for-wheel-clearance/ class=md-nav__link> 2008 02 24 painted the nextel and checked for wheel clearance </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-03-15-front-suspension-build/ class=md-nav__link> 2008 03 15 front suspension build </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-03-19-suspension-bushes-are-always-wrong/ class=md-nav__link> 2008 03 19 suspension bushes are always wrong </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-03-22-diff-bearings-need-replacing/ class=md-nav__link> 2008 03 22 diff bearings need replacing </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-04-08-fitted-the-rear-windows-and-steering-column/ class=md-nav__link> 2008 04 08 fitted the rear windows and steering column </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-04-12-shimmed-up-the-diff%2C-and-fitted-the-clocks/ class=md-nav__link> 2008 04 12 shimmed up the diff, and fitted the clocks </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-04-16-rebuilt-the-gearbox-so-i-get-gear-selection/ class=md-nav__link> 2008 04 16 rebuilt the gearbox so i get gear selection </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-07-08-its-on-its-wheels-at-last/ class=md-nav__link> 2008 07 08 its on its wheels at last </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-09-02-rebuilt-oil-pump--started-headwork/ class=md-nav__link> 2008 09 02 rebuilt oil pump started headwork </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-09-04-some-more-headwork/ class=md-nav__link> 2008 09 04 some more headwork </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-09-25-even-more-headwork/ class=md-nav__link> 2008 09 25 even more headwork </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-11-09-engine--transmission-fitted/ class=md-nav__link> 2008 11 09 engine transmission fitted </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-11-16-engine--gearbox-mounted--steering-column-fitted/ class=md-nav__link> 2008 11 16 engine gearbox mounted steering column fitted </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-12-14-stripping-the-x25xe-v6-bottom-end/ class=md-nav__link> 2008 12 14 stripping the x25xe v6 bottom end </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_7> <label class=md-nav__link for=__nav_6_7 id=__nav_6_7_label tabindex=0> 2009 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_7_label aria-expanded=false> <label class=md-nav__title for=__nav_6_7> <span class="md-nav__icon md-icon"></span> 2009 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../v6manta/2009/2009-06-24-making-the-dry-sump-pan/ class=md-nav__link> 2009 06 24 making the dry sump pan </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2009/2009-10-05-trialling-the-throttle-bodies--a-few-more-bits-painted/ class=md-nav__link> 2009 10 05 trialling the throttle bodies a few more bits painted </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2009/2009-12-18-flywheel-and-clutch/ class=md-nav__link> 2009 12 18 flywheel and clutch </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_8> <label class=md-nav__link for=__nav_6_8 id=__nav_6_8_label tabindex=0> 2010 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_8_label aria-expanded=false> <label class=md-nav__title for=__nav_6_8> <span class="md-nav__icon md-icon"></span> 2010 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-01-23-done-the-handbrake--sliders/ class=md-nav__link> 2010 01 23 done the handbrake sliders </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-01-27-started-building-the-v6-heads-up/ class=md-nav__link> 2010 01 27 started building the v6 heads up </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-01-30-picked-up-another-v6/ class=md-nav__link> 2010 01 30 picked up another v6 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-02-01-exhaust-manifolds/ class=md-nav__link> 2010 02 01 exhaust manifolds </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-02-02-starting-the-v6-build/ class=md-nav__link> 2010 02 02 starting the v6 build </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-02-03-cylinder-head-bolts-torque/ class=md-nav__link> 2010 02 03 cylinder head bolts torque </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-02-03-ordered-the-exhaust-manifold-flanges/ class=md-nav__link> 2010 02 03 ordered the exhaust manifold flanges </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-02-06-building-the-v6/ class=md-nav__link> 2010 02 06 building the v6 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-02-07-building-the-v6/ class=md-nav__link> 2010 02 07 building the v6 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-02-14-building-the-v6/ class=md-nav__link> 2010 02 14 building the v6 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-03-22-gearbox-sealed-and-release-bearing-fitted/ class=md-nav__link> 2010 03 22 gearbox sealed and release bearing fitted </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-04-03-started-on-the-manifolds/ class=md-nav__link> 2010 04 03 started on the manifolds </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-04-05-finished-a-manifold/ class=md-nav__link> 2010 04 05 finished a manifold </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-04-07-started-the-second-manifold/ class=md-nav__link> 2010 04 07 started the second manifold </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-04-11-need-a-todo-list/ class=md-nav__link> 2010 04 11 need a todo list </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-04-21-ticking-off-the-boxes/ class=md-nav__link> 2010 04 21 ticking off the boxes </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-04-26-nearly-finished-the-second-manifold/ class=md-nav__link> 2010 04 26 nearly finished the second manifold </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-05-09-got-the-car-rolling/ class=md-nav__link> 2010 05 09 got the car rolling </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-05-11-rolling-road-day/ class=md-nav__link> 2010 05 11 rolling road day </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-05-31-back-from-germany/ class=md-nav__link> 2010 05 31 back from germany </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-06-01-sumps-off/ class=md-nav__link> 2010 06 01 sumps off </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-06-06-done-most-of-the-bits-on-the-v6/ class=md-nav__link> 2010 06 06 done most of the bits on the v6 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-06-12-getting-ready-to-bolt-it-back-in/ class=md-nav__link> 2010 06 12 getting ready to bolt it back in </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-06-19-almost-ready-to-go-back-in/ class=md-nav__link> 2010 06 19 almost ready to go back in </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-09-22-lack-of-updates/ class=md-nav__link> 2010 09 22 lack of updates </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-09-26-few-little-bits/ class=md-nav__link> 2010 09 26 few little bits </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-10-09-v6-oil-problems..../ class=md-nav__link> 2010 10 09 v6 oil problems.... </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-10-12-starting-putting-the-engine-back-together/ class=md-nav__link> 2010 10 12 starting putting the engine back together </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-10-23-v6-is-broke/ class=md-nav__link> 2010 10 23 v6 is broke </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-10-24-stripping-the-v6/ class=md-nav__link> 2010 10 24 stripping the v6 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-10-25-v6-problem/ class=md-nav__link> 2010 10 25 v6 problem </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-11-03-picked-up-a-replacement-v6/ class=md-nav__link> 2010 11 03 picked up a replacement v6 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-12-12-been-busy-building/ class=md-nav__link> 2010 12 12 been busy building </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_9> <label class=md-nav__link for=__nav_6_9 id=__nav_6_9_label tabindex=0> 2011 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_9_label aria-expanded=false> <label class=md-nav__title for=__nav_6_9> <span class="md-nav__icon md-icon"></span> 2011 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../v6manta/2011/2011-01-01-finally-driven-the-manta-again-today/ class=md-nav__link> 2011 01 01 finally driven the manta again today </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2011/2011-03-13-fitting-some-new-seats/ class=md-nav__link> 2011 03 13 fitting some new seats </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2011/2011-03-13-the-manta-got-mapped/ class=md-nav__link> 2011 03 13 the manta got mapped </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2011/2011-03-25-went-to-brands-hatch/ class=md-nav__link> 2011 03 25 went to brands hatch </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2011/2011-09-04-started-work-on-the-2011-rebuild/ class=md-nav__link> 2011 09 04 started work on the 2011 rebuild </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2011/2011-09-10-built-some-more-of-the-frame/ class=md-nav__link> 2011 09 10 built some more of the frame </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2011/2011-09-14-started-work-on-the-new-sump-pan/ class=md-nav__link> 2011 09 14 started work on the new sump pan </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2011/2011-09-15-more-subframe-work/ class=md-nav__link> 2011 09 15 more subframe work </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2011/2011-09-17-gearbox-back-together/ class=md-nav__link> 2011 09 17 gearbox back together </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2011/2011-09-25-getting-ready-to-spray-the-engine-bay-again.../ class=md-nav__link> 2011 09 25 getting ready to spray the engine bay again... </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2011/2011-10-16-moving-along-with-the-rebuild/ class=md-nav__link> 2011 10 16 moving along with the rebuild </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2011/2011-10-18-painted-the-engine-bay/ class=md-nav__link> 2011 10 18 painted the engine bay </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2011/2011-11-15-dry-sump-work.../ class=md-nav__link> 2011 11 15 dry sump work... </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_10> <label class=md-nav__link for=__nav_6_10 id=__nav_6_10_label tabindex=0> 2012 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_10_label aria-expanded=false> <label class=md-nav__title for=__nav_6_10> <span class="md-nav__icon md-icon"></span> 2012 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-01-09-dry-sump-pan-is-welded/ class=md-nav__link> 2012 01 09 dry sump pan is welded </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-01-27-more-dry-sump-work/ class=md-nav__link> 2012 01 27 more dry sump work </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-02-21-engine-is-back-in.../ class=md-nav__link> 2012 02 21 engine is back in... </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-02-24-took-the-engine-back-out-again/ class=md-nav__link> 2012 02 24 took the engine back out again </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-02-27-engine-back-in-again/ class=md-nav__link> 2012 02 27 engine back in again </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-03-14-mostly-plumbed-back-in/ class=md-nav__link> 2012 03 14 mostly plumbed back in </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-04-04-started-her-up-again/ class=md-nav__link> 2012 04 04 started her up again </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-04-16-ready-for-a-test-drive/ class=md-nav__link> 2012 04 16 ready for a test drive </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-05-09-clutch-release-bearing-failure/ class=md-nav__link> 2012 05 09 clutch release bearing failure </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-05-17-stripping-the-t5-gearbox/ class=md-nav__link> 2012 05 17 stripping the t5 gearbox </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-10-13-rebuilt-the-gearbox/ class=md-nav__link> 2012 10 13 rebuilt the gearbox </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-11-11-finally-the-engines-back-in/ class=md-nav__link> 2012 11 11 finally the engines back in </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-11-14-nearly-back-together/ class=md-nav__link> 2012 11 14 nearly back together </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-11-25-the-finishing-touches/ class=md-nav__link> 2012 11 25 the finishing touches </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-11-28-finally-the-v6-manta-up-a-running-again/ class=md-nav__link> 2012 11 28 finally the v6 manta up a running again </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-12-30-virtually-back-on-the-road/ class=md-nav__link> 2012 12 30 virtually back on the road </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_11> <label class=md-nav__link for=__nav_6_11 id=__nav_6_11_label tabindex=0> 2013 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_11_label aria-expanded=false> <label class=md-nav__title for=__nav_6_11> <span class="md-nav__icon md-icon"></span> 2013 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../v6manta/2013/2013-01-10-driven-the-manta-again/ class=md-nav__link> 2013 01 10 driven the manta again </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2013/2013-01-15-had-a-great-blast-in-the-manta/ class=md-nav__link> 2013 01 15 had a great blast in the manta </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#understanding-the-c-runtime-startup class=md-nav__link> Understanding the C-Runtime Startup </a> <nav class=md-nav aria-label="Understanding the C-Runtime Startup"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#part-2armc-04 class=md-nav__link> part-2/armc-04 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#part-2armc05c class=md-nav__link> part-2/armc05.c </a> </li> <li class=md-nav__item> <a href=#part-2armc-06c class=md-nav__link> part-2/armc-06.c </a> </li> <li class=md-nav__item> <a href=#part-2armc-07 class=md-nav__link> part-2/armc-07 </a> </li> <li class=md-nav__item> <a href=#sections-and-c-startup class=md-nav__link> Sections and C Startup </a> </li> <li class=md-nav__item> <a href=#armc-08-starts class=md-nav__link> armc-08-start.S </a> </li> <li class=md-nav__item> <a href=#armc-08-cstartupc class=md-nav__link> armc-08-cstartup.c </a> </li> <li class=md-nav__item> <a href=#armc-08c class=md-nav__link> armc-08.c </a> </li> <li class=md-nav__item> <a href=#the-c-library-stubs class=md-nav__link> The C-Library stubs </a> </li> <li class=md-nav__item> <a href=#armc-09-cstubsc class=md-nav__link> armc-09-cstubs.c </a> </li> <li class=md-nav__item> <a href=#armc-09-starts class=md-nav__link> armc-09-start.S </a> </li> <li class=md-nav__item> <a href=#armc-09-cstartupc class=md-nav__link> armc-09-cstartup.c </a> </li> <li class=md-nav__item> <a href=#part-2armc-09c class=md-nav__link> part-2/armc-09.c </a> </li> <li class=md-nav__item> <a href=#part-3 class=md-nav__link> Part 3 </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=bmc-part-2-the-c-runtime>BMC Part 2 - The C Runtime<a class=headerlink href=#bmc-part-2-the-c-runtime title="Permanent link">&para;</a></h1> <p>In this part of the tutorial we'll look deeper into the linker and the C-Library so that we end up with a working C-Library link. Exciting stuff, huh?! Let's look further into what the compiler and linker are doing in order to create our bare-metal executable.</p> <p>The C-Runtime (different to the C-Library!) is currently missing from our code. In a lot of embedded systems the C-Runtime is essential, or else things break instantly. The most notable thing that's instantly visible in most embedded systems is that static variables are not initialised.</p> <p>This is why in our previous example, we were working without pre-initialised variables. Instead, we initialise the variable in the code at the start of main from a pre-processor define.</p> <blockquote> <p><strong>Github</strong> The code for the tutorials is now on <a href=https://github.com/BrianSidebotham/arm-tutorial-rpi>Github</a>. You can either browse the code, checkout the code, fork, branch, or download <a href=https://github.com/BrianSidebotham/arm-tutorial-rpi/archive/master.zip>as a zip</a> from GibHub.</p> </blockquote> <h2 id=understanding-the-c-runtime-startup>Understanding the C-Runtime Startup<a class=headerlink href=#understanding-the-c-runtime-startup title="Permanent link">&para;</a></h2> <p>Let's modify and use a pre-initialised variable instead:</p> <h3 id=part-2armc-04>part-2/armc-04<a class=headerlink href=#part-2armc-04 title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;rpi-gpio.h&quot;</span>
<a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>
<a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=cm>/** GPIO Register set */</span>
<a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=k>volatile</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=o>*</span><span class=w> </span><span class=n>gpio</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=o>*</span><span class=p>)</span><span class=n>GPIO_BASE</span><span class=p>;</span>
<a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a>
<a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=cm>/** Simple loop variable */</span>
<a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=k>volatile</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>tim</span><span class=p>;</span>
<a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a>
<a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=cm>/** Main function - we&#39;ll never return from here */</span>
<a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a><span class=p>{</span>
<a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a><span class=w>    </span><span class=cm>/* Write 1 to the GPIO16 init nibble in the Function Select 1 GPIO</span>
<a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a><span class=cm>       peripheral register to enable GPIO16 as an output */</span>
<a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a><span class=w>    </span><span class=n>gpio</span><span class=p>[</span><span class=n>LED_GPFSEL</span><span class=p>]</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>LED_GPFBIT</span><span class=p>);</span>
<a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a>
<a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a><span class=w>    </span><span class=cm>/* Never exit as there is no OS to exit to! */</span>
<a id=__codelineno-0-17 name=__codelineno-0-17 href=#__codelineno-0-17></a><span class=w>    </span><span class=k>while</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<a id=__codelineno-0-18 name=__codelineno-0-18 href=#__codelineno-0-18></a><span class=w>    </span><span class=p>{</span>
<a id=__codelineno-0-19 name=__codelineno-0-19 href=#__codelineno-0-19></a><span class=w>        </span><span class=k>for</span><span class=p>(</span><span class=n>tim</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>tim</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>500000</span><span class=p>;</span><span class=w> </span><span class=n>tim</span><span class=o>++</span><span class=p>)</span>
<a id=__codelineno-0-20 name=__codelineno-0-20 href=#__codelineno-0-20></a><span class=w>            </span><span class=p>;</span>
<a id=__codelineno-0-21 name=__codelineno-0-21 href=#__codelineno-0-21></a>
<a id=__codelineno-0-22 name=__codelineno-0-22 href=#__codelineno-0-22></a><span class=w>        </span><span class=cm>/* Set the LED GPIO pin low ( Turn OK LED on for original Pi, and off</span>
<a id=__codelineno-0-23 name=__codelineno-0-23 href=#__codelineno-0-23></a><span class=cm>           for plus models )*/</span>
<a id=__codelineno-0-24 name=__codelineno-0-24 href=#__codelineno-0-24></a><span class=w>        </span><span class=n>gpio</span><span class=p>[</span><span class=n>LED_GPCLR</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>LED_GPIO_BIT</span><span class=p>);</span>
<a id=__codelineno-0-25 name=__codelineno-0-25 href=#__codelineno-0-25></a>
<a id=__codelineno-0-26 name=__codelineno-0-26 href=#__codelineno-0-26></a><span class=w>        </span><span class=k>for</span><span class=p>(</span><span class=n>tim</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>tim</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>500000</span><span class=p>;</span><span class=w> </span><span class=n>tim</span><span class=o>++</span><span class=p>)</span>
<a id=__codelineno-0-27 name=__codelineno-0-27 href=#__codelineno-0-27></a><span class=w>            </span><span class=p>;</span>
<a id=__codelineno-0-28 name=__codelineno-0-28 href=#__codelineno-0-28></a>
<a id=__codelineno-0-29 name=__codelineno-0-29 href=#__codelineno-0-29></a><span class=w>        </span><span class=cm>/* Set the LED GPIO pin high ( Turn OK LED off for original Pi, and on</span>
<a id=__codelineno-0-30 name=__codelineno-0-30 href=#__codelineno-0-30></a><span class=cm>           for plus models )*/</span>
<a id=__codelineno-0-31 name=__codelineno-0-31 href=#__codelineno-0-31></a><span class=w>        </span><span class=n>gpio</span><span class=p>[</span><span class=n>LED_GPSET</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>LED_GPIO_BIT</span><span class=p>);</span>
<a id=__codelineno-0-32 name=__codelineno-0-32 href=#__codelineno-0-32></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-0-33 name=__codelineno-0-33 href=#__codelineno-0-33></a><span class=p>}</span>
</code></pre></div> <p>Compile it (using the build.sh script):</p> <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=go>part-2/armc-04 $ ./build.sh rpi0</span>
<a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=go>arm-none-eabi-gcc -g -nostartfiles -mfloat-abi=hard -O0 -DRPI0 -mfpu=vfp -march=armv6zk \</span>
<a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=go>    -mtune=arm1176jzf-s /.../part-2/armc-04/*.c -o /.../part-2/armc-04/kernel.armc-04.rpi0.elf</span>
<a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=go>/.../gcc-arm-none-eabi-7-2017-q4-major/bin/../lib/gcc/arm-none-eabi/7.2.1/../../../../\</span>
<a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=go>    arm-none-eabi/bin/ld: warning: cannot find entry symbol _start; defaulting to 0000000000008000</span>
<a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a><span class=go>arm-none-eabi-objcopy /.../part-2/armc-04/kernel.armc-04.rpi0.elf -O binary \</span>
<a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=go>    /.../part-2/armc-04/kernel.armc-04.rpi0.img</span>
</code></pre></div> <p>and we notice a few things:</p> <ul> <li>The size of the binary image is now 33k, but the previous version of this code was only a hundred bytes or so!</li> <li>The code, when written to the SDCARD still works - this isn't really expected without a working C-Runtime in place to initialise the variable gpio before calling main!?</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a>part-2/armc-04<span class=w> </span>$<span class=w> </span>ls<span class=w> </span>-lah
<a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a>total<span class=w> </span>40K
<a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a>drwxr-xr-x<span class=w> </span><span class=m>2</span><span class=w> </span>brian<span class=w> </span>brian<span class=w> </span><span class=m>4</span>.0K<span class=w> </span>Oct<span class=w> </span><span class=m>11</span><span class=w> </span><span class=m>21</span>:07<span class=w> </span>.
<a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a>drwxr-xr-x<span class=w> </span><span class=m>8</span><span class=w> </span>brian<span class=w> </span>brian<span class=w> </span><span class=m>4</span>.0K<span class=w> </span>Jan<span class=w>  </span><span class=m>4</span><span class=w>  </span><span class=m>2018</span><span class=w> </span>..
<a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a>-rw-r--r--<span class=w> </span><span class=m>1</span><span class=w> </span>brian<span class=w> </span>brian<span class=w> </span><span class=m>1</span>.2K<span class=w> </span>Sep<span class=w> </span><span class=m>21</span><span class=w> </span><span class=m>00</span>:19<span class=w> </span>armc-04.c
<a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a>-rwxr-xr-x<span class=w> </span><span class=m>1</span><span class=w> </span>brian<span class=w> </span>brian<span class=w> </span><span class=m>2</span>.7K<span class=w> </span>Oct<span class=w> </span><span class=m>11</span><span class=w> </span><span class=m>21</span>:07<span class=w> </span>build.sh
<a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a>-rwxr-xr-x<span class=w> </span><span class=m>1</span><span class=w> </span>brian<span class=w> </span>brian<span class=w>  </span><span class=m>108</span><span class=w> </span>Sep<span class=w> </span><span class=m>21</span><span class=w> </span><span class=m>00</span>:19<span class=w> </span>disassemble.sh
<a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a>-rwxr-xr-x<span class=w> </span><span class=m>1</span><span class=w> </span>brian<span class=w> </span>brian<span class=w>  </span>35K<span class=w> </span>Oct<span class=w> </span><span class=m>11</span><span class=w> </span><span class=m>21</span>:07<span class=w> </span>kernel.armc-04.rpi0.elf
<a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a>-rwxr-xr-x<span class=w> </span><span class=m>1</span><span class=w> </span>brian<span class=w> </span>brian<span class=w>  </span>65K<span class=w> </span>Oct<span class=w> </span><span class=m>11</span><span class=w> </span><span class=m>21</span>:07<span class=w> </span>kernel.armc-04.rpi0.img
<a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a>-rw-r--r--<span class=w> </span><span class=m>1</span><span class=w> </span>brian<span class=w> </span>brian<span class=w> </span><span class=m>1</span>.7K<span class=w> </span>Sep<span class=w> </span><span class=m>21</span><span class=w> </span><span class=m>00</span>:19<span class=w> </span>rpi-gpio.h
</code></pre></div> <p>In fact, this embedded system is different to a lot because we're loading an entire binary image into RAM and then executing from RAM. The majority of systems have a non-volatile memory section (Flash/ROM) where the executable code resides, and a volatile memory section (RAM) where the variable data resides. Variables exist in RAM, everything has a position in RAM.</p> <p>When we compile for a target that executes from an image in Flash and uses RAM for variables, we need a copy of the initial values for the variables from Flash so that every time the system is started the variables can be initialised to their initial value, and we need the code in Flash to copy these values into the variables <em>before</em> <code>main()</code> is called.</p> <p>This is one of the jobs of the C-Runtime code (CRT). This is a code object that is normally linked in automagically by your tool-chain. This is usually not the only object to get linked to your code behind your back - usually the Interrupt Vector Table gets linked in too, and a Linker Script tells the linker how to organise these additional pieces of code in your memory layout.</p> <p>Normally of course, this happens without you knowing. In general, you'll select your processor or embedded system on the command line and the appropriate linker script and C-Runtime is chosen for you and linked in.</p> <p>I urge you to go and look at your <code>arm-none-gcc-eabi</code> install now to see some of these files. Look under the <code>arm-none-eabi</code> sub-directory and then under the lib sub-directory. The C-Runtime code is a binary object file and is called <code>crt0.o</code>, the C Library for info is an archive of object files called <code>libc.a</code> (there may be several versions with different names), and then you'll have some <code>.ld</code> files. Under the ldscripts subdirectory you'll find the standard linker scripts.</p> <p>It's just worth a look to know they're there. GCC uses a thing called specs files too, which allow specifying system settings so that you can create a machine specification that allows you to target a machine easily. You can select a custom specs file with a command line option for GCC, otherwise gcc uses it's built-in specs.</p> <p>specs files are considered an advanced subject in the world of the GNU tool-chain, but they provide an excellent way of supplying machine-specific compilation settings. For the embedded engineer they're worth knowing about! :D</p> <p>So, now we've got two questions, why does our code work - because the initialisation isn't present in the C-Runtime? and, why has our code size jumped from a 100 bytes or so to 64k?</p> <p>The code works without any initialisation because the variables exist in the same memory space as the code. The bootloading process results in the raspberry-pi kernel being loaded into RAM in order to be executed, the GPU bootloader runs before the ARM processor we're targeting runs, and loads the kernel.img file from disk. Because of this, the variables position within the binary image becomes their variable memory location.</p> <p>The image is loaded by the boot-loader at address <code>0x8000</code> and then executed. So the bootloader has essentially done a taskt that the C-Runtime would normally do, copy the initial values of initialised variables from non-volatile memory to volatile memory. Cool.</p> <p>Look at the code produced closer with a disassembler. You've already got a disassembler! It comes with the toolchain; Welcome to the world of objdump (or in our case <code>arm-non-eabi-objdump</code>).</p> <p>We disassemble the elf file because then objdump knows what processor the binary was built for. It also then has knowledge of the different code sections too. There's a <code>disassemble.sh</code> script so go ahead and disassemble the code to see what the compiler generated. You'll get a <code>kernel*.asm</code> file that looks similar to if not the same as the following (RPI0) code:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a>Disassembly of section .text:
<a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a>
<a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a>00008000 &lt;main&gt;:
<a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a>    8000:    e59f30b8     ldr    r3, [pc, #184]    ; 80c0 &lt;main+0xc0&gt;
<a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a>    8004:    e5933000     ldr    r3, [r3]
<a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a>    8008:    e2833004     add    r3, r3, #4
<a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a>    800c:    e5932000     ldr    r2, [r3]
<a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a>    8010:    e59f30a8     ldr    r3, [pc, #168]    ; 80c0 &lt;main+0xc0&gt;
<a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a>    8014:    e5933000     ldr    r3, [r3]
<a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a>    8018:    e2833004     add    r3, r3, #4
<a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a>    801c:    e3822701     orr    r2, r2, #262144    ; 0x40000
<a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a>    8020:    e5832000     str    r2, [r3]
<a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a>    8024:    e59f3098     ldr    r3, [pc, #152]    ; 80c4 &lt;main+0xc4&gt;
<a id=__codelineno-3-14 name=__codelineno-3-14 href=#__codelineno-3-14></a>    8028:    e3a02000     mov    r2, #0
<a id=__codelineno-3-15 name=__codelineno-3-15 href=#__codelineno-3-15></a>    802c:    e5832000     str    r2, [r3]
<a id=__codelineno-3-16 name=__codelineno-3-16 href=#__codelineno-3-16></a>    8030:    ea000004     b    8048 &lt;main+0x48&gt;
<a id=__codelineno-3-17 name=__codelineno-3-17 href=#__codelineno-3-17></a>    8034:    e59f3088     ldr    r3, [pc, #136]    ; 80c4 &lt;main+0xc4&gt;
<a id=__codelineno-3-18 name=__codelineno-3-18 href=#__codelineno-3-18></a>    8038:    e5933000     ldr    r3, [r3]
<a id=__codelineno-3-19 name=__codelineno-3-19 href=#__codelineno-3-19></a>    803c:    e2833001     add    r3, r3, #1
<a id=__codelineno-3-20 name=__codelineno-3-20 href=#__codelineno-3-20></a>    8040:    e59f207c     ldr    r2, [pc, #124]    ; 80c4 &lt;main+0xc4&gt;
<a id=__codelineno-3-21 name=__codelineno-3-21 href=#__codelineno-3-21></a>    8044:    e5823000     str    r3, [r2]
<a id=__codelineno-3-22 name=__codelineno-3-22 href=#__codelineno-3-22></a>    8048:    e59f3074     ldr    r3, [pc, #116]    ; 80c4 &lt;main+0xc4&gt;
<a id=__codelineno-3-23 name=__codelineno-3-23 href=#__codelineno-3-23></a>    804c:    e5933000     ldr    r3, [r3]
<a id=__codelineno-3-24 name=__codelineno-3-24 href=#__codelineno-3-24></a>    8050:    e59f2070     ldr    r2, [pc, #112]    ; 80c8 &lt;main+0xc8&gt;
<a id=__codelineno-3-25 name=__codelineno-3-25 href=#__codelineno-3-25></a>    8054:    e1530002     cmp    r3, r2
<a id=__codelineno-3-26 name=__codelineno-3-26 href=#__codelineno-3-26></a>    8058:    9afffff5     bls    8034 &lt;main+0x34&gt;
<a id=__codelineno-3-27 name=__codelineno-3-27 href=#__codelineno-3-27></a>    805c:    e59f305c     ldr    r3, [pc, #92]    ; 80c0 &lt;main+0xc0&gt;
<a id=__codelineno-3-28 name=__codelineno-3-28 href=#__codelineno-3-28></a>    8060:    e5933000     ldr    r3, [r3]
<a id=__codelineno-3-29 name=__codelineno-3-29 href=#__codelineno-3-29></a>    8064:    e2833028     add    r3, r3, #40    ; 0x28
<a id=__codelineno-3-30 name=__codelineno-3-30 href=#__codelineno-3-30></a>    8068:    e3a02801     mov    r2, #65536    ; 0x10000
<a id=__codelineno-3-31 name=__codelineno-3-31 href=#__codelineno-3-31></a>    806c:    e5832000     str    r2, [r3]
<a id=__codelineno-3-32 name=__codelineno-3-32 href=#__codelineno-3-32></a>    8070:    e59f304c     ldr    r3, [pc, #76]    ; 80c4 &lt;main+0xc4&gt;
<a id=__codelineno-3-33 name=__codelineno-3-33 href=#__codelineno-3-33></a>    8074:    e3a02000     mov    r2, #0
<a id=__codelineno-3-34 name=__codelineno-3-34 href=#__codelineno-3-34></a>    8078:    e5832000     str    r2, [r3]
<a id=__codelineno-3-35 name=__codelineno-3-35 href=#__codelineno-3-35></a>    807c:    ea000004     b    8094 &lt;main+0x94&gt;
<a id=__codelineno-3-36 name=__codelineno-3-36 href=#__codelineno-3-36></a>    8080:    e59f303c     ldr    r3, [pc, #60]    ; 80c4 &lt;main+0xc4&gt;
<a id=__codelineno-3-37 name=__codelineno-3-37 href=#__codelineno-3-37></a>    8084:    e5933000     ldr    r3, [r3]
<a id=__codelineno-3-38 name=__codelineno-3-38 href=#__codelineno-3-38></a>    8088:    e2833001     add    r3, r3, #1
<a id=__codelineno-3-39 name=__codelineno-3-39 href=#__codelineno-3-39></a>    808c:    e59f2030     ldr    r2, [pc, #48]    ; 80c4 &lt;main+0xc4&gt;
<a id=__codelineno-3-40 name=__codelineno-3-40 href=#__codelineno-3-40></a>    8090:    e5823000     str    r3, [r2]
<a id=__codelineno-3-41 name=__codelineno-3-41 href=#__codelineno-3-41></a>    8094:    e59f3028     ldr    r3, [pc, #40]    ; 80c4 &lt;main+0xc4&gt;
<a id=__codelineno-3-42 name=__codelineno-3-42 href=#__codelineno-3-42></a>    8098:    e5933000     ldr    r3, [r3]
<a id=__codelineno-3-43 name=__codelineno-3-43 href=#__codelineno-3-43></a>    809c:    e59f2024     ldr    r2, [pc, #36]    ; 80c8 &lt;main+0xc8&gt;
<a id=__codelineno-3-44 name=__codelineno-3-44 href=#__codelineno-3-44></a>    80a0:    e1530002     cmp    r3, r2
<a id=__codelineno-3-45 name=__codelineno-3-45 href=#__codelineno-3-45></a>    80a4:    9afffff5     bls    8080 &lt;main+0x80&gt;
<a id=__codelineno-3-46 name=__codelineno-3-46 href=#__codelineno-3-46></a>    80a8:    e59f3010     ldr    r3, [pc, #16]    ; 80c0 &lt;main+0xc0&gt;
<a id=__codelineno-3-47 name=__codelineno-3-47 href=#__codelineno-3-47></a>    80ac:    e5933000     ldr    r3, [r3]
<a id=__codelineno-3-48 name=__codelineno-3-48 href=#__codelineno-3-48></a>    80b0:    e283301c     add    r3, r3, #28
<a id=__codelineno-3-49 name=__codelineno-3-49 href=#__codelineno-3-49></a>    80b4:    e3a02801     mov    r2, #65536    ; 0x10000
<a id=__codelineno-3-50 name=__codelineno-3-50 href=#__codelineno-3-50></a>    80b8:    e5832000     str    r2, [r3]
<a id=__codelineno-3-51 name=__codelineno-3-51 href=#__codelineno-3-51></a>    80bc:    eaffffd8     b    8024 &lt;main+0x24    &gt;
<a id=__codelineno-3-52 name=__codelineno-3-52 href=#__codelineno-3-52></a>    80c0:    000180cc     andeq    r8, r1, ip, asr #1
<a id=__codelineno-3-53 name=__codelineno-3-53 href=#__codelineno-3-53></a>    80c4:    000180d0     ldrdeq    r8, [r1], -r0
<a id=__codelineno-3-54 name=__codelineno-3-54 href=#__codelineno-3-54></a>    80c8:    0007a11f     andeq    sl, r7, pc, lsl r1
<a id=__codelineno-3-55 name=__codelineno-3-55 href=#__codelineno-3-55></a>
<a id=__codelineno-3-56 name=__codelineno-3-56 href=#__codelineno-3-56></a>Disassembly of section .data:
<a id=__codelineno-3-57 name=__codelineno-3-57 href=#__codelineno-3-57></a>
<a id=__codelineno-3-58 name=__codelineno-3-58 href=#__codelineno-3-58></a>000180cc &lt;gpio&gt;:
<a id=__codelineno-3-59 name=__codelineno-3-59 href=#__codelineno-3-59></a>   180cc:    20200000     eorcs    r0, r0, r0
<a id=__codelineno-3-60 name=__codelineno-3-60 href=#__codelineno-3-60></a>
<a id=__codelineno-3-61 name=__codelineno-3-61 href=#__codelineno-3-61></a>Disassembly of section .bss:
<a id=__codelineno-3-62 name=__codelineno-3-62 href=#__codelineno-3-62></a>
<a id=__codelineno-3-63 name=__codelineno-3-63 href=#__codelineno-3-63></a>000180d0 &lt;tim&gt;:
<a id=__codelineno-3-64 name=__codelineno-3-64 href=#__codelineno-3-64></a>   180d0:    00000000     andeq    r0, r0, r0
</code></pre></div> <blockquote> <p><strong>NOTE:</strong> Unless we're using the exact same compiler, your mileage may vary here. So assume the assembly code above is what's come out of the compiler and follow the text below which goes through it in detail.</p> </blockquote> <p>Let's take it line by line. The toolchain's linker has decided that the entry point for the code should be at memory address <code>0x8000</code>. We see from the disassembled listing that this is where the machine code starts. Let's look at what it does.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a>00008000 &lt;main&gt;:
<a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a>    8000:    e59f30b8     ldr    r3, [pc, #184]    ; 80c0 &lt;main+0xc0&gt;
</code></pre></div> <p>This first line loads r3 with the value at the <em>address</em> contained at the Program Counter (PC) + 184. In this assembler, <code>[]</code> is kind of an equivalent to dereferencing a pointer in C. So instead of loading r3 with the value <code>80c0</code> it will instead load r3 with the 32-bit value at memory location <code>0x80c0</code></p> <p>But wait a minute - if you do the maths of <code>0x8000 + 184</code> you get <code>0x80b8</code>. How come the disassembler is suggesting the data comes from <code>0x80c0</code>?</p> <p>Well PC relative addressing works slightly different to what you may expect and really there's a issue with it, the value of PC is different depending on whether the instruction set is currently ARM or Thumb. Further information is available on the <a href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.dui0473e/Cacdbfji.html">ARM website</a>.</p> <p>The important thing to note here is:</p> <blockquote> <p>In ARM state, the value of the PC is the address of the current instruction plus 8 bytes.</p> <p>In Thumb state:</p> <ul> <li> <p>For B, BL, CBNZ, and CBZ instructions, the value of the PC is the address of the current instruction plus 4 bytes.</p> </li> <li> <p>For all other instructions that use labels, the value of the PC is the address of the current instruction plus 4 bytes, with bit[1] of the result cleared to 0 to make it word-aligned.</p> </li> </ul> </blockquote> <p>We're in ARM instruction mode here. If you're not sure about ARM and Thumb instruction sets you can do some googling. Thumb (there's more than one Thumb mode!) are smaller width instructions to allow for more compact code which is very useful in heavily embedded systems.</p> <p>So actually the maths here sound be: <code>0x8000 + 0x8 + 0xb8 = 0x80c0</code> to get us to a memory address. At <code>0x80c0</code> there's the value <code>0x180cc</code> (<code>0x8000 + 0x80cc</code>):</p> <div class=highlight><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a>80c0:    000180cc     andeq    r8, r1, ip, asr #1
</code></pre></div> <p>You can ignore the disassembled version of this value as it's not machine code, instead it's merely a data value.</p> <p>The next line of the code loads r3 with the 32-bit value that's in memory at the address currently contained in r3. In c, this would look a bit horrid, but so you get the idea of what I've just explained, imagine something like this:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=kt>uint32_t</span><span class=w> </span><span class=n>r3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x180cc</span><span class=p>;</span>
<a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=n>r3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>*</span><span class=p>(</span><span class=kt>uint32_t</span><span class=o>*</span><span class=p>)</span><span class=n>r3</span><span class=p>;</span>
</code></pre></div> <p>At the address 0x180cc in our disassembled version there's the 32-bit value <code>0x20200000</code> which is the value we want the variable gpio initialised to (for the RPI1, for the RPI2 this will be <code>0x3F200000</code>. So this is why the code works without any explicit loading or initialisation, but let's look at exactly what's going on and find out why it works like this.</p> <p>The value at the end of our executable image can be viewed by dumping the hex and having a look at the plain machine code that's in the binary file. The disassemble script does this for you with a tool called <code>hexdump</code> and puts the result into a <code>kernel*.img.hexdump</code> file. It's a plain text file - you can go ahead and crack it open in a text editor or <code>cat</code> it.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a>0000000 30b8 e59f 3000 e593 3004 e283 2000 e593
<a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a>0000010 30a8 e59f 3000 e593 3004 e283 2701 e382
<a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a>0000020 2000 e583 3098 e59f 2000 e3a0 2000 e583
<a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a>0000030 0004 ea00 3088 e59f 3000 e593 3001 e283
<a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a>0000040 207c e59f 3000 e582 3074 e59f 3000 e593
<a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a>0000050 2070 e59f 0002 e153 fff5 9aff 305c e59f
<a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a>0000060 3000 e593 3028 e283 2801 e3a0 2000 e583
<a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a>0000070 304c e59f 2000 e3a0 2000 e583 0004 ea00
<a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a>0000080 303c e59f 3000 e593 3001 e283 2030 e59f
<a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a>0000090 3000 e582 3028 e59f 3000 e593 2024 e59f
<a id=__codelineno-7-11 name=__codelineno-7-11 href=#__codelineno-7-11></a>00000a0 0002 e153 fff5 9aff 3010 e59f 3000 e593
<a id=__codelineno-7-12 name=__codelineno-7-12 href=#__codelineno-7-12></a>00000b0 301c e283 2801 e3a0 2000 e583 ffd8 eaff
<a id=__codelineno-7-13 name=__codelineno-7-13 href=#__codelineno-7-13></a>00000c0 80cc 0001 80d0 0001 a11f 0007 0000 0000
<a id=__codelineno-7-14 name=__codelineno-7-14 href=#__codelineno-7-14></a>00000d0 0000 0000 0000 0000 0000 0000 0000 0000
<a id=__codelineno-7-15 name=__codelineno-7-15 href=#__codelineno-7-15></a>*
<a id=__codelineno-7-16 name=__codelineno-7-16 href=#__codelineno-7-16></a>00100c0 0000 0000 0000 0000 0000 0000 0000 2020
<a id=__codelineno-7-17 name=__codelineno-7-17 href=#__codelineno-7-17></a>00100d0
</code></pre></div> <p>The binary is in little-endian format because the processor is little endian. Adjust the <code>GPIO_BASE</code> value, recompile and disassemble again so you can see the value change. Sure the code won't work properly, but you can prove to yourself you're looking (and making sense of) the right thing.</p> <p>The thing to note here is that our binary image ends at <code>0x100cf</code>. After the bootloader has placed this binary image in memory at <code>0x8000</code> the last memory location we touch is <code>0x180cf</code>.</p> <p>Let's have a quick look at what happens next:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a>8008:    e2833004     add    r3, r3, #4
</code></pre></div> <p>Increase the value in r3 from <code>0x20200000</code> to <code>0x20200004</code> and store it in r3. This is part of the C line:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=n>gpio</span><span class=p>[</span><span class=n>LED_GPFSEL</span><span class=p>]</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>LED_GPFBIT</span><span class=p>);</span>
</code></pre></div> <p>LED_GPFSEL for this compilation for the RPI Zero is set by:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=cp>#define LED_GPFSEL      GPIO_GPFSEL1</span>
<a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=cp>#define GPIO_GPFSEL1    1</span>
</code></pre></div> <p>From the definition of <code>gpio</code> as <code>volatile unsigned int*</code> each item pointed to is an unsigned int which is 32-bit wide. That's 4 bytes, so we increase the pointer into gpio by 4 bytes to get the register address we require in r3.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a>800c:    e5932000     ldr    r2, [r3]
</code></pre></div> <p>Load the value of <code>gpio[LED_GPFSEL]</code> into r2. This is common for read-modify-write operations such as the <code>|=</code> operator we're using in this example. We need to do exactly that, read the value, modify the value and then write the new value.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a>8010:    e59f30a8     ldr    r3, [pc, #168]    ; 80c0 &lt;main+0xc0&gt;
<a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a>8014:    e5933000     ldr    r3, [r3]
<a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a>8018:    e2833004     add    r3, r3, #4
</code></pre></div> <p>The compiler being rather inefficient here. It's preparing r3 again to be the memory write destination which is exactly the same read memory location. Any sort of compiler optimisations should be able to get rid of the above three lines. They're really not required, but we understand what's going on still.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a>801c:    e3822701     orr    r2, r2, #262144    ; 0x40000
</code></pre></div> <p>The modify part of <code>|=</code>. In this case <code>(1 &lt;&lt; LED_GPFBIT)</code> has been reduced to a constant. The original <code>gpio[LED_GPFSEL]</code> value is still in r2. We OR that value with the constant to set the bit and store the new value in r2. The ARM architecture cannot modify a register value and store it to a memory location in a single instruction BTW in case you're thinking that would serve us better.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a>8020:    e5832000     str    r2, [r3]
</code></pre></div> <p>Finally, the write part of the read-modify-write operation is to write the new value back to the destination <code>gpio[LED_GPFSEL]</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a>8024:    e59f3098     ldr    r3, [pc, #152]    ; 80c4 &lt;main+0xc4&gt;
<a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a>...
<a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a>80c4:    000180d0     ldrdeq    r8, [r1], -r0
</code></pre></div> <p>Loads the value <code>0x180d0</code> into r3.</p> <p>This value is a problem! It is outside our binary image space. If we were to use this value it would be a random value that isn't within our control. How come?</p> <p>This memory location relates to the C variable <code>tim</code> in our program. This variable is determined by the C standard to have automatic storage duration and according to the C standard should therefore have a initialised value of 0, but we know here that this is not the case, instead we'll have a random value.</p> <p>Actually what happens in the code next is the <code>for</code> loop starts by setting the <code>tim</code> variable to <code>0</code>.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a>8028:    e3a02000     mov    r2, #0
<a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a>802c:    e5832000     str    r2, [r3]
</code></pre></div> <p>Let's do a sanity check and make sure we're right by assuming that this is the <code>tim</code> variable:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a>000180d4 B __bss_end__
<a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a>000180d4 B _bss_end__
<a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a>000180d0 B __bss_start
<a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a>000180d0 B __bss_start__
<a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a>000180cc D __data_start
<a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a>000180d0 D _edata
<a id=__codelineno-17-7 name=__codelineno-17-7 href=#__codelineno-17-7></a>000180d4 B _end
<a id=__codelineno-17-8 name=__codelineno-17-8 href=#__codelineno-17-8></a>000180d4 B __end__
<a id=__codelineno-17-9 name=__codelineno-17-9 href=#__codelineno-17-9></a>000180cc D gpio
<a id=__codelineno-17-10 name=__codelineno-17-10 href=#__codelineno-17-10></a>00008000 T main
<a id=__codelineno-17-11 name=__codelineno-17-11 href=#__codelineno-17-11></a>00080000 N _stack
<a id=__codelineno-17-12 name=__codelineno-17-12 href=#__codelineno-17-12></a>         U _start
<a id=__codelineno-17-13 name=__codelineno-17-13 href=#__codelineno-17-13></a>000180d0 B tim
</code></pre></div> <p>Yep! We're talking the same as <a href=https://sourceware.org/binutils/docs/binutils/nm.html>nm</a>. That's good at least!</p> <p>Now let's do an experiment. There's a reason I decoded the value <code>0x100cc</code> which is the address of the gpio variable as <code>0x8000 + 0x80cc</code> earlier:</p> <h2 id=part-2armc05c>part-2/armc05.c<a class=headerlink href=#part-2armc05c title="Permanent link">&para;</a></h2> <div class=highlight><pre><span></span><code><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;rpi-gpio.h&quot;</span>
<a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a>
<a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a><span class=cm>/** GPIO Register set */</span>
<a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a><span class=k>volatile</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=o>*</span><span class=w> </span><span class=n>gpio</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=o>*</span><span class=p>)</span><span class=n>GPIO_BASE</span><span class=p>;</span>
<a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a>
<a id=__codelineno-18-6 name=__codelineno-18-6 href=#__codelineno-18-6></a><span class=cm>/** Simple loop variable */</span>
<a id=__codelineno-18-7 name=__codelineno-18-7 href=#__codelineno-18-7></a><span class=k>volatile</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>tim</span><span class=p>;</span>
<a id=__codelineno-18-8 name=__codelineno-18-8 href=#__codelineno-18-8></a>
<a id=__codelineno-18-9 name=__codelineno-18-9 href=#__codelineno-18-9></a><span class=cm>/** Main function - we&#39;ll never return from here */</span>
<a id=__codelineno-18-10 name=__codelineno-18-10 href=#__codelineno-18-10></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=w> </span><span class=n>__attribute__</span><span class=p>((</span><span class=kr>naked</span><span class=p>));</span>
<a id=__codelineno-18-11 name=__codelineno-18-11 href=#__codelineno-18-11></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<a id=__codelineno-18-12 name=__codelineno-18-12 href=#__codelineno-18-12></a><span class=p>{</span>
<a id=__codelineno-18-13 name=__codelineno-18-13 href=#__codelineno-18-13></a><span class=w>    </span><span class=cm>/* Write 1 to the GPIO16 init nibble in the Function Select 1 GPIO</span>
<a id=__codelineno-18-14 name=__codelineno-18-14 href=#__codelineno-18-14></a><span class=cm>       peripheral register to enable GPIO16 as an output */</span>
<a id=__codelineno-18-15 name=__codelineno-18-15 href=#__codelineno-18-15></a><span class=w>    </span><span class=n>gpio</span><span class=p>[</span><span class=n>LED_GPFSEL</span><span class=p>]</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>LED_GPFBIT</span><span class=p>);</span>
<a id=__codelineno-18-16 name=__codelineno-18-16 href=#__codelineno-18-16></a>
<a id=__codelineno-18-17 name=__codelineno-18-17 href=#__codelineno-18-17></a><span class=w>    </span><span class=cm>/* Never exit as there is no OS to exit to! */</span>
<a id=__codelineno-18-18 name=__codelineno-18-18 href=#__codelineno-18-18></a><span class=w>    </span><span class=k>while</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<a id=__codelineno-18-19 name=__codelineno-18-19 href=#__codelineno-18-19></a><span class=w>    </span><span class=p>{</span>
<a id=__codelineno-18-20 name=__codelineno-18-20 href=#__codelineno-18-20></a><span class=w>        </span><span class=k>for</span><span class=p>(</span><span class=n>tim</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>tim</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>500000</span><span class=p>;</span><span class=w> </span><span class=n>tim</span><span class=o>++</span><span class=p>)</span>
<a id=__codelineno-18-21 name=__codelineno-18-21 href=#__codelineno-18-21></a><span class=w>            </span><span class=p>;</span>
<a id=__codelineno-18-22 name=__codelineno-18-22 href=#__codelineno-18-22></a>
<a id=__codelineno-18-23 name=__codelineno-18-23 href=#__codelineno-18-23></a><span class=w>        </span><span class=cm>/* Set the LED GPIO pin low ( Turn OK LED on for original Pi, and off</span>
<a id=__codelineno-18-24 name=__codelineno-18-24 href=#__codelineno-18-24></a><span class=cm>           for plus models )*/</span>
<a id=__codelineno-18-25 name=__codelineno-18-25 href=#__codelineno-18-25></a><span class=w>        </span><span class=n>gpio</span><span class=p>[</span><span class=n>LED_GPCLR</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>LED_GPIO_BIT</span><span class=p>);</span>
<a id=__codelineno-18-26 name=__codelineno-18-26 href=#__codelineno-18-26></a>
<a id=__codelineno-18-27 name=__codelineno-18-27 href=#__codelineno-18-27></a><span class=w>        </span><span class=k>for</span><span class=p>(</span><span class=n>tim</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>tim</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>500000</span><span class=p>;</span><span class=w> </span><span class=n>tim</span><span class=o>++</span><span class=p>)</span>
<a id=__codelineno-18-28 name=__codelineno-18-28 href=#__codelineno-18-28></a><span class=w>            </span><span class=p>;</span>
<a id=__codelineno-18-29 name=__codelineno-18-29 href=#__codelineno-18-29></a>
<a id=__codelineno-18-30 name=__codelineno-18-30 href=#__codelineno-18-30></a><span class=w>        </span><span class=cm>/* Set the LED GPIO pin high ( Turn OK LED off for original Pi, and on</span>
<a id=__codelineno-18-31 name=__codelineno-18-31 href=#__codelineno-18-31></a><span class=cm>           for plus models )*/</span>
<a id=__codelineno-18-32 name=__codelineno-18-32 href=#__codelineno-18-32></a><span class=w>        </span><span class=n>gpio</span><span class=p>[</span><span class=n>LED_GPSET</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>LED_GPIO_BIT</span><span class=p>);</span>
<a id=__codelineno-18-33 name=__codelineno-18-33 href=#__codelineno-18-33></a>
<a id=__codelineno-18-34 name=__codelineno-18-34 href=#__codelineno-18-34></a><span class=w>        </span><span class=k>for</span><span class=p>(</span><span class=n>tim</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>tim</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>500000</span><span class=p>;</span><span class=w> </span><span class=n>tim</span><span class=o>++</span><span class=p>)</span>
<a id=__codelineno-18-35 name=__codelineno-18-35 href=#__codelineno-18-35></a><span class=w>            </span><span class=p>;</span>
<a id=__codelineno-18-36 name=__codelineno-18-36 href=#__codelineno-18-36></a>
<a id=__codelineno-18-37 name=__codelineno-18-37 href=#__codelineno-18-37></a><span class=w>        </span><span class=cm>/* Set the LED GPIO pin low ( Turn OK LED on for original Pi, and off</span>
<a id=__codelineno-18-38 name=__codelineno-18-38 href=#__codelineno-18-38></a><span class=cm>           for plus models )*/</span>
<a id=__codelineno-18-39 name=__codelineno-18-39 href=#__codelineno-18-39></a><span class=w>        </span><span class=n>gpio</span><span class=p>[</span><span class=n>LED_GPCLR</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>LED_GPIO_BIT</span><span class=p>);</span>
<a id=__codelineno-18-40 name=__codelineno-18-40 href=#__codelineno-18-40></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-18-41 name=__codelineno-18-41 href=#__codelineno-18-41></a><span class=p>}</span>
</code></pre></div> <p><code>armc-05.c</code> varies only slightly from <code>armc-04.c</code> in that it adds in some code. When we look at this with <code>nm</code> we see that the <code>__data_start</code> section shifts by the same amount as the code we've added:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=go>part-2/armc-05 $ ./build.sh rpi0</span>
<a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a><span class=go>...</span>
<a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a>
<a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a><span class=go>part-2/armc-05 $ ./disassemble.sh</span>
<a id=__codelineno-19-5 name=__codelineno-19-5 href=#__codelineno-19-5></a><span class=go>...</span>
<a id=__codelineno-19-6 name=__codelineno-19-6 href=#__codelineno-19-6></a>
<a id=__codelineno-19-7 name=__codelineno-19-7 href=#__codelineno-19-7></a><span class=go>part-2/armc-05 $ cat kernel.armc-05.rpi0.elf.nm</span>
<a id=__codelineno-19-8 name=__codelineno-19-8 href=#__codelineno-19-8></a><span class=go> 00018120 B __bss_end__</span>
<a id=__codelineno-19-9 name=__codelineno-19-9 href=#__codelineno-19-9></a><span class=go> 00018120 B _bss_end__</span>
<a id=__codelineno-19-10 name=__codelineno-19-10 href=#__codelineno-19-10></a><span class=go> 0001811c B __bss_start</span>
<a id=__codelineno-19-11 name=__codelineno-19-11 href=#__codelineno-19-11></a><span class=go> 0001811c B __bss_start__</span>
<a id=__codelineno-19-12 name=__codelineno-19-12 href=#__codelineno-19-12></a><span class=go> 00018118 D __data_start</span>
<a id=__codelineno-19-13 name=__codelineno-19-13 href=#__codelineno-19-13></a><span class=go> 0001811c D _edata</span>
<a id=__codelineno-19-14 name=__codelineno-19-14 href=#__codelineno-19-14></a><span class=go> 00018120 B _end</span>
<a id=__codelineno-19-15 name=__codelineno-19-15 href=#__codelineno-19-15></a><span class=go> 00018120 B __end__</span>
<a id=__codelineno-19-16 name=__codelineno-19-16 href=#__codelineno-19-16></a><span class=go> 00018118 D gpio</span>
<a id=__codelineno-19-17 name=__codelineno-19-17 href=#__codelineno-19-17></a><span class=go> 00008000 T main</span>
<a id=__codelineno-19-18 name=__codelineno-19-18 href=#__codelineno-19-18></a><span class=go> 00080000 N _stack</span>
<a id=__codelineno-19-19 name=__codelineno-19-19 href=#__codelineno-19-19></a><span class=go>          U _start</span>
<a id=__codelineno-19-20 name=__codelineno-19-20 href=#__codelineno-19-20></a><span class=go> 0001811c B tim</span>
</code></pre></div> <p>If we go back to the original disassembled output above, we see that address <code>0x80cc (0x180cc - (0x8000 * 2))</code> is the next available memory address after the constants data which is itself immediately after the code section.</p> <p>I hope you're following this, we're really seeing a "bug" in the linker script. There's no need for us to have this offset. The offset load is correct because when we load this image in RAM the data is indeed going to be <code>+ 0x8000</code> because that's where the boot-loader is going to place the image, but something is spacing the data section away from the constants data.</p> <p>There's a lot more output when building this code. That's because we've added an option (<code>-Wl,-verbose</code>) to get verbose output from the linker to see what's going on.</p> <p>As you see from the start of the ld verbose output:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a>GNU ld (GNU Tools for Arm Embedded Processors 7-2017-q4-major) 2.29.51.20171128
<a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a>  Supported emulations:
<a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a>   armelf
<a id=__codelineno-20-4 name=__codelineno-20-4 href=#__codelineno-20-4></a>using internal linker script:
</code></pre></div> <p>LD is using an internal linker script. That means the linker script it's using is compiled into the ld executable.</p> <h2 id=part-2armc-06c>part-2/armc-06.c<a class=headerlink href=#part-2armc-06c title="Permanent link">&para;</a></h2> <p>The code is identical to <code>armc-04.c</code>. (So the original code without the additional loop in <code>armc-05.c</code>)</p> <p>However, we add <code>-Wl,-T,rpi.x</code> to the compilation command to instruct LD to use a different linker script to the one it was using. We've retained <code>-Wl,verbose</code> so we can see what happens.</p> <p>When passing options to the linker using GCC to compile and link, check the <a href=http://gcc.gnu.org/onlinedocs/gcc/Link-Options.html>gcc documentation</a> which details the options you can pass.</p> <p>Now we have control of the linker script. We can try to find out what's "wrong". I quote wrong, because technically this works, but we've got an annoying <code>0x8000</code> offset. It'll be a pain to debug one day, I know it. Let's find out what we need to do to fix it instead. You can also see how complicated a linker script can get when it needs to deal with C++ sections!</p> <p>I hope you're staying with me! I know this may seem far removed from C development on the Raspberry-Pi bare-metal, but in fact knowing how your tools work to construct the code is essential later on down the line - heck you wouldn't be getting it up and running on your own from scratch unless you knew at least some of this stuff!</p> <p>Whilst I'm scan-reading the linker script I'm looking for things that stick out. Most of these sections are not used in our basic example so far, so whatever is messing with us must have a size set, and must be present only when we have something in the initialised variables section which we know from our investigations with nm is the <code>__data_start</code> section (it aligns with the gpio symbol which we initialised).</p> <p>The "problem" must be between the <code>__data_start</code> section and end of the text section (the symbol main indicated the start of the text section). After a little bit of hunting, I see a comment and an alignment pertaining to the data section on line 107:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=cm>/* Adjust the address for the data segment.  We want to adjust up to</span>
<a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a><span class=cm>     the same address within the page on the next page up.  */</span>
<a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a><span class=w>  </span><span class=p>.</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ALIGN</span><span class=p>(</span><span class=n>CONSTANT</span><span class=w> </span><span class=p>(</span><span class=n>MAXPAGESIZE</span><span class=p>))</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(.</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=p>(</span><span class=n>CONSTANT</span><span class=w> </span><span class=p>(</span><span class=n>MAXPAGESIZE</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>));</span>
</code></pre></div> <p>Interesting, we apparently "want" to adjust up to the next page. If I comment this out with a standard C-style comment as can be seen in the rest of the file, we get back down to a size of a few hundred bytes with initialised data. Check again with the output of:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a><span class=go>part-2/armc-06 $ ll</span>
<a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a>
<a id=__codelineno-22-3 name=__codelineno-22-3 href=#__codelineno-22-3></a><span class=go>-rwxr-xr-x 1 brian brian   284 Oct 14 22:17 kernel.armc-06.rpi0.img*</span>
</code></pre></div> <p>When we disassemble the kernel code, we end up with something similar to the following:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a><span class=go>part-2/armc-06 $ ./disassemble.sh</span>
</code></pre></div> <div class=highlight><pre><span></span><code><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a>Disassembly of section .text:
<a id=__codelineno-24-2 name=__codelineno-24-2 href=#__codelineno-24-2></a>
<a id=__codelineno-24-3 name=__codelineno-24-3 href=#__codelineno-24-3></a>00008000 &lt;main&gt;:
<a id=__codelineno-24-4 name=__codelineno-24-4 href=#__codelineno-24-4></a>    8000:    e59f30b8     ldr    r3, [pc, #184]    ; 80c0 &lt;main+0xc0&gt;
<a id=__codelineno-24-5 name=__codelineno-24-5 href=#__codelineno-24-5></a>    8004:    e5933000     ldr    r3, [r3]
<a id=__codelineno-24-6 name=__codelineno-24-6 href=#__codelineno-24-6></a>    8008:    e2833010     add    r3, r3, #16
<a id=__codelineno-24-7 name=__codelineno-24-7 href=#__codelineno-24-7></a>    800c:    e5932000     ldr    r2, [r3]
<a id=__codelineno-24-8 name=__codelineno-24-8 href=#__codelineno-24-8></a>    8010:    e59f30a8     ldr    r3, [pc, #168]    ; 80c0 &lt;main+0xc0&gt;
<a id=__codelineno-24-9 name=__codelineno-24-9 href=#__codelineno-24-9></a>    8014:    e5933000     ldr    r3, [r3]
<a id=__codelineno-24-10 name=__codelineno-24-10 href=#__codelineno-24-10></a>    8018:    e2833010     add    r3, r3, #16
<a id=__codelineno-24-11 name=__codelineno-24-11 href=#__codelineno-24-11></a>    801c:    e3822602     orr    r2, r2, #2097152    ; 0x200000
<a id=__codelineno-24-12 name=__codelineno-24-12 href=#__codelineno-24-12></a>    8020:    e5832000     str    r2, [r3]
<a id=__codelineno-24-13 name=__codelineno-24-13 href=#__codelineno-24-13></a>    8024:    e59f3098     ldr    r3, [pc, #152]    ; 80c4 &lt;main+0xc4&gt;
<a id=__codelineno-24-14 name=__codelineno-24-14 href=#__codelineno-24-14></a>    8028:    e3a02000     mov    r2, #0
<a id=__codelineno-24-15 name=__codelineno-24-15 href=#__codelineno-24-15></a>    802c:    e5832000     str    r2, [r3]
<a id=__codelineno-24-16 name=__codelineno-24-16 href=#__codelineno-24-16></a>    8030:    ea000004     b    8048 &lt;main+0x48&gt;
<a id=__codelineno-24-17 name=__codelineno-24-17 href=#__codelineno-24-17></a>    8034:    e59f3088     ldr    r3, [pc, #136]    ; 80c4 &lt;main+0xc4&gt;
<a id=__codelineno-24-18 name=__codelineno-24-18 href=#__codelineno-24-18></a>    8038:    e5933000     ldr    r3, [r3]
<a id=__codelineno-24-19 name=__codelineno-24-19 href=#__codelineno-24-19></a>    803c:    e2833001     add    r3, r3, #1
<a id=__codelineno-24-20 name=__codelineno-24-20 href=#__codelineno-24-20></a>    8040:    e59f207c     ldr    r2, [pc, #124]    ; 80c4 &lt;main+0xc4&gt;
<a id=__codelineno-24-21 name=__codelineno-24-21 href=#__codelineno-24-21></a>    8044:    e5823000     str    r3, [r2]
<a id=__codelineno-24-22 name=__codelineno-24-22 href=#__codelineno-24-22></a>    8048:    e59f3074     ldr    r3, [pc, #116]    ; 80c4 &lt;main+0xc4&gt;
<a id=__codelineno-24-23 name=__codelineno-24-23 href=#__codelineno-24-23></a>    804c:    e5933000     ldr    r3, [r3]
<a id=__codelineno-24-24 name=__codelineno-24-24 href=#__codelineno-24-24></a>    8050:    e59f2070     ldr    r2, [pc, #112]    ; 80c8 &lt;main+0xc8&gt;
<a id=__codelineno-24-25 name=__codelineno-24-25 href=#__codelineno-24-25></a>    8054:    e1530002     cmp    r3, r2
<a id=__codelineno-24-26 name=__codelineno-24-26 href=#__codelineno-24-26></a>    8058:    9afffff5     bls    8034 &lt;main+0x34&gt;
<a id=__codelineno-24-27 name=__codelineno-24-27 href=#__codelineno-24-27></a>    805c:    e59f305c     ldr    r3, [pc, #92]    ; 80c0 &lt;main+0xc0&gt;
<a id=__codelineno-24-28 name=__codelineno-24-28 href=#__codelineno-24-28></a>    8060:    e5933000     ldr    r3, [r3]
<a id=__codelineno-24-29 name=__codelineno-24-29 href=#__codelineno-24-29></a>    8064:    e283302c     add    r3, r3, #44    ; 0x2c
<a id=__codelineno-24-30 name=__codelineno-24-30 href=#__codelineno-24-30></a>    8068:    e3a02902     mov    r2, #32768    ; 0x8000
<a id=__codelineno-24-31 name=__codelineno-24-31 href=#__codelineno-24-31></a>    806c:    e5832000     str    r2, [r3]
<a id=__codelineno-24-32 name=__codelineno-24-32 href=#__codelineno-24-32></a>    8070:    e59f304c     ldr    r3, [pc, #76]    ; 80c4 &lt;main+0xc4&gt;
<a id=__codelineno-24-33 name=__codelineno-24-33 href=#__codelineno-24-33></a>    8074:    e3a02000     mov    r2, #0
<a id=__codelineno-24-34 name=__codelineno-24-34 href=#__codelineno-24-34></a>    8078:    e5832000     str    r2, [r3]
<a id=__codelineno-24-35 name=__codelineno-24-35 href=#__codelineno-24-35></a>    807c:    ea000004     b    8094 &lt;main+0x94&gt;
<a id=__codelineno-24-36 name=__codelineno-24-36 href=#__codelineno-24-36></a>    8080:    e59f303c     ldr    r3, [pc, #60]    ; 80c4 &lt;main+0xc4&gt;
<a id=__codelineno-24-37 name=__codelineno-24-37 href=#__codelineno-24-37></a>    8084:    e5933000     ldr    r3, [r3]
<a id=__codelineno-24-38 name=__codelineno-24-38 href=#__codelineno-24-38></a>    8088:    e2833001     add    r3, r3, #1
<a id=__codelineno-24-39 name=__codelineno-24-39 href=#__codelineno-24-39></a>    808c:    e59f2030     ldr    r2, [pc, #48]    ; 80c4 &lt;main+0xc4&gt;
<a id=__codelineno-24-40 name=__codelineno-24-40 href=#__codelineno-24-40></a>    8090:    e5823000     str    r3, [r2]
<a id=__codelineno-24-41 name=__codelineno-24-41 href=#__codelineno-24-41></a>    8094:    e59f3028     ldr    r3, [pc, #40]    ; 80c4 &lt;main+0xc4&gt;
<a id=__codelineno-24-42 name=__codelineno-24-42 href=#__codelineno-24-42></a>    8098:    e5933000     ldr    r3, [r3]
<a id=__codelineno-24-43 name=__codelineno-24-43 href=#__codelineno-24-43></a>    809c:    e59f2024     ldr    r2, [pc, #36]    ; 80c8 &lt;main+0xc8&gt;
<a id=__codelineno-24-44 name=__codelineno-24-44 href=#__codelineno-24-44></a>    80a0:    e1530002     cmp    r3, r2
<a id=__codelineno-24-45 name=__codelineno-24-45 href=#__codelineno-24-45></a>    80a4:    9afffff5     bls    8080 &lt;main+0x80&gt;
<a id=__codelineno-24-46 name=__codelineno-24-46 href=#__codelineno-24-46></a>    80a8:    e59f3010     ldr    r3, [pc, #16]    ; 80c0 &lt;main+0xc0&gt;
<a id=__codelineno-24-47 name=__codelineno-24-47 href=#__codelineno-24-47></a>    80ac:    e5933000     ldr    r3, [r3]
<a id=__codelineno-24-48 name=__codelineno-24-48 href=#__codelineno-24-48></a>    80b0:    e2833020     add    r3, r3, #32
<a id=__codelineno-24-49 name=__codelineno-24-49 href=#__codelineno-24-49></a>    80b4:    e3a02902     mov    r2, #32768    ; 0x8000
<a id=__codelineno-24-50 name=__codelineno-24-50 href=#__codelineno-24-50></a>    80b8:    e5832000     str    r2, [r3]
<a id=__codelineno-24-51 name=__codelineno-24-51 href=#__codelineno-24-51></a>    80bc:    eaffffd8     b    8024 &lt;main+0x24&gt;
<a id=__codelineno-24-52 name=__codelineno-24-52 href=#__codelineno-24-52></a>    80c0:    000080cc     andeq    r8, r0, ip, asr #1
<a id=__codelineno-24-53 name=__codelineno-24-53 href=#__codelineno-24-53></a>    80c4:    000080d0     ldrdeq    r8, [r0], -r0
<a id=__codelineno-24-54 name=__codelineno-24-54 href=#__codelineno-24-54></a>    80c8:    0007a11f     andeq    sl, r7, pc, lsl r1
<a id=__codelineno-24-55 name=__codelineno-24-55 href=#__codelineno-24-55></a>
<a id=__codelineno-24-56 name=__codelineno-24-56 href=#__codelineno-24-56></a>Disassembly of section .data:
<a id=__codelineno-24-57 name=__codelineno-24-57 href=#__codelineno-24-57></a>
<a id=__codelineno-24-58 name=__codelineno-24-58 href=#__codelineno-24-58></a>000080cc &lt;gpio&gt;:
<a id=__codelineno-24-59 name=__codelineno-24-59 href=#__codelineno-24-59></a>    80cc:    20200000     eorcs    r0, r0, r0
<a id=__codelineno-24-60 name=__codelineno-24-60 href=#__codelineno-24-60></a>
<a id=__codelineno-24-61 name=__codelineno-24-61 href=#__codelineno-24-61></a>Disassembly of section .bss:
<a id=__codelineno-24-62 name=__codelineno-24-62 href=#__codelineno-24-62></a>
<a id=__codelineno-24-63 name=__codelineno-24-63 href=#__codelineno-24-63></a>000080d0 &lt;tim&gt;:
<a id=__codelineno-24-64 name=__codelineno-24-64 href=#__codelineno-24-64></a>    80d0:    00000000     andeq    r0, r0, r0
</code></pre></div> <p>Use the <a href=https://documentation-service.arm.com/static/5ed66080ca06a95ce53f932d>ARM instruction set quick reference card</a> to decypher if you're not familiar with ARM assembler.</p> <p>By the way, as a quick note - the comment in the linker script is entirely useless as it only describes what the code is doing, the worst type of comment! There is no <em>WHY</em> in the comment. Why are we wanting to do this? What's the reason for forcing the alignment? Anyway this alignment was forcing the <code>0x8000</code> additional offset to our rodata (initialised data) section.</p> <p>Cool, now the initialised data is tagged immediately on the end of the data and the values look sane too! I'll leave you to decode the assembly.</p> <h2 id=part-2armc-07>part-2/armc-07<a class=headerlink href=#part-2armc-07 title="Permanent link">&para;</a></h2> <p>The code here is the same as <code>armc-06.c</code>. Nothing has changed, we'll just modify our linker script. At this point, we can get rid of the annoying _start undefined symbol warning. At the top of the linker script, on line 9 you'll see a line that says <code>ENTRY(_start)</code></p> <p>In <code>armc-07</code> we've changed this to read <code>ENTRY(main)</code></p> <p>The warning will go away at last! But we'll soon learn why we need that <code>_start</code> section for the C-Runtime anyway!</p> <p>Have a quick check of the sections with nm again, now there's no Undefined sections!</p> <div class=highlight><pre><span></span><code><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a><span class=go>part-2/armc-07 $ ./build.sh rpi0</span>
<a id=__codelineno-25-2 name=__codelineno-25-2 href=#__codelineno-25-2></a>
<a id=__codelineno-25-3 name=__codelineno-25-3 href=#__codelineno-25-3></a><span class=go>arm-none-eabi-gcc -g -nostartfiles -mfloat-abi=hard -O0 -DRPI0 -mfpu=vfp -march=armv6zk \</span>
<a id=__codelineno-25-4 name=__codelineno-25-4 href=#__codelineno-25-4></a><span class=go>    -mtune=arm1176jzf-s part-2/armc-07/*.c -o part-2/armc-07/kernel.armc-07.rpi0.elf</span>
<a id=__codelineno-25-5 name=__codelineno-25-5 href=#__codelineno-25-5></a>
<a id=__codelineno-25-6 name=__codelineno-25-6 href=#__codelineno-25-6></a><span class=go>arm-none-eabi-objcopy part-2/armc-07/kernel.armc-07.rpi0.elf -O binary \</span>
<a id=__codelineno-25-7 name=__codelineno-25-7 href=#__codelineno-25-7></a><span class=go>    part-2/armc-07/kernel.armc-07.rpi0.img</span>
</code></pre></div> <div class=highlight><pre><span></span><code><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a><span class=go>part-2/armc-07 $ ./disassemble.sh</span>
</code></pre></div> <div class=highlight><pre><span></span><code><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a><span class=go>part-2/armc-07 $ cat ./kernel.armc-07.rpi0.elf.nm</span>
<a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a><span class=go>000080d4 B __bss_end__</span>
<a id=__codelineno-27-3 name=__codelineno-27-3 href=#__codelineno-27-3></a><span class=go>000080d4 B _bss_end__</span>
<a id=__codelineno-27-4 name=__codelineno-27-4 href=#__codelineno-27-4></a><span class=go>000080d0 B __bss_start</span>
<a id=__codelineno-27-5 name=__codelineno-27-5 href=#__codelineno-27-5></a><span class=go>000080d0 B __bss_start__</span>
<a id=__codelineno-27-6 name=__codelineno-27-6 href=#__codelineno-27-6></a><span class=go>000080cc D __data_start</span>
<a id=__codelineno-27-7 name=__codelineno-27-7 href=#__codelineno-27-7></a><span class=go>000080d0 D _edata</span>
<a id=__codelineno-27-8 name=__codelineno-27-8 href=#__codelineno-27-8></a><span class=go>000080d4 B _end</span>
<a id=__codelineno-27-9 name=__codelineno-27-9 href=#__codelineno-27-9></a><span class=go>000080d4 B __end__</span>
<a id=__codelineno-27-10 name=__codelineno-27-10 href=#__codelineno-27-10></a><span class=go>000080cc D gpio</span>
<a id=__codelineno-27-11 name=__codelineno-27-11 href=#__codelineno-27-11></a><span class=go>00008000 T main</span>
<a id=__codelineno-27-12 name=__codelineno-27-12 href=#__codelineno-27-12></a><span class=go>00080000 N _stack</span>
<a id=__codelineno-27-13 name=__codelineno-27-13 href=#__codelineno-27-13></a><span class=go>000080d0 B tim</span>
</code></pre></div> <h2 id=sections-and-c-startup>Sections and C Startup<a class=headerlink href=#sections-and-c-startup title="Permanent link">&para;</a></h2> <p>As we've found out, there are a lot of sections, some which you may not know the meaning of. The <code>.bss</code> section is used for data that is implicitly initialised to 0 at startup (This is mandated by the C Standard). This means that all variables that are statically declared are set to zero initially. Statically declared essentially means global, so local (automatic) variables in a function that are not marked as static do not get initialised to zero if you do not explicitly add an initial value. It's easier with an example, take for example the following C file:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a><span class=w>    </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>var1</span><span class=p>;</span>
<a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a><span class=w>    </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>var2</span><span class=p>;</span>
<a id=__codelineno-28-3 name=__codelineno-28-3 href=#__codelineno-28-3></a><span class=w>    </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>var3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>10</span><span class=p>;</span>
<a id=__codelineno-28-4 name=__codelineno-28-4 href=#__codelineno-28-4></a>
<a id=__codelineno-28-5 name=__codelineno-28-5 href=#__codelineno-28-5></a><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>function</span><span class=p>(</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=p>)</span>
<a id=__codelineno-28-6 name=__codelineno-28-6 href=#__codelineno-28-6></a><span class=w>    </span><span class=p>{</span>
<a id=__codelineno-28-7 name=__codelineno-28-7 href=#__codelineno-28-7></a><span class=w>        </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>funcvar1</span><span class=p>;</span>
<a id=__codelineno-28-8 name=__codelineno-28-8 href=#__codelineno-28-8></a><span class=w>        </span><span class=k>static</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>funcvar2</span><span class=p>;</span>
<a id=__codelineno-28-9 name=__codelineno-28-9 href=#__codelineno-28-9></a>
<a id=__codelineno-28-10 name=__codelineno-28-10 href=#__codelineno-28-10></a><span class=w>        </span><span class=cm>/* ... */</span>
<a id=__codelineno-28-11 name=__codelineno-28-11 href=#__codelineno-28-11></a>
<a id=__codelineno-28-12 name=__codelineno-28-12 href=#__codelineno-28-12></a><span class=w>    </span><span class=p>}</span>
</code></pre></div> <p>In the above example var1, var2 and funcvar2 are in the bss section, the rest are not. For more information on the bss section, see the <a href=http://en.wikipedia.org/wiki/.bss>wikipedia page on it</a></p> <p>The linker organises the data and sorts it out into the different sections. In the above, var3 for example goes into the data section. The code is compiled into machine code and then put in the <code>.text</code> section. See <a href=http://en.wikipedia.org/wiki/Code_segment>here</a> for "a little!" more information about the text section. There can be many text sections and there can be many data sections too. These sections are wild-carded in the linker script to ensure different sections can be defined whilst still knowing whether they are code or data sections.</p> <p>In our current code (armc-07) the bss section is not valid because it is not being initialised. That's because the C-Startup is missing. This is the importance of the <code>_start</code> symbol!</p> <p>The <code>_start</code> section is run before the c main() entry point and one of it's jobs is to initialise the bss section. The linker provides us with a couple of symbols for the sections so we know where they start and end. In the startup code all we need to do is loop between the addresses defined by <code>bss_start</code> and <code>bss_end</code> and set all locations to zero. It's easy when you know what you're meant to do!</p> <p>The <code>_startup</code> code should also setup the stack pointer. We'll need a working stack to get anything useful up and working! The stack is temporary memory space available for functions to use. The compiler tries to use registers for local (automatic) function variables, but if the size of data required by the local variables exceeds the amount of registers available, the compiler uses the stack for the local variables.</p> <p>So lets go ahead and setup the stack pointer to a sane value and initialise the bss section.</p> <p>Firstly, we'll set the linker script back to standard so the entry point is the <code>_start</code> symbol again, we'll have to generate this symbol and generally we'll need to do this is assembler. We need to setup the stack pointer before we enter the C code so that we're safe to write C which may attempt to use the stack straight away.</p> <p>Normally the complete startup is done in assembler, including zeroing the bss section, but it doesn't have to! I prefer to get into C as soon as possible, so let's see how little assembler we can get away with, and see what trips us up next!</p> <h2 id=armc-08-starts>armc-08-start.S<a class=headerlink href=#armc-08-starts title="Permanent link">&para;</a></h2> <div class=highlight><pre><span></span><code><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a>.section &quot;.text.startup&quot;
<a id=__codelineno-29-2 name=__codelineno-29-2 href=#__codelineno-29-2></a>
<a id=__codelineno-29-3 name=__codelineno-29-3 href=#__codelineno-29-3></a>.global _start
<a id=__codelineno-29-4 name=__codelineno-29-4 href=#__codelineno-29-4></a>
<a id=__codelineno-29-5 name=__codelineno-29-5 href=#__codelineno-29-5></a>_start:
<a id=__codelineno-29-6 name=__codelineno-29-6 href=#__codelineno-29-6></a>    // Set the stack pointer, which progresses downwards through memory
<a id=__codelineno-29-7 name=__codelineno-29-7 href=#__codelineno-29-7></a>    // Set it at 64MB which we know our application will not crash into
<a id=__codelineno-29-8 name=__codelineno-29-8 href=#__codelineno-29-8></a>    // and we also know will be available to the ARM CPU. No matter what
<a id=__codelineno-29-9 name=__codelineno-29-9 href=#__codelineno-29-9></a>    // settings we use to split the memory between the GPU and ARM CPU
<a id=__codelineno-29-10 name=__codelineno-29-10 href=#__codelineno-29-10></a>    ldr     sp, =0x8000
<a id=__codelineno-29-11 name=__codelineno-29-11 href=#__codelineno-29-11></a>
<a id=__codelineno-29-12 name=__codelineno-29-12 href=#__codelineno-29-12></a>    // Run the c startup function - should not return and will call kernel_main
<a id=__codelineno-29-13 name=__codelineno-29-13 href=#__codelineno-29-13></a>    b       _cstartup
<a id=__codelineno-29-14 name=__codelineno-29-14 href=#__codelineno-29-14></a>
<a id=__codelineno-29-15 name=__codelineno-29-15 href=#__codelineno-29-15></a>_inf_loop:
<a id=__codelineno-29-16 name=__codelineno-29-16 href=#__codelineno-29-16></a>    b       _inf_loop
</code></pre></div> <p>Not bad! There's not exactly a lot there to set up the stack pointer. The stack is placed at the start of our program and grows downwards through memory. You don't need a large amount of memory for the stack.</p> <p>Some important information about the <code>.section</code> declaration. With the linker script, I can see in <code>rpi.x</code> that the following text sections are available:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-30-1 name=__codelineno-30-1 href=#__codelineno-30-1></a>.text           :
<a id=__codelineno-30-2 name=__codelineno-30-2 href=#__codelineno-30-2></a>{
<a id=__codelineno-30-3 name=__codelineno-30-3 href=#__codelineno-30-3></a>  *(.text.unlikely .text.*_unlikely .text.unlikely.*)
<a id=__codelineno-30-4 name=__codelineno-30-4 href=#__codelineno-30-4></a>  *(.text.exit .text.exit.*)
<a id=__codelineno-30-5 name=__codelineno-30-5 href=#__codelineno-30-5></a>  *(.text.startup .text.startup.*)
<a id=__codelineno-30-6 name=__codelineno-30-6 href=#__codelineno-30-6></a>  *(.text.hot .text.hot.*)
<a id=__codelineno-30-7 name=__codelineno-30-7 href=#__codelineno-30-7></a>  *(.text .stub .text.* .gnu.linkonce.t.*)
<a id=__codelineno-30-8 name=__codelineno-30-8 href=#__codelineno-30-8></a>  /* .gnu.warning sections are handled specially by elf32.em.  */
<a id=__codelineno-30-9 name=__codelineno-30-9 href=#__codelineno-30-9></a>  *(.gnu.warning)
<a id=__codelineno-30-10 name=__codelineno-30-10 href=#__codelineno-30-10></a>  *(.glue_7t) *(.glue_7) *(.vfp11_veneer) *(.v4_bx)
<a id=__codelineno-30-11 name=__codelineno-30-11 href=#__codelineno-30-11></a>}
</code></pre></div> <p>This is also the order in which the text section is linked together by the linker. The standard functions generally go in the standard <code>.text</code> section. Therefore, we can put our <code>_startup</code> function before the main <code>.text</code> section by putting it in the <code>.text.startup</code> section. Other than <code>.text.unlikely</code> and <code>text.exit</code> which we won't use, <code>_startup</code> will be the first thing to go into the text segment which is where execution will start at <code>0x8000</code></p> <p>Then, we're in C for initialising the bss section by running the <code>cstartup</code> function:</p> <h2 id=armc-08-cstartupc>armc-08-cstartup.c<a class=headerlink href=#armc-08-cstartupc title="Permanent link">&para;</a></h2> <div class=highlight><pre><span></span><code><a id=__codelineno-31-1 name=__codelineno-31-1 href=#__codelineno-31-1></a><span class=k>extern</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>__bss_start__</span><span class=p>;</span>
<a id=__codelineno-31-2 name=__codelineno-31-2 href=#__codelineno-31-2></a><span class=k>extern</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>__bss_end__</span><span class=p>;</span>
<a id=__codelineno-31-3 name=__codelineno-31-3 href=#__codelineno-31-3></a>
<a id=__codelineno-31-4 name=__codelineno-31-4 href=#__codelineno-31-4></a><span class=k>extern</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>kernel_main</span><span class=p>(</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>r0</span><span class=p>,</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>r1</span><span class=p>,</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>atags</span><span class=w> </span><span class=p>);</span>
<a id=__codelineno-31-5 name=__codelineno-31-5 href=#__codelineno-31-5></a>
<a id=__codelineno-31-6 name=__codelineno-31-6 href=#__codelineno-31-6></a><span class=kt>void</span><span class=w> </span><span class=nf>_cstartup</span><span class=p>(</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>r0</span><span class=p>,</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>r1</span><span class=p>,</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>r2</span><span class=w> </span><span class=p>)</span>
<a id=__codelineno-31-7 name=__codelineno-31-7 href=#__codelineno-31-7></a><span class=p>{</span>
<a id=__codelineno-31-8 name=__codelineno-31-8 href=#__codelineno-31-8></a><span class=w>    </span><span class=cm>/*__bss_start__ and __bss_end__ are defined in the linker script */</span>
<a id=__codelineno-31-9 name=__codelineno-31-9 href=#__codelineno-31-9></a><span class=w>    </span><span class=kt>int</span><span class=o>*</span><span class=w> </span><span class=n>bss</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=n>__bss_start__</span><span class=p>;</span>
<a id=__codelineno-31-10 name=__codelineno-31-10 href=#__codelineno-31-10></a><span class=w>    </span><span class=kt>int</span><span class=o>*</span><span class=w> </span><span class=n>bss_end</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=n>__bss_end__</span><span class=p>;</span>
<a id=__codelineno-31-11 name=__codelineno-31-11 href=#__codelineno-31-11></a>
<a id=__codelineno-31-12 name=__codelineno-31-12 href=#__codelineno-31-12></a><span class=w>    </span><span class=cm>/*</span>
<a id=__codelineno-31-13 name=__codelineno-31-13 href=#__codelineno-31-13></a><span class=cm>        Clear the BSS section</span>
<a id=__codelineno-31-14 name=__codelineno-31-14 href=#__codelineno-31-14></a>
<a id=__codelineno-31-15 name=__codelineno-31-15 href=#__codelineno-31-15></a><span class=cm>        See http://en.wikipedia.org/wiki/.bss for further information on the</span>
<a id=__codelineno-31-16 name=__codelineno-31-16 href=#__codelineno-31-16></a><span class=cm>            BSS section</span>
<a id=__codelineno-31-17 name=__codelineno-31-17 href=#__codelineno-31-17></a>
<a id=__codelineno-31-18 name=__codelineno-31-18 href=#__codelineno-31-18></a><span class=cm>        See https://sourceware.org/newlib/libc.html#Stubs for further</span>
<a id=__codelineno-31-19 name=__codelineno-31-19 href=#__codelineno-31-19></a><span class=cm>            information on the c-library stubs</span>
<a id=__codelineno-31-20 name=__codelineno-31-20 href=#__codelineno-31-20></a><span class=cm>    */</span>
<a id=__codelineno-31-21 name=__codelineno-31-21 href=#__codelineno-31-21></a><span class=w>    </span><span class=k>while</span><span class=p>(</span><span class=w> </span><span class=n>bss</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>bss_end</span><span class=w> </span><span class=p>)</span>
<a id=__codelineno-31-22 name=__codelineno-31-22 href=#__codelineno-31-22></a><span class=w>        </span><span class=o>*</span><span class=n>bss</span><span class=o>++</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
<a id=__codelineno-31-23 name=__codelineno-31-23 href=#__codelineno-31-23></a>
<a id=__codelineno-31-24 name=__codelineno-31-24 href=#__codelineno-31-24></a><span class=w>    </span><span class=cm>/* We should never return from main ... */</span>
<a id=__codelineno-31-25 name=__codelineno-31-25 href=#__codelineno-31-25></a><span class=w>    </span><span class=n>kernel_main</span><span class=p>(</span><span class=w> </span><span class=n>r0</span><span class=p>,</span><span class=w> </span><span class=n>r1</span><span class=p>,</span><span class=w> </span><span class=n>r2</span><span class=w> </span><span class=p>);</span>
<a id=__codelineno-31-26 name=__codelineno-31-26 href=#__codelineno-31-26></a>
<a id=__codelineno-31-27 name=__codelineno-31-27 href=#__codelineno-31-27></a><span class=w>    </span><span class=cm>/* ... but if we do, safely trap here */</span>
<a id=__codelineno-31-28 name=__codelineno-31-28 href=#__codelineno-31-28></a><span class=w>    </span><span class=k>while</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<a id=__codelineno-31-29 name=__codelineno-31-29 href=#__codelineno-31-29></a><span class=w>    </span><span class=p>{</span>
<a id=__codelineno-31-30 name=__codelineno-31-30 href=#__codelineno-31-30></a><span class=w>        </span><span class=cm>/* EMPTY! */</span>
<a id=__codelineno-31-31 name=__codelineno-31-31 href=#__codelineno-31-31></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-31-32 name=__codelineno-31-32 href=#__codelineno-31-32></a><span class=p>}</span>
</code></pre></div> <p>Again, not that bad and pretty reasonable. <strong>NOTE:</strong> We've now changed from main to <code>kernel_main</code>, and there's a reason for this - the bootloader is actually expecting a slightly different entry definition compared to the standard C main function. So as we're setting up our own C-Runtime anyway, we can define the correct entry format. The correct bootloader entry point defines a couple of values which we can check to know what system we're booting.</p> <p>The actual C code hasn't really changed apart from the <code>kernel_main</code> difference:</p> <h2 id=armc-08c>armc-08.c<a class=headerlink href=#armc-08c title="Permanent link">&para;</a></h2> <div class=highlight><pre><span></span><code><a id=__codelineno-32-1 name=__codelineno-32-1 href=#__codelineno-32-1></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;rpi-gpio.h&quot;</span>
<a id=__codelineno-32-2 name=__codelineno-32-2 href=#__codelineno-32-2></a>
<a id=__codelineno-32-3 name=__codelineno-32-3 href=#__codelineno-32-3></a><span class=cm>/** GPIO Register set */</span>
<a id=__codelineno-32-4 name=__codelineno-32-4 href=#__codelineno-32-4></a><span class=k>volatile</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=o>*</span><span class=w> </span><span class=n>gpio</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=o>*</span><span class=p>)</span><span class=n>GPIO_BASE</span><span class=p>;</span>
<a id=__codelineno-32-5 name=__codelineno-32-5 href=#__codelineno-32-5></a>
<a id=__codelineno-32-6 name=__codelineno-32-6 href=#__codelineno-32-6></a><span class=cm>/** Simple loop variable */</span>
<a id=__codelineno-32-7 name=__codelineno-32-7 href=#__codelineno-32-7></a><span class=k>volatile</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>tim</span><span class=p>;</span>
<a id=__codelineno-32-8 name=__codelineno-32-8 href=#__codelineno-32-8></a>
<a id=__codelineno-32-9 name=__codelineno-32-9 href=#__codelineno-32-9></a><span class=cm>/** Main function - we&#39;ll never return from here */</span>
<a id=__codelineno-32-10 name=__codelineno-32-10 href=#__codelineno-32-10></a><span class=kt>void</span><span class=w> </span><span class=nf>kernel_main</span><span class=p>(</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>r0</span><span class=p>,</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>r1</span><span class=p>,</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>atags</span><span class=w> </span><span class=p>)</span>
<a id=__codelineno-32-11 name=__codelineno-32-11 href=#__codelineno-32-11></a><span class=p>{</span>
<a id=__codelineno-32-12 name=__codelineno-32-12 href=#__codelineno-32-12></a><span class=w>    </span><span class=cm>/* Write 1 to the GPIO16 init nibble in the Function Select 1 GPIO</span>
<a id=__codelineno-32-13 name=__codelineno-32-13 href=#__codelineno-32-13></a><span class=cm>       peripheral register to enable GPIO16 as an output */</span>
<a id=__codelineno-32-14 name=__codelineno-32-14 href=#__codelineno-32-14></a><span class=w>    </span><span class=n>gpio</span><span class=p>[</span><span class=n>LED_GPFSEL</span><span class=p>]</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>LED_GPFBIT</span><span class=p>);</span>
<a id=__codelineno-32-15 name=__codelineno-32-15 href=#__codelineno-32-15></a>
<a id=__codelineno-32-16 name=__codelineno-32-16 href=#__codelineno-32-16></a><span class=w>    </span><span class=cm>/* Never exit as there is no OS to exit to! */</span>
<a id=__codelineno-32-17 name=__codelineno-32-17 href=#__codelineno-32-17></a><span class=w>    </span><span class=k>while</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<a id=__codelineno-32-18 name=__codelineno-32-18 href=#__codelineno-32-18></a><span class=w>    </span><span class=p>{</span>
<a id=__codelineno-32-19 name=__codelineno-32-19 href=#__codelineno-32-19></a><span class=w>        </span><span class=k>for</span><span class=p>(</span><span class=n>tim</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>tim</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>500000</span><span class=p>;</span><span class=w> </span><span class=n>tim</span><span class=o>++</span><span class=p>)</span>
<a id=__codelineno-32-20 name=__codelineno-32-20 href=#__codelineno-32-20></a><span class=w>            </span><span class=p>;</span>
<a id=__codelineno-32-21 name=__codelineno-32-21 href=#__codelineno-32-21></a>
<a id=__codelineno-32-22 name=__codelineno-32-22 href=#__codelineno-32-22></a><span class=w>        </span><span class=cm>/* Set the LED GPIO pin low ( Turn OK LED on for original Pi, and off</span>
<a id=__codelineno-32-23 name=__codelineno-32-23 href=#__codelineno-32-23></a><span class=cm>           for plus models )*/</span>
<a id=__codelineno-32-24 name=__codelineno-32-24 href=#__codelineno-32-24></a><span class=w>        </span><span class=n>gpio</span><span class=p>[</span><span class=n>LED_GPCLR</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>LED_GPIO_BIT</span><span class=p>);</span>
<a id=__codelineno-32-25 name=__codelineno-32-25 href=#__codelineno-32-25></a>
<a id=__codelineno-32-26 name=__codelineno-32-26 href=#__codelineno-32-26></a><span class=w>        </span><span class=k>for</span><span class=p>(</span><span class=n>tim</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>tim</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>500000</span><span class=p>;</span><span class=w> </span><span class=n>tim</span><span class=o>++</span><span class=p>)</span>
<a id=__codelineno-32-27 name=__codelineno-32-27 href=#__codelineno-32-27></a><span class=w>            </span><span class=p>;</span>
<a id=__codelineno-32-28 name=__codelineno-32-28 href=#__codelineno-32-28></a>
<a id=__codelineno-32-29 name=__codelineno-32-29 href=#__codelineno-32-29></a><span class=w>        </span><span class=cm>/* Set the LED GPIO pin high ( Turn OK LED off for original Pi, and on</span>
<a id=__codelineno-32-30 name=__codelineno-32-30 href=#__codelineno-32-30></a><span class=cm>           for plus models )*/</span>
<a id=__codelineno-32-31 name=__codelineno-32-31 href=#__codelineno-32-31></a><span class=w>        </span><span class=n>gpio</span><span class=p>[</span><span class=n>LED_GPSET</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>LED_GPIO_BIT</span><span class=p>);</span>
<a id=__codelineno-32-32 name=__codelineno-32-32 href=#__codelineno-32-32></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-32-33 name=__codelineno-32-33 href=#__codelineno-32-33></a><span class=p>}</span>
</code></pre></div> <p>We again confirm with nm that everything is ordered at least something like sensible:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-33-1 name=__codelineno-33-1 href=#__codelineno-33-1></a><span class=go>part-2/armc-08 $ ./build.sh rpi0</span>
<a id=__codelineno-33-2 name=__codelineno-33-2 href=#__codelineno-33-2></a>
<a id=__codelineno-33-3 name=__codelineno-33-3 href=#__codelineno-33-3></a><span class=go>arm-none-eabi-gcc -g -nostartfiles -mfloat-abi=hard -O0 -DRPI0 -mfpu=vfp -march=armv6zk \</span>
<a id=__codelineno-33-4 name=__codelineno-33-4 href=#__codelineno-33-4></a><span class=go>    -mtune=arm1176jzf-s part-2/armc-08/*.S part-2/armc-08/*.c -o part-2/armc-08/kernel.armc-08.rpi0.elf</span>
<a id=__codelineno-33-5 name=__codelineno-33-5 href=#__codelineno-33-5></a>
<a id=__codelineno-33-6 name=__codelineno-33-6 href=#__codelineno-33-6></a><span class=go>arm-none-eabi-objcopy part-2/armc-08/kernel.armc-08.rpi0.elf -O binary \</span>
<a id=__codelineno-33-7 name=__codelineno-33-7 href=#__codelineno-33-7></a><span class=go>    part-2/armc-08/kernel.armc-08.rpi0.img</span>
</code></pre></div> <div class=highlight><pre><span></span><code><a id=__codelineno-34-1 name=__codelineno-34-1 href=#__codelineno-34-1></a><span class=go>part-2/armc-08 $ ./disassemble.sh</span>
</code></pre></div> <div class=highlight><pre><span></span><code><a id=__codelineno-35-1 name=__codelineno-35-1 href=#__codelineno-35-1></a><span class=go>part-2/armc-08 $ cat ./kernel.armc-08.rpi0.elf.nm</span>
<a id=__codelineno-35-2 name=__codelineno-35-2 href=#__codelineno-35-2></a>
<a id=__codelineno-35-3 name=__codelineno-35-3 href=#__codelineno-35-3></a><span class=go>00008164 B __bss_end__</span>
<a id=__codelineno-35-4 name=__codelineno-35-4 href=#__codelineno-35-4></a><span class=go>00008164 B _bss_end__</span>
<a id=__codelineno-35-5 name=__codelineno-35-5 href=#__codelineno-35-5></a><span class=go>00008160 B __bss_start</span>
<a id=__codelineno-35-6 name=__codelineno-35-6 href=#__codelineno-35-6></a><span class=go>00008160 B __bss_start__</span>
<a id=__codelineno-35-7 name=__codelineno-35-7 href=#__codelineno-35-7></a><span class=go>0000800c T _cstartup</span>
<a id=__codelineno-35-8 name=__codelineno-35-8 href=#__codelineno-35-8></a><span class=go>0000815c D __data_start</span>
<a id=__codelineno-35-9 name=__codelineno-35-9 href=#__codelineno-35-9></a><span class=go>00008160 D _edata</span>
<a id=__codelineno-35-10 name=__codelineno-35-10 href=#__codelineno-35-10></a><span class=go>00008164 B _end</span>
<a id=__codelineno-35-11 name=__codelineno-35-11 href=#__codelineno-35-11></a><span class=go>00008164 B __end__</span>
<a id=__codelineno-35-12 name=__codelineno-35-12 href=#__codelineno-35-12></a><span class=go>0000815c D gpio</span>
<a id=__codelineno-35-13 name=__codelineno-35-13 href=#__codelineno-35-13></a><span class=go>00008008 t _inf_loop</span>
<a id=__codelineno-35-14 name=__codelineno-35-14 href=#__codelineno-35-14></a><span class=go>00008078 T kernel_main</span>
<a id=__codelineno-35-15 name=__codelineno-35-15 href=#__codelineno-35-15></a><span class=go>00080000 N _stack</span>
<a id=__codelineno-35-16 name=__codelineno-35-16 href=#__codelineno-35-16></a><span class=go>00008000 T _start</span>
<a id=__codelineno-35-17 name=__codelineno-35-17 href=#__codelineno-35-17></a><span class=go>00008160 B tim</span>
</code></pre></div> <p>Yup, looks good - <code>_start</code> is at <code>0x8000</code> where execution will start. Stick it on the card and make sure the OK LED is blinking still. I appreciate that we're doing a lot of work where you can't see more interesting results - but it'll get better soon, I promise! For now we're getting a great foundation for developing in C for the bare metal Raspberry-Pi. Knowing what your tools are doing is pretty essential!</p> <div class=highlight><pre><span></span><code><a id=__codelineno-36-1 name=__codelineno-36-1 href=#__codelineno-36-1></a><span class=go>part-2/armc-08 $ ./make_card.sh rpi0</span>
<a id=__codelineno-36-2 name=__codelineno-36-2 href=#__codelineno-36-2></a><span class=go>part-2/armc-08 $ cat ./card.armc-08.rpi0.img &gt; /dev/sdg &amp;&amp; sync &amp;&amp; eject /dev/sdg</span>
</code></pre></div> <h2 id=the-c-library-stubs>The C-Library stubs<a class=headerlink href=#the-c-library-stubs title="Permanent link">&para;</a></h2> <p>Now that we've got the C-Runtime pretty much setup, we can implement the C-Library again with our own C-Runtime startup and C-Library stubs. This is where we want to get to - easy compiling with the C-Library being linked in so that we can make use of the C-Library functions on the Raspberry-Pi without an operating system.</p> <p>We are actually linking against the C-Library, but we're not using anything from within it. Therefore, the linker disregards the whole of the C-Library because there are no references to it within the code. Let's jump straight in and malloc some memory as I know that requires a stub. Compile <code>armc-09</code> without the <code>*-cstubs.c</code> and you'll see the error:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-37-1 name=__codelineno-37-1 href=#__codelineno-37-1></a>.../arm-none-eabi/lib/fpu\libg.a(lib_a-sbrkr.o): In function `_sbrk_r&#39;:
<a id=__codelineno-37-2 name=__codelineno-37-2 href=#__codelineno-37-2></a>sbrkr.c:(.text._sbrk_r+0x18): undefined reference to `_sbrk&#39;
<a id=__codelineno-37-3 name=__codelineno-37-3 href=#__codelineno-37-3></a>collect2.exe: error: ld returned 1 exit status
</code></pre></div> <p>So the malloc call is calling something in the c library called <code>_sbrk_r</code> which is a re-entrant safe (or multi-thread/interrupt safe) C library function all called <code>_sbrk</code>. This is the C-stub function that we must implement as it is operating-system dependant.</p> <p>It's worth looking at how other people have implemented these function calls. Look at them to see what they're doing. Generally you can look at other kernel code, or embedded system code:</p> <p><a href=http://www.opensource.apple.com/source/Libc/Libc-763.12/emulated/brk.c>http://www.opensource.apple.com/source/Libc/Libc-763.12/emulated/brk.c</a></p> <p><a href=http://linux.die.net/man/2/sbrk>http://linux.die.net/man/2/sbrk</a></p> <p>However, the best place is if examples are in the C-Library you're using! Newlib is well documented and <a href=https://sourceware.org/newlib/libc.html#Syscalls>includes example minimal systemc calls/stubs</a>.</p> <p>We implement this in the next tutorial <code>armc-09</code></p> <h2 id=armc-09-cstubsc>armc-09-cstubs.c<a class=headerlink href=#armc-09-cstubsc title="Permanent link">&para;</a></h2> <div class=highlight><pre><span></span><code><a id=__codelineno-38-1 name=__codelineno-38-1 href=#__codelineno-38-1></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;sys/stat.h&gt;</span>
<a id=__codelineno-38-2 name=__codelineno-38-2 href=#__codelineno-38-2></a>
<a id=__codelineno-38-3 name=__codelineno-38-3 href=#__codelineno-38-3></a><span class=cm>/* A helper function written in assembler to aid us in allocating memory */</span>
<a id=__codelineno-38-4 name=__codelineno-38-4 href=#__codelineno-38-4></a><span class=k>extern</span><span class=w> </span><span class=n>caddr_t</span><span class=w> </span><span class=nf>_get_stack_pointer</span><span class=p>(</span><span class=kt>void</span><span class=p>);</span>
<a id=__codelineno-38-5 name=__codelineno-38-5 href=#__codelineno-38-5></a>
<a id=__codelineno-38-6 name=__codelineno-38-6 href=#__codelineno-38-6></a>
<a id=__codelineno-38-7 name=__codelineno-38-7 href=#__codelineno-38-7></a><span class=cm>/* Increase program data space. As malloc and related functions depend on this,</span>
<a id=__codelineno-38-8 name=__codelineno-38-8 href=#__codelineno-38-8></a><span class=cm>   it is useful to have a working implementation. The following suffices for a</span>
<a id=__codelineno-38-9 name=__codelineno-38-9 href=#__codelineno-38-9></a><span class=cm>   standalone system; it exploits the symbol _end automatically defined by the</span>
<a id=__codelineno-38-10 name=__codelineno-38-10 href=#__codelineno-38-10></a><span class=cm>   GNU linker. */</span>
<a id=__codelineno-38-11 name=__codelineno-38-11 href=#__codelineno-38-11></a><span class=n>caddr_t</span><span class=w> </span><span class=nf>_sbrk</span><span class=p>(</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>incr</span><span class=w> </span><span class=p>)</span>
<a id=__codelineno-38-12 name=__codelineno-38-12 href=#__codelineno-38-12></a><span class=p>{</span>
<a id=__codelineno-38-13 name=__codelineno-38-13 href=#__codelineno-38-13></a><span class=w>    </span><span class=k>extern</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=n>_end</span><span class=p>;</span>
<a id=__codelineno-38-14 name=__codelineno-38-14 href=#__codelineno-38-14></a><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=kt>char</span><span class=o>*</span><span class=w> </span><span class=n>heap_end</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
<a id=__codelineno-38-15 name=__codelineno-38-15 href=#__codelineno-38-15></a><span class=w>    </span><span class=kt>char</span><span class=o>*</span><span class=w> </span><span class=n>prev_heap_end</span><span class=p>;</span>
<a id=__codelineno-38-16 name=__codelineno-38-16 href=#__codelineno-38-16></a>
<a id=__codelineno-38-17 name=__codelineno-38-17 href=#__codelineno-38-17></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=w> </span><span class=n>heap_end</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>)</span>
<a id=__codelineno-38-18 name=__codelineno-38-18 href=#__codelineno-38-18></a><span class=w>        </span><span class=n>heap_end</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=n>_end</span><span class=p>;</span>
<a id=__codelineno-38-19 name=__codelineno-38-19 href=#__codelineno-38-19></a>
<a id=__codelineno-38-20 name=__codelineno-38-20 href=#__codelineno-38-20></a><span class=w>     </span><span class=n>prev_heap_end</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>heap_end</span><span class=p>;</span>
<a id=__codelineno-38-21 name=__codelineno-38-21 href=#__codelineno-38-21></a>
<a id=__codelineno-38-22 name=__codelineno-38-22 href=#__codelineno-38-22></a><span class=w>     </span><span class=n>heap_end</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>incr</span><span class=p>;</span>
<a id=__codelineno-38-23 name=__codelineno-38-23 href=#__codelineno-38-23></a><span class=w>     </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>caddr_t</span><span class=p>)</span><span class=n>prev_heap_end</span><span class=p>;</span>
<a id=__codelineno-38-24 name=__codelineno-38-24 href=#__codelineno-38-24></a><span class=p>}</span>
</code></pre></div> <h2 id=armc-09-starts>armc-09-start.S<a class=headerlink href=#armc-09-starts title="Permanent link">&para;</a></h2> <div class=highlight><pre><span></span><code><a id=__codelineno-39-1 name=__codelineno-39-1 href=#__codelineno-39-1></a>.section &quot;.text.startup&quot;
<a id=__codelineno-39-2 name=__codelineno-39-2 href=#__codelineno-39-2></a>
<a id=__codelineno-39-3 name=__codelineno-39-3 href=#__codelineno-39-3></a>.global _start
<a id=__codelineno-39-4 name=__codelineno-39-4 href=#__codelineno-39-4></a>.global _get_stack_pointer
<a id=__codelineno-39-5 name=__codelineno-39-5 href=#__codelineno-39-5></a>
<a id=__codelineno-39-6 name=__codelineno-39-6 href=#__codelineno-39-6></a>_start:
<a id=__codelineno-39-7 name=__codelineno-39-7 href=#__codelineno-39-7></a>    // Set it at 64MB which we know our application will not crash into
<a id=__codelineno-39-8 name=__codelineno-39-8 href=#__codelineno-39-8></a>    // and we also know will be available to the ARM CPU. No matter what
<a id=__codelineno-39-9 name=__codelineno-39-9 href=#__codelineno-39-9></a>    // settings we use to split the memory between the GPU and ARM CPU
<a id=__codelineno-39-10 name=__codelineno-39-10 href=#__codelineno-39-10></a>    // ldr     sp, =0x8000
<a id=__codelineno-39-11 name=__codelineno-39-11 href=#__codelineno-39-11></a>    ldr     sp, =(64 * 1024 * 1024)
<a id=__codelineno-39-12 name=__codelineno-39-12 href=#__codelineno-39-12></a>
<a id=__codelineno-39-13 name=__codelineno-39-13 href=#__codelineno-39-13></a>    // Run the c startup function - should not return and will call kernel_main
<a id=__codelineno-39-14 name=__codelineno-39-14 href=#__codelineno-39-14></a>    b       _cstartup
<a id=__codelineno-39-15 name=__codelineno-39-15 href=#__codelineno-39-15></a>
<a id=__codelineno-39-16 name=__codelineno-39-16 href=#__codelineno-39-16></a>_inf_loop:
<a id=__codelineno-39-17 name=__codelineno-39-17 href=#__codelineno-39-17></a>    b       _inf_loop
</code></pre></div> <h2 id=armc-09-cstartupc>armc-09-cstartup.c<a class=headerlink href=#armc-09-cstartupc title="Permanent link">&para;</a></h2> <div class=highlight><pre><span></span><code><a id=__codelineno-40-1 name=__codelineno-40-1 href=#__codelineno-40-1></a><span class=k>extern</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>__bss_start__</span><span class=p>;</span>
<a id=__codelineno-40-2 name=__codelineno-40-2 href=#__codelineno-40-2></a><span class=k>extern</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>__bss_end__</span><span class=p>;</span>
<a id=__codelineno-40-3 name=__codelineno-40-3 href=#__codelineno-40-3></a>
<a id=__codelineno-40-4 name=__codelineno-40-4 href=#__codelineno-40-4></a><span class=k>extern</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>kernel_main</span><span class=p>(</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>r0</span><span class=p>,</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>r1</span><span class=p>,</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>atags</span><span class=w> </span><span class=p>);</span>
<a id=__codelineno-40-5 name=__codelineno-40-5 href=#__codelineno-40-5></a>
<a id=__codelineno-40-6 name=__codelineno-40-6 href=#__codelineno-40-6></a><span class=kt>void</span><span class=w> </span><span class=nf>_cstartup</span><span class=p>(</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>r0</span><span class=p>,</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>r1</span><span class=p>,</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>r2</span><span class=w> </span><span class=p>)</span>
<a id=__codelineno-40-7 name=__codelineno-40-7 href=#__codelineno-40-7></a><span class=p>{</span>
<a id=__codelineno-40-8 name=__codelineno-40-8 href=#__codelineno-40-8></a><span class=w>    </span><span class=cm>/*__bss_start__ and __bss_end__ are defined in the linker script */</span>
<a id=__codelineno-40-9 name=__codelineno-40-9 href=#__codelineno-40-9></a><span class=w>    </span><span class=kt>int</span><span class=o>*</span><span class=w> </span><span class=n>bss</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=n>__bss_start__</span><span class=p>;</span>
<a id=__codelineno-40-10 name=__codelineno-40-10 href=#__codelineno-40-10></a><span class=w>    </span><span class=kt>int</span><span class=o>*</span><span class=w> </span><span class=n>bss_end</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=n>__bss_end__</span><span class=p>;</span>
<a id=__codelineno-40-11 name=__codelineno-40-11 href=#__codelineno-40-11></a>
<a id=__codelineno-40-12 name=__codelineno-40-12 href=#__codelineno-40-12></a><span class=w>    </span><span class=cm>/*</span>
<a id=__codelineno-40-13 name=__codelineno-40-13 href=#__codelineno-40-13></a><span class=cm>        Clear the BSS section</span>
<a id=__codelineno-40-14 name=__codelineno-40-14 href=#__codelineno-40-14></a>
<a id=__codelineno-40-15 name=__codelineno-40-15 href=#__codelineno-40-15></a><span class=cm>        See http://en.wikipedia.org/wiki/.bss for further information on the</span>
<a id=__codelineno-40-16 name=__codelineno-40-16 href=#__codelineno-40-16></a><span class=cm>            BSS section</span>
<a id=__codelineno-40-17 name=__codelineno-40-17 href=#__codelineno-40-17></a>
<a id=__codelineno-40-18 name=__codelineno-40-18 href=#__codelineno-40-18></a><span class=cm>        See https://sourceware.org/newlib/libc.html#Stubs for further</span>
<a id=__codelineno-40-19 name=__codelineno-40-19 href=#__codelineno-40-19></a><span class=cm>            information on the c-library stubs</span>
<a id=__codelineno-40-20 name=__codelineno-40-20 href=#__codelineno-40-20></a><span class=cm>    */</span>
<a id=__codelineno-40-21 name=__codelineno-40-21 href=#__codelineno-40-21></a><span class=w>    </span><span class=k>while</span><span class=p>(</span><span class=w> </span><span class=n>bss</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>bss_end</span><span class=w> </span><span class=p>)</span>
<a id=__codelineno-40-22 name=__codelineno-40-22 href=#__codelineno-40-22></a><span class=w>        </span><span class=o>*</span><span class=n>bss</span><span class=o>++</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
<a id=__codelineno-40-23 name=__codelineno-40-23 href=#__codelineno-40-23></a>
<a id=__codelineno-40-24 name=__codelineno-40-24 href=#__codelineno-40-24></a><span class=w>    </span><span class=cm>/* We should never return from main ... */</span>
<a id=__codelineno-40-25 name=__codelineno-40-25 href=#__codelineno-40-25></a><span class=w>    </span><span class=n>kernel_main</span><span class=p>(</span><span class=w> </span><span class=n>r0</span><span class=p>,</span><span class=w> </span><span class=n>r1</span><span class=p>,</span><span class=w> </span><span class=n>r2</span><span class=w> </span><span class=p>);</span>
<a id=__codelineno-40-26 name=__codelineno-40-26 href=#__codelineno-40-26></a>
<a id=__codelineno-40-27 name=__codelineno-40-27 href=#__codelineno-40-27></a><span class=w>    </span><span class=cm>/* ... but if we do, safely trap here */</span>
<a id=__codelineno-40-28 name=__codelineno-40-28 href=#__codelineno-40-28></a><span class=w>    </span><span class=k>while</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<a id=__codelineno-40-29 name=__codelineno-40-29 href=#__codelineno-40-29></a><span class=w>    </span><span class=p>{</span>
<a id=__codelineno-40-30 name=__codelineno-40-30 href=#__codelineno-40-30></a><span class=w>        </span><span class=cm>/* EMPTY! */</span>
<a id=__codelineno-40-31 name=__codelineno-40-31 href=#__codelineno-40-31></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-40-32 name=__codelineno-40-32 href=#__codelineno-40-32></a><span class=p>}</span>
</code></pre></div> <h2 id=part-2armc-09c>part-2/armc-09.c<a class=headerlink href=#part-2armc-09c title="Permanent link">&para;</a></h2> <div class=highlight><pre><span></span><code><a id=__codelineno-41-1 name=__codelineno-41-1 href=#__codelineno-41-1></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;string.h&gt;</span>
<a id=__codelineno-41-2 name=__codelineno-41-2 href=#__codelineno-41-2></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;stdlib.h&gt;</span>
<a id=__codelineno-41-3 name=__codelineno-41-3 href=#__codelineno-41-3></a>
<a id=__codelineno-41-4 name=__codelineno-41-4 href=#__codelineno-41-4></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;rpi-gpio.h&quot;</span>
<a id=__codelineno-41-5 name=__codelineno-41-5 href=#__codelineno-41-5></a>
<a id=__codelineno-41-6 name=__codelineno-41-6 href=#__codelineno-41-6></a><span class=cm>/** GPIO Register set */</span>
<a id=__codelineno-41-7 name=__codelineno-41-7 href=#__codelineno-41-7></a><span class=k>volatile</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=o>*</span><span class=w> </span><span class=n>gpio</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=o>*</span><span class=p>)</span><span class=n>GPIO_BASE</span><span class=p>;</span>
<a id=__codelineno-41-8 name=__codelineno-41-8 href=#__codelineno-41-8></a>
<a id=__codelineno-41-9 name=__codelineno-41-9 href=#__codelineno-41-9></a><span class=cm>/** Main function - we&#39;ll never return from here */</span>
<a id=__codelineno-41-10 name=__codelineno-41-10 href=#__codelineno-41-10></a><span class=kt>void</span><span class=w> </span><span class=nf>kernel_main</span><span class=p>(</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>r0</span><span class=p>,</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>r1</span><span class=p>,</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>atags</span><span class=w> </span><span class=p>)</span>
<a id=__codelineno-41-11 name=__codelineno-41-11 href=#__codelineno-41-11></a><span class=p>{</span>
<a id=__codelineno-41-12 name=__codelineno-41-12 href=#__codelineno-41-12></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>loop</span><span class=p>;</span>
<a id=__codelineno-41-13 name=__codelineno-41-13 href=#__codelineno-41-13></a><span class=w>    </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=o>*</span><span class=w> </span><span class=n>counters</span><span class=p>;</span>
<a id=__codelineno-41-14 name=__codelineno-41-14 href=#__codelineno-41-14></a>
<a id=__codelineno-41-15 name=__codelineno-41-15 href=#__codelineno-41-15></a><span class=w>    </span><span class=cm>/* Set the LED GPIO pin to an output to drive the LED */</span>
<a id=__codelineno-41-16 name=__codelineno-41-16 href=#__codelineno-41-16></a><span class=w>    </span><span class=n>gpio</span><span class=p>[</span><span class=n>LED_GPFSEL</span><span class=p>]</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>LED_GPFBIT</span><span class=w> </span><span class=p>);</span>
<a id=__codelineno-41-17 name=__codelineno-41-17 href=#__codelineno-41-17></a>
<a id=__codelineno-41-18 name=__codelineno-41-18 href=#__codelineno-41-18></a><span class=w>    </span><span class=cm>/* Allocate a block of memory for counters */</span>
<a id=__codelineno-41-19 name=__codelineno-41-19 href=#__codelineno-41-19></a><span class=w>    </span><span class=n>counters</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>malloc</span><span class=p>(</span><span class=w> </span><span class=mi>1024</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=p>);</span>
<a id=__codelineno-41-20 name=__codelineno-41-20 href=#__codelineno-41-20></a>
<a id=__codelineno-41-21 name=__codelineno-41-21 href=#__codelineno-41-21></a><span class=w>    </span><span class=cm>/* Failed to allocate memory! */</span>
<a id=__codelineno-41-22 name=__codelineno-41-22 href=#__codelineno-41-22></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=w> </span><span class=n>counters</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>NULL</span><span class=w> </span><span class=p>)</span>
<a id=__codelineno-41-23 name=__codelineno-41-23 href=#__codelineno-41-23></a><span class=w>        </span><span class=k>while</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>     </span><span class=n>LED_ON</span><span class=p>();</span><span class=cm>/* Trap here */</span><span class=w> </span><span class=p>}</span>
<a id=__codelineno-41-24 name=__codelineno-41-24 href=#__codelineno-41-24></a>
<a id=__codelineno-41-25 name=__codelineno-41-25 href=#__codelineno-41-25></a><span class=w>    </span><span class=k>for</span><span class=p>(</span><span class=w> </span><span class=n>loop</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>loop</span><span class=o>&lt;</span><span class=mi>1024</span><span class=p>;</span><span class=w> </span><span class=n>loop</span><span class=o>++</span><span class=w> </span><span class=p>)</span>
<a id=__codelineno-41-26 name=__codelineno-41-26 href=#__codelineno-41-26></a><span class=w>        </span><span class=n>counters</span><span class=p>[</span><span class=n>loop</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
<a id=__codelineno-41-27 name=__codelineno-41-27 href=#__codelineno-41-27></a>
<a id=__codelineno-41-28 name=__codelineno-41-28 href=#__codelineno-41-28></a><span class=w>    </span><span class=cm>/* Never exit as there is no OS to exit to! */</span>
<a id=__codelineno-41-29 name=__codelineno-41-29 href=#__codelineno-41-29></a><span class=w>    </span><span class=k>while</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<a id=__codelineno-41-30 name=__codelineno-41-30 href=#__codelineno-41-30></a><span class=w>    </span><span class=p>{</span>
<a id=__codelineno-41-31 name=__codelineno-41-31 href=#__codelineno-41-31></a><span class=w>        </span><span class=cm>/* Light the LED */</span>
<a id=__codelineno-41-32 name=__codelineno-41-32 href=#__codelineno-41-32></a><span class=w>        </span><span class=n>LED_ON</span><span class=p>();</span>
<a id=__codelineno-41-33 name=__codelineno-41-33 href=#__codelineno-41-33></a>
<a id=__codelineno-41-34 name=__codelineno-41-34 href=#__codelineno-41-34></a><span class=w>        </span><span class=k>for</span><span class=p>(</span><span class=n>counters</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>counters</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>500000</span><span class=p>;</span><span class=w> </span><span class=n>counters</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>++</span><span class=p>)</span>
<a id=__codelineno-41-35 name=__codelineno-41-35 href=#__codelineno-41-35></a><span class=w>            </span><span class=p>;</span>
<a id=__codelineno-41-36 name=__codelineno-41-36 href=#__codelineno-41-36></a>
<a id=__codelineno-41-37 name=__codelineno-41-37 href=#__codelineno-41-37></a><span class=w>        </span><span class=cm>/* Set the GPIO16 output low ( Turn OK LED on )*/</span>
<a id=__codelineno-41-38 name=__codelineno-41-38 href=#__codelineno-41-38></a><span class=w>        </span><span class=n>LED_OFF</span><span class=p>();</span>
<a id=__codelineno-41-39 name=__codelineno-41-39 href=#__codelineno-41-39></a>
<a id=__codelineno-41-40 name=__codelineno-41-40 href=#__codelineno-41-40></a><span class=w>        </span><span class=k>for</span><span class=p>(</span><span class=n>counters</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>counters</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>500000</span><span class=p>;</span><span class=w> </span><span class=n>counters</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>++</span><span class=p>)</span>
<a id=__codelineno-41-41 name=__codelineno-41-41 href=#__codelineno-41-41></a><span class=w>            </span><span class=p>;</span>
<a id=__codelineno-41-42 name=__codelineno-41-42 href=#__codelineno-41-42></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-41-43 name=__codelineno-41-43 href=#__codelineno-41-43></a><span class=p>}</span>
</code></pre></div> <p>Build the example and program, now the counter variable is from malloc'd memory - usually malloc is the most mysterious of the c library stubs, but as you can see from the example, you can implement it easily and also implement it in C easily too! Of course occasionally it's necessary to drop down to assembler to get certain register values or talk to some special hardware features. Keep the <a href=http://infocenter.arm.com/help/topic/com.arm.doc.qrc0001l/QRC0001_UAL.pdf>cheat-sheet</a> close at hand while you're working with the C-Stubs.</p> <p>While we're here, we also remove the custom linker script at this point. We don't need to be using anymore. There is an option to control the <code>MAXPAGESIZE</code> variable in the linker script to keep the binary small. See the <a href=https://sourceware.org/binutils/docs/ld/Options.html#Options>GNU LD documentation</a> for details of the max-page-size option.</p> <p>There's a great description of this <a href=https://jonathanhamberg.com/post/2018-10-03-decreasing-elf-size/ >option here</a> and thanks to <a href=https://github.com/eyalabraham>eyalabraham</a> for <a href=https://github.com/BrianSidebotham/arm-tutorial-rpi/issues/18>bringing it to my attention</a>.</p> <p>For <code>armc-09</code> we change the linker flags to include the <code>max-page-size</code> option and set it to just 4 bytes. The build.sh file now has the following linker setting:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-42-1 name=__codelineno-42-1 href=#__codelineno-42-1></a><span class=nv>lflags</span><span class=o>=</span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>lflags</span><span class=si>}</span><span class=s2> -Wl,-z,max-page-size=0x04&quot;</span>
</code></pre></div> <h2 id=part-3>Part 3<a class=headerlink href=#part-3 title="Permanent link">&para;</a></h2> <p>In the next part of the bare metal tutorial, we'll add on a build system so that we're not using a silly single command-line, and we can harness the power of a full build system for our bare-metal environment. We'll then fall back to the Cambridge ASM tutorials and progress to using the timer for flashing the LED rather than the incrementing loop counter we've used so far.</p> <p>So, what are you waiting for? Head off to <a href=http://www.valvers.com/embedded-linux/raspberry-pi/step03-bare-metal-programming-in-c-pt3>Part3</a> now!</p> </article> </div> </div> <a href=# class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </a> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2002-2020 Brian Sidebotham </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/squidfunk target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a> <a href=https://gitter.im/squidfunk/mkdocs-material target=_blank rel=noopener title=gitter.im class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 384 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M66.4 322.5H16V0h50.4v322.5zM166.9 76.1h-50.4V512h50.4V76.1zm100.6 0h-50.4V512h50.4V76.1zM368 76h-50.4v247H368V76z"/></svg> </a> <a href=https://hub.docker.com/r/squidfunk/mkdocs-material/ target=_blank rel=noopener title=hub.docker.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 640 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M349.9 236.3h-66.1v-59.4h66.1v59.4zm0-204.3h-66.1v60.7h66.1V32zm78.2 144.8H362v59.4h66.1v-59.4zm-156.3-72.1h-66.1v60.1h66.1v-60.1zm78.1 0h-66.1v60.1h66.1v-60.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1l-13.3-8.9zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm-78.1-72.1h-66.1v60.1h66.1v-60.1z"/></svg> </a> <a href=https://pypi.org/project/mkdocs-material/ target=_blank rel=noopener title=pypi.org class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6zM286.2 404c11.1 0 20.1 9.1 20.1 20.3 0 11.3-9 20.4-20.1 20.4-11 0-20.1-9.2-20.1-20.4.1-11.3 9.1-20.3 20.1-20.3zM167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4zm-6.7-142.6c-11.1 0-20.1-9.1-20.1-20.3.1-11.3 9-20.4 20.1-20.4 11 0 20.1 9.2 20.1 20.4s-9 20.3-20.1 20.3z"/></svg> </a> <a href=https://twitter.com/squidfunk target=_blank rel=noopener title=twitter.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": ["content.code.annotate", "content.tooltips", "navigation.indexes", "navigation.sections", "navigation.tabs", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../../assets/javascripts/workers/search.db81ec45.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../../assets/javascripts/bundle.4b2c34cd.min.js></script> </body> </html>