<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=google-site-verification content=gdf4XzjnbaArINbai3d8P0x_W3ugnDeIUyhMuq-wHPs><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Brian Sidebotham"><link href=https://www.valvers.com/open-software/raspberry-pi/bare-metal-programming-in-c-part-5/ rel=canonical><link rel=icon href=../../../img/favicon.png><meta name=generator content="mkdocs-1.4.2, mkdocs-material-8.5.10"><title>Part 5 - Graphics (Basic) - valvers.com</title><link rel=stylesheet href=../../../assets/stylesheets/main.472b142f.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.08040f6c.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css><link rel=stylesheet href=/valvers-assets/extra.css><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=None data-md-color-accent=None> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#part-5-graphics-basic class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../.. title=valvers.com class="md-header__button md-logo" aria-label=valvers.com data-md-component=logo> <img src=https://www.gravatar.com/avatar/8db3007cd3103d9ff42e90cc95dc7213 alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> valvers.com </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Part 5 - Graphics (Basic) </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/valvers/valvers.website.src title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title=valvers.com class="md-nav__button md-logo" aria-label=valvers.com data-md-component=logo> <img src=https://www.gravatar.com/avatar/8db3007cd3103d9ff42e90cc95dc7213 alt=logo> </a> valvers.com </label> <div class=md-nav__source> <a href=https://github.com/valvers/valvers.website.src title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> Home </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2> Denford orac <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Denford orac" data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Denford orac </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../denford-orac/ class=md-nav__link> Index </a> </li> <li class=md-nav__item> <a href=../../../denford-orac/2009-04-06-my-denford-orac/ class=md-nav__link> 2009 04 06 my denford orac </a> </li> <li class=md-nav__item> <a href=../../../denford-orac/2012-02-17-uprated-spindle-motor/ class=md-nav__link> 2012 02 17 uprated spindle motor </a> </li> <li class=md-nav__item> <a href=../../../denford-orac/2012-03-22-gathering-some-information/ class=md-nav__link> 2012 03 22 gathering some information </a> </li> <li class=md-nav__item> <a href=../../../denford-orac/2012-09-27-750w-motor-sourced/ class=md-nav__link> 2012 09 27 750w motor sourced </a> </li> <li class=md-nav__item> <a href=../../../denford-orac/2012-10-01-motor-doesnt-fit/ class=md-nav__link> 2012 10 01 motor doesnt fit </a> </li> <li class=md-nav__item> <a href=../../../denford-orac/2012-10-10-drill-head-disassembly/ class=md-nav__link> 2012 10 10 drill head disassembly </a> </li> <li class=md-nav__item> <a href=../../../denford-orac/2012-10-13-more-quill-dismantling/ class=md-nav__link> 2012 10 13 more quill dismantling </a> </li> <li class=md-nav__item> <a href=../../../denford-orac/2012-10-17-drill-spindle-is-apart/ class=md-nav__link> 2012 10 17 drill spindle is apart </a> </li> <li class=md-nav__item> <a href=../../../denford-orac/2012-10-29-removing-electrical-cabinet/ class=md-nav__link> 2012 10 29 removing electrical cabinet </a> </li> <li class=md-nav__item> <a href=../../../denford-orac/2012-10-31-tested-the-drill-head-above-the-lathe/ class=md-nav__link> 2012 10 31 tested the drill head above the lathe </a> </li> <li class=md-nav__item> <a href=../../../denford-orac/2012-11-02-rebuild-of-an-orac/ class=md-nav__link> 2012 11 02 rebuild of an orac </a> </li> <li class=md-nav__item> <a href=../../../denford-orac/2013-03-13-new-motor-fitted/ class=md-nav__link> 2013 03 13 new motor fitted </a> </li> <li class=md-nav__item> <a href=../../../denford-orac/2020-06-28-denford-orac-machinekit-controller/ class=md-nav__link> Denford Orac Machinekit Controller </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3> Engineering <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Engineering data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Engineering </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../engineering/ class=md-nav__link> Index </a> </li> <li class=md-nav__item> <a href=../../../engineering/an-and-jic-fittings/ class=md-nav__link> AN and JIC Fittings </a> </li> <li class=md-nav__item> <a href=../../../engineering/bolt-dimensions/ class=md-nav__link> Bolt Dimensions </a> </li> <li class=md-nav__item> <a href=../../../engineering/linuxcnc/ class=md-nav__link> LinuxCNC </a> </li> <li class=md-nav__item> <a href=../../../engineering/making-a-cyr-wheel/ class=md-nav__link> Making a Cyr Wheel </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 type=checkbox id=__nav_4 checked> <label class=md-nav__link for=__nav_4> Open software <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Open software" data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Open software </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../ class=md-nav__link> Open-Software </a> </li> <li class=md-nav__item> <a href=../../android-car-dash/ class=md-nav__link> Android car dash </a> </li> <li class=md-nav__item> <a href=../../logging-with-gcc/ class=md-nav__link> Logging with gcc </a> </li> <li class=md-nav__item> <a href=../../posix-shell-scripting/ class=md-nav__link> Posix Shell Scripting </a> </li> <li class=md-nav__item> <a href=../../rpi-cm4-linuxcnc/ class=md-nav__link> RPI CM4 Linux CNC </a> </li> <li class=md-nav__item> <a href=../../working-with-the-screen-command/ class=md-nav__link> Working with the Screen Command </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_7 type=checkbox id=__nav_4_7> <label class=md-nav__link for=__nav_4_7> Arduino <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Arduino data-md-level=2> <label class=md-nav__title for=__nav_4_7> <span class="md-nav__icon md-icon"></span> Arduino </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../arduino/esp32-mqtt-tutorial/ class=md-nav__link> ESP32 MQTT Tutorial </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_8 type=checkbox id=__nav_4_8> <label class=md-nav__link for=__nav_4_8> Aws <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Aws data-md-level=2> <label class=md-nav__title for=__nav_4_8> <span class="md-nav__icon md-icon"></span> Aws </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../aws/aws-lambda-getting-started/ class=md-nav__link> AWS Lambda Getting Started </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_9 type=checkbox id=__nav_4_9> <label class=md-nav__link for=__nav_4_9> Gcc <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Gcc data-md-level=2> <label class=md-nav__title for=__nav_4_9> <span class="md-nav__icon md-icon"></span> Gcc </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../gcc/weak-function-attributes/ class=md-nav__link> Weak Function Attributes </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_10 type=checkbox id=__nav_4_10> <label class=md-nav__link for=__nav_4_10> Python <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Python data-md-level=2> <label class=md-nav__title for=__nav_4_10> <span class="md-nav__icon md-icon"></span> Python </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../python/pylab/ class=md-nav__link> Pylab </a> </li> <li class=md-nav__item> <a href=../../python/the-lethality-of-default-arguments-in-python/ class=md-nav__link> The Lethality of Default Arguments in Python </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_11 type=checkbox id=__nav_4_11 checked> <label class=md-nav__link for=__nav_4_11> Raspberry pi <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Raspberry pi" data-md-level=2> <label class=md-nav__title for=__nav_4_11> <span class="md-nav__icon md-icon"></span> Raspberry pi </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../bare-metal-programming-in-c-card/ class=md-nav__link> BMC Card Scripts </a> </li> <li class=md-nav__item> <a href=../bare-metal-programming-in-c-compiler/ class=md-nav__link> BMC Compiler </a> </li> <li class=md-nav__item> <a href=../bare-metal-programming-in-c-firmware/ class=md-nav__link> BMC Firmware </a> </li> <li class=md-nav__item> <a href=../bare-metal-programming-in-c-part-1/ class=md-nav__link> BMC Part 1 - Getting Started </a> </li> <li class=md-nav__item> <a href=../bare-metal-programming-in-c-part-2/ class=md-nav__link> BMC Part 2 - The C Runtime </a> </li> <li class=md-nav__item> <a href=../bare-metal-programming-in-c-part-3/ class=md-nav__link> BMC Part 3 - CMake Build System </a> </li> <li class=md-nav__item> <a href=../bare-metal-programming-in-c-part-4/ class=md-nav__link> BMC Part 4 - Interrupts </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Part 5 - Graphics (Basic) <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Part 5 - Graphics (Basic) </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#reference-material class=md-nav__link> Reference Material </a> </li> <li class=md-nav__item> <a href=#the-gpu-videocore-iv class=md-nav__link> The GPU (Videocore IV) </a> </li> <li class=md-nav__item> <a href=#tutorial-background class=md-nav__link> Tutorial Background </a> </li> <li class=md-nav__item> <a href=#getting-a-uart-text-console class=md-nav__link> Getting a UART Text Console </a> <nav class=md-nav aria-label="Getting a UART Text Console"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#aux-peripheral class=md-nav__link> AUX peripheral </a> </li> <li class=md-nav__item> <a href=#the-_write-system-call class=md-nav__link> The _write() System Call </a> </li> <li class=md-nav__item> <a href=#enabling-vfp-support class=md-nav__link> Enabling VFP Support </a> </li> <li class=md-nav__item> <a href=#mailboxes class=md-nav__link> Mailboxes </a> </li> <li class=md-nav__item> <a href=#mailbox-property-interface class=md-nav__link> Mailbox Property Interface </a> </li> <li class=md-nav__item> <a href=#the-framebuffer-properties class=md-nav__link> The Framebuffer Properties </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#part-5armc-014 class=md-nav__link> part-5/armc-014 </a> <nav class=md-nav aria-label=part-5/armc-014> <ul class=md-nav__list> <li class=md-nav__item> <a href=#results class=md-nav__link> Results </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#part-5armc-015 class=md-nav__link> part-5/armc-015 </a> <nav class=md-nav aria-label=part-5/armc-015> <ul class=md-nav__list> <li class=md-nav__item> <a href=#enabling-cache class=md-nav__link> Enabling Cache </a> </li> <li class=md-nav__item> <a href=#maxmising-the-clock-speed class=md-nav__link> Maxmising the Clock Speed </a> </li> <li class=md-nav__item> <a href=#rpi2-performance class=md-nav__link> RPI2+ Performance </a> </li> <li class=md-nav__item> <a href=#making-the-compiler-work-for-us class=md-nav__link> Making the Compiler work for us </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#part-5armc-016 class=md-nav__link> part-5/armc-016 </a> </li> <li class=md-nav__item> <a href=#more-interesting-graphics class=md-nav__link> More Interesting Graphics </a> <nav class=md-nav aria-label="More Interesting Graphics"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#starfield class=md-nav__link> Starfield </a> </li> <li class=md-nav__item> <a href=#double-buffer-and-no-vertical-sync class=md-nav__link> Double Buffer and No Vertical Sync </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#next class=md-nav__link> Next </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../bare-metal-programming-in-c/ class=md-nav__link> Raspberry-Pi Bare Metal Tutorial </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_12 type=checkbox id=__nav_4_12> <label class=md-nav__link for=__nav_4_12> Saltstack <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Saltstack data-md-level=2> <label class=md-nav__title for=__nav_4_12> <span class="md-nav__icon md-icon"></span> Saltstack </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../saltstack/building-a-centos8-salt-master/ class=md-nav__link> Building a CentOS8 Salt Master </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_13 type=checkbox id=__nav_4_13> <label class=md-nav__link for=__nav_4_13> Webstacks <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Webstacks data-md-level=2> <label class=md-nav__title for=__nav_4_13> <span class="md-nav__icon md-icon"></span> Webstacks </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../webstacks/using-reactjs-and-bulma/ class=md-nav__link> Using ReactJS and Bulma </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5 type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5> Random <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Random data-md-level=1> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Random </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../random/ class=md-nav__link> Random Stuff </a> </li> <li class=md-nav__item> <a href=../../../random/mortgage/ class=md-nav__link> Mortgage </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_6 type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6> V6manta <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=V6manta data-md-level=1> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> V6manta </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../v6manta/ class=md-nav__link> Index </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_6_2 type=checkbox id=__nav_6_2> <label class=md-nav__link for=__nav_6_2> 2003 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=2003 data-md-level=2> <label class=md-nav__title for=__nav_6_2> <span class="md-nav__icon md-icon"></span> 2003 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../v6manta/2003/2003-07-28-/ class=md-nav__link> 2003 07 28 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2003/2003-07-28-brought-a-1.8s-berlinetta/ class=md-nav__link> 2003 07 28 brought a 1.8s berlinetta </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2003/2003-07-28-stage-rally-opel-manta/ class=md-nav__link> 2003 07 28 stage rally opel manta </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2003/2003-08-12-/ class=md-nav__link> 2003 08 12 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2003/2003-08-13-/ class=md-nav__link> 2003 08 13 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2003/2003-08-23-/ class=md-nav__link> 2003 08 23 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2003/2003-09-11-/ class=md-nav__link> 2003 09 11 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2003/2003-09-28-/ class=md-nav__link> 2003 09 28 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2003/2003-10-07-/ class=md-nav__link> 2003 10 07 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2003/2003-10-09-/ class=md-nav__link> 2003 10 09 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2003/2003-11-04-/ class=md-nav__link> 2003 11 04 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2003/2003-12-16-/ class=md-nav__link> 2003 12 16 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_6_3 type=checkbox id=__nav_6_3> <label class=md-nav__link for=__nav_6_3> 2004 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=2004 data-md-level=2> <label class=md-nav__title for=__nav_6_3> <span class="md-nav__icon md-icon"></span> 2004 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-01-06-/ class=md-nav__link> 2004 01 06 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-01-07-/ class=md-nav__link> 2004 01 07 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-01-26-/ class=md-nav__link> 2004 01 26 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-01-29-/ class=md-nav__link> 2004 01 29 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-02-09-/ class=md-nav__link> 2004 02 09 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-02-13-/ class=md-nav__link> 2004 02 13 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-02-19-/ class=md-nav__link> 2004 02 19 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-04-20-finally-got-around-to-the-manta/ class=md-nav__link> 2004 04 20 finally got around to the manta </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-06-17-/ class=md-nav__link> 2004 06 17 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-06-18-/ class=md-nav__link> 2004 06 18 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-06-21-/ class=md-nav__link> 2004 06 21 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-07-26-/ class=md-nav__link> 2004 07 26 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-08-09-/ class=md-nav__link> 2004 08 09 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-08-10-/ class=md-nav__link> 2004 08 10 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-09-03-/ class=md-nav__link> 2004 09 03 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-09-27-/ class=md-nav__link> 2004 09 27 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-10-07-/ class=md-nav__link> 2004 10 07 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-10-08-/ class=md-nav__link> 2004 10 08 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-10-11-/ class=md-nav__link> 2004 10 11 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-10-13-/ class=md-nav__link> 2004 10 13 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-10-15-/ class=md-nav__link> 2004 10 15 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-10-18-/ class=md-nav__link> 2004 10 18 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-10-21-/ class=md-nav__link> 2004 10 21 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-10-22-/ class=md-nav__link> 2004 10 22 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-10-29-/ class=md-nav__link> 2004 10 29 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-11-01-/ class=md-nav__link> 2004 11 01 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2004/2004-12-10-were-back/ class=md-nav__link> 2004 12 10 were back </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_6_4 type=checkbox id=__nav_6_4> <label class=md-nav__link for=__nav_6_4> 2005 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=2005 data-md-level=2> <label class=md-nav__title for=__nav_6_4> <span class="md-nav__icon md-icon"></span> 2005 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../v6manta/2005/2005-05-16-/ class=md-nav__link> 2005 05 16 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2005/2005-08-04-done-something/ class=md-nav__link> 2005 08 04 done something </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2005/2005-08-08-/ class=md-nav__link> 2005 08 08 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2005/2005-08-10-/ class=md-nav__link> 2005 08 10 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2005/2005-08-25-/ class=md-nav__link> 2005 08 25 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2005/2005-08-31-/ class=md-nav__link> 2005 08 31 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2005/2005-09-05-/ class=md-nav__link> 2005 09 05 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2005/2005-09-19-/ class=md-nav__link> 2005 09 19 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2005/2005-09-22-/ class=md-nav__link> 2005 09 22 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2005/2005-09-23-/ class=md-nav__link> 2005 09 23 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2005/2005-11-01-/ class=md-nav__link> 2005 11 01 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2005/2005-11-03-/ class=md-nav__link> 2005 11 03 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_6_5 type=checkbox id=__nav_6_5> <label class=md-nav__link for=__nav_6_5> 2007 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=2007 data-md-level=2> <label class=md-nav__title for=__nav_6_5> <span class="md-nav__icon md-icon"></span> 2007 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../v6manta/2007/2007-10-20-/ class=md-nav__link> 2007 10 20 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2007/2007-10-20-perspex-windows/ class=md-nav__link> 2007 10 20 perspex windows </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2007/2007-11-13-getting-it-ready-to-paint.../ class=md-nav__link> 2007 11 13 getting it ready to paint... </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2007/2007-11-21-almost-started-painting/ class=md-nav__link> 2007 11 21 almost started painting </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2007/2007-11-28-underneath-is-complete/ class=md-nav__link> 2007 11 28 underneath is complete </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2007/2007-12-04-painting-the-inside-and-engine-bay/ class=md-nav__link> 2007 12 04 painting the inside and engine bay </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_6_6 type=checkbox id=__nav_6_6> <label class=md-nav__link for=__nav_6_6> 2008 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=2008 data-md-level=2> <label class=md-nav__title for=__nav_6_6> <span class="md-nav__icon md-icon"></span> 2008 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-01-14-painting-the-shell-orange/ class=md-nav__link> 2008 01 14 painting the shell orange </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-01-16-out-of-the-booth/ class=md-nav__link> 2008 01 16 out of the booth </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-01-23-rear-axle-trial-fitting/ class=md-nav__link> 2008 01 23 rear axle trial fitting </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-02-24-painted-the-nextel-and-checked-for-wheel-clearance/ class=md-nav__link> 2008 02 24 painted the nextel and checked for wheel clearance </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-03-15-front-suspension-build/ class=md-nav__link> 2008 03 15 front suspension build </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-03-19-suspension-bushes-are-always-wrong/ class=md-nav__link> 2008 03 19 suspension bushes are always wrong </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-03-22-diff-bearings-need-replacing/ class=md-nav__link> 2008 03 22 diff bearings need replacing </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-04-08-fitted-the-rear-windows-and-steering-column/ class=md-nav__link> 2008 04 08 fitted the rear windows and steering column </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-04-12-shimmed-up-the-diff%2C-and-fitted-the-clocks/ class=md-nav__link> 2008 04 12 shimmed up the diff, and fitted the clocks </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-04-16-rebuilt-the-gearbox-so-i-get-gear-selection/ class=md-nav__link> 2008 04 16 rebuilt the gearbox so i get gear selection </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-07-08-its-on-its-wheels-at-last/ class=md-nav__link> 2008 07 08 its on its wheels at last </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-09-02-rebuilt-oil-pump--started-headwork/ class=md-nav__link> 2008 09 02 rebuilt oil pump started headwork </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-09-04-some-more-headwork/ class=md-nav__link> 2008 09 04 some more headwork </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-09-25-even-more-headwork/ class=md-nav__link> 2008 09 25 even more headwork </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-11-09-engine--transmission-fitted/ class=md-nav__link> 2008 11 09 engine transmission fitted </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-11-16-engine--gearbox-mounted--steering-column-fitted/ class=md-nav__link> 2008 11 16 engine gearbox mounted steering column fitted </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2008/2008-12-14-stripping-the-x25xe-v6-bottom-end/ class=md-nav__link> 2008 12 14 stripping the x25xe v6 bottom end </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_6_7 type=checkbox id=__nav_6_7> <label class=md-nav__link for=__nav_6_7> 2009 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=2009 data-md-level=2> <label class=md-nav__title for=__nav_6_7> <span class="md-nav__icon md-icon"></span> 2009 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../v6manta/2009/2009-06-24-making-the-dry-sump-pan/ class=md-nav__link> 2009 06 24 making the dry sump pan </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2009/2009-10-05-trialling-the-throttle-bodies--a-few-more-bits-painted/ class=md-nav__link> 2009 10 05 trialling the throttle bodies a few more bits painted </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2009/2009-12-18-flywheel-and-clutch/ class=md-nav__link> 2009 12 18 flywheel and clutch </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_6_8 type=checkbox id=__nav_6_8> <label class=md-nav__link for=__nav_6_8> 2010 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=2010 data-md-level=2> <label class=md-nav__title for=__nav_6_8> <span class="md-nav__icon md-icon"></span> 2010 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-01-23-done-the-handbrake--sliders/ class=md-nav__link> 2010 01 23 done the handbrake sliders </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-01-27-started-building-the-v6-heads-up/ class=md-nav__link> 2010 01 27 started building the v6 heads up </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-01-30-picked-up-another-v6/ class=md-nav__link> 2010 01 30 picked up another v6 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-02-01-exhaust-manifolds/ class=md-nav__link> 2010 02 01 exhaust manifolds </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-02-02-starting-the-v6-build/ class=md-nav__link> 2010 02 02 starting the v6 build </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-02-03-cylinder-head-bolts-torque/ class=md-nav__link> 2010 02 03 cylinder head bolts torque </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-02-03-ordered-the-exhaust-manifold-flanges/ class=md-nav__link> 2010 02 03 ordered the exhaust manifold flanges </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-02-06-building-the-v6/ class=md-nav__link> 2010 02 06 building the v6 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-02-07-building-the-v6/ class=md-nav__link> 2010 02 07 building the v6 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-02-14-building-the-v6/ class=md-nav__link> 2010 02 14 building the v6 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-03-22-gearbox-sealed-and-release-bearing-fitted/ class=md-nav__link> 2010 03 22 gearbox sealed and release bearing fitted </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-04-03-started-on-the-manifolds/ class=md-nav__link> 2010 04 03 started on the manifolds </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-04-05-finished-a-manifold/ class=md-nav__link> 2010 04 05 finished a manifold </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-04-07-started-the-second-manifold/ class=md-nav__link> 2010 04 07 started the second manifold </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-04-11-need-a-todo-list/ class=md-nav__link> 2010 04 11 need a todo list </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-04-21-ticking-off-the-boxes/ class=md-nav__link> 2010 04 21 ticking off the boxes </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-04-26-nearly-finished-the-second-manifold/ class=md-nav__link> 2010 04 26 nearly finished the second manifold </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-05-09-got-the-car-rolling/ class=md-nav__link> 2010 05 09 got the car rolling </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-05-11-rolling-road-day/ class=md-nav__link> 2010 05 11 rolling road day </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-05-31-back-from-germany/ class=md-nav__link> 2010 05 31 back from germany </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-06-01-sumps-off/ class=md-nav__link> 2010 06 01 sumps off </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-06-06-done-most-of-the-bits-on-the-v6/ class=md-nav__link> 2010 06 06 done most of the bits on the v6 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-06-12-getting-ready-to-bolt-it-back-in/ class=md-nav__link> 2010 06 12 getting ready to bolt it back in </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-06-19-almost-ready-to-go-back-in/ class=md-nav__link> 2010 06 19 almost ready to go back in </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-09-22-lack-of-updates/ class=md-nav__link> 2010 09 22 lack of updates </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-09-26-few-little-bits/ class=md-nav__link> 2010 09 26 few little bits </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-10-09-v6-oil-problems..../ class=md-nav__link> 2010 10 09 v6 oil problems.... </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-10-12-starting-putting-the-engine-back-together/ class=md-nav__link> 2010 10 12 starting putting the engine back together </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-10-23-v6-is-broke/ class=md-nav__link> 2010 10 23 v6 is broke </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-10-24-stripping-the-v6/ class=md-nav__link> 2010 10 24 stripping the v6 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-10-25-v6-problem/ class=md-nav__link> 2010 10 25 v6 problem </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-11-03-picked-up-a-replacement-v6/ class=md-nav__link> 2010 11 03 picked up a replacement v6 </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2010/2010-12-12-been-busy-building/ class=md-nav__link> 2010 12 12 been busy building </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_6_9 type=checkbox id=__nav_6_9> <label class=md-nav__link for=__nav_6_9> 2011 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=2011 data-md-level=2> <label class=md-nav__title for=__nav_6_9> <span class="md-nav__icon md-icon"></span> 2011 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../v6manta/2011/2011-01-01-finally-driven-the-manta-again-today/ class=md-nav__link> 2011 01 01 finally driven the manta again today </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2011/2011-03-13-fitting-some-new-seats/ class=md-nav__link> 2011 03 13 fitting some new seats </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2011/2011-03-13-the-manta-got-mapped/ class=md-nav__link> 2011 03 13 the manta got mapped </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2011/2011-03-25-went-to-brands-hatch/ class=md-nav__link> 2011 03 25 went to brands hatch </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2011/2011-09-04-started-work-on-the-2011-rebuild/ class=md-nav__link> 2011 09 04 started work on the 2011 rebuild </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2011/2011-09-10-built-some-more-of-the-frame/ class=md-nav__link> 2011 09 10 built some more of the frame </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2011/2011-09-14-started-work-on-the-new-sump-pan/ class=md-nav__link> 2011 09 14 started work on the new sump pan </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2011/2011-09-15-more-subframe-work/ class=md-nav__link> 2011 09 15 more subframe work </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2011/2011-09-17-gearbox-back-together/ class=md-nav__link> 2011 09 17 gearbox back together </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2011/2011-09-25-getting-ready-to-spray-the-engine-bay-again.../ class=md-nav__link> 2011 09 25 getting ready to spray the engine bay again... </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2011/2011-10-16-moving-along-with-the-rebuild/ class=md-nav__link> 2011 10 16 moving along with the rebuild </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2011/2011-10-18-painted-the-engine-bay/ class=md-nav__link> 2011 10 18 painted the engine bay </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2011/2011-11-15-dry-sump-work.../ class=md-nav__link> 2011 11 15 dry sump work... </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_6_10 type=checkbox id=__nav_6_10> <label class=md-nav__link for=__nav_6_10> 2012 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=2012 data-md-level=2> <label class=md-nav__title for=__nav_6_10> <span class="md-nav__icon md-icon"></span> 2012 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-01-09-dry-sump-pan-is-welded/ class=md-nav__link> 2012 01 09 dry sump pan is welded </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-01-27-more-dry-sump-work/ class=md-nav__link> 2012 01 27 more dry sump work </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-02-21-engine-is-back-in.../ class=md-nav__link> 2012 02 21 engine is back in... </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-02-24-took-the-engine-back-out-again/ class=md-nav__link> 2012 02 24 took the engine back out again </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-02-27-engine-back-in-again/ class=md-nav__link> 2012 02 27 engine back in again </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-03-14-mostly-plumbed-back-in/ class=md-nav__link> 2012 03 14 mostly plumbed back in </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-04-04-started-her-up-again/ class=md-nav__link> 2012 04 04 started her up again </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-04-16-ready-for-a-test-drive/ class=md-nav__link> 2012 04 16 ready for a test drive </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-05-09-clutch-release-bearing-failure/ class=md-nav__link> 2012 05 09 clutch release bearing failure </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-05-17-stripping-the-t5-gearbox/ class=md-nav__link> 2012 05 17 stripping the t5 gearbox </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-10-13-rebuilt-the-gearbox/ class=md-nav__link> 2012 10 13 rebuilt the gearbox </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-11-11-finally-the-engines-back-in/ class=md-nav__link> 2012 11 11 finally the engines back in </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-11-14-nearly-back-together/ class=md-nav__link> 2012 11 14 nearly back together </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-11-25-the-finishing-touches/ class=md-nav__link> 2012 11 25 the finishing touches </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-11-28-finally-the-v6-manta-up-a-running-again/ class=md-nav__link> 2012 11 28 finally the v6 manta up a running again </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2012/2012-12-30-virtually-back-on-the-road/ class=md-nav__link> 2012 12 30 virtually back on the road </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_6_11 type=checkbox id=__nav_6_11> <label class=md-nav__link for=__nav_6_11> 2013 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=2013 data-md-level=2> <label class=md-nav__title for=__nav_6_11> <span class="md-nav__icon md-icon"></span> 2013 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../v6manta/2013/2013-01-10-driven-the-manta-again/ class=md-nav__link> 2013 01 10 driven the manta again </a> </li> <li class=md-nav__item> <a href=../../../v6manta/2013/2013-01-15-had-a-great-blast-in-the-manta/ class=md-nav__link> 2013 01 15 had a great blast in the manta </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#reference-material class=md-nav__link> Reference Material </a> </li> <li class=md-nav__item> <a href=#the-gpu-videocore-iv class=md-nav__link> The GPU (Videocore IV) </a> </li> <li class=md-nav__item> <a href=#tutorial-background class=md-nav__link> Tutorial Background </a> </li> <li class=md-nav__item> <a href=#getting-a-uart-text-console class=md-nav__link> Getting a UART Text Console </a> <nav class=md-nav aria-label="Getting a UART Text Console"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#aux-peripheral class=md-nav__link> AUX peripheral </a> </li> <li class=md-nav__item> <a href=#the-_write-system-call class=md-nav__link> The _write() System Call </a> </li> <li class=md-nav__item> <a href=#enabling-vfp-support class=md-nav__link> Enabling VFP Support </a> </li> <li class=md-nav__item> <a href=#mailboxes class=md-nav__link> Mailboxes </a> </li> <li class=md-nav__item> <a href=#mailbox-property-interface class=md-nav__link> Mailbox Property Interface </a> </li> <li class=md-nav__item> <a href=#the-framebuffer-properties class=md-nav__link> The Framebuffer Properties </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#part-5armc-014 class=md-nav__link> part-5/armc-014 </a> <nav class=md-nav aria-label=part-5/armc-014> <ul class=md-nav__list> <li class=md-nav__item> <a href=#results class=md-nav__link> Results </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#part-5armc-015 class=md-nav__link> part-5/armc-015 </a> <nav class=md-nav aria-label=part-5/armc-015> <ul class=md-nav__list> <li class=md-nav__item> <a href=#enabling-cache class=md-nav__link> Enabling Cache </a> </li> <li class=md-nav__item> <a href=#maxmising-the-clock-speed class=md-nav__link> Maxmising the Clock Speed </a> </li> <li class=md-nav__item> <a href=#rpi2-performance class=md-nav__link> RPI2+ Performance </a> </li> <li class=md-nav__item> <a href=#making-the-compiler-work-for-us class=md-nav__link> Making the Compiler work for us </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#part-5armc-016 class=md-nav__link> part-5/armc-016 </a> </li> <li class=md-nav__item> <a href=#more-interesting-graphics class=md-nav__link> More Interesting Graphics </a> <nav class=md-nav aria-label="More Interesting Graphics"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#starfield class=md-nav__link> Starfield </a> </li> <li class=md-nav__item> <a href=#double-buffer-and-no-vertical-sync class=md-nav__link> Double Buffer and No Vertical Sync </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#next class=md-nav__link> Next </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/valvers/valvers.website.src/edit/master/docs/open-software/raspberry-pi/bare-metal-programming-in-c-part-5.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg> </a> <h1 id=part-5-graphics-basic>Part 5 - Graphics (Basic)<a class=headerlink href=#part-5-graphics-basic title="Permanent link">&para;</a></h1> <p>Finally, we get on to a tutorial that moves us away from blinking an LED as we explore the VideoCore IV GPU's framebuffer.</p> <h2 id=reference-material>Reference Material<a class=headerlink href=#reference-material title="Permanent link">&para;</a></h2> <p>We need some reading material for this tutorial - this is how I put the tutorial together, by reading and studying the manuals available for the Videcore, mainly for this tutorial the information comes from the BCM238x peripherals datasheet and the raspberrypi gpu mailbox documnetation.</p> <p>Some material that's useful (Generally for late night reading!):</p> <ul> <li><a href=https://github.com/raspberrypi/firmware/wiki/Accessing-mailboxes>Raspberry Pi Firmware Mailboxes information</a></li> </ul> <p>This information is less important for now, but worth noting:</p> <p>Yes there's a lot of text and more than one manual - but that's the only way you learn!</p> <ul> <li><a href=http://www.broadcom.com/docs/support/videocore/VideoCoreIV-AG100-R.pdf>VideoCoreIv-AG100 3D Architecture Reference</a></li> <li><a href=http://www.broadcom.com/docs/support/videocore/Brcm_Android_ICS_Graphics_Stack.tar.gz>Android Graphics Driver Source Code for VideoCoreIV</a></li> </ul> <h2 id=the-gpu-videocore-iv>The GPU (Videocore IV)<a class=headerlink href=#the-gpu-videocore-iv title="Permanent link">&para;</a></h2> <p>The GPU and ARM devices can communicate with each other through a mailbox system. However, don't forget that the ARM and GPU also share the memory space, and so although we have to communicate through the mailbox, this is what negotiates settings and a framebuffer. The framebuffer address in memory is then returned from the GPU and we can go ahead and write to the framebuffer to see graphics.</p> <p>A framebuffer is a term that really refers to a block of video memory. This video memory is used to display pixels on the screen. So we have access to each pixel on the screen and can change it's colour properties. The framebuffer should be at least as big as the screen resolution. The size of the framebuffer memory block is given by a simple equation:</p> <div class=highlight><pre><span></span><code><span class=n>framebuffer_bytes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pixels_x</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>pixels_y</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>bytes_per_pixel</span><span class=w></span>
</code></pre></div> <blockquote> <p><strong>NOTE</strong> In this tutorial we'll be using a framebuffer and so won't have any higher-level functions like OpenGL or accelerated graphics. We're going to create a simple software renderer.</p> </blockquote> <p>The number of bytes per pixel sets the number of colours available. The Raspberry-Pi GPU supports 8-bit, but in this mode the 8-bit value corresponds to a palette entry, and the palette appears to be very limited. A palette mode can be really useful as it's fast (minimal amount of memory required for the graphics) and can be really useful for some special effects by simply altering the palette. These were great techniques for fast graphics on the old 16-bit machines in the 1990s.</p> <p>16-bit requires two bytes of data per pixel and directly represents the Red, Green and Blue levels of the colour of the pixel (awkwardly packed into 16-bits), and 32-bit has 4 bytes of data per pixel which has 8-bit per primary colour and an 8-bit alpha channel (transparency).</p> <p>The GPU inner workings are generally quite a closely guarded secret. It's a specialised processor, but also a powerful processor and most people would like to run code on it, just like we're running code on the GPU itself, but alas the GPU information is still under NDA (Non-Disclosure Agreement) terms.</p> <p>Broadcom however, did release some information and some of the most interesting information is in the <a href=http://www.broadcom.com/docs/support/videocore/Brcm_Android_ICS_Graphics_Stack.tar.gz>BCM21553 Graphics Driver</a> . I'll reference what material I've got from there as we go. Unfortunately there is no definitive source of information for the Raspberry Pi GPU, only bits and pieces scattered around the web.</p> <p>The GPU is a Videocore IV. As we're going to use the mailbox communication with the GPU anyway, we can skip a lot of the GPU detail and just concentrate on communicating with the GPU to get a framebuffer to use.</p> <p>The mailbox interface is our main entry point into the world of graphics. The interface was developed and created by a few guys at broadcom. The mailbox interface is software running on the GPU which receives messages from software running on the arm and returns responses to each message after performing a task. It's implemented in the start.elf file that we require on the SD Card to boot the Raspberry-Pi. You can see their discussion about implementing the mailbox on <a href=https://github.com/raspberrypi/firmware/issues/47>Github</a></p> <p>The mailboxes are defined <a href=https://github.com/raspberrypi/firmware/wiki/Mailboxes>on Github</a>.</p> <p>The interface we're interested in is the <a href=https://github.com/raspberrypi/firmware/wiki/Mailbox-property-interface>Property Interface Mailbox</a></p> <p>This mailbox is responsible for negotiating the framebuffer. We need some code to be able to read and write data from the mailbox and we also need to define the data structure defined by the framebuffer mailbox documentation.</p> <h2 id=tutorial-background>Tutorial Background<a class=headerlink href=#tutorial-background title="Permanent link">&para;</a></h2> <p>The ARM014 tutorial introduces a few new peices of the puzzle. Firstly, as an aid to debugging now the code is getting more complex it introduces the mini UART which means we can have a basic "console". As we've bothered with the standard c library we can see how to tie the standard library functions like <code>printf()</code> to the UART. Secondly, it introduces the mailbox property interface which is a method of the ARM processor talking to the GPU. If we're going to get to the point of generating graphics, we must talk to the GPU!</p> <p>This code does generate an "animated" display, but as we'll see - it is extremely slow to use un-optimised software rendering on an RPI! If you want, go ahead and compile it now and plug the raspberry pi into a monitor or television with a HDMI interface. It <strong>should</strong> work!</p> <p>As we're now including new hardware into the mix it's possible that your monitor or TV doesn't support the resolution and colour depth that the example is hard coded to use. It's an example that's designed to be simple rather than supporting every HDMI panel out there. Hopefully you'll have luck with it. I'm using an old Hanns-G HUD19 monitor with DVI-&gt;HDMI adaptor.</p> <p>If it works, you'll see an ever-changing display which moves through the colour spectrum, continuously writing to every pixel in the framebuffer! You can see the (rather boring) output on <a href=https://youtube.com>YouTube</a>.</p> <p>This tutorial shows how a 700MHz (or 900MHz) processor doesn't give you carte-blanche to program in C and end up with an optimised output. In this example there is no vertical sync used, we simply dedicate 100% of the one of the ARM processors cores to drawing to every pixel in the framebuffer, varying the colour as we go. In this way we can see the raw speed of the processor at work. It's pretty slow isn't it!</p> <p>We'll start to optimise in the <code>ARM015</code> code later on in this tutorial.</p> <h2 id=getting-a-uart-text-console>Getting a UART Text Console<a class=headerlink href=#getting-a-uart-text-console title="Permanent link">&para;</a></h2> <p>Read that title carefully, not getting a graphics Text Console but instead getting some text out of the code to help us debug. As the code becomes more complex we need better ways of debugging. A later tutorial will talk about using JTAG but for now we can have the basic UART based text debugging that gets us out of most holes!</p> <p>This requires some hardware. Namely a <a href=https://cpc.farnell.com/ftdi/ttl-232r-3v3/cable-usb-to-ttl-level-seri-converter/dp/SC10142>TTL-232R-3V3</a> or equivalent is required. The mini uart described in the AUX peripheral below is available on the RPI IO expansion headers on pins 8 (GPIO14/TXD) and 10 (GPIO15/RXD)</p> <p>Connecting the UART to a PC is pretty easy, a quick connection guide is available:</p> <p><img alt="UART Connection" src=/img/bare-metal-programming-in-c/part-5-ftdi-ttl-232r-3v3-rpi-connection.png></p> <p>Also, a quick photo of one connected up:</p> <p><img alt="UART Connection" src=/img/bare-metal-programming-in-c/part-5-ftdi-ttl-232r-3v3-rpi-connection-photo.jpg></p> <h3 id=aux-peripheral>AUX peripheral<a class=headerlink href=#aux-peripheral title="Permanent link">&para;</a></h3> <p>The AUX peripheral includes a couple of communication interfaces which we can put to use. In this tutorial we will enable the mini UART which has Rx/Tx signals available on the IO header of the raspberry-pi. We will connect that to an FTDI 3.3V USB-&gt;UART converter and then we can connect PuTTY to the COM port and see output from the code!</p> <p>We will do some more work on the c stubs to provide uart support in the write system call which is what the likes of <code>printf()</code>, etc. functions use to write to the system.</p> <div class=highlight><pre><span></span><code><span class=cm>/*</span>
<span class=cm>    Part of the Raspberry-Pi Bare Metal Tutorials</span>
<span class=cm>    https://www.valvers.com/rpi/bare-metal/</span>
<span class=cm>    Copyright (c) 2013-2018, Brian Sidebotham</span>

<span class=cm>    This software is licensed under the MIT License.</span>
<span class=cm>    Please see the LICENSE file included with this software.</span>

<span class=cm>*/</span><span class=w></span>

<span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;rpi-aux.h&quot;</span><span class=cp></span>
<span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;rpi-base.h&quot;</span><span class=cp></span>
<span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;rpi-gpio.h&quot;</span><span class=cp></span>

<span class=k>static</span><span class=w> </span><span class=n>aux_t</span><span class=o>*</span><span class=w> </span><span class=n>auxillary</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>aux_t</span><span class=o>*</span><span class=p>)</span><span class=n>AUX_BASE</span><span class=p>;</span><span class=w></span>


<span class=n>aux_t</span><span class=o>*</span><span class=w> </span><span class=nf>RPI_GetAux</span><span class=p>(</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>auxillary</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=cm>/* Define the system clock frequency in MHz for the baud rate calculation.</span>
<span class=cm>   This is clearly defined on the BCM2835 datasheet errata page:</span>
<span class=cm>   http://elinux.org/BCM2835_datasheet_errata */</span><span class=w></span>


<span class=kt>void</span><span class=w> </span><span class=nf>RPI_AuxMiniUartInit</span><span class=p>(</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>baud</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>bits</span><span class=w> </span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=cm>/* As this is a mini uart the configuration is complete! Now just</span>
<span class=cm>       enable the uart. Note from the documentation in section 2.1.1 of</span>
<span class=cm>       the ARM peripherals manual:</span>

<span class=cm>       If the enable bits are clear you will have no access to a</span>
<span class=cm>       peripheral. You can not even read or write the registers */</span><span class=w></span>
<span class=w>    </span><span class=n>auxillary</span><span class=o>-&gt;</span><span class=n>ENABLES</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>AUX_ENA_MINIUART</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=n>auxillary</span><span class=o>-&gt;</span><span class=n>MU_IER</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=cm>/* Disable flow control,enable transmitter and receiver! */</span><span class=w></span>
<span class=w>    </span><span class=n>auxillary</span><span class=o>-&gt;</span><span class=n>MU_CNTL</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=cm>/* Decide between seven or eight-bit mode */</span><span class=w></span>
<span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=w> </span><span class=n>bits</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>8</span><span class=w> </span><span class=p>)</span><span class=w></span>
<span class=w>        </span><span class=n>auxillary</span><span class=o>-&gt;</span><span class=n>MU_LCR</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>AUX_MULCR_8BIT_MODE</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>else</span><span class=w></span>
<span class=w>        </span><span class=n>auxillary</span><span class=o>-&gt;</span><span class=n>MU_LCR</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=n>auxillary</span><span class=o>-&gt;</span><span class=n>MU_MCR</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=cm>/* Disable all interrupts from MU and clear the fifos */</span><span class=w></span>
<span class=w>    </span><span class=n>auxillary</span><span class=o>-&gt;</span><span class=n>MU_IER</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=n>auxillary</span><span class=o>-&gt;</span><span class=n>MU_IIR</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0xC6</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=cm>/* Transposed calculation from Section 2.2.1 of the ARM peripherals manual */</span><span class=w></span>
<span class=w>    </span><span class=n>auxillary</span><span class=o>-&gt;</span><span class=n>MU_BAUD</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=n>SYSFREQ</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=mi>8</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>baud</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=cm>/* Setup GPIO 14 and 15 as alternative function 5 which is UART 1 TXD/RXD. These need to be</span>
<span class=cm>       set before enabling the UART */</span><span class=w></span>
<span class=w>    </span><span class=n>RPI_SetGpioPinFunction</span><span class=p>(</span><span class=w> </span><span class=n>RPI_GPIO14</span><span class=p>,</span><span class=w> </span><span class=n>FS_ALT5</span><span class=w> </span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>RPI_SetGpioPinFunction</span><span class=p>(</span><span class=w> </span><span class=n>RPI_GPIO15</span><span class=p>,</span><span class=w> </span><span class=n>FS_ALT5</span><span class=w> </span><span class=p>);</span><span class=w></span>

<span class=w>    </span><span class=cm>/* See the requirements in the GPIO section of the timing requirements of the GPIO controller.</span>
<span class=cm>       Who knows why 150 cycles is mentioned - what if we&#39;re running at 1500MHz as opposed to</span>
<span class=cm>       500MHz ? */</span><span class=w></span>
<span class=w>    </span><span class=n>RPI_GetGpio</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>GPPUD</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>for</span><span class=p>(</span><span class=w> </span><span class=k>volatile</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>&lt;</span><span class=mi>150</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>}</span><span class=w></span>
<span class=w>    </span><span class=n>RPI_GetGpio</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>GPPUDCLK0</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>14</span><span class=w> </span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=k>for</span><span class=p>(</span><span class=w> </span><span class=k>volatile</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>&lt;</span><span class=mi>150</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>}</span><span class=w></span>
<span class=w>    </span><span class=n>RPI_GetGpio</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>GPPUDCLK0</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=cm>/* Disable flow control,enable transmitter and receiver! */</span><span class=w></span>
<span class=w>    </span><span class=n>auxillary</span><span class=o>-&gt;</span><span class=n>MU_CNTL</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>AUX_MUCNTL_TX_ENABLE</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>


<span class=kt>void</span><span class=w> </span><span class=nf>RPI_AuxMiniUartWrite</span><span class=p>(</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=cm>/* Wait until the UART has an empty space in the FIFO */</span><span class=w></span>
<span class=w>    </span><span class=k>while</span><span class=p>(</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=n>auxillary</span><span class=o>-&gt;</span><span class=n>MU_LSR</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>AUX_MULSR_TX_EMPTY</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=cm>/* Write the character to the FIFO for transmission */</span><span class=w></span>
<span class=w>    </span><span class=n>auxillary</span><span class=o>-&gt;</span><span class=n>MU_IO</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>c</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=cm>/*</span>
<span class=cm>    Part of the Raspberry-Pi Bare Metal Tutorials</span>
<span class=cm>    https://www.valvers.com/rpi/bare-metal/</span>
<span class=cm>    Copyright (c) 2013-2018, Brian Sidebotham</span>

<span class=cm>    This software is licensed under the MIT License.</span>
<span class=cm>    Please see the LICENSE file included with this software.</span>

<span class=cm>*/</span><span class=w></span>

<span class=cp>#ifndef RPI_AUX_H</span>
<span class=cp>#define RPI_AUX_H</span>

<span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;rpi-base.h&quot;</span><span class=cp></span>

<span class=cm>/* Although these values were originally from the BCM2835 Arm peripherals PDF</span>
<span class=cm>   it&#39;s clear that was rushed and has some glaring errors - so these values</span>
<span class=cm>   may appear to be different. These values have been changed due to data on</span>
<span class=cm>   the elinux BCM2835 datasheet errata:</span>
<span class=cm>   http://elinux.org/BCM2835_datasheet_errata */</span><span class=w></span>

<span class=cp>#define AUX_BASE    ( PERIPHERAL_BASE + 0x215000 )</span>

<span class=cp>#define AUX_ENA_MINIUART            ( 1 &lt;&lt; 0 )</span>
<span class=cp>#define AUX_ENA_SPI1                ( 1 &lt;&lt; 1 )</span>
<span class=cp>#define AUX_ENA_SPI2                ( 1 &lt;&lt; 2 )</span>

<span class=cp>#define AUX_IRQ_SPI2                ( 1 &lt;&lt; 2 )</span>
<span class=cp>#define AUX_IRQ_SPI1                ( 1 &lt;&lt; 1 )</span>
<span class=cp>#define AUX_IRQ_MU                  ( 1 &lt;&lt; 0 )</span>

<span class=cp>#define AUX_MULCR_8BIT_MODE         ( 3 &lt;&lt; 0 )  </span><span class=cm>/* See errata for this value */</span><span class=cp></span>
<span class=cp>#define AUX_MULCR_BREAK             ( 1 &lt;&lt; 6 )</span>
<span class=cp>#define AUX_MULCR_DLAB_ACCESS       ( 1 &lt;&lt; 7 )</span>

<span class=cp>#define AUX_MUMCR_RTS               ( 1 &lt;&lt; 1 )</span>

<span class=cp>#define AUX_MULSR_DATA_READY        ( 1 &lt;&lt; 0 )</span>
<span class=cp>#define AUX_MULSR_RX_OVERRUN        ( 1 &lt;&lt; 1 )</span>
<span class=cp>#define AUX_MULSR_TX_EMPTY          ( 1 &lt;&lt; 5 )</span>
<span class=cp>#define AUX_MULSR_TX_IDLE           ( 1 &lt;&lt; 6 )</span>

<span class=cp>#define AUX_MUMSR_CTS               ( 1 &lt;&lt; 5 )</span>

<span class=cp>#define AUX_MUCNTL_RX_ENABLE        ( 1 &lt;&lt; 0 )</span>
<span class=cp>#define AUX_MUCNTL_TX_ENABLE        ( 1 &lt;&lt; 1 )</span>
<span class=cp>#define AUX_MUCNTL_RTS_FLOW         ( 1 &lt;&lt; 2 )</span>
<span class=cp>#define AUX_MUCNTL_CTS_FLOW         ( 1 &lt;&lt; 3 )</span>
<span class=cp>#define AUX_MUCNTL_RTS_FIFO         ( 3 &lt;&lt; 4 )</span>
<span class=cp>#define AUX_MUCNTL_RTS_ASSERT       ( 1 &lt;&lt; 6 )</span>
<span class=cp>#define AUX_MUCNTL_CTS_ASSERT       ( 1 &lt;&lt; 7 )</span>

<span class=cp>#define AUX_MUSTAT_SYMBOL_AV        ( 1 &lt;&lt; 0 )</span>
<span class=cp>#define AUX_MUSTAT_SPACE_AV         ( 1 &lt;&lt; 1 )</span>
<span class=cp>#define AUX_MUSTAT_RX_IDLE          ( 1 &lt;&lt; 2 )</span>
<span class=cp>#define AUX_MUSTAT_TX_IDLE          ( 1 &lt;&lt; 3 )</span>
<span class=cp>#define AUX_MUSTAT_RX_OVERRUN       ( 1 &lt;&lt; 4 )</span>
<span class=cp>#define AUX_MUSTAT_TX_FIFO_FULL     ( 1 &lt;&lt; 5 )</span>
<span class=cp>#define AUX_MUSTAT_RTS              ( 1 &lt;&lt; 6 )</span>
<span class=cp>#define AUX_MUSTAT_CTS              ( 1 &lt;&lt; 7 )</span>
<span class=cp>#define AUX_MUSTAT_TX_EMPTY         ( 1 &lt;&lt; 8 )</span>
<span class=cp>#define AUX_MUSTAT_TX_DONE          ( 1 &lt;&lt; 9 )</span>
<span class=cp>#define AUX_MUSTAT_RX_FIFO_LEVEL    ( 7 &lt;&lt; 16 )</span>
<span class=cp>#define AUX_MUSTAT_TX_FIFO_LEVEL    ( 7 &lt;&lt; 24 )</span>


<span class=cp>#define FSEL0(x)        ( x )</span>
<span class=p>...</span><span class=w></span>
<span class=cp>#define FSEL53(x)       ( x &lt;&lt; 9 )</span>


<span class=k>typedef</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>IRQ</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>ENABLES</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>reserved1</span><span class=p>[((</span><span class=mh>0x40</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mh>0x04</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mi>4</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>];</span><span class=w></span>

<span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>MU_IO</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>MU_IER</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>MU_IIR</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>MU_LCR</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>MU_MCR</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>MU_LSR</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>MU_MSR</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>MU_SCRATCH</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>MU_CNTL</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>MU_STAT</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>MU_BAUD</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>reserved2</span><span class=p>[(</span><span class=mh>0x80</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mh>0x68</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mi>4</span><span class=p>];</span><span class=w></span>

<span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>SPI0_CNTL0</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>SPI0_CNTL1</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>SPI0_STAT</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>SPI0_IO</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>SPI0_PEEK</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>reserved3</span><span class=p>[(</span><span class=mh>0xC0</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mh>0x94</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mi>4</span><span class=p>];</span><span class=w></span>

<span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>SPI1_CNTL0</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>SPI1_CNTL1</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>SPI1_STAT</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>SPI1_IO</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>SPI1_PEEK</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w> </span><span class=n>aux_t</span><span class=p>;</span><span class=w></span>

<span class=k>extern</span><span class=w> </span><span class=n>aux_t</span><span class=o>*</span><span class=w> </span><span class=nf>RPI_GetAux</span><span class=p>(</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=p>);</span><span class=w></span>
<span class=k>extern</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>RPI_AuxMiniUartInit</span><span class=p>(</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>baud</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>bits</span><span class=w> </span><span class=p>);</span><span class=w></span>
<span class=k>extern</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>RPI_AuxMiniUartWrite</span><span class=p>(</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=p>);</span><span class=w></span>

<span class=cp>#endif</span>
</code></pre></div> <p>I'm not going to go too far into explaining these drivers now. It's written in C, and you've got the BCM2835 data sheet the same as I have. You should be getting familiar with the layout of these "driver" files and the documentation in the BCM2835 peripherals document.</p> <p>We provide an initialisation function so we can set the number of bits (data bits) and the baud rate. The mini UART implementation isn't that configurable because it's not a full UART implementation. It's designed to provide a quick means of providing a console with as little code as possible. So there's no setting for parity or number of stop bits. It's always N1 (No parity, one stop bit).</p> <blockquote> <p><strong>HACK:</strong> The calculation for the baud rate registers is done based on a defined system frequency relative to the RPI type. It works, but it's not as nice as using a programatically detected system frequency.</p> </blockquote> <p>The functions are written in a blocking mode, so the write function blocks until the UART can accept the next character, then it writes the new character and returns. Normally we'd use the UART interrupt to send a whole buffer of data rather than manually polling the register as this ties the processor up waiting. However, these are easy to use!</p> <h3 id=the-_write-system-call>The _write() System Call<a class=headerlink href=#the-_write-system-call title="Permanent link">&para;</a></h3> <p>Whenever data needs to be written to the OS it's done so through a function called <code>_write</code>. This is one of the original c-stubs we wrote in a previous tutorial. We previously just implemented a blank function. Here's the blank function we had. As you can see, it's not quite blank, but <code>outbyte</code> does nothing with the data, it's an empty sink.</p> <div class=highlight><pre><span></span><code><span class=kt>void</span><span class=w> </span><span class=nf>outbyte</span><span class=p>(</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=n>b</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=kt>int</span><span class=w> </span><span class=nf>_write</span><span class=p>(</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>file</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>ptr</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>todo</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=k>for</span><span class=p>(</span><span class=w> </span><span class=n>todo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>todo</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>len</span><span class=p>;</span><span class=w> </span><span class=n>todo</span><span class=o>++</span><span class=w> </span><span class=p>)</span><span class=w></span>
<span class=w>      </span><span class=n>outbyte</span><span class=p>(</span><span class=o>*</span><span class=n>ptr</span><span class=o>++</span><span class=p>);</span><span class=w></span>

<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>len</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>We can tie all writes to the OS (for all files) to the UART console by adding the UART write function call to outbyte:</p> <div class=highlight><pre><span></span><code><span class=kt>void</span><span class=w> </span><span class=nf>outbyte</span><span class=p>(</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>RPI_AuxMiniUartWrite</span><span class=p>(</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=p>);</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>Originally this is what I did, and then when I used printf() to test function I kept getting a crash. In fact after some debugging with the OK LED in the processor exception handlers we introduced in the last tutorial I was able to determine it was an undefined instruction error.</p> <p>When you run this tutorials examples with PuTTY, you'll see output similar to this:</p> <p><img alt="PuTTY RPi Connection" src=/img/bare-metal-programming-in-c/part-5-putty-rpi-connection.png></p> <p>If you're on Linux, you can use screen to view the output of the tutorial in the terminal:</p> <div class=highlight><pre><span></span><code>screen /dev/ttyUSB0 115200,cs8,ixoff,-istrip
</code></pre></div> <blockquote> <p><strong>NOTE:</strong> You may have to use sudo in order to open the USB tty!</p> </blockquote> <h3 id=enabling-vfp-support>Enabling VFP Support<a class=headerlink href=#enabling-vfp-support title="Permanent link">&para;</a></h3> <p>After a bit more thinking and tinkering I realised we have to enable the VFP now in order to use <code>printf</code>. As we're compiling and telling the compiler (or more the linker actually) that we're targeting a device with the VFP it is linking to a libc that can use VFP instructions and why shouldn't something in the <code>printf</code> implementation use the VFP instruction when necessary to speed things up?</p> <p>There is some <a href=http://stackoverflow.com/questions/24589235/application-hangs-when-calling-printf-to-uart-with-bare-metal-raspberry-pi/27257841#27257841>more information about the problem on a stackoverflow answer</a>.</p> <p>Without the VFP co-processor being enabled, VFP instructions will cause an undefined instruction exception. Enabling the VFP is another task that the C Runtime startup file <code>crt0</code> would have performed for us, but we're on our own since we have to use <code>-nostartfiles</code> (See an earlier tutorial).</p> <p>Some <a href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.dai0098a/index.html">recommended information about enabling VFP support</a> is available from ARM.</p> <p>Some <a href=http://processors.wiki.ti.com/index.php/Cortex-A8#How_to_enable_NEON>example code for enabling the VFP</a> is available on the TI wiki, and that's the code we slice in to armc-start.S so that the VFP is enabled before the c library is setup:</p> <div class=highlight><pre><span></span><code><span class=c1>// Enable VFP ------------------------------------------------------------</span>

<span class=c1>// r1 = Access Control Register</span>
<span class=nf>MRC</span><span class=w> </span><span class=no>p15</span><span class=p>,</span><span class=w> </span><span class=mi>#0</span><span class=p>,</span><span class=w> </span><span class=no>r1</span><span class=p>,</span><span class=w> </span><span class=no>c1</span><span class=p>,</span><span class=w> </span><span class=no>c0</span><span class=p>,</span><span class=w> </span><span class=mi>#2</span><span class=w></span>
<span class=c1>// enable full access for p10,11</span>
<span class=nf>ORR</span><span class=w> </span><span class=no>r1</span><span class=p>,</span><span class=w> </span><span class=no>r1</span><span class=p>,</span><span class=w> </span><span class=c1>#(0xf &lt;&lt; 20)</span>
<span class=c1>// ccess Control Register = r1</span>
<span class=nf>MCR</span><span class=w> </span><span class=no>p15</span><span class=p>,</span><span class=w> </span><span class=mi>#0</span><span class=p>,</span><span class=w> </span><span class=no>r1</span><span class=p>,</span><span class=w> </span><span class=no>c1</span><span class=p>,</span><span class=w> </span><span class=no>c0</span><span class=p>,</span><span class=w> </span><span class=mi>#2</span><span class=w></span>
<span class=nf>MOV</span><span class=w> </span><span class=no>r1</span><span class=p>,</span><span class=w> </span><span class=mi>#0</span><span class=w></span>
<span class=c1>// flush prefetch buffer because of FMXR below</span>
<span class=nf>MCR</span><span class=w> </span><span class=no>p15</span><span class=p>,</span><span class=w> </span><span class=mi>#0</span><span class=p>,</span><span class=w> </span><span class=no>r1</span><span class=p>,</span><span class=w> </span><span class=no>c7</span><span class=p>,</span><span class=w> </span><span class=no>c5</span><span class=p>,</span><span class=w> </span><span class=mi>#4</span><span class=w></span>
<span class=c1>// and CP 10 &amp; 11 were only just enabled</span>
<span class=c1>// Enable VFP itself</span>
<span class=nf>MOV</span><span class=w> </span><span class=no>r0</span><span class=p>,</span><span class=mi>#0</span><span class=no>x40000000</span><span class=w></span>
<span class=c1>// FPEXC = r0</span>
<span class=nf>FMXR</span><span class=w> </span><span class=no>FPEXC</span><span class=p>,</span><span class=w> </span><span class=no>r0</span><span class=w></span>
</code></pre></div> <p>With those additions, we can now go ahead and use the c-library write functions. It means that the full <code>printf()</code> implementation can be used on the UART for example without us having to lift a finger and try and implement something as fundamental as that ourselves.</p> <p>Also, this provides us with a debug/comms channel that is separate to the display. It's hard to use the display for debugging when the display isn't yet working!</p> <h3 id=mailboxes>Mailboxes<a class=headerlink href=#mailboxes title="Permanent link">&para;</a></h3> <p>We introduce some code in a few files, namely <code>rpi-mailbox</code> and <code>rpi-mailbox-interface</code>. The first is a common interface to access the mailbox system which passes information from the GPU to the ARM processor. The mailbox interface is implemented in the firmware (start.elf) that runs on the GPU.</p> <p>Here's the code, and as noted in the comments, the mailbox interface is described on the RPI firmware github wiki:</p> <ul> <li><a href=https://github.com/raspberrypi/firmware/wiki/Accessing-mailboxes>Access Mailboxes</a></li> <li><a href=https://github.com/raspberrypi/firmware/wiki/Mailboxes>Mailboxes Wiki</a></li> </ul> <p><code>rpi-mailbox.h</code></p> <div class=highlight><pre><span></span><code><span class=cp>#ifndef RPI_MAILBOX_H</span>
<span class=cp>#define RPI_MAILBOX_H</span>

<span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;rpi-base.h&quot;</span><span class=cp></span>

<span class=cp>#define RPI_MAILBOX0_BASE    ( PERIPHERAL_BASE + 0xB880 )</span>

<span class=cm>/* The available mailbox channels in the BCM2835 Mailbox interface.</span>
<span class=cm>   See https://github.com/raspberrypi/firmware/wiki/Mailboxes for</span>
<span class=cm>   information */</span><span class=w></span>
<span class=k>typedef</span><span class=w> </span><span class=k>enum</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>MB0_POWER_MANAGEMENT</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>MB0_FRAMEBUFFER</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>MB0_VIRTUAL_UART</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>MB0_VCHIQ</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>MB0_LEDS</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>MB0_BUTTONS</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>MB0_TOUCHSCREEN</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>MB0_UNUSED</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>MB0_TAGS_ARM_TO_VC</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>MB0_TAGS_VC_TO_ARM</span><span class=p>,</span><span class=w></span>
<span class=p>}</span><span class=w> </span><span class=n>mailbox0_channel_t</span><span class=p>;</span><span class=w></span>

<span class=cm>/* These defines come from the Broadcom Videocode driver source code, see:</span>
<span class=cm>   brcm_usrlib/dag/vmcsx/vcinclude/bcm2708_chip/arm_control.h */</span><span class=w></span>
<span class=k>enum</span><span class=w> </span><span class=n>mailbox_status_reg_bits</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>ARM_MS_FULL</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=mh>0x80000000</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>ARM_MS_EMPTY</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x40000000</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>ARM_MS_LEVEL</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x400000FF</span><span class=p>,</span><span class=w></span>
<span class=p>};</span><span class=w></span>

<span class=cm>/* Define a structure which defines the register access to a mailbox.</span>
<span class=cm>   Not all mailboxes support the full register set! */</span><span class=w></span>
<span class=k>typedef</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>Read</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>reserved1</span><span class=p>[((</span><span class=mh>0x90</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mh>0x80</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mi>4</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>];</span><span class=w></span>
<span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>Poll</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>Sender</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>Status</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>Configuration</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>volatile</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>Write</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w> </span><span class=n>mailbox_t</span><span class=p>;</span><span class=w></span>

<span class=k>extern</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>RPI_Mailbox0Write</span><span class=p>(</span><span class=w> </span><span class=n>mailbox0_channel_t</span><span class=w> </span><span class=n>channel</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=p>);</span><span class=w></span>
<span class=k>extern</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>RPI_Mailbox0Read</span><span class=p>(</span><span class=w> </span><span class=n>mailbox0_channel_t</span><span class=w> </span><span class=n>channel</span><span class=w> </span><span class=p>);</span><span class=w></span>

<span class=cp>#endif</span>
</code></pre></div> <p><code>rpi-mailbox.c</code>:</p> <div class=highlight><pre><span></span><code><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;stdint.h&gt;</span><span class=cp></span>

<span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;rpi-gpio.h&quot;</span><span class=cp></span>
<span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;rpi-mailbox.h&quot;</span><span class=cp></span>

<span class=cm>/* Mailbox 0 mapped to it&#39;s base address */</span><span class=w></span>
<span class=k>static</span><span class=w> </span><span class=n>mailbox_t</span><span class=o>*</span><span class=w> </span><span class=n>rpiMailbox0</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>mailbox_t</span><span class=o>*</span><span class=p>)</span><span class=n>RPI_MAILBOX0_BASE</span><span class=p>;</span><span class=w></span>

<span class=kt>void</span><span class=w> </span><span class=nf>RPI_Mailbox0Write</span><span class=p>(</span><span class=w> </span><span class=n>mailbox0_channel_t</span><span class=w> </span><span class=n>channel</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=cm>/* For information about accessing mailboxes, see:</span>
<span class=cm>       https://github.com/raspberrypi/firmware/wiki/Accessing-mailboxes */</span><span class=w></span>

<span class=w>    </span><span class=cm>/* Add the channel number into the lower 4 bits */</span><span class=w></span>
<span class=w>    </span><span class=n>value</span><span class=w> </span><span class=o>&amp;=</span><span class=w> </span><span class=o>~</span><span class=p>(</span><span class=mh>0xF</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>value</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>channel</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=cm>/* Wait until the mailbox becomes available and then write to the mailbox</span>
<span class=cm>       channel */</span><span class=w></span>
<span class=w>    </span><span class=k>while</span><span class=p>(</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=n>rpiMailbox0</span><span class=o>-&gt;</span><span class=n>Status</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>ARM_MS_FULL</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=cm>/* Write the modified value + channel number into the write register */</span><span class=w></span>
<span class=w>    </span><span class=n>rpiMailbox0</span><span class=o>-&gt;</span><span class=n>Write</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>


<span class=kt>int</span><span class=w> </span><span class=nf>RPI_Mailbox0Read</span><span class=p>(</span><span class=w> </span><span class=n>mailbox0_channel_t</span><span class=w> </span><span class=n>channel</span><span class=w> </span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=cm>/* For information about accessing mailboxes, see:</span>
<span class=cm>       https://github.com/raspberrypi/firmware/wiki/Accessing-mailboxes */</span><span class=w></span>
<span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=cm>/* Keep reading the register until the desired channel gives us a value */</span><span class=w></span>
<span class=w>    </span><span class=k>while</span><span class=p>(</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0xF</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>channel</span><span class=w> </span><span class=p>)</span><span class=w></span>
<span class=w>    </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=cm>/* Wait while the mailbox is empty because otherwise there&#39;s no value</span>
<span class=cm>           to read! */</span><span class=w></span>
<span class=w>        </span><span class=k>while</span><span class=p>(</span><span class=w> </span><span class=n>rpiMailbox0</span><span class=o>-&gt;</span><span class=n>Status</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>ARM_MS_EMPTY</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>}</span><span class=w></span>

<span class=w>        </span><span class=cm>/* Extract the value from the Read register of the mailbox. The value</span>
<span class=cm>           is actually in the upper 28 bits */</span><span class=w></span>
<span class=w>        </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rpiMailbox0</span><span class=o>-&gt;</span><span class=n>Read</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=cm>/* Return just the value (the upper 28-bits) */</span><span class=w></span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>4</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>There are two mailboxes, 0 and 1. We only need to use mailbox 0. Mailbox has a number of channels to communicate on which are defined in the <code>enum mailbox0_channel_t</code>.</p> <p>The basics of the mailbox operation are pretty straight forward.</p> <p>To <strong>write</strong> to a mailbox we first construct a composite value. We can write a 32-bit value to the GPU which is generally a memory address, but the mailbox also has to support multiple channels and there is no separate place to write the channel number. In order to achieve multiple channels on a single mailbox the lower nibble (4-bits) are reserved for the channel number and the upper 28-bits are the value we're sending to the GPU. This means that any address we send to the GPU is missing the lowest 4-bits and the GPU simply assumes those bits are all 0. We therefore need to align any address we send the GPU to a 16-byte boundary which will ensure the lower 4-bits will be 0.</p> <p>The ARM waits for the mailbox to become empty by polling the status register and then it can write the composite value of the address and channel to the mailbox.</p> <p>To <strong>read</strong> from a mailbox we wait until the mailbox is full and read the value. Only when the value contains the same channel as we are waiting to communicate with do we proceed and return.</p> <p>The value is a 16-byte aligned memory address. It's important to know that we don't just send a value and get a value back. We send an address to a memory block that we have constructed specifically formatted messages in to communicate with the GPU. The messages that are passed to the GPU are channel dependant and so aren't defined in this code module. We will do a code module for each channel we use. Actually, we're only going to use one - <code>MB0_TAGS_ARM_TO_VC</code> which is used with the mailbox property interface.</p> <blockquote> <p><strong>NOTE:</strong> Although the Framebuffer channel looks like the place to begin, actually we'll ignore that mailbox channel because it's a deprecated channel. It came before the mailbox property interface channel had framebuffer properties added to it.</p> </blockquote> <h3 id=mailbox-property-interface>Mailbox Property Interface<a class=headerlink href=#mailbox-property-interface title="Permanent link">&para;</a></h3> <p>The <a href=https://github.com/raspberrypi/firmware/wiki/Mailbox-property-interface>Mailbox Property Interface</a> specifies the messaging structure that needs to be present in the 16-byte aligned memory region I mentioned earlier. There are a lot of properties, and you need to read that page a couple of times to get a hold of how the data needs to be laid out.</p> <p>Here's the code we're using to support the Mailbox Property Interface:</p> <p><code>rpi-mailbox-interface.c</code>:</p> <div class=highlight><pre><span></span><code><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;stdarg.h&gt;</span><span class=cp></span>
<span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;stdio.h&gt;</span><span class=cp></span>
<span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;string.h&gt;</span><span class=cp></span>

<span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;rpi-mailbox.h&quot;</span><span class=cp></span>
<span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;rpi-mailbox-interface.h&quot;</span><span class=cp></span>

<span class=cm>/* Make sure the property tag buffer is aligned to a 16-byte boundary because</span>
<span class=cm>   we only have 28-bits available in the property interface protocol to pass</span>
<span class=cm>   the address of the buffer to the VC. */</span><span class=w></span>
<span class=k>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>pt</span><span class=p>[</span><span class=mi>8192</span><span class=p>]</span><span class=w> </span><span class=n>__attribute__</span><span class=p>((</span><span class=n>aligned</span><span class=p>(</span><span class=mi>16</span><span class=p>)));</span><span class=w></span>
<span class=k>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>pt_index</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w></span>


<span class=kt>void</span><span class=w> </span><span class=nf>RPI_PropertyInit</span><span class=p>(</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=cm>/* Fill in the size on-the-fly */</span><span class=w></span>
<span class=w>    </span><span class=n>pt</span><span class=p>[</span><span class=n>PT_OSIZE</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>12</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=cm>/* Process request (All other values are reserved!) */</span><span class=w></span>
<span class=w>    </span><span class=n>pt</span><span class=p>[</span><span class=n>PT_OREQUEST_OR_RESPONSE</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=cm>/* First available data slot */</span><span class=w></span>
<span class=w>    </span><span class=n>pt_index</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>2</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=cm>/* NULL tag to terminate tag list */</span><span class=w></span>
<span class=w>    </span><span class=n>pt</span><span class=p>[</span><span class=n>pt_index</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=cm>/**</span>
<span class=cm>    @brief Add a property tag to the current tag list. Data can be included. All data is uint32_t</span>
<span class=cm>    @param tag</span>
<span class=cm>*/</span><span class=w></span>
<span class=kt>void</span><span class=w> </span><span class=nf>RPI_PropertyAddTag</span><span class=p>(</span><span class=w> </span><span class=n>rpi_mailbox_tag_t</span><span class=w> </span><span class=n>tag</span><span class=p>,</span><span class=w> </span><span class=p>...</span><span class=w> </span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=kt>va_list</span><span class=w> </span><span class=n>vl</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>va_start</span><span class=p>(</span><span class=w> </span><span class=n>vl</span><span class=p>,</span><span class=w> </span><span class=n>tag</span><span class=w> </span><span class=p>);</span><span class=w></span>

<span class=w>    </span><span class=n>pt</span><span class=p>[</span><span class=n>pt_index</span><span class=o>++</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tag</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=k>switch</span><span class=p>(</span><span class=w> </span><span class=n>tag</span><span class=w> </span><span class=p>)</span><span class=w></span>
<span class=w>    </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>TAG_GET_FIRMWARE_VERSION</span><span class=p>:</span><span class=w></span>
<span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>TAG_GET_BOARD_MODEL</span><span class=p>:</span><span class=w></span>
<span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>TAG_GET_BOARD_REVISION</span><span class=p>:</span><span class=w></span>
<span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>TAG_GET_BOARD_MAC_ADDRESS</span><span class=p>:</span><span class=w></span>
<span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>TAG_GET_BOARD_SERIAL</span><span class=p>:</span><span class=w></span>
<span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>TAG_GET_ARM_MEMORY</span><span class=p>:</span><span class=w></span>
<span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>TAG_GET_VC_MEMORY</span><span class=p>:</span><span class=w></span>
<span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>TAG_GET_DMA_CHANNELS</span><span class=p>:</span><span class=w></span>
<span class=w>            </span><span class=cm>/* Provide an 8-byte buffer for the response */</span><span class=w></span>
<span class=w>            </span><span class=n>pt</span><span class=p>[</span><span class=n>pt_index</span><span class=o>++</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>8</span><span class=p>;</span><span class=w></span>
<span class=w>            </span><span class=n>pt</span><span class=p>[</span><span class=n>pt_index</span><span class=o>++</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=cm>/* Request */</span><span class=w></span>
<span class=w>            </span><span class=n>pt_index</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>2</span><span class=p>;</span><span class=w></span>
<span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w></span>

<span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>TAG_GET_CLOCKS</span><span class=p>:</span><span class=w></span>
<span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>TAG_GET_COMMAND_LINE</span><span class=p>:</span><span class=w></span>
<span class=w>            </span><span class=cm>/* Provide a 256-byte buffer */</span><span class=w></span>
<span class=w>            </span><span class=n>pt</span><span class=p>[</span><span class=n>pt_index</span><span class=o>++</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>256</span><span class=p>;</span><span class=w></span>
<span class=w>            </span><span class=n>pt</span><span class=p>[</span><span class=n>pt_index</span><span class=o>++</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=cm>/* Request */</span><span class=w></span>
<span class=w>            </span><span class=n>pt_index</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>256</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>2</span><span class=p>;</span><span class=w></span>
<span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w></span>

<span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>TAG_ALLOCATE_BUFFER</span><span class=p>:</span><span class=w></span>
<span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>TAG_GET_MAX_CLOCK_RATE</span><span class=p>:</span><span class=w></span>
<span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>TAG_GET_MIN_CLOCK_RATE</span><span class=p>:</span><span class=w></span>
<span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>TAG_GET_CLOCK_RATE</span><span class=p>:</span><span class=w></span>
<span class=w>            </span><span class=n>pt</span><span class=p>[</span><span class=n>pt_index</span><span class=o>++</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>8</span><span class=p>;</span><span class=w></span>
<span class=w>            </span><span class=n>pt</span><span class=p>[</span><span class=n>pt_index</span><span class=o>++</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=cm>/* Request */</span><span class=w></span>
<span class=w>            </span><span class=n>pt</span><span class=p>[</span><span class=n>pt_index</span><span class=o>++</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>va_arg</span><span class=p>(</span><span class=w> </span><span class=n>vl</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=p>);</span><span class=w></span>
<span class=w>            </span><span class=n>pt</span><span class=p>[</span><span class=n>pt_index</span><span class=o>++</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w></span>
<span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w></span>

<span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>TAG_SET_CLOCK_RATE</span><span class=p>:</span><span class=w></span>
<span class=w>            </span><span class=n>pt</span><span class=p>[</span><span class=n>pt_index</span><span class=o>++</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>12</span><span class=p>;</span><span class=w></span>
<span class=w>            </span><span class=n>pt</span><span class=p>[</span><span class=n>pt_index</span><span class=o>++</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=cm>/* Request */</span><span class=w></span>
<span class=w>            </span><span class=n>pt</span><span class=p>[</span><span class=n>pt_index</span><span class=o>++</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>va_arg</span><span class=p>(</span><span class=w> </span><span class=n>vl</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=p>);</span><span class=w> </span><span class=cm>/* Clock ID */</span><span class=w></span>
<span class=w>            </span><span class=n>pt</span><span class=p>[</span><span class=n>pt_index</span><span class=o>++</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>va_arg</span><span class=p>(</span><span class=w> </span><span class=n>vl</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=p>);</span><span class=w> </span><span class=cm>/* Rate (in Hz) */</span><span class=w></span>
<span class=w>            </span><span class=n>pt</span><span class=p>[</span><span class=n>pt_index</span><span class=o>++</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>va_arg</span><span class=p>(</span><span class=w> </span><span class=n>vl</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=p>);</span><span class=w> </span><span class=cm>/* Skip turbo setting if == 1 */</span><span class=w></span>
<span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w></span>

<span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>TAG_GET_PHYSICAL_SIZE</span><span class=p>:</span><span class=w></span>
<span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>TAG_SET_PHYSICAL_SIZE</span><span class=p>:</span><span class=w></span>
<span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>TAG_TEST_PHYSICAL_SIZE</span><span class=p>:</span><span class=w></span>
<span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>TAG_GET_VIRTUAL_SIZE</span><span class=p>:</span><span class=w></span>
<span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>TAG_SET_VIRTUAL_SIZE</span><span class=p>:</span><span class=w></span>
<span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>TAG_TEST_VIRTUAL_SIZE</span><span class=p>:</span><span class=w></span>
<span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>TAG_GET_VIRTUAL_OFFSET</span><span class=p>:</span><span class=w></span>
<span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>TAG_SET_VIRTUAL_OFFSET</span><span class=p>:</span><span class=w></span>
<span class=w>            </span><span class=n>pt</span><span class=p>[</span><span class=n>pt_index</span><span class=o>++</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>8</span><span class=p>;</span><span class=w></span>
<span class=w>            </span><span class=n>pt</span><span class=p>[</span><span class=n>pt_index</span><span class=o>++</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=cm>/* Request */</span><span class=w></span>

<span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=n>tag</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TAG_SET_PHYSICAL_SIZE</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w></span>
<span class=w>                </span><span class=p>(</span><span class=w> </span><span class=n>tag</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TAG_SET_VIRTUAL_SIZE</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w></span>
<span class=w>                </span><span class=p>(</span><span class=w> </span><span class=n>tag</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TAG_SET_VIRTUAL_OFFSET</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w></span>
<span class=w>                </span><span class=p>(</span><span class=w> </span><span class=n>tag</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TAG_TEST_PHYSICAL_SIZE</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w></span>
<span class=w>                </span><span class=p>(</span><span class=w> </span><span class=n>tag</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TAG_TEST_VIRTUAL_SIZE</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=p>)</span><span class=w></span>
<span class=w>            </span><span class=p>{</span><span class=w></span>
<span class=w>                </span><span class=n>pt</span><span class=p>[</span><span class=n>pt_index</span><span class=o>++</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>va_arg</span><span class=p>(</span><span class=w> </span><span class=n>vl</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=p>);</span><span class=w> </span><span class=cm>/* Width */</span><span class=w></span>
<span class=w>                </span><span class=n>pt</span><span class=p>[</span><span class=n>pt_index</span><span class=o>++</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>va_arg</span><span class=p>(</span><span class=w> </span><span class=n>vl</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=p>);</span><span class=w> </span><span class=cm>/* Height */</span><span class=w></span>
<span class=w>            </span><span class=p>}</span><span class=w></span>
<span class=w>            </span><span class=k>else</span><span class=w></span>
<span class=w>            </span><span class=p>{</span><span class=w></span>
<span class=w>                </span><span class=n>pt_index</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>2</span><span class=p>;</span><span class=w></span>
<span class=w>            </span><span class=p>}</span><span class=w></span>
<span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w></span>

<span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>TAG_GET_ALPHA_MODE</span><span class=p>:</span><span class=w></span>
<span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>TAG_SET_ALPHA_MODE</span><span class=p>:</span><span class=w></span>
<span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>TAG_GET_DEPTH</span><span class=p>:</span><span class=w></span>
<span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>TAG_SET_DEPTH</span><span class=p>:</span><span class=w></span>
<span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>TAG_GET_PIXEL_ORDER</span><span class=p>:</span><span class=w></span>
<span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>TAG_SET_PIXEL_ORDER</span><span class=p>:</span><span class=w></span>
<span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>TAG_GET_PITCH</span><span class=p>:</span><span class=w></span>
<span class=w>            </span><span class=n>pt</span><span class=p>[</span><span class=n>pt_index</span><span class=o>++</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>4</span><span class=p>;</span><span class=w></span>
<span class=w>            </span><span class=n>pt</span><span class=p>[</span><span class=n>pt_index</span><span class=o>++</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=cm>/* Request */</span><span class=w></span>

<span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=n>tag</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TAG_SET_DEPTH</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w></span>
<span class=w>                </span><span class=p>(</span><span class=w> </span><span class=n>tag</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TAG_SET_PIXEL_ORDER</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w></span>
<span class=w>                </span><span class=p>(</span><span class=w> </span><span class=n>tag</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TAG_SET_ALPHA_MODE</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=p>)</span><span class=w></span>
<span class=w>            </span><span class=p>{</span><span class=w></span>
<span class=w>                </span><span class=cm>/* Colour Depth, bits-per-pixel \ Pixel Order State */</span><span class=w></span>
<span class=w>                </span><span class=n>pt</span><span class=p>[</span><span class=n>pt_index</span><span class=o>++</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>va_arg</span><span class=p>(</span><span class=w> </span><span class=n>vl</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=p>);</span><span class=w></span>
<span class=w>            </span><span class=p>}</span><span class=w></span>
<span class=w>            </span><span class=k>else</span><span class=w></span>
<span class=w>            </span><span class=p>{</span><span class=w></span>
<span class=w>                </span><span class=n>pt_index</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w></span>
<span class=w>            </span><span class=p>}</span><span class=w></span>
<span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w></span>

<span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>TAG_GET_OVERSCAN</span><span class=p>:</span><span class=w></span>
<span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>TAG_SET_OVERSCAN</span><span class=p>:</span><span class=w></span>
<span class=w>            </span><span class=n>pt</span><span class=p>[</span><span class=n>pt_index</span><span class=o>++</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>16</span><span class=p>;</span><span class=w></span>
<span class=w>            </span><span class=n>pt</span><span class=p>[</span><span class=n>pt_index</span><span class=o>++</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=cm>/* Request */</span><span class=w></span>

<span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=n>tag</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TAG_SET_OVERSCAN</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=p>)</span><span class=w></span>
<span class=w>            </span><span class=p>{</span><span class=w></span>
<span class=w>                </span><span class=n>pt</span><span class=p>[</span><span class=n>pt_index</span><span class=o>++</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>va_arg</span><span class=p>(</span><span class=w> </span><span class=n>vl</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=p>);</span><span class=w> </span><span class=cm>/* Top pixels */</span><span class=w></span>
<span class=w>                </span><span class=n>pt</span><span class=p>[</span><span class=n>pt_index</span><span class=o>++</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>va_arg</span><span class=p>(</span><span class=w> </span><span class=n>vl</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=p>);</span><span class=w> </span><span class=cm>/* Bottom pixels */</span><span class=w></span>
<span class=w>                </span><span class=n>pt</span><span class=p>[</span><span class=n>pt_index</span><span class=o>++</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>va_arg</span><span class=p>(</span><span class=w> </span><span class=n>vl</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=p>);</span><span class=w> </span><span class=cm>/* Left pixels */</span><span class=w></span>
<span class=w>                </span><span class=n>pt</span><span class=p>[</span><span class=n>pt_index</span><span class=o>++</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>va_arg</span><span class=p>(</span><span class=w> </span><span class=n>vl</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=p>);</span><span class=w> </span><span class=cm>/* Right pixels */</span><span class=w></span>
<span class=w>            </span><span class=p>}</span><span class=w></span>
<span class=w>            </span><span class=k>else</span><span class=w></span>
<span class=w>            </span><span class=p>{</span><span class=w></span>
<span class=w>                </span><span class=n>pt_index</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>4</span><span class=p>;</span><span class=w></span>
<span class=w>            </span><span class=p>}</span><span class=w></span>
<span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w></span>

<span class=w>        </span><span class=k>default</span><span class=o>:</span><span class=w></span>
<span class=w>            </span><span class=cm>/* Unsupported tags, just remove the tag from the list */</span><span class=w></span>
<span class=w>            </span><span class=n>pt_index</span><span class=o>--</span><span class=p>;</span><span class=w></span>
<span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=cm>/* Make sure the tags are 0 terminated to end the list and update the buffer size */</span><span class=w></span>
<span class=w>    </span><span class=n>pt</span><span class=p>[</span><span class=n>pt_index</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=n>va_end</span><span class=p>(</span><span class=w> </span><span class=n>vl</span><span class=w> </span><span class=p>);</span><span class=w></span>
<span class=p>}</span><span class=w></span>


<span class=kt>int</span><span class=w> </span><span class=nf>RPI_PropertyProcess</span><span class=p>(</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w></span>

<span class=cp>#if( PRINT_PROP_DEBUG == 1 )</span>
<span class=w>    </span><span class=n>printf</span><span class=p>(</span><span class=w> </span><span class=s>&quot;%s Length: %d</span><span class=se>\r\n</span><span class=s>&quot;</span><span class=p>,</span><span class=w> </span><span class=n>__func__</span><span class=p>,</span><span class=w> </span><span class=n>pt</span><span class=p>[</span><span class=n>PT_OSIZE</span><span class=p>]</span><span class=w> </span><span class=p>);</span><span class=w></span>
<span class=cp>#endif</span>
<span class=w>    </span><span class=cm>/* Fill in the size of the buffer */</span><span class=w></span>
<span class=w>    </span><span class=n>pt</span><span class=p>[</span><span class=n>PT_OSIZE</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=n>pt_index</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>2</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>pt</span><span class=p>[</span><span class=n>PT_OREQUEST_OR_RESPONSE</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w></span>

<span class=cp>#if( PRINT_PROP_DEBUG == 1 )</span>
<span class=w>    </span><span class=k>for</span><span class=p>(</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=p>(</span><span class=n>pt</span><span class=p>[</span><span class=n>PT_OSIZE</span><span class=p>]</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>2</span><span class=p>);</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=w> </span><span class=p>)</span><span class=w></span>
<span class=w>        </span><span class=n>printf</span><span class=p>(</span><span class=w> </span><span class=s>&quot;Request: %3d %8.8X</span><span class=se>\r\n</span><span class=s>&quot;</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=n>pt</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=w> </span><span class=p>);</span><span class=w></span>
<span class=cp>#endif</span>
<span class=w>    </span><span class=n>RPI_Mailbox0Write</span><span class=p>(</span><span class=w> </span><span class=n>MB0_TAGS_ARM_TO_VC</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=p>)</span><span class=n>pt</span><span class=w> </span><span class=p>);</span><span class=w></span>

<span class=w>    </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>RPI_Mailbox0Read</span><span class=p>(</span><span class=w> </span><span class=n>MB0_TAGS_ARM_TO_VC</span><span class=w> </span><span class=p>);</span><span class=w></span>

<span class=cp>#if( PRINT_PROP_DEBUG == 1 )</span>
<span class=w>    </span><span class=k>for</span><span class=p>(</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=p>(</span><span class=n>pt</span><span class=p>[</span><span class=n>PT_OSIZE</span><span class=p>]</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>2</span><span class=p>);</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=w> </span><span class=p>)</span><span class=w></span>
<span class=w>        </span><span class=n>printf</span><span class=p>(</span><span class=w> </span><span class=s>&quot;Response: %3d %8.8X</span><span class=se>\r\n</span><span class=s>&quot;</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=n>pt</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=w> </span><span class=p>);</span><span class=w></span>
<span class=cp>#endif</span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>


<span class=n>rpi_mailbox_property_t</span><span class=o>*</span><span class=w> </span><span class=nf>RPI_PropertyGet</span><span class=p>(</span><span class=w> </span><span class=n>rpi_mailbox_tag_t</span><span class=w> </span><span class=n>tag</span><span class=w> </span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>static</span><span class=w> </span><span class=n>rpi_mailbox_property_t</span><span class=w> </span><span class=n>property</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=kt>int</span><span class=o>*</span><span class=w> </span><span class=n>tag_buffer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>NULL</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=n>property</span><span class=p>.</span><span class=n>tag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tag</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=cm>/* Get the tag from the buffer. Start at the first tag position  */</span><span class=w></span>
<span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>index</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>2</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=k>while</span><span class=p>(</span><span class=w> </span><span class=n>index</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=n>pt</span><span class=p>[</span><span class=n>PT_OSIZE</span><span class=p>]</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=p>)</span><span class=w></span>
<span class=w>    </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=cm>/* printf( &quot;Test Tag: [%d] %8.8X\r\n&quot;, index, pt[index] ); */</span><span class=w></span>
<span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=w> </span><span class=n>pt</span><span class=p>[</span><span class=n>index</span><span class=p>]</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>tag</span><span class=w> </span><span class=p>)</span><span class=w></span>
<span class=w>        </span><span class=p>{</span><span class=w></span>
<span class=w>            </span><span class=n>tag_buffer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=n>pt</span><span class=p>[</span><span class=n>index</span><span class=p>];</span><span class=w></span>
<span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=p>}</span><span class=w></span>

<span class=w>        </span><span class=cm>/* Progress to the next tag if we haven&#39;t yet discovered the tag */</span><span class=w></span>
<span class=w>        </span><span class=n>index</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=n>pt</span><span class=p>[</span><span class=n>index</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>]</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>3</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=cm>/* Return NULL of the property tag cannot be found in the buffer */</span><span class=w></span>
<span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=w> </span><span class=n>tag_buffer</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>NULL</span><span class=w> </span><span class=p>)</span><span class=w></span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>NULL</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=cm>/* Return the required data */</span><span class=w></span>
<span class=w>    </span><span class=n>property</span><span class=p>.</span><span class=n>byte_length</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tag_buffer</span><span class=p>[</span><span class=n>T_ORESPONSE</span><span class=p>]</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0xFFFF</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>memcpy</span><span class=p>(</span><span class=w> </span><span class=n>property</span><span class=p>.</span><span class=n>data</span><span class=p>.</span><span class=n>buffer_8</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>tag_buffer</span><span class=p>[</span><span class=n>T_OVALUE</span><span class=p>],</span><span class=w> </span><span class=n>property</span><span class=p>.</span><span class=n>byte_length</span><span class=w> </span><span class=p>);</span><span class=w></span>

<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=o>&amp;</span><span class=n>property</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=cp>#ifndef RPI_MAILBOX_INTERFACE_H</span>
<span class=cp>#define RPI_MAILBOX_INTERFACE_H</span>

<span class=cm>/**</span>
<span class=cm>    @brief An enum of the RPI-&gt;Videocore firmware mailbox property interface</span>
<span class=cm>    properties. Further details are available from</span>
<span class=cm>    https://github.com/raspberrypi/firmware/wiki/Mailbox-property-interface</span>
<span class=cm>*/</span><span class=w></span>
<span class=k>typedef</span><span class=w> </span><span class=k>enum</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=cm>/* Videocore */</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_GET_FIRMWARE_VERSION</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x1</span><span class=p>,</span><span class=w></span>

<span class=w>    </span><span class=cm>/* Hardware */</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_GET_BOARD_MODEL</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x10001</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_GET_BOARD_REVISION</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_GET_BOARD_MAC_ADDRESS</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_GET_BOARD_SERIAL</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_GET_ARM_MEMORY</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_GET_VC_MEMORY</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_GET_CLOCKS</span><span class=p>,</span><span class=w></span>

<span class=w>    </span><span class=cm>/* Config */</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_GET_COMMAND_LINE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x50001</span><span class=p>,</span><span class=w></span>

<span class=w>    </span><span class=cm>/* Shared resource management */</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_GET_DMA_CHANNELS</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x60001</span><span class=p>,</span><span class=w></span>

<span class=w>    </span><span class=cm>/* Power */</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_GET_POWER_STATE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x20001</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_GET_TIMING</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_SET_POWER_STATE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x28001</span><span class=p>,</span><span class=w></span>

<span class=w>    </span><span class=cm>/* Clocks */</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_GET_CLOCK_STATE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x30001</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_SET_CLOCK_STATE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x38001</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_GET_CLOCK_RATE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x30002</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_SET_CLOCK_RATE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x38002</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_GET_MAX_CLOCK_RATE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x30004</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_GET_MIN_CLOCK_RATE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x30007</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_GET_TURBO</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x30009</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_SET_TURBO</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x38009</span><span class=p>,</span><span class=w></span>

<span class=w>    </span><span class=cm>/* Voltage */</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_GET_VOLTAGE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x30003</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_SET_VOLTAGE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x38003</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_GET_MAX_VOLTAGE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x30005</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_GET_MIN_VOLTAGE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x30008</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_GET_TEMPERATURE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x30006</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_GET_MAX_TEMPERATURE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x3000A</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_ALLOCATE_MEMORY</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x3000C</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_LOCK_MEMORY</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x3000D</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_UNLOCK_MEMORY</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x3000E</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_RELEASE_MEMORY</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x3000F</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_EXECUTE_CODE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x30010</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_GET_DISPMANX_MEM_HANDLE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x30014</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_GET_EDID_BLOCK</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x30020</span><span class=p>,</span><span class=w></span>

<span class=w>    </span><span class=cm>/* Framebuffer */</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_ALLOCATE_BUFFER</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x40001</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_RELEASE_BUFFER</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x48001</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_BLANK_SCREEN</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x40002</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_GET_PHYSICAL_SIZE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x40003</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_TEST_PHYSICAL_SIZE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x44003</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_SET_PHYSICAL_SIZE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x48003</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_GET_VIRTUAL_SIZE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x40004</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_TEST_VIRTUAL_SIZE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x44004</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_SET_VIRTUAL_SIZE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x48004</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_GET_DEPTH</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x40005</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_TEST_DEPTH</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x44005</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_SET_DEPTH</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x48005</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_GET_PIXEL_ORDER</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x40006</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_TEST_PIXEL_ORDER</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x44006</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_SET_PIXEL_ORDER</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x48006</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_GET_ALPHA_MODE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x40007</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_TEST_ALPHA_MODE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x44007</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_SET_ALPHA_MODE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x48007</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_GET_PITCH</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x40008</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_GET_VIRTUAL_OFFSET</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x40009</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_TEST_VIRTUAL_OFFSET</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x44009</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_SET_VIRTUAL_OFFSET</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x48009</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_GET_OVERSCAN</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x4000A</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_TEST_OVERSCAN</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x4400A</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_SET_OVERSCAN</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x4800A</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_GET_PALETTE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x4000B</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_TEST_PALETTE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x4400B</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_SET_PALETTE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x4800B</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_SET_CURSOR_INFO</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x8011</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_SET_CURSOR_STATE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x8010</span><span class=w></span>

<span class=w>    </span><span class=p>}</span><span class=w> </span><span class=n>rpi_mailbox_tag_t</span><span class=p>;</span><span class=w></span>


<span class=k>typedef</span><span class=w> </span><span class=k>enum</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_STATE_REQUEST</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_STATE_RESPONSE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w> </span><span class=n>rpi_tag_state_t</span><span class=p>;</span><span class=w></span>


<span class=k>typedef</span><span class=w> </span><span class=k>enum</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>PT_OSIZE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>PT_OREQUEST_OR_RESPONSE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w> </span><span class=n>rpi_tag_buffer_offset_t</span><span class=p>;</span><span class=w></span>

<span class=k>typedef</span><span class=w> </span><span class=k>enum</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>T_OIDENT</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>T_OVALUE_SIZE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>T_ORESPONSE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>T_OVALUE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>3</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w> </span><span class=n>rpi_tag_offset_t</span><span class=p>;</span><span class=w></span>

<span class=k>typedef</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>tag</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>byte_length</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>union</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>value_32</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=n>buffer_8</span><span class=p>[</span><span class=mi>256</span><span class=p>];</span><span class=w></span>
<span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>buffer_32</span><span class=p>[</span><span class=mi>64</span><span class=p>];</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w> </span><span class=n>data</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w> </span><span class=n>rpi_mailbox_property_t</span><span class=p>;</span><span class=w></span>

<span class=k>typedef</span><span class=w> </span><span class=k>enum</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_CLOCK_RESERVED</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_CLOCK_EMMC</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_CLOCK_UART</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_CLOCK_ARM</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_CLOCK_CORE</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_CLOCK_V3D</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_CLOCK_H264</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_CLOCK_ISP</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_CLOCK_SDRAM</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_CLOCK_PIXEL</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>TAG_CLOCK_PWM</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w> </span><span class=n>rpi_tag_clock_id_t</span><span class=p>;</span><span class=w></span>

<span class=k>extern</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>RPI_PropertyInit</span><span class=p>(</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=p>);</span><span class=w></span>
<span class=k>extern</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>RPI_PropertyAddTag</span><span class=p>(</span><span class=w> </span><span class=n>rpi_mailbox_tag_t</span><span class=w> </span><span class=n>tag</span><span class=p>,</span><span class=w> </span><span class=p>...</span><span class=w> </span><span class=p>);</span><span class=w></span>
<span class=k>extern</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>RPI_PropertyProcess</span><span class=p>(</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=p>);</span><span class=w></span>
<span class=k>extern</span><span class=w> </span><span class=n>rpi_mailbox_property_t</span><span class=o>*</span><span class=w> </span><span class=nf>RPI_PropertyGet</span><span class=p>(</span><span class=w> </span><span class=n>rpi_mailbox_tag_t</span><span class=w> </span><span class=n>tag</span><span class=w> </span><span class=p>);</span><span class=w></span>

<span class=cp>#endif</span>
</code></pre></div> <blockquote> <p><strong>NOTE:</strong> As you can see, I've left some debugging <code>printf()</code> calls in so you can choose to print them out - this means it'll print out the buffer you message the GPU with and see the resulting buffer when the GPU has finished it's response</p> </blockquote> <p>We start off with a memory buffer which is large enough to hold a concatenated list of property tags and data for the property tags we want to use. We use a gcc extension to align it to a 16-byte boundary:</p> <div class=highlight><pre><span></span><code><span class=k>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>pt</span><span class=p>[</span><span class=mi>8192</span><span class=p>]</span><span class=w> </span><span class=n>__attribute__</span><span class=p>((</span><span class=n>aligned</span><span class=p>(</span><span class=mi>16</span><span class=p>)));</span><span class=w></span>
</code></pre></div> <p>The rest of the functions form a C API to the Mailbox Property Interface. There are various APIs people come up with to generate the memory structure.</p> <p>The messages are constructed such that the data length is large enough for whichever is larger, the message request data size or the response data size. It's also good to note that so long as the data size is large enough the GPU will be happy. i.e. you can use a larger data size for the tag and the GPU won't complain. As you can see from the <code>void RPI_PropertyAddTag( rpi_mailbox_tag_t tag, ... )</code> switch <code>tag</code> statement there are only a few types of tag layout anyway.</p> <p>The GPU acts upon tag values which have the request/response code set to process request settings (always 0). When the GPU has parsed a value and filled the tag's value buffer with the value required it sets the request/response indicator to 1 to show that the data in the value buffer is the GPU's response. All of this modifies the data in-place.</p> <p>The API I wrote for this tutorial allows us to have a simple paradime for using the property interface.</p> <div class=highlight><pre><span></span><code><span class=cm>/* Initialise, Add and Process tags */</span><span class=w></span>
<span class=n>RPI_PropertyInit</span><span class=p>();</span><span class=w></span>
<span class=n>RPI_PropertyAddTag</span><span class=p>(</span><span class=w> </span><span class=n>TAG_</span><span class=o>*</span><span class=p>,</span><span class=w> </span><span class=p>...</span><span class=w> </span><span class=p>);</span><span class=w></span>
<span class=n>RPI_PropertyAddTag</span><span class=p>(</span><span class=w> </span><span class=n>TAG_</span><span class=o>*</span><span class=p>,</span><span class=w> </span><span class=p>...</span><span class=w> </span><span class=p>);</span><span class=w></span>
<span class=n>RPI_PropertyAddTag</span><span class=p>(</span><span class=w> </span><span class=n>TAG_</span><span class=o>*</span><span class=p>,</span><span class=w> </span><span class=p>...</span><span class=w> </span><span class=p>);</span><span class=w></span>
<span class=n>RPI_PropertyProcess</span><span class=p>();</span><span class=w></span>

<span class=cm>/* Get the value for each tag */</span><span class=w></span>
<span class=n>property_value_buffer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>RPI_PropertyGet</span><span class=p>(</span><span class=w> </span><span class=n>TAG_</span><span class=o>*</span><span class=w> </span><span class=p>);</span><span class=w></span>
</code></pre></div> <h3 id=the-framebuffer-properties>The Framebuffer Properties<a class=headerlink href=#the-framebuffer-properties title="Permanent link">&para;</a></h3> <p>If you don't yet know, a framebuffer is a block of memory who's data is written to a display. The data organisation depends on the display's attributes such as width, height, colour depth, etc. There is not usually a conversion between one type of data and the framebuffer. The GPU simply clocks the data in the framebuffer to the display.</p> <p>If a monitor is plugged in to the Raspberry-Pi the GPU detects it and displays a colour gradiant square on the screen. This shows that the RPI is up and running and has detected the screen.</p> <p>Through the mailbox property interface we can negotiate with the GPU so that it creates a framebuffer in memory that is of the correct size to represent the screen attached (or the size of the virtual screen we've requested). It will return a pointer to that memory so that the ARM has memory it can write to that will be directly written to the screen by the GPU. It's the most basic and simplest form of graphics. Each pixel's colour can be controlled by writing data into the buffer.</p> <p>Let's look at how we use the property interface to negotiate a 32-bit framebuffer at 1280x1024:</p> <div class=highlight><pre><span></span><code><span class=cm>/* Initialise a framebuffer... */</span><span class=w></span>
<span class=n>RPI_PropertyInit</span><span class=p>();</span><span class=w></span>
<span class=n>RPI_PropertyAddTag</span><span class=p>(</span><span class=w> </span><span class=n>TAG_ALLOCATE_BUFFER</span><span class=w> </span><span class=p>);</span><span class=w></span>
<span class=n>RPI_PropertyAddTag</span><span class=p>(</span><span class=w> </span><span class=n>TAG_SET_PHYSICAL_SIZE</span><span class=p>,</span><span class=w> </span><span class=mi>1280</span><span class=p>,</span><span class=w> </span><span class=mi>1024</span><span class=w> </span><span class=p>);</span><span class=w></span>
<span class=n>RPI_PropertyAddTag</span><span class=p>(</span><span class=w> </span><span class=n>TAG_SET_VIRTUAL_SIZE</span><span class=p>,</span><span class=w> </span><span class=mi>1280</span><span class=p>,</span><span class=w> </span><span class=mi>2048</span><span class=w> </span><span class=p>);</span><span class=w></span>
<span class=n>RPI_PropertyAddTag</span><span class=p>(</span><span class=w> </span><span class=n>TAG_SET_DEPTH</span><span class=p>,</span><span class=w> </span><span class=mi>32</span><span class=w> </span><span class=p>);</span><span class=w></span>
<span class=n>RPI_PropertyAddTag</span><span class=p>(</span><span class=w> </span><span class=n>TAG_GET_PITCH</span><span class=w> </span><span class=p>);</span><span class=w></span>
<span class=n>RPI_PropertyAddTag</span><span class=p>(</span><span class=w> </span><span class=n>TAG_GET_PHYSICAL_SIZE</span><span class=w> </span><span class=p>);</span><span class=w></span>
<span class=n>RPI_PropertyAddTag</span><span class=p>(</span><span class=w> </span><span class=n>TAG_GET_DEPTH</span><span class=w> </span><span class=p>);</span><span class=w></span>
<span class=n>RPI_PropertyProcess</span><span class=p>();</span><span class=w></span>
</code></pre></div> <p>As you can see, we set up a load of tags for the GPU to process. We ask it to allocate a framebuffer, so set the physical and virtual size of the screen, and the colour depth. We then also ask it to return us some information, the current pitch, the physical size and the colour depth.</p> <p>The mailbox interface guarantees that the SET_* tags will be completed before the GET_* tags are processed so we can do a single process with all of the tags in place. Some of the SET_* tags may not be able to achieve what we ask for and so we must use the GET_* tags to know what the framebuffer settings actually are.</p> <p>The reason there is a physical and virtual size (and why they are set differently!) is because the virtual size can be larger than the physical size where the physical is "mapped" to a part of the framebuffer. The framebuffer is made to hold the largest of the two (which is invariably the virtual size).</p> <p>In the code I've made the virtual size twice the height of the physical size. There are other mailbox properties that allow us to set an offset where the physical screen will begin in the framebuffer. You can think of the virtual as being the framebuffer and the physical as the screen. We can draw to a larger framebuffer in a region that's off the physical screen and then offset the physical screen to the area of the framebuffer we've drawn to and the update to the screen is instant rather than updating as we draw which usually shows artifacts.</p> <p>For now, we just initialise the framebuffer (using the code above) and then write to the framebuffer space within the limits of the physical size. We draw a colour gradient box like the GPU does on power-on, but we "animate" it by continuously altering the colour vectors and re-drawing the screen. We use 100% of the CPU processing time to draw and you'll see just how slow this is!</p> <p>Go ahead and run the example. You can spend some time changing the colour depth setting and screen size to see the performance of the framebuffer fill. You'll notice it's a lot slower than you'd realise to refresh the screen when every pixel is written to.</p> <p>This is the code that does the actual draw to the framebuffer:</p> <div class=highlight><pre><span></span><code><span class=cm>/* Produce a colour spread across the screen */</span><span class=w></span>
<span class=k>for</span><span class=p>(</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>y</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>y</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>height</span><span class=p>;</span><span class=w> </span><span class=n>y</span><span class=o>++</span><span class=w> </span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>line_offset</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>y</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>width</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=k>for</span><span class=p>(</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>width</span><span class=p>;</span><span class=w> </span><span class=n>x</span><span class=o>++</span><span class=w> </span><span class=p>)</span><span class=w></span>
<span class=w>    </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=n>fb</span><span class=p>[</span><span class=n>line_offset</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>x</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pixel_value</span><span class=o>++</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>We've stuck with 32 bits per pixel (previously this tutorial had an option). This simplifies the framebuffer drawing and we can see here what we're doing is really simple. All we're interested in is how fast we can write to the screen when modifying every pixel.</p> <p>The pixel offset calculation can be done based on the bpp (bits-per-pixel) or colour depth setting and the number of pixels per line. We're using the width and calculating the start of the next line based on the exact memory size taken up by the pixel data.</p> <p>This isn't entirely right however, because the GPU can choose to optimise the number of bytes per pixel row. The GPU refers to this as the pitch and is returned through the property interface. We should really use that when we move to an option for lower bits per pixel.</p> <p>The framebuffer memory is organised with the top left pixel being at offset 0, in screen coordinates this is <code>0,0</code>. Bottom right is coordinate <code>width-1,height-1</code>.</p> <h2 id=part-5armc-014>part-5/armc-014<a class=headerlink href=#part-5armc-014 title="Permanent link">&para;</a></h2> <p>This example expands on the previous part-4 interrupts code and introduces the mailbox API to negotiate a framebuffer with the GPU. It then draws an ever-changing colour square on the screen which changes colour to animate the display. The Frames Per Second (FPS) is also calculated and sent to the mini UART so if you're monitoring the UART with a terminal such as PuTTY you'll be able to see the FPS calculated live on your Pi.</p> <p>While we acheive that, this does demonstrate how slow software rendering is. The framebuffer is set to 640x480 so that the demo will work on every HDMI panel that's plugged in. 640x480 is not exactly a big screen and yet below are the Frames Per Second (FPS) we managed to achieve on the RPI1 and RPI2.</p> <p>In order to calculate the frames per second, we need to know how long a second is. We therefore use the following code to determine the core frequency so we can calculate the required timer interrupt speed. The BCM2385 peripherals datasheet refers to the APB clock which is the same as the core clock.</p> <p>The code is a bit messy, but it gets the job done so no matter the rpi we're running on, or the current core frequency, we'll get the right timer interrupt rate. We use this interrupt rate to keep track of the uptime in seconds and blinking the LED at 2Hz.</p> <div class=highlight><pre><span></span><code><span class=cm>/* Use the GPU Mailbox to dynamically retrieve the CORE Clock Frequency. This is also what the</span>
<span class=cm>   datasheet refers to as the APB (Advanced Peripheral Bus) clock which drives the ARM Timer</span>
<span class=cm>   peripheral */</span><span class=w></span>
<span class=n>RPI_PropertyInit</span><span class=p>();</span><span class=w></span>
<span class=n>RPI_PropertyAddTag</span><span class=p>(</span><span class=n>TAG_GET_CLOCK_RATE</span><span class=p>,</span><span class=w> </span><span class=n>TAG_CLOCK_CORE</span><span class=p>);</span><span class=w></span>
<span class=n>RPI_PropertyProcess</span><span class=p>();</span><span class=w></span>
<span class=n>mp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>RPI_PropertyGet</span><span class=p>(</span><span class=n>TAG_GET_CLOCK_RATE</span><span class=p>);</span><span class=w></span>
<span class=kt>uint32_t</span><span class=w> </span><span class=n>core_frequency</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mp</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>.</span><span class=n>buffer_32</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span><span class=w></span>

<span class=cm>/* Calculate the timer reload register value so we achieve an interrupt rate of 2Hz. Every</span>
<span class=cm>   second interrupt will therefore be one second. It&#39;s approximate, the division doesn&#39;t</span>
<span class=cm>   really work out to be precisely 1s because of the divisor options and the core</span>
<span class=cm>   frequency. */</span><span class=w></span>
<span class=kt>uint16_t</span><span class=w> </span><span class=n>prescales</span><span class=p>[]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>16</span><span class=p>,</span><span class=w> </span><span class=mi>256</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>};</span><span class=w></span>
<span class=kt>uint32_t</span><span class=w> </span><span class=n>timer_load</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=mf>1.0</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mi>2</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=p>(</span><span class=mf>1.0</span><span class=o>/</span><span class=p>(</span><span class=n>core_frequency</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=p>(</span><span class=n>RPI_GetArmTimer</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>PreDivider</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=p>(</span><span class=n>prescales</span><span class=p>[(</span><span class=n>RPI_GetArmTimer</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>Control</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0xC</span><span class=p>)</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>2</span><span class=p>])));</span><span class=w></span>
<span class=n>RPI_GetArmTimer</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>Load</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>timer_load</span><span class=p>;</span><span class=w></span>
</code></pre></div> <p>Run the code and you'll get some continually changing output on the UART console that shows you the board revision, clock speeds and the currently calculated Frames Per Second (FPS) achieve.</p> <div class=highlight><pre><span></span><code>------------------------------------------
Valvers.com ARM Bare Metal Tutorials
Initialise UART console with standard libc
CORE Frequency: 200MHz
ARM  Frequency: 600MHz
Board Revision: 0x00b03111 rpi-4B BCM2711 2GiB Sony UK
Firmware Version: 1593701958
MAC Address: DC:A6:32:02:DB:E0
Serial Number: C2702EF910000000
Initialised Framebuffer: 640x480 32bpp
Pitch: 2560 bytes
Framebuffer address: 3E9A2000
</code></pre></div> <h3 id=results>Results<a class=headerlink href=#results title="Permanent link">&para;</a></h3> <p>Here's some tabulated results about the ARM frequency (with no settings in config.txt) for the various boards I'm working with and the Frames Per Second (FPS) they all acheived:</p> <table> <thead> <tr> <th>Model</th> <th>FPS</th> <th>CORE Frequency</th> <th>ARM Frequency</th> <th>Board Revision</th> </tr> </thead> <tbody> <tr> <td>RPI0</td> <td>5.21</td> <td>250MHz</td> <td>700MHz</td> <td><code>0x00900092</code> rpi-Zero BCM2835 512MB Sony UK</td> </tr> <tr> <td>RPI1B+</td> <td>5.05</td> <td>250MHz</td> <td>700MHz</td> <td><code>0x00000010</code> rpi-1B+ BCM2835</td> </tr> <tr> <td>RPI2</td> <td>2.30</td> <td>250MHz</td> <td>600MHz</td> <td><code>0x00a01041</code> rpi-2B BCM2836 1GiB Sony UK</td> </tr> <tr> <td>RPI3B</td> <td>2.26</td> <td>250MHz</td> <td>600MHz</td> <td><code>0x00a02082</code> rpi-3B BCM2837 1GiB Sony UK</td> </tr> <tr> <td>RPI4</td> <td>2.77</td> <td>200MHz</td> <td>600MHz</td> <td><code>0x00b03111</code> rpi-4B BCM2711 2GiB Sony UK</td> </tr> </tbody> </table> <blockquote> <p><strong>NOTE:</strong> The RPI3B I have doesn't flash its LED because it's not a B+ where the ACK LED was moved back to a GPIO pin. So on my model the ACK LED is attached to an IO expander and is meant to be accessed through the GPU mailbox interface! I just compiled with <code>./build.sh rpi3bp</code></p> </blockquote> <p>Those results are the right way round, I promise - the <code>RPI0</code> appears to be the winner here against all the other competition! It's time for us to do some thinking and some optimising...</p> <h2 id=part-5armc-015>part-5/armc-015<a class=headerlink href=#part-5armc-015 title="Permanent link">&para;</a></h2> <p>In the RPI processor (all models) there is a cache system which is disabled by default and is designed to speed the processor up by enabling code to be (hopefully) run from the cache.</p> <p>In this example we enable the L1 cache in the <code>armc-start.S</code> startup file and programatically set the ARM frequency to the maximum it's allowed to be (without overclocking). This is the only change we're going to make to see if we see any worthwhile gain in enabling this layer.</p> <h3 id=enabling-cache>Enabling Cache<a class=headerlink href=#enabling-cache title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><span class=na>.equ</span><span class=w>    </span><span class=no>SCTLR_ENABLE_DATA_CACHE</span><span class=w>         </span><span class=mi>0x4</span><span class=w></span>
<span class=na>.equ</span><span class=w>    </span><span class=no>SCTLR_ENABLE_BRANCH_PREDICTION</span><span class=w>  </span><span class=mi>0x800</span><span class=w></span>
<span class=na>.equ</span><span class=w>    </span><span class=no>SCTLR_ENABLE_INSTRUCTION_CACHE</span><span class=w>  </span><span class=mi>0x1000</span><span class=w></span>

<span class=c1>// Enable L1 Cache -------------------------------------------------------</span>

<span class=c1>// R0 = System Control Register</span>
<span class=nf>mrc</span><span class=w> </span><span class=no>p15</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=no>r0</span><span class=p>,</span><span class=no>c1</span><span class=p>,</span><span class=no>c0</span><span class=p>,</span><span class=mi>0</span><span class=w></span>

<span class=c1>// Enable caches and branch prediction</span>
<span class=nf>orr</span><span class=w> </span><span class=no>r0</span><span class=p>,</span><span class=c1>#SCTLR_ENABLE_BRANCH_PREDICTION</span>
<span class=nf>orr</span><span class=w> </span><span class=no>r0</span><span class=p>,</span><span class=c1>#SCTLR_ENABLE_DATA_CACHE</span>
<span class=nf>orr</span><span class=w> </span><span class=no>r0</span><span class=p>,</span><span class=c1>#SCTLR_ENABLE_INSTRUCTION_CACHE</span>

<span class=c1>// System Control Register = R0</span>
<span class=nf>mcr</span><span class=w> </span><span class=no>p15</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=no>r0</span><span class=p>,</span><span class=no>c1</span><span class=p>,</span><span class=no>c0</span><span class=p>,</span><span class=mi>0</span><span class=w></span>
</code></pre></div> <p>Look to the <a href=https://silver.arm.com/download/ARM_and_AMBA_Architecture/AR570-DA-70000-r0p0-00rel2/DDI0406C_C_arm_architecture_reference_manual.pdf>ARMv7-a architecture manual</a> for information on enabling L1 Cache. L1 cache is closest to the processor and so is what we're interesting in enabling first off.</p> <p>Let's go through the code we've added so we know <strong>why</strong> we've added it and also why it works.</p> <p><strong>Section B6.1.86</strong> SCTLR, System Control Register, PMSA describes the system control register</p> <p>This register has some bits defined which are useful for us, namely:</p> <div class=highlight><pre><span></span><code>I, bit[12] Instruction cache enable bit.

    This is a global enable bit for instruction caches. The possible values
    of this bit are:

    0 Instruction caches disabled.
    1 Instruction caches enabled.

    If the system does not implement any instruction caches that can be
    accessed by the processor, at any level of the memory hierarchy, this
    bit is RAZ/WI.

    If the system implements any instruction caches that can be accessed
    by the processor then it must be possible to disable them by setting
    this bit to 0.

    Cache enabling and disabling on page B2-1270 describes the effect of
    enabling the caches.

Z, bit[11] Branch prediction enable bit.

    The possible values of this bit are:

    0 Program flow prediction disabled.
    1 Program flow prediction enabled.

    Setting this bit to 1 enables branch prediction, also called program
    flow prediction.

    If program flow prediction cannot be disabled, this bit is RAO/WI.
    If the implementation does not support program flow prediction then
    this bit is RAZ/WI.

C, bit[2] Cache enable bit.

    This is a global enable bit for data and unified caches. The possible
    values of this bit are:

    0 Data and unified caches disabled.
    1 Data and unified caches enabled.

    If the system does not implement any data or unified caches that can
    be accessed by the processor, at any level of the memory hierarchy,
    this bit is RAZ/WI.

    If the system implements any data or unified caches that can be
    accessed by the processor then it must be possible to disable them by
    setting this bit to 0.

For more information about the effect of this bit see Cache enabling and
disabling on page B2-1270.
</code></pre></div> <p>In the <a href=https://silver.arm.com/download/ARM_Architecture/AR550-DA-70002-r0p0-00rel0/DDI%2001001.pdf>ARMv6 Architecture Manual</a> for the Pi1 we see:</p> <p><strong>Section B3.4</strong> Register 1:Control registers which also descibes the system control register</p> <p>This control register implements bits in the register we're interested in for enabling L1 cache:</p> <div class=highlight><pre><span></span><code>I (bit[12])

    If separate L1 caches are used, this is the enable/disable bit for the L1
    instruction cache:

    0 = L1 instruction cache disabled
    1 = L1 instruction cache enabled.

    If an L1 unified cache is used or the L1 instruction cache is not
    implemented, this bit read as 0 and ignores writes. If the L1 instruction
    cache cannot be disabled, this bit reads as 1 and ignores writes.

    The state of this bit does not affect further levels of cache in the
    system.


Z (bit[11])

    On ARM processors which support branch prediction, this is the
    enable/disable bit for branch prediction:

    0 = Program flow prediction disabled
    1 = Program flow prediction enabled.

    If program flow prediction cannot be disabled, this bit reads as 1 and
    ignores writes.

    Program flow prediction includes all possible forms of speculative change
    of instruction stream prediction. Examples include static prediction,
    dynamic prediction, and return stacks.

    On ARM processors that do not support branch prediction, this bit reads as
    0 and ignores writes.


C (bit[2])

    If a L1 unified cache is used, this is the enable/disable bit for the
    unified cache. If separate L1 caches are used, this is the enable/disable
    bit for the data cache. In either case:

    0 = L1 unified/data cache disabled
    1 = L1 unified/data cache enabled.

    If the L1 cache is not implemented, this bit reads as 0 and ignores
    writes. If the L1 cache cannot be disabled, this bit reads as 1 and
    ignores writes.

    The state of this bit does not affect other levels of cache in the system.
</code></pre></div> <p>As can be seen, although the cache system has changed slightly - it is essentially the same for us to use across both RPi1 and RPi2:</p> <p>Get the value of the System Control Register in R0</p> <div class=highlight><pre><span></span><code><span class=c1>// Enable L1 Cache -------------------------------------------------------</span>

<span class=c1>// R0 = System Control Register</span>
<span class=nf>mrc</span><span class=w> </span><span class=no>p15</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=no>r0</span><span class=p>,</span><span class=no>c1</span><span class=p>,</span><span class=no>c0</span><span class=p>,</span><span class=mi>0</span><span class=w></span>
</code></pre></div> <p>Enable the three cache bits we just identified in the architecture manuals above:</p> <div class=highlight><pre><span></span><code><span class=c1>// Enable caches and branch prediction</span>
<span class=nf>orr</span><span class=w> </span><span class=no>r0</span><span class=p>,</span><span class=c1>#SCTLR_ENABLE_BRANCH_PREDICTION</span>
<span class=nf>orr</span><span class=w> </span><span class=no>r0</span><span class=p>,</span><span class=c1>#SCTLR_ENABLE_DATA_CACHE</span>
<span class=nf>orr</span><span class=w> </span><span class=no>r0</span><span class=p>,</span><span class=c1>#SCTLR_ENABLE_INSTRUCTION_CACHE</span>
</code></pre></div> <p>Write the modified value back to the System Control Register:</p> <div class=highlight><pre><span></span><code><span class=c1>// System Control Register = R0</span>
<span class=nf>mcr</span><span class=w> </span><span class=no>p15</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=no>r0</span><span class=p>,</span><span class=no>c1</span><span class=p>,</span><span class=no>c0</span><span class=p>,</span><span class=mi>0</span><span class=w></span>
</code></pre></div> <h3 id=maxmising-the-clock-speed>Maxmising the Clock Speed<a class=headerlink href=#maxmising-the-clock-speed title="Permanent link">&para;</a></h3> <p>I also added in some more mailbox properties to make the RPI2 run faster. When the RPI2 starts executing code from the ARM the ARM is running at 600MHz which is a way below its 900MHz maximum. Using the mailbox properties interface we can both ask the GPU for the ARMs maximum frequency and then set the ARM frequency to the maximum returned by the GPU:</p> <div class=highlight><pre><span></span><code><span class=n>mp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>RPI_PropertyGet</span><span class=p>(</span><span class=w> </span><span class=n>TAG_GET_MAX_CLOCK_RATE</span><span class=w> </span><span class=p>);</span><span class=w></span>

<span class=n>RPI_PropertyInit</span><span class=p>();</span><span class=w></span>
<span class=n>RPI_PropertyAddTag</span><span class=p>(</span><span class=w> </span><span class=n>TAG_SET_CLOCK_RATE</span><span class=p>,</span><span class=w> </span><span class=n>TAG_CLOCK_ARM</span><span class=p>,</span><span class=w> </span><span class=n>mp</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>.</span><span class=n>buffer_32</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=w> </span><span class=p>);</span><span class=w></span>
<span class=n>RPI_PropertyProcess</span><span class=p>();</span><span class=w></span>
</code></pre></div> <p>Both the above are fairly easy pickings for making sure we're getting the best speed available out of the processors, yet it was still a bit of work to get the gains!</p> <p>Run <strong>armc-015</strong> and see the gains! Here's the FPS results with No cache for comparison, don't forget that some of the ARM frequencies have changed to the maximum available here too:</p> <table> <thead> <tr> <th>Model</th> <th>FPS</th> <th>FPS (L1 Cache)</th> <th>Improvement</th> <th>CORE Frequency</th> <th>ARM Frequency</th> <th>Board Revision</th> </tr> </thead> <tbody> <tr> <td>RPI0</td> <td>5.21</td> <td>6.86</td> <td><strong>1.65</strong></td> <td>250MHz</td> <td>1000MHz</td> <td><code>0x00900092</code> rpi-Zero BCM2835 512MB Sony UK</td> </tr> <tr> <td>RPI1B+</td> <td>5.05</td> <td>5.95</td> <td><strong>0.9</strong></td> <td>250MHz</td> <td>700MHz</td> <td><code>0x00000010</code> rpi-1B+ BCM2835</td> </tr> <tr> <td>RPI2</td> <td>2.30</td> <td>3.04</td> <td><strong>0.74</strong></td> <td>250MHz</td> <td>900MHz</td> <td><code>0x00a01041</code> rpi-2B BCM2836 1GiB Sony UK</td> </tr> <tr> <td>RPI3B</td> <td>2.26</td> <td>3.08</td> <td><strong>0.82</strong></td> <td>250MHz</td> <td>1200MHz</td> <td><code>0x00a02082</code> rpi-3B BCM2837 1GiB Sony UK</td> </tr> <tr> <td>RPI4</td> <td>2.77</td> <td>3.75</td> <td><strong>0.98</strong></td> <td>200MHz</td> <td>1500MHz</td> <td><code>0x00b03111</code> rpi-4B BCM2711 2GiB Sony UK</td> </tr> </tbody> </table> <p>Some reasonable gains, but still not exactly fast enough to start writing demos or games (Other than text-based games!). Considering some of the ARM frequency gains (+900MHz) the gains are pretty rubbish.</p> <ul> <li><code>RPI0</code> improves a reasonable amount from a 300MHz increase in ARM frequency and the L1 Cache</li> <li><code>RPI1B+</code> improves slightly from just the L1 Cache</li> <li><code>RPI2</code> improves slightly from 300MHz increase in ARM frequency and the L1 Cache</li> <li><code>RPI3B+</code> improves a reasonable amount with 600MHz increase in ARM frequency and the L1 Cache</li> <li><code>RPI4</code> improves a reasonable amount with the largest increase of 900MHz increase in ARM Frequency and the L1 Cache</li> </ul> <h3 id=rpi2-performance>RPI2+ Performance<a class=headerlink href=#rpi2-performance title="Permanent link">&para;</a></h3> <p>At this point the question of why the RPI&#8532;/4 models are so much slower than the RPI1 should come to mind! I don't have the answer (Send them on a postcard please!)</p> <p>The only thing going for the RPI1 is a much simpler memory system. Since the rest introduce a quad-core architecture, things got a whole bunch more complicated on the memory bus.</p> <p>Anyway, let's see what else we can do.</p> <h3 id=making-the-compiler-work-for-us>Making the Compiler work for us<a class=headerlink href=#making-the-compiler-work-for-us title="Permanent link">&para;</a></h3> <p>Up until now we've been working with optimisation levels <code>-O0</code>. Let's change that...</p> <h2 id=part-5armc-016>part-5/armc-016<a class=headerlink href=#part-5armc-016 title="Permanent link">&para;</a></h2> <p>One simple change to this code to see what gains can be had by the compiler. If we're using a C compiler, we really should take advantage of the fact that a massive part of it's job is to optimise the code it generates to run as fast as possible.</p> <p>We'll change the optimisation level, from <code>-O1</code> to <code>-O4</code>. Nothing else, let's see what happens to the FPS:</p> <table> <thead> <tr> <th>Model</th> <th>FPS</th> <th>FPS (L1 Cache)</th> <th>FPS (<code>-O4</code>)</th> <th>Improvement</th> <th>CORE Frequency</th> <th>ARM Frequency</th> <th>Board Revision</th> </tr> </thead> <tbody> <tr> <td>RPI0</td> <td>5.21</td> <td>6.86</td> <td>119</td> <td><strong>112</strong></td> <td>250MHz</td> <td>1000MHz</td> <td><code>0x00900092</code> rpi-Zero BCM2835 512MB Sony UK</td> </tr> <tr> <td>RPI1B+</td> <td>5.05</td> <td>5.95</td> <td>96</td> <td><strong>90</strong></td> <td>250MHz</td> <td>700MHz</td> <td><code>0x00000010</code> rpi-1B+ BCM2835</td> </tr> <tr> <td>RPI2</td> <td>2.30</td> <td>3.04</td> <td>139</td> <td><strong>136</strong></td> <td>250MHz</td> <td>900MHz</td> <td><code>0x00a01041</code> rpi-2B BCM2836 1GiB Sony UK</td> </tr> <tr> <td>RPI3B</td> <td>2.26</td> <td>3.08</td> <td>168</td> <td><strong>165</strong></td> <td>250MHz</td> <td>1200MHz</td> <td><code>0x00a02082</code> rpi-3B BCM2837 1GiB Sony UK</td> </tr> <tr> <td>RPI4</td> <td>2.77</td> <td>3.75</td> <td>250</td> <td><strong>246</strong></td> <td>500MHz</td> <td>1500MHz</td> <td><code>0x00b03111</code> rpi-4B BCM2711 2GiB Sony UK</td> </tr> </tbody> </table> <p>Those are some impressive gains across the board! Clearly the compiler has done something essential for such big gainst. Perhaps it enables the code to entirely sit within cache or something as simple as that.</p> <p>What's it done? I don't know, that's for the compiler to know and for me to find out if I can be bothered. Right now I need get on with writing code.</p> <p>If you're interested in finding out, you can disassemble the code and see if you can see the major difference between an <code>-O0</code> binary and an <code>-O4</code> binary!</p> <h2 id=more-interesting-graphics>More Interesting Graphics<a class=headerlink href=#more-interesting-graphics title="Permanent link">&para;</a></h2> <p>Back in the 90s I used to love programming demos on the Commodore Amiga 500. I loved the results. Everything was written in assembler and the tricks and cheats you used were really clever. It was a competitive environment - the moment you saw someone show a demo with something you hadn't coded you just had to get it done. It was hard!</p> <p>With the RPi we have a lot of hardware in front of us - it must be possible to do some rudimentary (and ineffecient) effects.</p> <p>Let's have a go:</p> <p><img alt="Sinewave Effects" src=/img/bare-metal-programming-in-c/part-5-rpi2-sinewave-scroller-armc017.gif></p> <p>I had this stuff lying around for quite some time before I included it in the turotial, but it moves things in a better direction - a more fun direction. I grabbed a an old demoscene style font as a GIF and use that to do actually display some graphics on the screen.</p> <p>Use GIMP to save a (non-animated) GIF as a c source code. Go and find some other fonts to play with. Although this is a demoscene style font, we'll need a font to generate a console for our RPi in the upcoming tutorials, so it's worth playing around with this stuff.</p> <p>The c soruce from gimp needs to be modified slightly as we need access to the struct from outside of the c file. We <code>typedef</code> the struct in our own header file <code>gimp-image.h</code>. It's all that header does.</p> <p>The c source containing the image data contains 16-bit data. This 16-bit data is the same as the graphics memory in the GPU when we get a 16-bit framebuffer.</p> <p>Loading and displaying images is great for working out how the graphics works at a lower level. The things we have to pay particular attention to are the number of bits per pixel for both the image data and the screen. They must match, or be transposed to match each other some how. We do this by transforming the image data to make it match that of the current dislay. This also includes getting the byte order correct so we know that the colour will be correct when it's displayed on the screen.</p> <p>I've probably not been as thorough as I should be with the graphics in this tutorial code. I know that it works on my monitor with the GIF data in the tutorial though.</p> <p>The code is starting to get messy - we'll need a tidy up in the next tutorial.</p> <p>We have a <code>PutPixel</code> function now, a vertical blit (<code>RPI_BlitV</code>) and we also have some other functions too. We also have a standard Blit (<code>RPI_Blit</code>) function which are simply memory copies from the image data memory space to the video graphics memory space. I've not introduced surfaces, so we've really just got image data and the gpu data in the same format to make things as simple as possible.</p> <blockquote> <p><strong>NOTE</strong>: The only supported format at the moment is a 16-bit colour framebuffer. It's enough to get us going, but doesn't have alpha transparency.</p> </blockquote> <p>In modern GPUs, we would load this font/image data up to the graphics card and the GPU would take care of blitting for us. Unfortunately we have to suffer "software rendering" which is obscenely slow in comparison. Of course, only for now - until we get some hardware acceleration going!</p> <p>We don't have any hardware acceleration and we only have one thread (we have no context switching yet, and the other processors are parked). So this is all pretty inefficient.</p> <p>There's no vertical sync interrupt that I've found. Instead, I've implemented delta timing in order to stick to a 50Hz refresh rate on the graphics (your mileage may vary here) so it's as flicker-free as possible.</p> <p>Here's the code I've introduced (at a high level):</p> <div class=highlight><pre><span></span><code><span class=cm>/* Wait 500ms to let UART to settle before we use it. The UART takes a little time to switch</span>
<span class=cm>   speeds. Comment out this to see some garbage at the start of the UART output if you like */</span><span class=w></span>
<span class=n>RPI_WaitMicroSeconds</span><span class=p>(</span><span class=w> </span><span class=mi>500000</span><span class=w> </span><span class=p>);</span><span class=w></span>
</code></pre></div> <p>Turns out, after we switch the baud rate of the mini uart, we need to wait a certain amount of time before using the uart as it takes a while for the baud rate change to take effect. I'm sure the wait time is more like 10-50 cycles, but it doesn't harm to wait "enough" time.</p> <div class=highlight><pre><span></span><code><span class=n>font_image</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>image16_from_gimp</span><span class=p>(</span><span class=w> </span><span class=o>&amp;</span><span class=n>font09</span><span class=w> </span><span class=p>);</span><span class=w></span>
<span class=n>font</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>font_from_image</span><span class=p>(</span><span class=w> </span><span class=mi>29</span><span class=p>,</span><span class=w> </span><span class=mi>35</span><span class=p>,</span><span class=w> </span><span class=n>font_image</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>);</span><span class=w></span>
</code></pre></div> <p>We "normalise" the font image (which we exported from GIMP) to a 16-bit internal image struct. In this case, the conversion is almost straight-through. But it's important when we've got a framebuffer to normalise all image data to the same data layout as the graphics memory. This way we can "Blit", or simply copy chunks of memory into video memory to instantly show graphics.</p> <p>We also do the same for the font when we've normalised the graphical data. Now we have graphical objects representing letters so we can write text to the framebuffer.</p> <div class=highlight><pre><span></span><code><span class=n>sinewave_effect_t</span><span class=o>*</span><span class=w> </span><span class=n>text_fx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>FX_NewSine</span><span class=p>((</span><span class=n>sinewave_settings_t</span><span class=p>){</span><span class=w></span>
<span class=w>        </span><span class=p>.</span><span class=n>amplitude</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>45</span><span class=p>,</span><span class=w></span>
<span class=w>        </span><span class=p>.</span><span class=n>frequency</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w></span>
<span class=w>        </span><span class=p>.</span><span class=n>speed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>4</span><span class=p>,</span><span class=w></span>
<span class=w>        </span><span class=p>.</span><span class=n>fb</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>RPI_GetFramebuffer</span><span class=p>()</span><span class=w> </span><span class=p>});</span><span class=w></span>
</code></pre></div> <p>I introduced a very basic effects system that is based around sinewaves. They produce the finest effects. Here, under the hood we create a sinewave lookup table which has various attributes.</p> <p>The framebuffer is passed in to the effects generation in order to apply units to the frequency attribute. The width of the screen is set to 1Hz. Therefore if you have, here a frequency of 1Hz will generate 1 full sinewave across the width of the screen.</p> <p>Let's have a closer look, because this stuff represents the biggest changes in the code. Not rpi-specific, but it's important anyway.</p> <div class=highlight><pre><span></span><code><span class=n>sinewave_effect_t</span><span class=o>*</span><span class=w> </span><span class=nf>FX_NewSine</span><span class=p>(</span><span class=w> </span><span class=n>sinewave_settings_t</span><span class=w> </span><span class=n>settings</span><span class=w> </span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>sinewave_effect_t</span><span class=o>*</span><span class=w> </span><span class=n>fx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>malloc</span><span class=p>(</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>sinewave_effect_t</span><span class=p>)</span><span class=w> </span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>fx</span><span class=o>-&gt;</span><span class=n>effect</span><span class=p>.</span><span class=n>effect_type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>TEXT_EFFECT_SINEWAVE</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>fx</span><span class=o>-&gt;</span><span class=n>effect</span><span class=p>.</span><span class=n>vertical_blit_y_processor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sin_vertical_blit_y_processor</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>fx</span><span class=o>-&gt;</span><span class=n>index</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=n>fx</span><span class=o>-&gt;</span><span class=n>settings</span><span class=p>.</span><span class=n>amplitude</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>settings</span><span class=p>.</span><span class=n>amplitude</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>fx</span><span class=o>-&gt;</span><span class=n>settings</span><span class=p>.</span><span class=n>fb</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>settings</span><span class=p>.</span><span class=n>fb</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>fx</span><span class=o>-&gt;</span><span class=n>settings</span><span class=p>.</span><span class=n>frequency</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>settings</span><span class=p>.</span><span class=n>frequency</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>fx</span><span class=o>-&gt;</span><span class=n>settings</span><span class=p>.</span><span class=n>speed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>settings</span><span class=p>.</span><span class=n>speed</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=n>fx</span><span class=o>-&gt;</span><span class=n>sinewave</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SIN_New</span><span class=p>(</span><span class=w> </span><span class=n>settings</span><span class=p>.</span><span class=n>amplitude</span><span class=p>,</span><span class=w> </span><span class=n>settings</span><span class=p>.</span><span class=n>frequency</span><span class=p>,</span><span class=w> </span><span class=n>settings</span><span class=p>.</span><span class=n>fb</span><span class=w> </span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>fx</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=n>sinewave_t</span><span class=o>*</span><span class=w> </span><span class=nf>SIN_New</span><span class=p>(</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>amplitude</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>frequency</span><span class=p>,</span><span class=w> </span><span class=n>framebuffer_info_t</span><span class=o>*</span><span class=w> </span><span class=n>fb</span><span class=w> </span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>sinewave_t</span><span class=o>*</span><span class=w> </span><span class=n>newsine</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>malloc</span><span class=p>(</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>sinewave_t</span><span class=p>)</span><span class=w> </span><span class=p>);</span><span class=w></span>

<span class=w>    </span><span class=n>newsine</span><span class=o>-&gt;</span><span class=n>amplitude</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>amplitude</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>newsine</span><span class=o>-&gt;</span><span class=n>steps</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>fb</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>fb</span><span class=o>-&gt;</span><span class=n>physical_width</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=mi>360</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>newsine</span><span class=o>-&gt;</span><span class=n>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>malloc</span><span class=p>(</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>newsine</span><span class=o>-&gt;</span><span class=n>steps</span><span class=w> </span><span class=p>);</span><span class=w></span>

<span class=w>    </span><span class=kt>double</span><span class=w> </span><span class=n>delta</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>double</span><span class=p>)</span><span class=mi>360</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=n>newsine</span><span class=o>-&gt;</span><span class=n>steps</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>frequency</span><span class=w> </span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=kt>double</span><span class=w> </span><span class=n>deg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=k>for</span><span class=p>(</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>step</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>step</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>newsine</span><span class=o>-&gt;</span><span class=n>steps</span><span class=p>;</span><span class=w> </span><span class=n>step</span><span class=o>++</span><span class=w> </span><span class=p>)</span><span class=w></span>
<span class=w>    </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=cm>/* Convert degrees to radians before sin function */</span><span class=w></span>
<span class=w>        </span><span class=n>newsine</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>[</span><span class=n>step</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sin</span><span class=p>(</span><span class=n>deg</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mf>0.0174533</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>amplitude</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=n>deg</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>delta</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>newsine</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>Here, we generate a sinewave at a set amplitude and number of steps (relative to the screen width) with a frequency of our choosing.</p> <p>We use a common effects structure with an ENUM that identifies the type of effect in case in future if we develop more effects we need to determine some logical conditions based on the effect type.</p> <div class=highlight><pre><span></span><code><span class=w>    </span><span class=n>fx</span><span class=o>-&gt;</span><span class=n>effect</span><span class=p>.</span><span class=n>vertical_blit_y_processor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sin_vertical_blit_y_processor</span><span class=p>;</span><span class=w></span>
</code></pre></div> <p>Here, we set a function against a graphical event.</p> <div class=highlight><pre><span></span><code><span class=k>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>sin_vertical_blit_y_processor</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>sinewave_effect_t</span><span class=o>*</span><span class=w> </span><span class=n>fx</span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>fx</span><span class=o>-&gt;</span><span class=n>sinewave</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>[(</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>fx</span><span class=o>-&gt;</span><span class=n>index</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>fx</span><span class=o>-&gt;</span><span class=n>sinewave</span><span class=o>-&gt;</span><span class=n>steps</span><span class=p>];</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>In this function, which will get run for every x-pixel position on a supporting graphical function, we return a value from the sinewave data. The vertical blitter was written to support this functionality because normally we can just use memcpy with the front graphical data to move it quickly to video memory to display it.</p> <div class=highlight><pre><span></span><code><span class=k>for</span><span class=p>(</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>px</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>px</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>font</span><span class=o>-&gt;</span><span class=n>pixel_width</span><span class=p>;</span><span class=w> </span><span class=n>px</span><span class=o>++</span><span class=w> </span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>py</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=n>effect</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>effect</span><span class=o>-&gt;</span><span class=n>vertical_blit_y_processor</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>effect</span><span class=o>-&gt;</span><span class=n>vertical_blit_y_processor</span><span class=p>(</span><span class=n>x</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>px</span><span class=p>,</span><span class=w> </span><span class=n>effect</span><span class=p>)</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>RPI_BlitV</span><span class=p>(</span><span class=n>x</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>px</span><span class=p>,</span><span class=w> </span><span class=n>y</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>py</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>font</span><span class=o>-&gt;</span><span class=n>image</span><span class=o>-&gt;</span><span class=n>pixel_data</span><span class=p>[</span><span class=n>blit_addr</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=n>px</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=p>)],</span><span class=w> </span><span class=n>font</span><span class=o>-&gt;</span><span class=n>pixel_height</span><span class=p>,</span><span class=w> </span><span class=n>font</span><span class=o>-&gt;</span><span class=n>image</span><span class=o>-&gt;</span><span class=n>pitch</span><span class=w> </span><span class=p>);</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>In the <code>font_putc()</code> function that's responsible for putting this on the screen we make the function effect-aware. For each column of pixels in each character we run the <code>veritcal_blit_y_processor</code> handler if it is set and apply the effect to the y value of the pixel column.</p> <p>Remember we set the frequency and amplitude of the sinewave? This determines the curvature of the text on-screen. As things stand here, the sinewave effect is static. If the text doesn't move in the horizontal direction the text will simply stay in the same shape every frame.</p> <p>In order to animate the effect we need a new method.</p> <div class=highlight><pre><span></span><code><span class=kt>void</span><span class=w> </span><span class=nf>FX_AnimateSine</span><span class=p>(</span><span class=w> </span><span class=n>sinewave_effect_t</span><span class=o>*</span><span class=w> </span><span class=n>fx</span><span class=w> </span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=w> </span><span class=n>fx</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>NULL</span><span class=w> </span><span class=p>)</span><span class=w></span>
<span class=w>        </span><span class=k>return</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=n>fx</span><span class=o>-&gt;</span><span class=n>index</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>fx</span><span class=o>-&gt;</span><span class=n>settings</span><span class=p>.</span><span class=n>speed</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>et, voila. This is why we have speed and an index. We can shift the reference between pixel offset and sinewave step. This moves the sinewave effect across the screen. We move the same amount every frame.</p> <p>To show off the effects we also set up another sinewave and apply it to the text position which moves the effected text around the screen centre.</p> <h3 id=starfield>Starfield<a class=headerlink href=#starfield title="Permanent link">&para;</a></h3> <p>The starfield implementation is a bit crude, but works. We're not going to introduce the RPi random number generator capabilities here because they're essentially undocumented outside of the linux source code. They're also quite different between the RPI4 and the other PIs (urgh).</p> <p>There's a new python file <code>create-random-stars.py</code> therefore which accepts a <code>--count</code> argument for the amount of stars, everything else is hard coded.</p> <p><code>stars.c</code> and <code>stars.h</code> contain the randomised stars. Have a go at creating a new set with a different amount of stars, etc.</p> <p>You could always apply a sinewave effect to the stars which is scaled by their speed/depth.</p> <h3 id=double-buffer-and-no-vertical-sync>Double Buffer and No Vertical Sync<a class=headerlink href=#double-buffer-and-no-vertical-sync title="Permanent link">&para;</a></h3> <p>If you're at all familiar with graphics, we tend to draw to an area of memory that is not currently visible and when the graphics card is ready we flip the video memory pointer to the area we've been drawing.</p> <p>Once we've flipped, we start drawing in the other area that was previously visible and then the process flips the video memory pointer back again at the next sync point for the graphics card.</p> <p>We don't have a vertical sync reference unfortunately. The RPi doesn't appear to expose this to the ARM device easily.</p> <p>In order to do flicker-free (almost anyway) graphics rendering we must do something called delta timing. The ensures we lock to a 50Hz framerate in the code. So long as this time is very tightly controlled and we use double buffering we generally end up with flicker-free graphics.</p> <div class=highlight><pre><span></span><code><span class=kt>void</span><span class=w> </span><span class=nf>RPI_SwitchFramebuffer</span><span class=p>(</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=w> </span><span class=n>framebuffer</span><span class=p>.</span><span class=n>current_buffer</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>framebuffer</span><span class=p>.</span><span class=n>buffers</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=w> </span><span class=p>)</span><span class=w></span>
<span class=w>    </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=cm>/* We&#39;ve been drawing to buffer 0 - so now show that on the screen and flip the graphics</span>
<span class=cm>           pointers over to the other canvas */</span><span class=w></span>
<span class=w>        </span><span class=n>RPI_PropertyInit</span><span class=p>();</span><span class=w></span>
<span class=w>        </span><span class=n>RPI_PropertyAddTag</span><span class=p>(</span><span class=w> </span><span class=n>TAG_SET_VIRTUAL_OFFSET</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=n>RPI_PropertyProcess</span><span class=p>();</span><span class=w></span>

<span class=w>        </span><span class=n>framebuffer</span><span class=p>.</span><span class=n>current_buffer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>framebuffer</span><span class=p>.</span><span class=n>buffers</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=w>    </span><span class=k>else</span><span class=w></span>
<span class=w>    </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=n>RPI_PropertyInit</span><span class=p>();</span><span class=w></span>
<span class=w>        </span><span class=n>RPI_PropertyAddTag</span><span class=p>(</span><span class=w> </span><span class=n>TAG_SET_VIRTUAL_OFFSET</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>framebuffer</span><span class=p>.</span><span class=n>physical_height</span><span class=w> </span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=n>RPI_PropertyProcess</span><span class=p>();</span><span class=w></span>

<span class=w>        </span><span class=n>framebuffer</span><span class=p>.</span><span class=n>current_buffer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>framebuffer</span><span class=p>.</span><span class=n>buffers</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>So now we have this function in the framebuffer code which instructs the GPU to flip to either <code>buffer[0]</code> or <code>buffer[1]</code> depending on where we've been drawing.</p> <p>For timing we also have a new function:</p> <div class=highlight><pre><span></span><code><span class=kt>void</span><span class=w> </span><span class=nf>RPI_TimeEvent</span><span class=p>(</span><span class=w> </span><span class=n>rpi_cpu_time_t</span><span class=o>*</span><span class=w> </span><span class=n>cputime</span><span class=p>,</span><span class=w> </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>us</span><span class=w> </span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>rpi_cpu_time_t</span><span class=w> </span><span class=n>current_time</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>inbound_time</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cputime</span><span class=o>-&gt;</span><span class=n>lo</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>cputime</span><span class=o>-&gt;</span><span class=n>lo</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>us</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=w> </span><span class=n>inbound_time</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>cputime</span><span class=o>-&gt;</span><span class=n>lo</span><span class=w> </span><span class=p>)</span><span class=w></span>
<span class=w>    </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=cm>/* The lo register overflowed, so increas the high timer */</span><span class=w></span>
<span class=w>        </span><span class=n>cputime</span><span class=o>-&gt;</span><span class=n>hi</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=k>while</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=w></span>
<span class=w>    </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=n>RPI_GetCurrentCpuTime</span><span class=p>(</span><span class=w> </span><span class=o>&amp;</span><span class=n>current_time</span><span class=w> </span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=n>current_time</span><span class=p>.</span><span class=n>hi</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>cputime</span><span class=o>-&gt;</span><span class=n>hi</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w></span>
<span class=w>          </span><span class=p>(</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=n>current_time</span><span class=p>.</span><span class=n>hi</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>cputime</span><span class=o>-&gt;</span><span class=n>hi</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=n>current_time</span><span class=p>.</span><span class=n>lo</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>cputime</span><span class=o>-&gt;</span><span class=n>lo</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=p>)</span><span class=w></span>
<span class=w>        </span><span class=p>{</span><span class=w></span>
<span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=p>}</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>This is used in the main loop to synchronise the graphic buffer switch:</p> <div class=highlight><pre><span></span><code><span class=w>    </span><span class=n>RPI_SwitchFramebuffer</span><span class=p>();</span><span class=w></span>
<span class=w>    </span><span class=n>RPI_TimeEvent</span><span class=p>(</span><span class=w> </span><span class=o>&amp;</span><span class=n>cputime</span><span class=p>,</span><span class=w> </span><span class=mi>20000</span><span class=w> </span><span class=p>);</span><span class=w></span>
</code></pre></div> <p>The RPI_TimeEvent function will make sure that between calls of the function the required amount of time has passed. It's not amazingly accurate, but it's enough to get a good graphical experience.</p> <h2 id=next>Next<a class=headerlink href=#next title="Permanent link">&para;</a></h2> <p>I've run out of time, so we'll leave graphics here for now and come back to it in a few tutorials time to do some more advanced stuff. We'll look at using hardware accelerated graphics next time.</p> <p>When you're ready, head over to <a href=https://www.valvers.com/embedded-linux/raspberry-pi/step06-bare-metal-programming-in-c-pt6>part 6</a> where we'll be using SD-Cards a LOT less and move to a new method of developing.</p> </article> </div> </div> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../bare-metal-programming-in-c-part-4/ class="md-footer__link md-footer__link--prev" aria-label="Previous: BMC Part 4 - Interrupts" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> BMC Part 4 - Interrupts </div> </div> </a> <a href=../bare-metal-programming-in-c/ class="md-footer__link md-footer__link--next" aria-label="Next: Raspberry-Pi Bare Metal Tutorial" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> Raspberry-Pi Bare Metal Tutorial </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2002-2020 Brian Sidebotham </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script> <script src=../../../assets/javascripts/bundle.d6c3db9e.min.js></script> <script src=https://code.jquery.com/jquery-3.4.1.slim.min.js></script> <script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js></script> <script src=https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js></script> <script src=/valvers-assets/extra.js></script> </body> </html>