



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="https://www.valvers.com/open-software/raspberry-pi/step05-bare-metal-programming-in-cpt5/">
      
      
        <meta name="author" content="Brian Sidebotham">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../img/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.6.3">
      <meta name="google-site-verification" content="gdf4XzjnbaArINbai3d8P0x_W3ugnDeIUyhMuq-wHPs" />
    
    
      
        <title>Part 5 - Graphics (Basic) - valvers.com</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application.adb8469c.css">
      
        <link rel="stylesheet" href="../../../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#546e7a">
      
    
    
      <script src="../../../assets/javascripts/modernizr.86422ebf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    
      <link rel="stylesheet" href="../../../valvers-assets/extra.css">
    
    
      
        
<script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-57476377-1", "valvers.com")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="blue-grey" data-md-color-accent="deep-orange">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#part-5-graphics-basic" tabindex="0" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://www.valvers.com" title="valvers.com" aria-label="valvers.com" class="md-header-nav__button md-logo">
          
            <img alt="logo" src="https://avatars3.githubusercontent.com/u/5575236?v=4?size=32" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              valvers.com
            </span>
            <span class="md-header-nav__topic">
              
                Part 5 - Graphics (Basic)
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/valvers/valvers.website.src/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="../../.." class="md-tabs__link">
        Home
      </a>
    
  </li>

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../denford-orac/" class="md-tabs__link">
          Denford orac
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../engineering/" class="md-tabs__link">
          Engineering
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../" class="md-tabs__link md-tabs__link--active">
          Open software
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../v6manta/" class="md-tabs__link">
          V6manta
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://www.valvers.com" title="valvers.com" class="md-nav__button md-logo">
      
        <img alt="logo" src="https://avatars3.githubusercontent.com/u/5575236?v=4?size=32" width="48" height="48">
      
    </a>
    valvers.com
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/valvers/valvers.website.src/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Denford orac
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Denford orac
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2009-04-06-my-denford-orac/" title="2009 04 06 my denford orac" class="md-nav__link">
      2009 04 06 my denford orac
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2012-02-17-uprated-spindle-motor/" title="2012 02 17 uprated spindle motor" class="md-nav__link">
      2012 02 17 uprated spindle motor
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2012-03-22-gathering-some-information/" title="2012 03 22 gathering some information" class="md-nav__link">
      2012 03 22 gathering some information
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2012-09-27-750w-motor-sourced/" title="2012 09 27 750w motor sourced" class="md-nav__link">
      2012 09 27 750w motor sourced
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2012-10-01-motor-doesnt-fit/" title="2012 10 01 motor doesnt fit" class="md-nav__link">
      2012 10 01 motor doesnt fit
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2012-10-10-drill-head-disassembly/" title="2012 10 10 drill head disassembly" class="md-nav__link">
      2012 10 10 drill head disassembly
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2012-10-13-more-quill-dismantling/" title="2012 10 13 more quill dismantling" class="md-nav__link">
      2012 10 13 more quill dismantling
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2012-10-17-drill-spindle-is-apart/" title="2012 10 17 drill spindle is apart" class="md-nav__link">
      2012 10 17 drill spindle is apart
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2012-10-29-removing-electrical-cabinet/" title="2012 10 29 removing electrical cabinet" class="md-nav__link">
      2012 10 29 removing electrical cabinet
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2012-10-31-tested-the-drill-head-above-the-lathe/" title="2012 10 31 tested the drill head above the lathe" class="md-nav__link">
      2012 10 31 tested the drill head above the lathe
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2012-11-02-rebuild-of-an-orac/" title="2012 11 02 rebuild of an orac" class="md-nav__link">
      2012 11 02 rebuild of an orac
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2013-03-13-new-motor-fitted/" title="2013 03 13 new motor fitted" class="md-nav__link">
      2013 03 13 new motor fitted
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Engineering
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Engineering
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../engineering/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../engineering/an-and-jic-fittings/" title="AN and JIC Fittings" class="md-nav__link">
      AN and JIC Fittings
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../engineering/bolt-dimensions/" title="Bolt Dimensions" class="md-nav__link">
      Bolt Dimensions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../engineering/linux-cnc-on-beaglebone-black/" title="Linux CNC on Beaglebone Black" class="md-nav__link">
      Linux CNC on Beaglebone Black
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../engineering/making-a-cyr-wheel/" title="Making a Cyr Wheel" class="md-nav__link">
      Making a Cyr Wheel
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      Open software
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Open software
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../" title="Open-Software" class="md-nav__link">
      Open-Software
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../android-car-dash/" title="Android car dash" class="md-nav__link">
      Android car dash
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../logging-with-gcc/" title="Logging with gcc" class="md-nav__link">
      Logging with gcc
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../posix-shell-scripting/" title="Posix Shell Scripting" class="md-nav__link">
      Posix Shell Scripting
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../working-with-the-screen-command/" title="Working with the Screen Command" class="md-nav__link">
      Working with the Screen Command
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-6" type="checkbox" id="nav-4-6">
    
    <label class="md-nav__link" for="nav-4-6">
      Arduino
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-6">
        Arduino
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../arduino/esp32-mqtt-tutorial/" title="ESP32 MQTT Tutorial" class="md-nav__link">
      ESP32 MQTT Tutorial
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-7" type="checkbox" id="nav-4-7">
    
    <label class="md-nav__link" for="nav-4-7">
      Aws
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-7">
        Aws
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../aws/aws-lambda-getting-started/" title="AWS Lambda Getting Started" class="md-nav__link">
      AWS Lambda Getting Started
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-8" type="checkbox" id="nav-4-8">
    
    <label class="md-nav__link" for="nav-4-8">
      Gcc
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-8">
        Gcc
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../gcc/weak-function-attributes/" title="Weak Function Attributes" class="md-nav__link">
      Weak Function Attributes
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-9" type="checkbox" id="nav-4-9">
    
    <label class="md-nav__link" for="nav-4-9">
      Python
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-9">
        Python
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../python/pylab/" title="Pylab" class="md-nav__link">
      Pylab
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-10" type="checkbox" id="nav-4-10" checked>
    
    <label class="md-nav__link" for="nav-4-10">
      Raspberry pi
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-10">
        Raspberry pi
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../" title="Open Software - Raspberry Pi" class="md-nav__link">
      Open Software - Raspberry Pi
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../step01-bare-metal-programming-in-cpt1/" title="Part 1 - Getting Started" class="md-nav__link">
      Part 1 - Getting Started
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../step02-bare-metal-programming-in-cpt2/" title="Part 2 - The C Runtime" class="md-nav__link">
      Part 2 - The C Runtime
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../step03-bare-metal-programming-in-cpt3/" title="Introducing CMake" class="md-nav__link">
      Introducing CMake
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../step04-bare-metal-programming-in-cpt4/" title="Part 4 - Interrupts" class="md-nav__link">
      Part 4 - Interrupts
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Part 5 - Graphics (Basic)
      </label>
    
    <a href="./" title="Part 5 - Graphics (Basic)" class="md-nav__link md-nav__link--active">
      Part 5 - Graphics (Basic)
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#reference-material" class="md-nav__link">
    Reference Material
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-gpu-videocore-iv" class="md-nav__link">
    The GPU (Videocore IV)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#part-5armc-014" class="md-nav__link">
    part-5/armc-014
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-a-uart-text-console" class="md-nav__link">
    Getting a UART Text Console
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aux-peripheral" class="md-nav__link">
    AUX peripheral
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-_write-system-call" class="md-nav__link">
    The _write() System Call
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enabling-vfp-support" class="md-nav__link">
    Enabling VFP Support
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mailboxes" class="md-nav__link">
    Mailboxes
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mailbox-property-interface" class="md-nav__link">
    Mailbox Property Interface
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-framebuffer-properties" class="md-nav__link">
    The Framebuffer Properties
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#armc-014" class="md-nav__link">
    armc-014
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#armc-015" class="md-nav__link">
    armc-015
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#enabling-cache" class="md-nav__link">
    Enabling Cache
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maxmising-the-clock-speed-rpi2" class="md-nav__link">
    Maxmising the Clock Speed (RPI2)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rpi2-performance" class="md-nav__link">
    RPI2 performance
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#making-the-compiler-work-for-us" class="md-nav__link">
    Making the Compiler work for us
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#armc-016" class="md-nav__link">
    armc-016
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-11" type="checkbox" id="nav-4-11">
    
    <label class="md-nav__link" for="nav-4-11">
      Saltstack
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-11">
        Saltstack
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../saltstack/building-a-centos8-salt-master/" title="Building a CentOS8 Salt Master" class="md-nav__link">
      Building a CentOS8 Salt Master
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-12" type="checkbox" id="nav-4-12">
    
    <label class="md-nav__link" for="nav-4-12">
      Webstacks
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-12">
        Webstacks
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../webstacks/using-reactjs-and-bulma/" title="Using ReactJS and Bulma" class="md-nav__link">
      Using ReactJS and Bulma
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      V6manta
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        V6manta
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-2" type="checkbox" id="nav-5-2">
    
    <label class="md-nav__link" for="nav-5-2">
      2003
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-2">
        2003
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-07-28-/" title="2003 07 28" class="md-nav__link">
      2003 07 28 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-07-28-brought-a-1.8s-berlinetta/" title="2003 07 28 brought a 1.8s berlinetta" class="md-nav__link">
      2003 07 28 brought a 1.8s berlinetta
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-07-28-stage-rally-opel-manta/" title="2003 07 28 stage rally opel manta" class="md-nav__link">
      2003 07 28 stage rally opel manta
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-08-12-/" title="2003 08 12" class="md-nav__link">
      2003 08 12 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-08-13-/" title="2003 08 13" class="md-nav__link">
      2003 08 13 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-08-23-/" title="2003 08 23" class="md-nav__link">
      2003 08 23 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-09-11-/" title="2003 09 11" class="md-nav__link">
      2003 09 11 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-09-28-/" title="2003 09 28" class="md-nav__link">
      2003 09 28 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-10-07-/" title="2003 10 07" class="md-nav__link">
      2003 10 07 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-10-09-/" title="2003 10 09" class="md-nav__link">
      2003 10 09 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-11-04-/" title="2003 11 04" class="md-nav__link">
      2003 11 04 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-12-16-/" title="2003 12 16" class="md-nav__link">
      2003 12 16 
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-3" type="checkbox" id="nav-5-3">
    
    <label class="md-nav__link" for="nav-5-3">
      2004
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-3">
        2004
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-01-06-/" title="2004 01 06" class="md-nav__link">
      2004 01 06 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-01-07-/" title="2004 01 07" class="md-nav__link">
      2004 01 07 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-01-26-/" title="2004 01 26" class="md-nav__link">
      2004 01 26 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-01-29-/" title="2004 01 29" class="md-nav__link">
      2004 01 29 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-02-09-/" title="2004 02 09" class="md-nav__link">
      2004 02 09 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-02-13-/" title="2004 02 13" class="md-nav__link">
      2004 02 13 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-02-19-/" title="2004 02 19" class="md-nav__link">
      2004 02 19 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-04-20-finally-got-around-to-the-manta/" title="2004 04 20 finally got around to the manta" class="md-nav__link">
      2004 04 20 finally got around to the manta
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-06-17-/" title="2004 06 17" class="md-nav__link">
      2004 06 17 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-06-18-/" title="2004 06 18" class="md-nav__link">
      2004 06 18 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-06-21-/" title="2004 06 21" class="md-nav__link">
      2004 06 21 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-07-26-/" title="2004 07 26" class="md-nav__link">
      2004 07 26 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-08-09-/" title="2004 08 09" class="md-nav__link">
      2004 08 09 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-08-10-/" title="2004 08 10" class="md-nav__link">
      2004 08 10 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-09-03-/" title="2004 09 03" class="md-nav__link">
      2004 09 03 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-09-27-/" title="2004 09 27" class="md-nav__link">
      2004 09 27 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-10-07-/" title="2004 10 07" class="md-nav__link">
      2004 10 07 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-10-08-/" title="2004 10 08" class="md-nav__link">
      2004 10 08 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-10-11-/" title="2004 10 11" class="md-nav__link">
      2004 10 11 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-10-13-/" title="2004 10 13" class="md-nav__link">
      2004 10 13 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-10-15-/" title="2004 10 15" class="md-nav__link">
      2004 10 15 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-10-18-/" title="2004 10 18" class="md-nav__link">
      2004 10 18 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-10-21-/" title="2004 10 21" class="md-nav__link">
      2004 10 21 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-10-22-/" title="2004 10 22" class="md-nav__link">
      2004 10 22 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-10-29-/" title="2004 10 29" class="md-nav__link">
      2004 10 29 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-11-01-/" title="2004 11 01" class="md-nav__link">
      2004 11 01 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-12-10-were-back/" title="2004 12 10 were back" class="md-nav__link">
      2004 12 10 were back
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-4" type="checkbox" id="nav-5-4">
    
    <label class="md-nav__link" for="nav-5-4">
      2005
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-4">
        2005
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-05-16-/" title="2005 05 16" class="md-nav__link">
      2005 05 16 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-08-04-done-something/" title="2005 08 04 done something" class="md-nav__link">
      2005 08 04 done something
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-08-08-/" title="2005 08 08" class="md-nav__link">
      2005 08 08 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-08-10-/" title="2005 08 10" class="md-nav__link">
      2005 08 10 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-08-25-/" title="2005 08 25" class="md-nav__link">
      2005 08 25 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-08-31-/" title="2005 08 31" class="md-nav__link">
      2005 08 31 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-09-05-/" title="2005 09 05" class="md-nav__link">
      2005 09 05 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-09-19-/" title="2005 09 19" class="md-nav__link">
      2005 09 19 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-09-22-/" title="2005 09 22" class="md-nav__link">
      2005 09 22 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-09-23-/" title="2005 09 23" class="md-nav__link">
      2005 09 23 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-11-01-/" title="2005 11 01" class="md-nav__link">
      2005 11 01 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-11-03-/" title="2005 11 03" class="md-nav__link">
      2005 11 03 
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-5" type="checkbox" id="nav-5-5">
    
    <label class="md-nav__link" for="nav-5-5">
      2007
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-5">
        2007
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2007/2007-10-20-/" title="2007 10 20" class="md-nav__link">
      2007 10 20 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2007/2007-10-20-perspex-windows/" title="2007 10 20 perspex windows" class="md-nav__link">
      2007 10 20 perspex windows
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2007/2007-11-13-getting-it-ready-to-paint.../" title="2007 11 13 getting it ready to paint..." class="md-nav__link">
      2007 11 13 getting it ready to paint...
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2007/2007-11-21-almost-started-painting/" title="2007 11 21 almost started painting" class="md-nav__link">
      2007 11 21 almost started painting
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2007/2007-11-28-underneath-is-complete/" title="2007 11 28 underneath is complete" class="md-nav__link">
      2007 11 28 underneath is complete
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2007/2007-12-04-painting-the-inside-and-engine-bay/" title="2007 12 04 painting the inside and engine bay" class="md-nav__link">
      2007 12 04 painting the inside and engine bay
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-6" type="checkbox" id="nav-5-6">
    
    <label class="md-nav__link" for="nav-5-6">
      2008
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-6">
        2008
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-01-14-painting-the-shell-orange/" title="2008 01 14 painting the shell orange" class="md-nav__link">
      2008 01 14 painting the shell orange
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-01-16-out-of-the-booth/" title="2008 01 16 out of the booth" class="md-nav__link">
      2008 01 16 out of the booth
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-01-23-rear-axle-trial-fitting/" title="2008 01 23 rear axle trial fitting" class="md-nav__link">
      2008 01 23 rear axle trial fitting
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-02-24-painted-the-nextel-and-checked-for-wheel-clearance/" title="2008 02 24 painted the nextel and checked for wheel clearance" class="md-nav__link">
      2008 02 24 painted the nextel and checked for wheel clearance
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-03-15-front-suspension-build/" title="2008 03 15 front suspension build" class="md-nav__link">
      2008 03 15 front suspension build
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-03-19-suspension-bushes-are-always-wrong/" title="2008 03 19 suspension bushes are always wrong" class="md-nav__link">
      2008 03 19 suspension bushes are always wrong
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-03-22-diff-bearings-need-replacing/" title="2008 03 22 diff bearings need replacing" class="md-nav__link">
      2008 03 22 diff bearings need replacing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-04-08-fitted-the-rear-windows-and-steering-column/" title="2008 04 08 fitted the rear windows and steering column" class="md-nav__link">
      2008 04 08 fitted the rear windows and steering column
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-04-12-shimmed-up-the-diff,-and-fitted-the-clocks/" title="2008 04 12 shimmed up the diff, and fitted the clocks" class="md-nav__link">
      2008 04 12 shimmed up the diff, and fitted the clocks
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-04-16-rebuilt-the-gearbox-so-i-get-gear-selection/" title="2008 04 16 rebuilt the gearbox so i get gear selection" class="md-nav__link">
      2008 04 16 rebuilt the gearbox so i get gear selection
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-07-08-its-on-its-wheels-at-last/" title="2008 07 08 its on its wheels at last" class="md-nav__link">
      2008 07 08 its on its wheels at last
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-09-02-rebuilt-oil-pump--started-headwork/" title="2008 09 02 rebuilt oil pump started headwork" class="md-nav__link">
      2008 09 02 rebuilt oil pump  started headwork
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-09-04-some-more-headwork/" title="2008 09 04 some more headwork" class="md-nav__link">
      2008 09 04 some more headwork
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-09-25-even-more-headwork/" title="2008 09 25 even more headwork" class="md-nav__link">
      2008 09 25 even more headwork
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-11-09-engine--transmission-fitted/" title="2008 11 09 engine transmission fitted" class="md-nav__link">
      2008 11 09 engine  transmission fitted
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-11-16-engine--gearbox-mounted--steering-column-fitted/" title="2008 11 16 engine gearbox mounted steering column fitted" class="md-nav__link">
      2008 11 16 engine  gearbox mounted  steering column fitted
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-12-14-stripping-the-x25xe-v6-bottom-end/" title="2008 12 14 stripping the x25xe v6 bottom end" class="md-nav__link">
      2008 12 14 stripping the x25xe v6 bottom end
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-7" type="checkbox" id="nav-5-7">
    
    <label class="md-nav__link" for="nav-5-7">
      2009
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-7">
        2009
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2009/2009-06-24-making-the-dry-sump-pan/" title="2009 06 24 making the dry sump pan" class="md-nav__link">
      2009 06 24 making the dry sump pan
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2009/2009-10-05-trialling-the-throttle-bodies--a-few-more-bits-painted/" title="2009 10 05 trialling the throttle bodies a few more bits painted" class="md-nav__link">
      2009 10 05 trialling the throttle bodies  a few more bits painted
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2009/2009-12-18-flywheel-and-clutch/" title="2009 12 18 flywheel and clutch" class="md-nav__link">
      2009 12 18 flywheel and clutch
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-8" type="checkbox" id="nav-5-8">
    
    <label class="md-nav__link" for="nav-5-8">
      2010
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-8">
        2010
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-01-23-done-the-handbrake--sliders/" title="2010 01 23 done the handbrake sliders" class="md-nav__link">
      2010 01 23 done the handbrake  sliders
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-01-27-started-building-the-v6-heads-up/" title="2010 01 27 started building the v6 heads up" class="md-nav__link">
      2010 01 27 started building the v6 heads up
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-01-30-picked-up-another-v6/" title="2010 01 30 picked up another v6" class="md-nav__link">
      2010 01 30 picked up another v6
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-02-01-exhaust-manifolds/" title="2010 02 01 exhaust manifolds" class="md-nav__link">
      2010 02 01 exhaust manifolds
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-02-02-starting-the-v6-build/" title="2010 02 02 starting the v6 build" class="md-nav__link">
      2010 02 02 starting the v6 build
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-02-03-cylinder-head-bolts-torque/" title="2010 02 03 cylinder head bolts torque" class="md-nav__link">
      2010 02 03 cylinder head bolts torque
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-02-03-ordered-the-exhaust-manifold-flanges/" title="2010 02 03 ordered the exhaust manifold flanges" class="md-nav__link">
      2010 02 03 ordered the exhaust manifold flanges
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-02-06-building-the-v6/" title="2010 02 06 building the v6" class="md-nav__link">
      2010 02 06 building the v6
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-02-07-building-the-v6/" title="2010 02 07 building the v6" class="md-nav__link">
      2010 02 07 building the v6
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-02-14-building-the-v6/" title="2010 02 14 building the v6" class="md-nav__link">
      2010 02 14 building the v6
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-03-22-gearbox-sealed-and-release-bearing-fitted/" title="2010 03 22 gearbox sealed and release bearing fitted" class="md-nav__link">
      2010 03 22 gearbox sealed and release bearing fitted
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-04-03-started-on-the-manifolds/" title="2010 04 03 started on the manifolds" class="md-nav__link">
      2010 04 03 started on the manifolds
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-04-05-finished-a-manifold/" title="2010 04 05 finished a manifold" class="md-nav__link">
      2010 04 05 finished a manifold
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-04-07-started-the-second-manifold/" title="2010 04 07 started the second manifold" class="md-nav__link">
      2010 04 07 started the second manifold
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-04-11-need-a-todo-list/" title="2010 04 11 need a todo list" class="md-nav__link">
      2010 04 11 need a todo list
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-04-21-ticking-off-the-boxes/" title="2010 04 21 ticking off the boxes" class="md-nav__link">
      2010 04 21 ticking off the boxes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-04-26-nearly-finished-the-second-manifold/" title="2010 04 26 nearly finished the second manifold" class="md-nav__link">
      2010 04 26 nearly finished the second manifold
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-05-09-got-the-car-rolling/" title="2010 05 09 got the car rolling" class="md-nav__link">
      2010 05 09 got the car rolling
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-05-11-rolling-road-day/" title="2010 05 11 rolling road day" class="md-nav__link">
      2010 05 11 rolling road day
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-05-31-back-from-germany/" title="2010 05 31 back from germany" class="md-nav__link">
      2010 05 31 back from germany
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-06-01-sumps-off/" title="2010 06 01 sumps off" class="md-nav__link">
      2010 06 01 sumps off
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-06-06-done-most-of-the-bits-on-the-v6/" title="2010 06 06 done most of the bits on the v6" class="md-nav__link">
      2010 06 06 done most of the bits on the v6
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-06-12-getting-ready-to-bolt-it-back-in/" title="2010 06 12 getting ready to bolt it back in" class="md-nav__link">
      2010 06 12 getting ready to bolt it back in
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-06-19-almost-ready-to-go-back-in/" title="2010 06 19 almost ready to go back in" class="md-nav__link">
      2010 06 19 almost ready to go back in
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-09-22-lack-of-updates/" title="2010 09 22 lack of updates" class="md-nav__link">
      2010 09 22 lack of updates
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-09-26-few-little-bits/" title="2010 09 26 few little bits" class="md-nav__link">
      2010 09 26 few little bits
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-10-09-v6-oil-problems..../" title="2010 10 09 v6 oil problems...." class="md-nav__link">
      2010 10 09 v6 oil problems....
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-10-12-starting-putting-the-engine-back-together/" title="2010 10 12 starting putting the engine back together" class="md-nav__link">
      2010 10 12 starting putting the engine back together
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-10-23-v6-is-broke/" title="2010 10 23 v6 is broke" class="md-nav__link">
      2010 10 23 v6 is broke
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-10-24-stripping-the-v6/" title="2010 10 24 stripping the v6" class="md-nav__link">
      2010 10 24 stripping the v6
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-10-25-v6-problem/" title="2010 10 25 v6 problem" class="md-nav__link">
      2010 10 25 v6 problem
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-11-03-picked-up-a-replacement-v6/" title="2010 11 03 picked up a replacement v6" class="md-nav__link">
      2010 11 03 picked up a replacement v6
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-12-12-been-busy-building/" title="2010 12 12 been busy building" class="md-nav__link">
      2010 12 12 been busy building
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-9" type="checkbox" id="nav-5-9">
    
    <label class="md-nav__link" for="nav-5-9">
      2011
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-9">
        2011
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-01-01-finally-driven-the-manta-again-today/" title="2011 01 01 finally driven the manta again today" class="md-nav__link">
      2011 01 01 finally driven the manta again today
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-03-13-fitting-some-new-seats/" title="2011 03 13 fitting some new seats" class="md-nav__link">
      2011 03 13 fitting some new seats
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-03-13-the-manta-got-mapped/" title="2011 03 13 the manta got mapped" class="md-nav__link">
      2011 03 13 the manta got mapped
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-03-25-went-to-brands-hatch/" title="2011 03 25 went to brands hatch" class="md-nav__link">
      2011 03 25 went to brands hatch
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-09-04-started-work-on-the-2011-rebuild/" title="2011 09 04 started work on the 2011 rebuild" class="md-nav__link">
      2011 09 04 started work on the 2011 rebuild
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-09-10-built-some-more-of-the-frame/" title="2011 09 10 built some more of the frame" class="md-nav__link">
      2011 09 10 built some more of the frame
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-09-14-started-work-on-the-new-sump-pan/" title="2011 09 14 started work on the new sump pan" class="md-nav__link">
      2011 09 14 started work on the new sump pan
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-09-15-more-subframe-work/" title="2011 09 15 more subframe work" class="md-nav__link">
      2011 09 15 more subframe work
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-09-17-gearbox-back-together/" title="2011 09 17 gearbox back together" class="md-nav__link">
      2011 09 17 gearbox back together
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-09-25-getting-ready-to-spray-the-engine-bay-again.../" title="2011 09 25 getting ready to spray the engine bay again..." class="md-nav__link">
      2011 09 25 getting ready to spray the engine bay again...
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-10-16-moving-along-with-the-rebuild/" title="2011 10 16 moving along with the rebuild" class="md-nav__link">
      2011 10 16 moving along with the rebuild
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-10-18-painted-the-engine-bay/" title="2011 10 18 painted the engine bay" class="md-nav__link">
      2011 10 18 painted the engine bay
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-11-15-dry-sump-work.../" title="2011 11 15 dry sump work..." class="md-nav__link">
      2011 11 15 dry sump work...
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-10" type="checkbox" id="nav-5-10">
    
    <label class="md-nav__link" for="nav-5-10">
      2012
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-10">
        2012
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-01-09-dry-sump-pan-is-welded/" title="2012 01 09 dry sump pan is welded" class="md-nav__link">
      2012 01 09 dry sump pan is welded
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-01-27-more-dry-sump-work/" title="2012 01 27 more dry sump work" class="md-nav__link">
      2012 01 27 more dry sump work
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-02-21-engine-is-back-in.../" title="2012 02 21 engine is back in..." class="md-nav__link">
      2012 02 21 engine is back in...
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-02-24-took-the-engine-back-out-again/" title="2012 02 24 took the engine back out again" class="md-nav__link">
      2012 02 24 took the engine back out again
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-02-27-engine-back-in-again/" title="2012 02 27 engine back in again" class="md-nav__link">
      2012 02 27 engine back in again
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-03-14-mostly-plumbed-back-in/" title="2012 03 14 mostly plumbed back in" class="md-nav__link">
      2012 03 14 mostly plumbed back in
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-04-04-started-her-up-again/" title="2012 04 04 started her up again" class="md-nav__link">
      2012 04 04 started her up again
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-04-16-ready-for-a-test-drive/" title="2012 04 16 ready for a test drive" class="md-nav__link">
      2012 04 16 ready for a test drive
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-05-09-clutch-release-bearing-failure/" title="2012 05 09 clutch release bearing failure" class="md-nav__link">
      2012 05 09 clutch release bearing failure
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-05-17-stripping-the-t5-gearbox/" title="2012 05 17 stripping the t5 gearbox" class="md-nav__link">
      2012 05 17 stripping the t5 gearbox
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-10-13-rebuilt-the-gearbox/" title="2012 10 13 rebuilt the gearbox" class="md-nav__link">
      2012 10 13 rebuilt the gearbox
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-11-11-finally-the-engines-back-in/" title="2012 11 11 finally the engines back in" class="md-nav__link">
      2012 11 11 finally the engines back in
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-11-14-nearly-back-together/" title="2012 11 14 nearly back together" class="md-nav__link">
      2012 11 14 nearly back together
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-11-25-the-finishing-touches/" title="2012 11 25 the finishing touches" class="md-nav__link">
      2012 11 25 the finishing touches
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-11-28-finally-the-v6-manta-up-a-running-again/" title="2012 11 28 finally the v6 manta up a running again" class="md-nav__link">
      2012 11 28 finally the v6 manta up a running again
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-12-30-virtually-back-on-the-road/" title="2012 12 30 virtually back on the road" class="md-nav__link">
      2012 12 30 virtually back on the road
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-11" type="checkbox" id="nav-5-11">
    
    <label class="md-nav__link" for="nav-5-11">
      2013
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-11">
        2013
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2013/2013-01-10-driven-the-manta-again/" title="2013 01 10 driven the manta again" class="md-nav__link">
      2013 01 10 driven the manta again
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2013/2013-01-15-had-a-great-blast-in-the-manta/" title="2013 01 15 had a great blast in the manta" class="md-nav__link">
      2013 01 15 had a great blast in the manta
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#reference-material" class="md-nav__link">
    Reference Material
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-gpu-videocore-iv" class="md-nav__link">
    The GPU (Videocore IV)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#part-5armc-014" class="md-nav__link">
    part-5/armc-014
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-a-uart-text-console" class="md-nav__link">
    Getting a UART Text Console
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aux-peripheral" class="md-nav__link">
    AUX peripheral
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-_write-system-call" class="md-nav__link">
    The _write() System Call
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enabling-vfp-support" class="md-nav__link">
    Enabling VFP Support
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mailboxes" class="md-nav__link">
    Mailboxes
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mailbox-property-interface" class="md-nav__link">
    Mailbox Property Interface
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-framebuffer-properties" class="md-nav__link">
    The Framebuffer Properties
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#armc-014" class="md-nav__link">
    armc-014
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#armc-015" class="md-nav__link">
    armc-015
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#enabling-cache" class="md-nav__link">
    Enabling Cache
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maxmising-the-clock-speed-rpi2" class="md-nav__link">
    Maxmising the Clock Speed (RPI2)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rpi2-performance" class="md-nav__link">
    RPI2 performance
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#making-the-compiler-work-for-us" class="md-nav__link">
    Making the Compiler work for us
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#armc-016" class="md-nav__link">
    armc-016
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset" id="content">
              
                
                  <a href="https://github.com/valvers/valvers.website.src/edit/master/docs/open-software/raspberry-pi/step05-bare-metal-programming-in-cpt5.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <ul class="metadata page-metadata" data-bi-name="page info" lang="en-us" dir="ltr">
                  <li class="last-updated-holder displayDate loading">
                    <span class="last-updated-text">Last updated:</span>
                    <time role="presentation" datetime="2018-10-25T00:00:00.000Z" data-article-date-source="ms.date">2020-02-18</time>
                  </li>
                <!--
                  <li class="readingTime">
                    2 minutes to read
                  </li>
                -->
                  <li class="contributors-holder">
                    <span class="contributors-text">Contributors</span>
                    <ul class="contributors" data-bi-name="contributors"><li><a href="https://github.com/BrianSidebotham" title="Brian Sidebotham" data-bi-name="contributorprofile"><img src="../img/contributor.svg" data-src="https://avatars3.githubusercontent.com/u/5575236?v=4?size=32" alt="Brian Sidebotham"></a></li></ul>
                  </li>
                </ul>
                <h1 id="part-5-graphics-basic">Part 5 - Graphics (Basic)<a class="headerlink" href="#part-5-graphics-basic" title="Permanent link">&para;</a></h1>
<p>Finally, we get on to a tutorial that moves us away from blinking an LED as we explore the VideoCore IV GPU</p>
<h2 id="reference-material">Reference Material<a class="headerlink" href="#reference-material" title="Permanent link">&para;</a></h2>
<p>We need some reading material for this tutorial - this is how I put the tutorial together, by reading and studying the manuals available for the Videcore, but for this tutorial mainly the information from the Cambridge Raspberry Pi Tutorials. Yes there's a lot of text and more than one manual - but that's the only way you learn!</p>
<p>Some material that's useful (Generally for late night reading!):</p>
<ul>
<li><a href="https://github.com/raspberrypi/firmware/wiki/Accessing-mailboxes">Raspberry Pi Firmware Mailboxes information</a></li>
</ul>
<p>This information is less important for now, but worth noting:</p>
<ul>
<li><a href="http://www.broadcom.com/docs/support/videocore/VideoCoreIV-AG100-R.pdf">VideoCoreIv-AG100 3D Architecture Reference</a></li>
<li><a href="http://www.broadcom.com/docs/support/videocore/Brcm_Android_ICS_Graphics_Stack.tar.gz">Android Graphics Driver Source Code for VideoCoreIV</a></li>
</ul>
<h2 id="the-gpu-videocore-iv">The GPU (Videocore IV)<a class="headerlink" href="#the-gpu-videocore-iv" title="Permanent link">&para;</a></h2>
<p>The GPU and ARM devices can communicate with each other through a mailbox system. However, don't forget that the ARM and GPU also share the memory space, and so although we have to communicate through the mailbox, this is what negotiates settings and a framebuffer. The framebuffer address in memory is then returned from the GPU and we can go ahead and write to the framebuffer to see graphics.</p>
<p>A framebuffer is a term that really refers to a block of video memory. This video memory is used to display pixels on the screen. So we have access to each pixel on the screen and can change it's colour properties. The framebuffer should be at least as big as the screen resolution. The size of the framebuffer memory block is given by:</p>
<div class="codehilite"><pre><span></span><code>    <span class="n">framebuffer_bytes</span> <span class="o">=</span> <span class="n">pixels_x</span> <span class="o">*</span> <span class="n">pixels_y</span> <span class="o">*</span> <span class="n">bytes_per_pixel</span><span class="p">;</span>
</code></pre></div>

<blockquote>
<p><strong>NOTE</strong> In this tutorial we'll be using a framebuffer and so won't have any higher-level functions like OpenGL or accelerated graphics. We're going to create a simple software renderer.</p>
</blockquote>
<p>The number of bytes per pixel sets the number of colours available. The Raspberry-Pi GPU supports 8-bit, but in this mode the 8-bit value corresponds to a palette entry, and the palette appears to be very limited A palette mode can be really useful as it's fast (minimal amount of memory required for the graphics) and can be really useful for some special effects by simply altering the palette.</p>
<p>16-bit requires two bytes of data per pixel and directly represents the Red, Green and Blue levels of the colour of the pixel, and 32-bit has 4 bytes of data per pixel which has 8-bit per primary colour and an 8-biot alpha channel (transparency).</p>
<p>The GPU is generally quite a closely guarded secret. It's a specialised processor, but also a powerful processor and most people would like to run code on it, just like we're running code on the GPU itself, but alas the GPU information is still under NDA (Non-Disclosure Agreement) terms.</p>
<p>Broadcom however, did release some information and some of the most interesting information is in the [BCM21553 Graphics Driver]
(<a href="http://www.broadcom.com/docs/support/videocore/Brcm_Android_ICS_Graphics_Stack.tar.gz">http://www.broadcom.com/docs/support/videocore/Brcm_Android_ICS_Graphics_Stack.tar.gz</a>). I'll reference what material I've got from there as we go. Unfortunately there is no definitive source of information for the Raspberry Pi GPU, only bits and pieces scattered around the web. The GPU is a Videocore IV. As we're going to use the mailbox communication with the GPU anyway, we can skip a lot of the GPU detail and just concentrate on communicating with the GPU to get a framebuffer to use.</p>
<p>The mailbox interface is our main entry point into the world of graphics. The interface was developed and created by a few guys at broadcom. The mailbox interface is software running on the GPU which receives messages from software running on the arm and returns responses to each message after performing a task. It's implemented in the start.elf file that we require on the SD Card to boot the Raspberry-Pi. You can see their discussion about implementing the mailbox on <a href="https://github.com/raspberrypi/firmware/issues/47">Github</a></p>
<p>The mailboxes are defined <a href="https://github.com/raspberrypi/firmware/wiki/Mailboxes">on Github</a>.</p>
<p>The interface we're interested in is the <a href="https://github.com/raspberrypi/firmware/wiki/Mailbox-property-interface">Property Interface Mailbox</a>.</p>
<p>This mailbox is responsible for negotiating the framebuffer. We need some code to be able to read and write data from the mailbox and we also need to define the data structure defined by the framebuffer mailbox documentation.</p>
<h2 id="part-5armc-014">part-5/armc-014<a class="headerlink" href="#part-5armc-014" title="Permanent link">&para;</a></h2>
<p>The ARM014 tutorial introduces a few new peices of the puzzle. Firstly, as an aid to debugging now the code is getting more complex it introduces the mini UART which means we can have a basic "console". As we've bothered with the standard c library we can see how to tie the standard library functions like <code>printf()</code> to the UART. Secondly, it introduces the mailbox property interface which is a method of the ARM processor talking to the GPU. If we're going to get to the point of generating graphics, we must talk to the GPU!</p>
<p>This code does generate an "animated" display, but as we'll see - it is extremely slow to use un-optimised software rendering on an RPI! If you want, go ahead and compile it now and plug the raspberry pi into a monitor or television with a HDMI interface. It <strong>should</strong> work! As we're now including new hardware into the mix it's possible that your monitor or TV doesn't support the resolution and colour depth that the example is hard coded to use. It's an example that's designed to be simple rather than supporting every HDMI panel out there. Hopefully you'll have luck with it. I'm using an old Hanns-G HUD19 monitor with DVI-&gt;HDMI adaptor.</p>
<p>If it works, you'll see an ever-changing display which moves through the colour spectrum, continuously writing to every pixel in the framebuffer! You can see the (rather boring) output on <a href="https://youtube.com">YouTube</a>.</p>
<p>This tutorial shows how a 700MHz (or 900MHz) processor doesn't give you carte-blanche to program in C and end up with an optimised output. In this example there is no vertical sync used, we simply dedicate 100% of the ARM processor time to drawing the rectangle in video memory and then moving it one pixel before drawing it to the video memory again. In this way we can see the raw speed of the processor at work. It's pretty slow isn't it!</p>
<p>We'll optimise in the ARM015 code later on in this tutorial.</p>
<h2 id="getting-a-uart-text-console">Getting a UART Text Console<a class="headerlink" href="#getting-a-uart-text-console" title="Permanent link">&para;</a></h2>
<p>Read that title carefully, not getting a graphics Text Console but instead getting some text out of the code to help us debug. As the code becomes more complex we need better ways of debugging. A later tutorial will talk about using JTAG but for now we can have the basic UART based text debugging that gets us out of most holes!</p>
<p>This requires some hardware. Namely a <a href="http://cpc.farnell.com/ftdi/ttl-232r-3v3/cable-usb-to-ttl-level-seri-converter/dp/SC10142">TTL-232R-3V3</a> or equivalent is required. The mini uart described in the AUX peripheral below is available on the RPI IO expansion headers on pins 8 (GPIO14/TXD) and 10 (GPIO15/RXD)</p>
<p>Connecting the UART to a PC is pretty easy, a quick connection guide is available:</p>
<p><img alt="UART Connection" src="https://raw.githubusercontent.com/BrianSidebotham/arm-tutorial-rpi/master/part-5/img/arm-tutorial-rpi/ftdi-ttl-232r-3v3-rpi-connection.png" /></p>
<p>Also, a quick photo of one connected up:</p>
<p><img alt="UART Connection" src="https://raw.githubusercontent.com/BrianSidebotham/arm-tutorial-rpi/master/part-5/img/arm-tutorial-rpi/ftdi-ttl-232r-3v3-rpi-connection-photo.jpg" /></p>
<h3 id="aux-peripheral">AUX peripheral<a class="headerlink" href="#aux-peripheral" title="Permanent link">&para;</a></h3>
<p>The AUX peripheral includes a couple of communication interfaces which we can put to use. In this tutorial we will enable the mini UART which has Rx/Tx signals available on the IO header of the raspberry-pi. We will connect that to an FTDI 3.3V USB-&gt;UART converter and then we can connect PuTTY to the COM port and see output from the code!</p>
<p>We will do some more work on the c stubs to provide uart support in the write system call which is what the likes of <code>printf()</code>, etc. functions use to write to the system.</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&quot;rpi-aux.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;rpi-base.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;rpi-gpio.h&quot;</span><span class="cp"></span>

<span class="k">static</span> <span class="n">aux_t</span><span class="o">*</span> <span class="n">auxillary</span> <span class="o">=</span> <span class="p">(</span><span class="n">aux_t</span><span class="o">*</span><span class="p">)</span><span class="n">AUX_BASE</span><span class="p">;</span>


<span class="n">aux_t</span><span class="o">*</span> <span class="nf">RPI_GetAux</span><span class="p">(</span> <span class="kt">void</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">auxillary</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Define the system clock frequency in MHz for the baud rate calculation.</span>
<span class="cm">   This is clearly defined on the BCM2835 datasheet errata page:</span>
<span class="cm">   http://elinux.org/BCM2835_datasheet_errata */</span>
<span class="cp">#define SYS_FREQ    250000000</span>

<span class="kt">void</span> <span class="nf">RPI_AuxMiniUartInit</span><span class="p">(</span> <span class="kt">int</span> <span class="n">baud</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="k">volatile</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="cm">/* As this is a mini uart the configuration is complete! Now just</span>
<span class="cm">       enable the uart. Note from the documentation in section 2.1.1 of</span>
<span class="cm">       the ARM peripherals manual:</span>

<span class="cm">       If the enable bits are clear you will have no access to a</span>
<span class="cm">       peripheral. You can not even read or write the registers */</span>
    <span class="n">auxillary</span><span class="o">-&gt;</span><span class="n">ENABLES</span> <span class="o">=</span> <span class="n">AUX_ENA_MINIUART</span><span class="p">;</span>

    <span class="cm">/* Disable interrupts for now */</span>
    <span class="cm">/* auxillary-&gt;IRQ &amp;= ~AUX_IRQ_MU; */</span>

    <span class="n">auxillary</span><span class="o">-&gt;</span><span class="n">MU_IER</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="cm">/* Disable flow control,enable transmitter and receiver! */</span>
    <span class="n">auxillary</span><span class="o">-&gt;</span><span class="n">MU_CNTL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="cm">/* Decide between seven or eight-bit mode */</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">bits</span> <span class="o">==</span> <span class="mi">8</span> <span class="p">)</span>
        <span class="n">auxillary</span><span class="o">-&gt;</span><span class="n">MU_LCR</span> <span class="o">=</span> <span class="n">AUX_MULCR_8BIT_MODE</span><span class="p">;</span>
    <span class="k">else</span>
        <span class="n">auxillary</span><span class="o">-&gt;</span><span class="n">MU_LCR</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">auxillary</span><span class="o">-&gt;</span><span class="n">MU_MCR</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="cm">/* Disable all interrupts from MU and clear the fifos */</span>
    <span class="n">auxillary</span><span class="o">-&gt;</span><span class="n">MU_IER</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">auxillary</span><span class="o">-&gt;</span><span class="n">MU_IIR</span> <span class="o">=</span> <span class="mh">0xC6</span><span class="p">;</span>

    <span class="cm">/* Transposed calculation from Section 2.2.1 of the ARM peripherals</span>
<span class="cm">       manual */</span>
    <span class="n">auxillary</span><span class="o">-&gt;</span><span class="n">MU_BAUD</span> <span class="o">=</span> <span class="p">(</span> <span class="n">SYS_FREQ</span> <span class="o">/</span> <span class="p">(</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">baud</span> <span class="p">)</span> <span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

     <span class="cm">/* Setup GPIO 14 and 15 as alternative function 5 which is</span>
<span class="cm">        UART 1 TXD/RXD. These need to be set before enabling the UART */</span>
    <span class="n">RPI_SetGpioPinFunction</span><span class="p">(</span> <span class="n">RPI_GPIO14</span><span class="p">,</span> <span class="n">FS_ALT5</span> <span class="p">);</span>
    <span class="n">RPI_SetGpioPinFunction</span><span class="p">(</span> <span class="n">RPI_GPIO15</span><span class="p">,</span> <span class="n">FS_ALT5</span> <span class="p">);</span>

    <span class="n">RPI_GetGpio</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GPPUD</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">150</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
    <span class="n">RPI_GetGpio</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GPPUDCLK0</span> <span class="o">=</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span> <span class="p">);</span>
    <span class="k">for</span><span class="p">(</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">150</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
    <span class="n">RPI_GetGpio</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GPPUDCLK0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="cm">/* Disable flow control,enable transmitter and receiver! */</span>
    <span class="n">auxillary</span><span class="o">-&gt;</span><span class="n">MU_CNTL</span> <span class="o">=</span> <span class="n">AUX_MUCNTL_TX_ENABLE</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">RPI_AuxMiniUartWrite</span><span class="p">(</span> <span class="kt">char</span> <span class="n">c</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* Wait until the UART has an empty space in the FIFO */</span>
    <span class="k">while</span><span class="p">(</span> <span class="p">(</span> <span class="n">auxillary</span><span class="o">-&gt;</span><span class="n">MU_LSR</span> <span class="o">&amp;</span> <span class="n">AUX_MULSR_TX_EMPTY</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

    <span class="cm">/* Write the character to the FIFO for transmission */</span>
    <span class="n">auxillary</span><span class="o">-&gt;</span><span class="n">MU_IO</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="cp">#ifndef RPI_AUX_H</span>
<span class="cp">#define RPI_AUX_H</span>

<span class="cp">#include</span> <span class="cpf">&quot;rpi-base.h&quot;</span><span class="cp"></span>

<span class="cp">#define AUX_BASE    ( PERIPHERAL_BASE + 0x215000 )</span>

<span class="cp">#define AUX_ENA_MINIUART            ( 1 &lt;&lt; 0 )</span>
<span class="cp">#define AUX_ENA_SPI1                ( 1 &lt;&lt; 1 )</span>
<span class="cp">#define AUX_ENA_SPI2                ( 1 &lt;&lt; 2 )</span>

<span class="cp">#define AUX_IRQ_SPI2                ( 1 &lt;&lt; 2 )</span>
<span class="cp">#define AUX_IRQ_SPI1                ( 1 &lt;&lt; 1 )</span>
<span class="cp">#define AUX_IRQ_MU                  ( 1 &lt;&lt; 0 )</span>

<span class="cp">#define AUX_MULCR_8BIT_MODE         ( 3 &lt;&lt; 0 )  </span><span class="cm">/* See errata for this value */</span><span class="cp"></span>
<span class="cp">#define AUX_MULCR_BREAK             ( 1 &lt;&lt; 6 )</span>
<span class="cp">#define AUX_MULCR_DLAB_ACCESS       ( 1 &lt;&lt; 7 )</span>

<span class="cp">#define AUX_MUMCR_RTS               ( 1 &lt;&lt; 1 )</span>

<span class="cp">#define AUX_MULSR_DATA_READY        ( 1 &lt;&lt; 0 )</span>
<span class="cp">#define AUX_MULSR_RX_OVERRUN        ( 1 &lt;&lt; 1 )</span>
<span class="cp">#define AUX_MULSR_TX_EMPTY          ( 1 &lt;&lt; 5 )</span>
<span class="cp">#define AUX_MULSR_TX_IDLE           ( 1 &lt;&lt; 6 )</span>

<span class="cp">#define AUX_MUMSR_CTS               ( 1 &lt;&lt; 5 )</span>

<span class="cp">#define AUX_MUCNTL_RX_ENABLE        ( 1 &lt;&lt; 0 )</span>
<span class="cp">#define AUX_MUCNTL_TX_ENABLE        ( 1 &lt;&lt; 1 )</span>
<span class="cp">#define AUX_MUCNTL_RTS_FLOW         ( 1 &lt;&lt; 2 )</span>
<span class="cp">#define AUX_MUCNTL_CTS_FLOW         ( 1 &lt;&lt; 3 )</span>
<span class="cp">#define AUX_MUCNTL_RTS_FIFO         ( 3 &lt;&lt; 4 )</span>
<span class="cp">#define AUX_MUCNTL_RTS_ASSERT       ( 1 &lt;&lt; 6 )</span>
<span class="cp">#define AUX_MUCNTL_CTS_ASSERT       ( 1 &lt;&lt; 7 )</span>

<span class="cp">#define AUX_MUSTAT_SYMBOL_AV        ( 1 &lt;&lt; 0 )</span>
<span class="cp">#define AUX_MUSTAT_SPACE_AV         ( 1 &lt;&lt; 1 )</span>
<span class="cp">#define AUX_MUSTAT_RX_IDLE          ( 1 &lt;&lt; 2 )</span>
<span class="cp">#define AUX_MUSTAT_TX_IDLE          ( 1 &lt;&lt; 3 )</span>
<span class="cp">#define AUX_MUSTAT_RX_OVERRUN       ( 1 &lt;&lt; 4 )</span>
<span class="cp">#define AUX_MUSTAT_TX_FIFO_FULL     ( 1 &lt;&lt; 5 )</span>
<span class="cp">#define AUX_MUSTAT_RTS              ( 1 &lt;&lt; 6 )</span>
<span class="cp">#define AUX_MUSTAT_CTS              ( 1 &lt;&lt; 7 )</span>
<span class="cp">#define AUX_MUSTAT_TX_EMPTY         ( 1 &lt;&lt; 8 )</span>
<span class="cp">#define AUX_MUSTAT_TX_DONE          ( 1 &lt;&lt; 9 )</span>
<span class="cp">#define AUX_MUSTAT_RX_FIFO_LEVEL    ( 7 &lt;&lt; 16 )</span>
<span class="cp">#define AUX_MUSTAT_TX_FIFO_LEVEL    ( 7 &lt;&lt; 24 )</span>


<span class="cp">#define FSEL0(x)        ( x )</span>
<span class="p">...</span>
<span class="cp">#define FSEL53(x)       ( x &lt;&lt; 9 )</span>


<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">IRQ</span><span class="p">;</span>
    <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ENABLES</span><span class="p">;</span>

    <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reserved1</span><span class="p">[((</span><span class="mh">0x40</span> <span class="o">-</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

    <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">MU_IO</span><span class="p">;</span>
    <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">MU_IER</span><span class="p">;</span>
    <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">MU_IIR</span><span class="p">;</span>
    <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">MU_LCR</span><span class="p">;</span>
    <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">MU_MCR</span><span class="p">;</span>
    <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">MU_LSR</span><span class="p">;</span>
    <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">MU_MSR</span><span class="p">;</span>
    <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">MU_SCRATCH</span><span class="p">;</span>
    <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">MU_CNTL</span><span class="p">;</span>
    <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">MU_STAT</span><span class="p">;</span>
    <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">MU_BAUD</span><span class="p">;</span>

    <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reserved2</span><span class="p">[(</span><span class="mh">0x80</span> <span class="o">-</span> <span class="mh">0x68</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">];</span>

    <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">SPI0_CNTL0</span><span class="p">;</span>
    <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">SPI0_CNTL1</span><span class="p">;</span>
    <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">SPI0_STAT</span><span class="p">;</span>
    <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">SPI0_IO</span><span class="p">;</span>
    <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">SPI0_PEEK</span><span class="p">;</span>

    <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reserved3</span><span class="p">[(</span><span class="mh">0xC0</span> <span class="o">-</span> <span class="mh">0x94</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">];</span>

    <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">SPI1_CNTL0</span><span class="p">;</span>
    <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">SPI1_CNTL1</span><span class="p">;</span>
    <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">SPI1_STAT</span><span class="p">;</span>
    <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">SPI1_IO</span><span class="p">;</span>
    <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">SPI1_PEEK</span><span class="p">;</span>
    <span class="p">}</span> <span class="n">aux_t</span><span class="p">;</span>

<span class="k">extern</span> <span class="n">aux_t</span><span class="o">*</span> <span class="nf">RPI_GetAux</span><span class="p">(</span> <span class="kt">void</span> <span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="nf">RPI_AuxMiniUartInit</span><span class="p">(</span> <span class="kt">int</span> <span class="n">baud</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits</span> <span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="nf">RPI_AuxMiniUartWrite</span><span class="p">(</span> <span class="kt">char</span> <span class="n">c</span> <span class="p">);</span>

<span class="cp">#endif</span>
</code></pre></div>

<p>I'm not going to go too far into explaining these drivers now. It's written in C, and you've got the BCM2835 data sheet the same as I have. You should be getting familiar with the layout of these "driver" files and the documentation in the BCM2835 peripherals document.</p>
<p>We provide an initialisation function so we can set the number of bits (data bits) and the baud rate. The mini UART implementation isn't that configurable because it's not a full UART implementation. It's designed to provide a quick means of providing a console with as little code as possible. So there's no setting for parity or number of stop bits. It's always N1 (No parity, one stop bit).</p>
<blockquote>
<p><strong>HACK:</strong> The calculation for the baud rate registers is done based on a defined system frequency of 250MHz. It works, but it's not as nice as using a detected system frequency. Perhaps after this tutorial you could get the system frequency and update the calculation to use it!</p>
</blockquote>
<p>The functions are written in a blocking mode, so the write function blocks until the UART can accept the next character, then it writes the new character and returns. Normally we'd use the UART interrupt to send a whole buffer of data rather than manually polling the register as this ties the processor up waiting. However, these are easy to use!</p>
<h3 id="the-_write-system-call">The _write() System Call<a class="headerlink" href="#the-_write-system-call" title="Permanent link">&para;</a></h3>
<p>Whenever data needs to be written to the OS it's done so through a function called <code>_write</code>. This is one of the original c-stubs we wrote in a previous tutorial. We previously just implemented a blank function. Here's the blank function we had. As you can see, it's not quite blank, but <code>outbyte</code> does nothing with the data, it's an empty sink.</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span> <span class="nf">outbyte</span><span class="p">(</span> <span class="kt">char</span> <span class="n">b</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">b</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">_write</span><span class="p">(</span> <span class="kt">int</span> <span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">todo</span><span class="p">;</span>

    <span class="k">for</span><span class="p">(</span> <span class="n">todo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">todo</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">todo</span><span class="o">++</span> <span class="p">)</span>
      <span class="n">outbyte</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="o">++</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>We can tie all writes to the OS (for all files) to the UART console by adding the UART write function call to outbyte:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span> <span class="nf">outbyte</span><span class="p">(</span> <span class="kt">char</span> <span class="n">b</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="n">RPI_AuxMiniUartWrite</span><span class="p">(</span> <span class="n">b</span> <span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>Originally this is what I did, and then when I used printf() to test function I kept getting a crash. In fact after some debugging with the OK LED in the processor exception handlers we introduced in the last tutorial I was able to determine it was an undefined instruction error.</p>
<p>When you run this tutorials examples with PuTTY, you'll see output similar to this:</p>
<p><img alt="PuTTY RPi Connection" src="https://raw.githubusercontent.com/BrianSidebotham/arm-tutorial-rpi/master/part-5/img/arm-tutorial-rpi/putty-rpi-connection.png" /></p>
<h3 id="enabling-vfp-support">Enabling VFP Support<a class="headerlink" href="#enabling-vfp-support" title="Permanent link">&para;</a></h3>
<p>After a bit more thinking and tinkering I realised we have to enable the VFP now in order to use printf. As we're compiling and telling the compiler (or more the linker actually) that we're targeting a device with the VFP it is linking to a libc that can use VFP instructions and why shouldn't something in the printf implementation use the VFP instruction when necessary to speed things up?</p>
<p>There is some <a href="http://stackoverflow.com/questions/24589235/application-hangs-when-calling-printf-to-uart-with-bare-metal-raspberry-pi/27257841#27257841">more information about the problem on a stackoverflow answer</a>.</p>
<p>Without the VFP co-processor being enabled, VFP instructions will cause an undefined instruction exception. Enabling the VFP is another task that the C Runtime startup file crt0 would have performed for us, but we're on our own since we have to use <code>-nostartfiles</code> (See an earlier tutorial).</p>
<p>Some <a href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.dai0098a/index.html">recommended information about enabling VFP support</a> is available from ARM.</p>
<p>Some <a href="http://processors.wiki.ti.com/index.php/Cortex-A8#How_to_enable_NEON">example code for enabling the VFP</a> is available on the TI wiki, and that's the code we slice in to armc-start.S so that the VFP is enabled before the c library is setup:</p>
<div class="codehilite"><pre><span></span><code>    // Enable VFP ------------------------------------------------------------

    // r1 = Access Control Register
    MRC p15, #0, r1, c1, c0, #2
    // enable full access for p10,11
    ORR r1, r1, #(0xf &lt;&lt; 20)
    // ccess Control Register = r1
    MCR p15, #0, r1, c1, c0, #2
    MOV r1, #0
    // flush prefetch buffer because of FMXR below
    MCR p15, #0, r1, c7, c5, #4
    // and CP 10 &amp; 11 were only just enabled
    // Enable VFP itself
    MOV r0,#0x40000000
    // FPEXC = r0
    FMXR FPEXC, r0
</code></pre></div>

<p>With those additions, we can now go ahead and use the c-library write functions. It means that the full <code>printf()</code> implementation can be used on the UART for example without us having to lift a finger and try and implement something as fundamental as that ourselves.</p>
<p>Also, this provides us with a debug/comms channel that is separate to the display. It's hard to use the display for debugging when the display isn't yet working!</p>
<h2 id="mailboxes">Mailboxes<a class="headerlink" href="#mailboxes" title="Permanent link">&para;</a></h2>
<p>We introduce some code in a few files, namely <code>rpi-mailbox</code> and <code>rpi-mailbox-interface</code>. The first is a common interface to access the mailbox system which passes information from the GPU to the ARM processor. The mailbox interface is implemented in the firmware (start.elf) that runs on the GPU.</p>
<p>Here's the code, and as noted in the comments, the mailbox interface is described on the RPI firmware github wiki:</p>
<ul>
<li><a href="https://github.com/raspberrypi/firmware/wiki/Accessing-mailboxes">https://github.com/raspberrypi/firmware/wiki/Accessing-mailboxes</a></li>
<li><a href="https://github.com/raspberrypi/firmware/wiki/Mailboxes">https://github.com/raspberrypi/firmware/wiki/Mailboxes</a></li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="cp">#ifndef RPI_MAILBOX_H</span>
<span class="cp">#define RPI_MAILBOX_H</span>

<span class="cp">#include</span> <span class="cpf">&quot;rpi-base.h&quot;</span><span class="cp"></span>

<span class="cp">#define RPI_MAILBOX0_BASE    ( PERIPHERAL_BASE + 0xB880 )</span>

<span class="cm">/* The available mailbox channels in the BCM2835 Mailbox interface.</span>
<span class="cm">   See https://github.com/raspberrypi/firmware/wiki/Mailboxes for</span>
<span class="cm">   information */</span>
<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
    <span class="n">MB0_POWER_MANAGEMENT</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">MB0_FRAMEBUFFER</span><span class="p">,</span>
    <span class="n">MB0_VIRTUAL_UART</span><span class="p">,</span>
    <span class="n">MB0_VCHIQ</span><span class="p">,</span>
    <span class="n">MB0_LEDS</span><span class="p">,</span>
    <span class="n">MB0_BUTTONS</span><span class="p">,</span>
    <span class="n">MB0_TOUCHSCREEN</span><span class="p">,</span>
    <span class="n">MB0_UNUSED</span><span class="p">,</span>
    <span class="n">MB0_TAGS_ARM_TO_VC</span><span class="p">,</span>
    <span class="n">MB0_TAGS_VC_TO_ARM</span><span class="p">,</span>
<span class="p">}</span> <span class="n">mailbox0_channel_t</span><span class="p">;</span>

<span class="cm">/* These defines come from the Broadcom Videocode driver source code, see:</span>
<span class="cm">   brcm_usrlib/dag/vmcsx/vcinclude/bcm2708_chip/arm_control.h */</span>
<span class="k">enum</span> <span class="n">mailbox_status_reg_bits</span> <span class="p">{</span>
    <span class="n">ARM_MS_FULL</span>  <span class="o">=</span> <span class="mh">0x80000000</span><span class="p">,</span>
    <span class="n">ARM_MS_EMPTY</span> <span class="o">=</span> <span class="mh">0x40000000</span><span class="p">,</span>
    <span class="n">ARM_MS_LEVEL</span> <span class="o">=</span> <span class="mh">0x400000FF</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Define a structure which defines the register access to a mailbox.</span>
<span class="cm">   Not all mailboxes support the full register set! */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">Read</span><span class="p">;</span>
    <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reserved1</span><span class="p">[((</span><span class="mh">0x90</span> <span class="o">-</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
    <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">Poll</span><span class="p">;</span>
    <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">Sender</span><span class="p">;</span>
    <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">Status</span><span class="p">;</span>
    <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">Configuration</span><span class="p">;</span>
    <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">Write</span><span class="p">;</span>
    <span class="p">}</span> <span class="n">mailbox_t</span><span class="p">;</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="nf">RPI_Mailbox0Write</span><span class="p">(</span> <span class="n">mailbox0_channel_t</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span> <span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="nf">RPI_Mailbox0Read</span><span class="p">(</span> <span class="n">mailbox0_channel_t</span> <span class="n">channel</span> <span class="p">);</span>

<span class="cp">#endif</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&quot;rpi-gpio.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;rpi-mailbox.h&quot;</span><span class="cp"></span>

<span class="cm">/* Mailbox 0 mapped to it&#39;s base address */</span>
<span class="k">static</span> <span class="n">mailbox_t</span><span class="o">*</span> <span class="n">rpiMailbox0</span> <span class="o">=</span> <span class="p">(</span><span class="n">mailbox_t</span><span class="o">*</span><span class="p">)</span><span class="n">RPI_MAILBOX0_BASE</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">RPI_Mailbox0Write</span><span class="p">(</span> <span class="n">mailbox0_channel_t</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* For information about accessing mailboxes, see:</span>
<span class="cm">       https://github.com/raspberrypi/firmware/wiki/Accessing-mailboxes */</span>

    <span class="cm">/* Add the channel number into the lower 4 bits */</span>
    <span class="n">value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xF</span><span class="p">);</span>
    <span class="n">value</span> <span class="o">|=</span> <span class="n">channel</span><span class="p">;</span>

    <span class="cm">/* Wait until the mailbox becomes available and then write to the mailbox</span>
<span class="cm">       channel */</span>
    <span class="k">while</span><span class="p">(</span> <span class="p">(</span> <span class="n">rpiMailbox0</span><span class="o">-&gt;</span><span class="n">Status</span> <span class="o">&amp;</span> <span class="n">ARM_MS_FULL</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

    <span class="cm">/* Write the modified value + channel number into the write register */</span>
    <span class="n">rpiMailbox0</span><span class="o">-&gt;</span><span class="n">Write</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">RPI_Mailbox0Read</span><span class="p">(</span> <span class="n">mailbox0_channel_t</span> <span class="n">channel</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* For information about accessing mailboxes, see:</span>
<span class="cm">       https://github.com/raspberrypi/firmware/wiki/Accessing-mailboxes */</span>
    <span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

    <span class="cm">/* Keep reading the register until the desired channel gives us a value */</span>
    <span class="k">while</span><span class="p">(</span> <span class="p">(</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xF</span> <span class="p">)</span> <span class="o">!=</span> <span class="n">channel</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="cm">/* Wait while the mailbox is empty because otherwise there&#39;s no value</span>
<span class="cm">           to read! */</span>
        <span class="k">while</span><span class="p">(</span> <span class="n">rpiMailbox0</span><span class="o">-&gt;</span><span class="n">Status</span> <span class="o">&amp;</span> <span class="n">ARM_MS_EMPTY</span> <span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

        <span class="cm">/* Extract the value from the Read register of the mailbox. The value</span>
<span class="cm">           is actually in the upper 28 bits */</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">rpiMailbox0</span><span class="o">-&gt;</span><span class="n">Read</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Return just the value (the upper 28-bits) */</span>
    <span class="k">return</span> <span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>There are two mailboxes, 0 and 1. We only need to use mailbox 0. Mailbox has a number of channels to communicate on which are defined in the <code>enum mailbox0_channel_t</code>.</p>
<p>The basics of the mailbox operation are pretty straight forward.</p>
<p>To <strong>write</strong> to a mailbox we first construct a composite value. We can write a 32-bit value to the GPU which is generally a memory address, but the mailbox also has to support multiple channels and there is no separate place to write the channel number. In order to achieve multiple channels on a single mailbox the lower nibble (4-bits) are reserved for the channel number and the upper 28-bits are the value we're sending to the GPU. This means that any address we send to the GPU is missing the lowest 4-bits and the GPU simply assumes those bits are all 0. We therefore need to align any address we send the GPU to a 16-byte boundary which will ensure the lower 4-bits will be 0.</p>
<p>The ARM waits for the mailbox to become empty by polling the status register and then it can write the composite value of the address and channel to the mailbox.</p>
<p>To <strong>read</strong> from a mailbox we wait until the mailbox is full and read the value. Only when the value contains the same channel as we are waiting to communicate with do we proceed and return.</p>
<p>The value is a 16-byte aligned memory address. It's important to know that we don't just send a value and get a value back. We send an address to a memory block that we have constructed specifically formatted messages in to communicate with the GPU. The messages that are passed to the GPU are channel dependant and so aren't defined in this code module. We will do a code module for each channel we use. Actually, we're only going to use one - <code>MB0_TAGS_ARM_TO_VC</code> which is used with the mailbox property interface.</p>
<blockquote>
<p><strong>NOTE:</strong> Although the Framebuffer channel looks like the place to begin, actually we'll ignore that mailbox channel because it's a deprecated channel. It came before the mailbox property interface channel had framebuffer properties added to it.</p>
</blockquote>
<h3 id="mailbox-property-interface">Mailbox Property Interface<a class="headerlink" href="#mailbox-property-interface" title="Permanent link">&para;</a></h3>
<p>The <a href="https://github.com/raspberrypi/firmware/wiki/Mailbox-property-interface">Mailbox Property Interface</a> specifies the messaging structure that needs to be present in the 16-byte aligned memory region I mentioned earlier. There are a lot of properties, and you need to read that page a couple of times to get a hold of how the data needs to be laid out.</p>
<p>Here's the code we're using to support the Mailbox Property Interface:</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&lt;stdarg.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&quot;rpi-mailbox.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;rpi-mailbox-interface.h&quot;</span><span class="cp"></span>

<span class="cm">/* Make sure the property tag buffer is aligned to a 16-byte boundary because</span>
<span class="cm">   we only have 28-bits available in the property interface protocol to pass</span>
<span class="cm">   the address of the buffer to the VC. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pt</span><span class="p">[</span><span class="mi">8192</span><span class="p">]</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="mi">16</span><span class="p">)));</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pt_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


<span class="kt">void</span> <span class="nf">RPI_PropertyInit</span><span class="p">(</span> <span class="kt">void</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* Fill in the size on-the-fly */</span>
    <span class="n">pt</span><span class="p">[</span><span class="n">PT_OSIZE</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>

    <span class="cm">/* Process request (All other values are reserved!) */</span>
    <span class="n">pt</span><span class="p">[</span><span class="n">PT_OREQUEST_OR_RESPONSE</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="cm">/* First available data slot */</span>
    <span class="n">pt_index</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

    <span class="cm">/* NULL tag to terminate tag list */</span>
    <span class="n">pt</span><span class="p">[</span><span class="n">pt_index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm">    @brief Add a property tag to the current tag list. Data can be included. All data is uint32_t</span>
<span class="cm">    @param tag</span>
<span class="cm">*/</span>
<span class="kt">void</span> <span class="nf">RPI_PropertyAddTag</span><span class="p">(</span> <span class="n">rpi_mailbox_tag_t</span> <span class="n">tag</span><span class="p">,</span> <span class="p">...</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="kt">va_list</span> <span class="n">vl</span><span class="p">;</span>
    <span class="n">va_start</span><span class="p">(</span> <span class="n">vl</span><span class="p">,</span> <span class="n">tag</span> <span class="p">);</span>

    <span class="n">pt</span><span class="p">[</span><span class="n">pt_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">tag</span><span class="p">;</span>

    <span class="k">switch</span><span class="p">(</span> <span class="n">tag</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="k">case</span> <span class="nl">TAG_GET_FIRMWARE_VERSION</span><span class="p">:</span>
        <span class="k">case</span> <span class="nl">TAG_GET_BOARD_MODEL</span><span class="p">:</span>
        <span class="k">case</span> <span class="nl">TAG_GET_BOARD_REVISION</span><span class="p">:</span>
        <span class="k">case</span> <span class="nl">TAG_GET_BOARD_MAC_ADDRESS</span><span class="p">:</span>
        <span class="k">case</span> <span class="nl">TAG_GET_BOARD_SERIAL</span><span class="p">:</span>
        <span class="k">case</span> <span class="nl">TAG_GET_ARM_MEMORY</span><span class="p">:</span>
        <span class="k">case</span> <span class="nl">TAG_GET_VC_MEMORY</span><span class="p">:</span>
        <span class="k">case</span> <span class="nl">TAG_GET_DMA_CHANNELS</span><span class="p">:</span>
            <span class="cm">/* Provide an 8-byte buffer for the response */</span>
            <span class="n">pt</span><span class="p">[</span><span class="n">pt_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
            <span class="n">pt</span><span class="p">[</span><span class="n">pt_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Request */</span>
            <span class="n">pt_index</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="nl">TAG_GET_CLOCKS</span><span class="p">:</span>
        <span class="k">case</span> <span class="nl">TAG_GET_COMMAND_LINE</span><span class="p">:</span>
            <span class="cm">/* Provide a 256-byte buffer */</span>
            <span class="n">pt</span><span class="p">[</span><span class="n">pt_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
            <span class="n">pt</span><span class="p">[</span><span class="n">pt_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Request */</span>
            <span class="n">pt_index</span> <span class="o">+=</span> <span class="mi">256</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="nl">TAG_ALLOCATE_BUFFER</span><span class="p">:</span>
            <span class="n">pt</span><span class="p">[</span><span class="n">pt_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
            <span class="n">pt</span><span class="p">[</span><span class="n">pt_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Request */</span>
            <span class="n">pt</span><span class="p">[</span><span class="n">pt_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span> <span class="n">vl</span><span class="p">,</span> <span class="kt">int</span> <span class="p">);</span>
            <span class="n">pt_index</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="nl">TAG_GET_PHYSICAL_SIZE</span><span class="p">:</span>
        <span class="k">case</span> <span class="nl">TAG_SET_PHYSICAL_SIZE</span><span class="p">:</span>
        <span class="k">case</span> <span class="nl">TAG_TEST_PHYSICAL_SIZE</span><span class="p">:</span>
        <span class="k">case</span> <span class="nl">TAG_GET_VIRTUAL_SIZE</span><span class="p">:</span>
        <span class="k">case</span> <span class="nl">TAG_SET_VIRTUAL_SIZE</span><span class="p">:</span>
        <span class="k">case</span> <span class="nl">TAG_TEST_VIRTUAL_SIZE</span><span class="p">:</span>
        <span class="k">case</span> <span class="nl">TAG_GET_VIRTUAL_OFFSET</span><span class="p">:</span>
        <span class="k">case</span> <span class="nl">TAG_SET_VIRTUAL_OFFSET</span><span class="p">:</span>
            <span class="n">pt</span><span class="p">[</span><span class="n">pt_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
            <span class="n">pt</span><span class="p">[</span><span class="n">pt_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Request */</span>

            <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">TAG_SET_PHYSICAL_SIZE</span> <span class="p">)</span> <span class="o">||</span>
                <span class="p">(</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">TAG_SET_VIRTUAL_SIZE</span> <span class="p">)</span> <span class="o">||</span>
                <span class="p">(</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">TAG_SET_VIRTUAL_OFFSET</span> <span class="p">)</span> <span class="o">||</span>
                <span class="p">(</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">TAG_TEST_PHYSICAL_SIZE</span> <span class="p">)</span> <span class="o">||</span>
                <span class="p">(</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">TAG_TEST_VIRTUAL_SIZE</span> <span class="p">)</span> <span class="p">)</span>
            <span class="p">{</span>
                <span class="n">pt</span><span class="p">[</span><span class="n">pt_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span> <span class="n">vl</span><span class="p">,</span> <span class="kt">int</span> <span class="p">);</span> <span class="cm">/* Width */</span>
                <span class="n">pt</span><span class="p">[</span><span class="n">pt_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span> <span class="n">vl</span><span class="p">,</span> <span class="kt">int</span> <span class="p">);</span> <span class="cm">/* Height */</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">pt_index</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>


        <span class="k">case</span> <span class="nl">TAG_GET_ALPHA_MODE</span><span class="p">:</span>
        <span class="k">case</span> <span class="nl">TAG_SET_ALPHA_MODE</span><span class="p">:</span>
        <span class="k">case</span> <span class="nl">TAG_GET_DEPTH</span><span class="p">:</span>
        <span class="k">case</span> <span class="nl">TAG_SET_DEPTH</span><span class="p">:</span>
        <span class="k">case</span> <span class="nl">TAG_GET_PIXEL_ORDER</span><span class="p">:</span>
        <span class="k">case</span> <span class="nl">TAG_SET_PIXEL_ORDER</span><span class="p">:</span>
        <span class="k">case</span> <span class="nl">TAG_GET_PITCH</span><span class="p">:</span>
            <span class="n">pt</span><span class="p">[</span><span class="n">pt_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
            <span class="n">pt</span><span class="p">[</span><span class="n">pt_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Request */</span>

            <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">TAG_SET_DEPTH</span> <span class="p">)</span> <span class="o">||</span>
                <span class="p">(</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">TAG_SET_PIXEL_ORDER</span> <span class="p">)</span> <span class="o">||</span>
                <span class="p">(</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">TAG_SET_ALPHA_MODE</span> <span class="p">)</span> <span class="p">)</span>
            <span class="p">{</span>
                <span class="cm">/* Colour Depth, bits-per-pixel \ Pixel Order State */</span>
                <span class="n">pt</span><span class="p">[</span><span class="n">pt_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span> <span class="n">vl</span><span class="p">,</span> <span class="kt">int</span> <span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">pt_index</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="nl">TAG_GET_OVERSCAN</span><span class="p">:</span>
        <span class="k">case</span> <span class="nl">TAG_SET_OVERSCAN</span><span class="p">:</span>
            <span class="n">pt</span><span class="p">[</span><span class="n">pt_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
            <span class="n">pt</span><span class="p">[</span><span class="n">pt_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Request */</span>

            <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">TAG_SET_OVERSCAN</span> <span class="p">)</span> <span class="p">)</span>
            <span class="p">{</span>
                <span class="n">pt</span><span class="p">[</span><span class="n">pt_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span> <span class="n">vl</span><span class="p">,</span> <span class="kt">int</span> <span class="p">);</span> <span class="cm">/* Top pixels */</span>
                <span class="n">pt</span><span class="p">[</span><span class="n">pt_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span> <span class="n">vl</span><span class="p">,</span> <span class="kt">int</span> <span class="p">);</span> <span class="cm">/* Bottom pixels */</span>
                <span class="n">pt</span><span class="p">[</span><span class="n">pt_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span> <span class="n">vl</span><span class="p">,</span> <span class="kt">int</span> <span class="p">);</span> <span class="cm">/* Left pixels */</span>
                <span class="n">pt</span><span class="p">[</span><span class="n">pt_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span> <span class="n">vl</span><span class="p">,</span> <span class="kt">int</span> <span class="p">);</span> <span class="cm">/* Right pixels */</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">pt_index</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">default</span><span class="o">:</span>
            <span class="cm">/* Unsupported tags, just remove the tag from the list */</span>
            <span class="n">pt_index</span><span class="o">--</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Make sure the tags are 0 terminated to end the list and update the buffer size */</span>
    <span class="n">pt</span><span class="p">[</span><span class="n">pt_index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">va_end</span><span class="p">(</span> <span class="n">vl</span> <span class="p">);</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">RPI_PropertyProcess</span><span class="p">(</span> <span class="kt">void</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

<span class="cp">#if( PRINT_PROP_DEBUG == 1 )</span>
    <span class="n">printf</span><span class="p">(</span> <span class="s">&quot;%s Length: %d</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">pt</span><span class="p">[</span><span class="n">PT_OSIZE</span><span class="p">]</span> <span class="p">);</span>
<span class="cp">#endif</span>
    <span class="cm">/* Fill in the size of the buffer */</span>
    <span class="n">pt</span><span class="p">[</span><span class="n">PT_OSIZE</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span> <span class="n">pt_index</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">pt</span><span class="p">[</span><span class="n">PT_OREQUEST_OR_RESPONSE</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#if( PRINT_PROP_DEBUG == 1 )</span>
    <span class="k">for</span><span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="n">PT_OSIZE</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
        <span class="n">printf</span><span class="p">(</span> <span class="s">&quot;Request: %3d %8.8X</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">pt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">);</span>
<span class="cp">#endif</span>
    <span class="n">RPI_Mailbox0Write</span><span class="p">(</span> <span class="n">MB0_TAGS_ARM_TO_VC</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">pt</span> <span class="p">);</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">RPI_Mailbox0Read</span><span class="p">(</span> <span class="n">MB0_TAGS_ARM_TO_VC</span> <span class="p">);</span>

<span class="cp">#if( PRINT_PROP_DEBUG == 1 )</span>
    <span class="k">for</span><span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="n">PT_OSIZE</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
        <span class="n">printf</span><span class="p">(</span> <span class="s">&quot;Response: %3d %8.8X</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">pt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">);</span>
<span class="cp">#endif</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">rpi_mailbox_property_t</span><span class="o">*</span> <span class="nf">RPI_PropertyGet</span><span class="p">(</span> <span class="n">rpi_mailbox_tag_t</span> <span class="n">tag</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="n">rpi_mailbox_property_t</span> <span class="n">property</span><span class="p">;</span>
    <span class="kt">int</span><span class="o">*</span> <span class="n">tag_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">property</span><span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span><span class="p">;</span>

    <span class="cm">/* Get the tag from the buffer. Start at the first tag position  */</span>
    <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

    <span class="k">while</span><span class="p">(</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="p">(</span> <span class="n">pt</span><span class="p">[</span><span class="n">PT_OSIZE</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="cm">/* printf( &quot;Test Tag: [%d] %8.8X\r\n&quot;, index, pt[index] ); */</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">pt</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="n">tag</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="n">tag_buffer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pt</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/* Progress to the next tag if we haven&#39;t yet discovered the tag */</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="p">(</span> <span class="n">pt</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span> <span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Return NULL of the property tag cannot be found in the buffer */</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">tag_buffer</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">)</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="cm">/* Return the required data */</span>
    <span class="n">property</span><span class="p">.</span><span class="n">byte_length</span> <span class="o">=</span> <span class="n">tag_buffer</span><span class="p">[</span><span class="n">T_ORESPONSE</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span> <span class="n">property</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">buffer_8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag_buffer</span><span class="p">[</span><span class="n">T_OVALUE</span><span class="p">],</span> <span class="n">property</span><span class="p">.</span><span class="n">byte_length</span> <span class="p">);</span>

    <span class="k">return</span> <span class="o">&amp;</span><span class="n">property</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="cp">#ifndef RPI_MAILBOX_INTERFACE_H</span>
<span class="cp">#define RPI_MAILBOX_INTERFACE_H</span>

<span class="cm">/**</span>
<span class="cm">    @brief An enum of the RPI-&gt;Videocore firmware mailbox property interface</span>
<span class="cm">    properties. Further details are available from</span>
<span class="cm">    https://github.com/raspberrypi/firmware/wiki/Mailbox-property-interface</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
    <span class="cm">/* Videocore */</span>
    <span class="n">TAG_GET_FIRMWARE_VERSION</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span>

    <span class="cm">/* Hardware */</span>
    <span class="n">TAG_GET_BOARD_MODEL</span> <span class="o">=</span> <span class="mh">0x10001</span><span class="p">,</span>
    <span class="n">TAG_GET_BOARD_REVISION</span><span class="p">,</span>
    <span class="n">TAG_GET_BOARD_MAC_ADDRESS</span><span class="p">,</span>
    <span class="n">TAG_GET_BOARD_SERIAL</span><span class="p">,</span>
    <span class="n">TAG_GET_ARM_MEMORY</span><span class="p">,</span>
    <span class="n">TAG_GET_VC_MEMORY</span><span class="p">,</span>
    <span class="n">TAG_GET_CLOCKS</span><span class="p">,</span>

    <span class="cm">/* Config */</span>
    <span class="n">TAG_GET_COMMAND_LINE</span> <span class="o">=</span> <span class="mh">0x50001</span><span class="p">,</span>

    <span class="cm">/* Shared resource management */</span>
    <span class="n">TAG_GET_DMA_CHANNELS</span> <span class="o">=</span> <span class="mh">0x60001</span><span class="p">,</span>

    <span class="cm">/* Power */</span>
    <span class="n">TAG_GET_POWER_STATE</span> <span class="o">=</span> <span class="mh">0x20001</span><span class="p">,</span>
    <span class="n">TAG_GET_TIMING</span><span class="p">,</span>
    <span class="n">TAG_SET_POWER_STATE</span> <span class="o">=</span> <span class="mh">0x28001</span><span class="p">,</span>

    <span class="cm">/* Clocks */</span>
    <span class="n">TAG_GET_CLOCK_STATE</span> <span class="o">=</span> <span class="mh">0x30001</span><span class="p">,</span>
    <span class="n">TAG_SET_CLOCK_STATE</span> <span class="o">=</span> <span class="mh">0x38001</span><span class="p">,</span>
    <span class="n">TAG_GET_CLOCK_RATE</span> <span class="o">=</span> <span class="mh">0x30002</span><span class="p">,</span>
    <span class="n">TAG_SET_CLOCK_RATE</span> <span class="o">=</span> <span class="mh">0x38002</span><span class="p">,</span>
    <span class="n">TAG_GET_MAX_CLOCK_RATE</span> <span class="o">=</span> <span class="mh">0x30004</span><span class="p">,</span>
    <span class="n">TAG_GET_MIN_CLOCK_RATE</span> <span class="o">=</span> <span class="mh">0x30007</span><span class="p">,</span>
    <span class="n">TAG_GET_TURBO</span> <span class="o">=</span> <span class="mh">0x30009</span><span class="p">,</span>
    <span class="n">TAG_SET_TURBO</span> <span class="o">=</span> <span class="mh">0x38009</span><span class="p">,</span>

    <span class="cm">/* Voltage */</span>
    <span class="n">TAG_GET_VOLTAGE</span> <span class="o">=</span> <span class="mh">0x30003</span><span class="p">,</span>
    <span class="n">TAG_SET_VOLTAGE</span> <span class="o">=</span> <span class="mh">0x38003</span><span class="p">,</span>
    <span class="n">TAG_GET_MAX_VOLTAGE</span> <span class="o">=</span> <span class="mh">0x30005</span><span class="p">,</span>
    <span class="n">TAG_GET_MIN_VOLTAGE</span> <span class="o">=</span> <span class="mh">0x30008</span><span class="p">,</span>
    <span class="n">TAG_GET_TEMPERATURE</span> <span class="o">=</span> <span class="mh">0x30006</span><span class="p">,</span>
    <span class="n">TAG_GET_MAX_TEMPERATURE</span> <span class="o">=</span> <span class="mh">0x3000A</span><span class="p">,</span>
    <span class="n">TAG_ALLOCATE_MEMORY</span> <span class="o">=</span> <span class="mh">0x3000C</span><span class="p">,</span>
    <span class="n">TAG_LOCK_MEMORY</span> <span class="o">=</span> <span class="mh">0x3000D</span><span class="p">,</span>
    <span class="n">TAG_UNLOCK_MEMORY</span> <span class="o">=</span> <span class="mh">0x3000E</span><span class="p">,</span>
    <span class="n">TAG_RELEASE_MEMORY</span> <span class="o">=</span> <span class="mh">0x3000F</span><span class="p">,</span>
    <span class="n">TAG_EXECUTE_CODE</span> <span class="o">=</span> <span class="mh">0x30010</span><span class="p">,</span>
    <span class="n">TAG_GET_DISPMANX_MEM_HANDLE</span> <span class="o">=</span> <span class="mh">0x30014</span><span class="p">,</span>
    <span class="n">TAG_GET_EDID_BLOCK</span> <span class="o">=</span> <span class="mh">0x30020</span><span class="p">,</span>

    <span class="cm">/* Framebuffer */</span>
    <span class="n">TAG_ALLOCATE_BUFFER</span> <span class="o">=</span> <span class="mh">0x40001</span><span class="p">,</span>
    <span class="n">TAG_RELEASE_BUFFER</span> <span class="o">=</span> <span class="mh">0x48001</span><span class="p">,</span>
    <span class="n">TAG_BLANK_SCREEN</span> <span class="o">=</span> <span class="mh">0x40002</span><span class="p">,</span>
    <span class="n">TAG_GET_PHYSICAL_SIZE</span> <span class="o">=</span> <span class="mh">0x40003</span><span class="p">,</span>
    <span class="n">TAG_TEST_PHYSICAL_SIZE</span> <span class="o">=</span> <span class="mh">0x44003</span><span class="p">,</span>
    <span class="n">TAG_SET_PHYSICAL_SIZE</span> <span class="o">=</span> <span class="mh">0x48003</span><span class="p">,</span>
    <span class="n">TAG_GET_VIRTUAL_SIZE</span> <span class="o">=</span> <span class="mh">0x40004</span><span class="p">,</span>
    <span class="n">TAG_TEST_VIRTUAL_SIZE</span> <span class="o">=</span> <span class="mh">0x44004</span><span class="p">,</span>
    <span class="n">TAG_SET_VIRTUAL_SIZE</span> <span class="o">=</span> <span class="mh">0x48004</span><span class="p">,</span>
    <span class="n">TAG_GET_DEPTH</span> <span class="o">=</span> <span class="mh">0x40005</span><span class="p">,</span>
    <span class="n">TAG_TEST_DEPTH</span> <span class="o">=</span> <span class="mh">0x44005</span><span class="p">,</span>
    <span class="n">TAG_SET_DEPTH</span> <span class="o">=</span> <span class="mh">0x48005</span><span class="p">,</span>
    <span class="n">TAG_GET_PIXEL_ORDER</span> <span class="o">=</span> <span class="mh">0x40006</span><span class="p">,</span>
    <span class="n">TAG_TEST_PIXEL_ORDER</span> <span class="o">=</span> <span class="mh">0x44006</span><span class="p">,</span>
    <span class="n">TAG_SET_PIXEL_ORDER</span> <span class="o">=</span> <span class="mh">0x48006</span><span class="p">,</span>
    <span class="n">TAG_GET_ALPHA_MODE</span> <span class="o">=</span> <span class="mh">0x40007</span><span class="p">,</span>
    <span class="n">TAG_TEST_ALPHA_MODE</span> <span class="o">=</span> <span class="mh">0x44007</span><span class="p">,</span>
    <span class="n">TAG_SET_ALPHA_MODE</span> <span class="o">=</span> <span class="mh">0x48007</span><span class="p">,</span>
    <span class="n">TAG_GET_PITCH</span> <span class="o">=</span> <span class="mh">0x40008</span><span class="p">,</span>
    <span class="n">TAG_GET_VIRTUAL_OFFSET</span> <span class="o">=</span> <span class="mh">0x40009</span><span class="p">,</span>
    <span class="n">TAG_TEST_VIRTUAL_OFFSET</span> <span class="o">=</span> <span class="mh">0x44009</span><span class="p">,</span>
    <span class="n">TAG_SET_VIRTUAL_OFFSET</span> <span class="o">=</span> <span class="mh">0x48009</span><span class="p">,</span>
    <span class="n">TAG_GET_OVERSCAN</span> <span class="o">=</span> <span class="mh">0x4000A</span><span class="p">,</span>
    <span class="n">TAG_TEST_OVERSCAN</span> <span class="o">=</span> <span class="mh">0x4400A</span><span class="p">,</span>
    <span class="n">TAG_SET_OVERSCAN</span> <span class="o">=</span> <span class="mh">0x4800A</span><span class="p">,</span>
    <span class="n">TAG_GET_PALETTE</span> <span class="o">=</span> <span class="mh">0x4000B</span><span class="p">,</span>
    <span class="n">TAG_TEST_PALETTE</span> <span class="o">=</span> <span class="mh">0x4400B</span><span class="p">,</span>
    <span class="n">TAG_SET_PALETTE</span> <span class="o">=</span> <span class="mh">0x4800B</span><span class="p">,</span>
    <span class="n">TAG_SET_CURSOR_INFO</span> <span class="o">=</span> <span class="mh">0x8011</span><span class="p">,</span>
    <span class="n">TAG_SET_CURSOR_STATE</span> <span class="o">=</span> <span class="mh">0x8010</span>

    <span class="p">}</span> <span class="n">rpi_mailbox_tag_t</span><span class="p">;</span>


<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
    <span class="n">TAG_STATE_REQUEST</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">TAG_STATE_RESPONSE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">}</span> <span class="n">rpi_tag_state_t</span><span class="p">;</span>


<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
    <span class="n">PT_OSIZE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">PT_OREQUEST_OR_RESPONSE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">}</span> <span class="n">rpi_tag_buffer_offset_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
    <span class="n">T_OIDENT</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">T_OVALUE_SIZE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">T_ORESPONSE</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">T_OVALUE</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="p">}</span> <span class="n">rpi_tag_offset_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">tag</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">byte_length</span><span class="p">;</span>
    <span class="k">union</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">value_32</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buffer_8</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
        <span class="kt">int</span> <span class="n">buffer_32</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
    <span class="p">}</span> <span class="n">data</span><span class="p">;</span>
    <span class="p">}</span> <span class="n">rpi_mailbox_property_t</span><span class="p">;</span>


<span class="k">extern</span> <span class="kt">void</span> <span class="nf">RPI_PropertyInit</span><span class="p">(</span> <span class="kt">void</span> <span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="nf">RPI_PropertyAddTag</span><span class="p">(</span> <span class="n">rpi_mailbox_tag_t</span> <span class="n">tag</span><span class="p">,</span> <span class="p">...</span> <span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="nf">RPI_PropertyProcess</span><span class="p">(</span> <span class="kt">void</span> <span class="p">);</span>
<span class="k">extern</span> <span class="n">rpi_mailbox_property_t</span><span class="o">*</span> <span class="nf">RPI_PropertyGet</span><span class="p">(</span> <span class="n">rpi_mailbox_tag_t</span> <span class="n">tag</span> <span class="p">);</span>

<span class="cp">#endif</span>
</code></pre></div>

<blockquote>
<p><strong>NOTE:</strong> As you can see, I've left some debugging <code>printf()</code> calls in so you can alter <code>PRINT_PROP_DEBUG</code> to print them out - this means it'll print out the buffer you message the GPU with and see the resulting buffer when the GPU has finished it's response</p>
</blockquote>
<p>We start off with a memory buffer which is large enough to hold a concatenated list of property tags and data for the property tags we want to use. We use a gcc extension to align it to a 16-byte boundary:</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span> <span class="kt">int</span> <span class="n">pt</span><span class="p">[</span><span class="mi">8192</span><span class="p">]</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="mi">16</span><span class="p">)));</span>
</code></pre></div>

<p>The rest of the functions form a C API to the Mailbox Property Interface. There are various APIs people come up with to generate the memory structure.</p>
<p>The messages are constructed such that the data length is large enough for whichever is larger, the message request data size or the response data size. It's also good to note that so long as the data size is large enough the GPU will be happy. i.e. you can use a larger data size for the tag and the GPU won't complain. As you can see from the <code>void RPI_PropertyAddTag( rpi_mailbox_tag_t tag, ... )</code> switch <code>tag</code> statement there are only a few types of tag layout anyway.</p>
<p>The GPU acts upon tag values which have the request/response code set to process request settings (always 0). When the GPU has parsed a value and filled the tag's value buffer with the value required it sets the request/response indicator to 1 to show that the data in the value buffer is the GPU's response. All of this modifies the data in-place.</p>
<p>The API I wrote for this tutorial allows us to have a simple paradime for using the property interface.</p>
<div class="codehilite"><pre><span></span><code>    <span class="cm">/* Initialise, Add and Process tags */</span>
    <span class="n">RPI_PropertyInit</span><span class="p">();</span>
    <span class="n">RPI_PropertyAddTag</span><span class="p">(</span> <span class="n">TAG_</span><span class="o">*</span><span class="p">,</span> <span class="p">...</span> <span class="p">);</span>
    <span class="n">RPI_PropertyAddTag</span><span class="p">(</span> <span class="n">TAG_</span><span class="o">*</span><span class="p">,</span> <span class="p">...</span> <span class="p">);</span>
    <span class="n">RPI_PropertyAddTag</span><span class="p">(</span> <span class="n">TAG_</span><span class="o">*</span><span class="p">,</span> <span class="p">...</span> <span class="p">);</span>
    <span class="n">RPI_PropertyProcess</span><span class="p">();</span>

    <span class="cm">/* Get the value for each tag */</span>
    <span class="n">property_value_buffer</span> <span class="o">=</span> <span class="n">RPI_PropertyGet</span><span class="p">(</span> <span class="n">TAG_</span><span class="o">*</span> <span class="p">);</span>
</code></pre></div>

<h2 id="the-framebuffer-properties">The Framebuffer Properties<a class="headerlink" href="#the-framebuffer-properties" title="Permanent link">&para;</a></h2>
<p>If you don't yet know, a framebuffer is a block of memory who's data is written to a display. The data organisation depends on the display's attributes such as width, height, colour depth, etc. There is not usually a conversion between one type of data and the framebuffer. The GPU simply clocks the data in the framebuffer to the display.</p>
<p>If a monitor is plugged in to the Raspberry-Pi the GPU detects it and displays a colour gradiant square on the screen. This shows that the RPI is up and running and has detected the screen.</p>
<p>Through the mailbox property interface we can negotiate with the GPU so that it creates a framebuffer in memory that is of the correct size to represent the screen attached (or the size of the virtual screen we've requested). It will return a pointer to that memory so that the ARM has memory it can write to that will be directly written to the screen by the GPU. It's the most basic and simplest form of graphics. Each pixel's colour can be controlled by writing data into the buffer.</p>
<p>Let's look at how we use the property interface to negotiate a 32-bit framebuffer at 1280x1024:</p>
<div class="codehilite"><pre><span></span><code>    <span class="cm">/* Initialise a framebuffer... */</span>
    <span class="n">RPI_PropertyInit</span><span class="p">();</span>
    <span class="n">RPI_PropertyAddTag</span><span class="p">(</span> <span class="n">TAG_ALLOCATE_BUFFER</span> <span class="p">);</span>
    <span class="n">RPI_PropertyAddTag</span><span class="p">(</span> <span class="n">TAG_SET_PHYSICAL_SIZE</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">1024</span> <span class="p">);</span>
    <span class="n">RPI_PropertyAddTag</span><span class="p">(</span> <span class="n">TAG_SET_VIRTUAL_SIZE</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">2048</span> <span class="p">);</span>
    <span class="n">RPI_PropertyAddTag</span><span class="p">(</span> <span class="n">TAG_SET_DEPTH</span><span class="p">,</span> <span class="mi">32</span> <span class="p">);</span>
    <span class="n">RPI_PropertyAddTag</span><span class="p">(</span> <span class="n">TAG_GET_PITCH</span> <span class="p">);</span>
    <span class="n">RPI_PropertyAddTag</span><span class="p">(</span> <span class="n">TAG_GET_PHYSICAL_SIZE</span> <span class="p">);</span>
    <span class="n">RPI_PropertyAddTag</span><span class="p">(</span> <span class="n">TAG_GET_DEPTH</span> <span class="p">);</span>
    <span class="n">RPI_PropertyProcess</span><span class="p">();</span>
</code></pre></div>

<p>As you can see, we set up a load of tags for the GPU to process. We ask it to allocate a framebuffer, so set the physical and virtual size of the screen, and the colour depth. We then also ask it to return us some information, the current pitch, the physical size and the colour depth.</p>
<p>The mailbox interface guarantees that the SET_* tags will be completed before the GET_* tags are processed so we can do a single process with all of the tags in place. Some of the SET_* tags may not be able to achieve what we ask for and so we must use the GET_* tags to know what the framebuffer settings actually are.</p>
<p>The reason there is a physical and virtual size (and why they are set differently!) is because the virtual size can be larger than the physical size where the physical is "mapped" to a part of the framebuffer. The framebuffer is made to hold the largest of the two (which is invariably the virtual size).</p>
<p>In the code I've made the virtual size twice the height of the physical size. There are other mailbox properties that allow us to set an offset where the physical screen will begin in the framebuffer. You can think of the virtual as being the framebuffer and the physical as the screen. We can draw to a larger framebuffer in a region that's off the physical screen and then offset the physical screen to the area of the framebuffer we've drawn to and the update to the screen is instant rather than updating as we draw which usually shows artifacts.</p>
<p>For now, we just initialise the framebuffer (using the code above) and then write to the framebuffer space within the limits of the physical size. We draw a colour gradient box like the GPU does on power-on, but we "animate" it by continuously altering the colour vectors and re-drawing the screen. We use 100% of the CPU processing time to draw and you'll see just how slow this is!</p>
<p>Go ahead and run the example. You can spend some time changing the colour depth setting and screen size to see the performance of the framebuffer fill. You'll notice it's a lot slower than you'd realise to refresh the screen when every pixel is written to.</p>
<p>This is the code that does the actual draw to the framebuffer:</p>
<div class="codehilite"><pre><span></span><code>    <span class="n">pixel_offset</span> <span class="o">=</span> <span class="p">(</span> <span class="n">x</span> <span class="o">*</span> <span class="p">(</span> <span class="n">bpp</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span> <span class="p">)</span> <span class="p">)</span> <span class="o">+</span> <span class="p">(</span> <span class="n">y</span> <span class="o">*</span> <span class="n">pitch</span> <span class="p">);</span>

    <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span> <span class="n">current_colour</span><span class="p">.</span><span class="n">r</span> <span class="o">*</span> <span class="mh">0xFF</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
    <span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span> <span class="n">current_colour</span><span class="p">.</span><span class="n">g</span> <span class="o">*</span> <span class="mh">0xFF</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span> <span class="n">current_colour</span><span class="p">.</span><span class="n">b</span> <span class="o">*</span> <span class="mh">0xFF</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span> <span class="n">current_colour</span><span class="p">.</span><span class="n">b</span> <span class="o">*</span> <span class="mh">0xFF</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">bpp</span> <span class="o">==</span> <span class="mi">32</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="cm">/* Four bytes to write */</span>
        <span class="n">fb</span><span class="p">[</span> <span class="n">pixel_offset</span><span class="o">++</span> <span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
        <span class="n">fb</span><span class="p">[</span> <span class="n">pixel_offset</span><span class="o">++</span> <span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
        <span class="n">fb</span><span class="p">[</span> <span class="n">pixel_offset</span><span class="o">++</span> <span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
        <span class="n">fb</span><span class="p">[</span> <span class="n">pixel_offset</span><span class="o">++</span> <span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">bpp</span> <span class="o">==</span> <span class="mi">24</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="cm">/* Three bytes to write */</span>
        <span class="n">fb</span><span class="p">[</span> <span class="n">pixel_offset</span><span class="o">++</span> <span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
        <span class="n">fb</span><span class="p">[</span> <span class="n">pixel_offset</span><span class="o">++</span> <span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
        <span class="n">fb</span><span class="p">[</span> <span class="n">pixel_offset</span><span class="o">++</span> <span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">bpp</span> <span class="o">==</span> <span class="mi">16</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="cm">/* Two bytes to write */</span>
        <span class="cm">/* Bit pack RGB565 into the 16-bit pixel offset */</span>
        <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">fb</span><span class="p">[</span><span class="n">pixel_offset</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span> <span class="p">)</span> <span class="o">|</span> <span class="p">(</span> <span class="p">(</span> <span class="n">g</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span> <span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span> <span class="p">)</span> <span class="o">|</span> <span class="p">(</span> <span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span> <span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="cm">/* Palette mode. TODO: Work out a colour scheme for</span>
<span class="cm">        packing rgb into an 8-bit palette! */</span>
    <span class="p">}</span>
</code></pre></div>

<p>As you can see, for each colour depth there is a different drawing algorithm. The RPI also supports an 8-bit palette mode which is not supported here.</p>
<p>The pixel offset calculation can be done based on the bpp (bits-per-pixel) or colour depth setting. Notice that normally we'd use the screen width in this calculation, but instead we're using <code>pitch</code>. This is because the GPU can optimse the number of bytes per pixel line so that it can do faster maths, so this is one of the values we request back from the GPU when we initialise the framebuffer.</p>
<p>The framebuffer memory is organised with the top left pixel being at offset 0, in screen coordinates this is 0,0.</p>
<blockquote>
<p><strong>NOTE:</strong> To notice any animation of the colour with this example, you may have to run the sample code for a little while.</p>
</blockquote>
<h3 id="armc-014">armc-014<a class="headerlink" href="#armc-014" title="Permanent link">&para;</a></h3>
<p>This example expands on the previous pt4 interrupts code and introduces the mailbox API to negotiate a framebuffer with the GPU. It then draws an ever-changing colour square on the screen which changes colour to animate the display. The Frames Per Second (FPS) is also calculated and sent to the mini UART so if you're monitoring the UART with a terminal such as PuTTY you'll be able to see the FPS calculated live on your Pi.</p>
<p>While we acheive that, this does demonstrate how slow software rendering is. The framebuffer is set to 640x480 so that the demo will work on every HDMI panel that's plugged in. 640x480 is not exactly a big screen and yet below are the Frames Per Second (FPS) we managed to achieve on the RPI1 and RPI2.</p>
<table>
<thead>
<tr>
<th>RPI1</th>
<th>RPI2</th>
</tr>
</thead>
<tbody>
<tr>
<td>3.67</td>
<td>0.68</td>
</tr>
</tbody>
</table>
<p>Those results are the right way round, I promise! It's time for us to do some thinking and optimising...</p>
<h3 id="armc-015">armc-015<a class="headerlink" href="#armc-015" title="Permanent link">&para;</a></h3>
<p>In the RPI processor (both RPI1 and RPI2) there is a cache system which is disabled by default and is designed to speed the processor up by enabling code to be (hopefully) run from the cache. In this example we add enabling the cache to the <code>armc-start.S</code> startup file:</p>
<h4 id="enabling-cache">Enabling Cache<a class="headerlink" href="#enabling-cache" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code>    .equ    SCTLR_ENABLE_DATA_CACHE         0x4
    .equ    SCTLR_ENABLE_BRANCH_PREDICTION  0x800
    .equ    SCTLR_ENABLE_INSTRUCTION_CACHE  0x1000

    // Enable L1 Cache -------------------------------------------------------

    // R0 = System Control Register
    mrc p15,0,r0,c1,c0,0

    // Enable caches and branch prediction
    orr r0,#SCTLR_ENABLE_BRANCH_PREDICTION
    orr r0,#SCTLR_ENABLE_DATA_CACHE
    orr r0,#SCTLR_ENABLE_INSTRUCTION_CACHE

    // System Control Register = R0
    mcr p15,0,r0,c1,c0,0
</code></pre></div>

<p>Look to the <a href="https://silver.arm.com/download/ARM_and_AMBA_Architecture/AR570-DA-70000-r0p0-00rel2/DDI0406C_C_arm_architecture_reference_manual.pdf">ARMv7-a architecture manual</a> for information on enabling L1 Cache. L1 cache is closest to the processor and so is what we're interesting in enabling first off.</p>
<p>Let's go through the code we've added so we know <strong>why</strong> we've added it and also why it works.</p>
<p><strong>Section B6.1.86</strong> SCTLR, System Control Register, PMSA describes the system control register</p>
<p>This register has some bits defined which are useful for us, namely:</p>
<div class="codehilite"><pre><span></span><code>    I, bit[12] Instruction cache enable bit.

        This is a global enable bit for instruction caches. The possible values
        of this bit are:

        0 Instruction caches disabled.
        1 Instruction caches enabled.

        If the system does not implement any instruction caches that can be
        accessed by the processor, at any level of the memory hierarchy, this
        bit is RAZ/WI.

        If the system implements any instruction caches that can be accessed
        by the processor then it must be possible to disable them by setting
        this bit to 0.

        Cache enabling and disabling on page B2-1270 describes the effect of
        enabling the caches.

    Z, bit[11] Branch prediction enable bit.

        The possible values of this bit are:

        0 Program flow prediction disabled.
        1 Program flow prediction enabled.

        Setting this bit to 1 enables branch prediction, also called program
        flow prediction.

        If program flow prediction cannot be disabled, this bit is RAO/WI.
        If the implementation does not support program flow prediction then
        this bit is RAZ/WI.

    C, bit[2] Cache enable bit.

        This is a global enable bit for data and unified caches. The possible
        values of this bit are:

        0 Data and unified caches disabled.
        1 Data and unified caches enabled.

        If the system does not implement any data or unified caches that can
        be accessed by the processor, at any level of the memory hierarchy,
        this bit is RAZ/WI.

        If the system implements any data or unified caches that can be
        accessed by the processor then it must be possible to disable them by
        setting this bit to 0.

    For more information about the effect of this bit see Cache enabling and
    disabling on page B2-1270.
</code></pre></div>

<p>In the <a href="https://silver.arm.com/download/ARM_Architecture/AR550-DA-70002-r0p0-00rel0/DDI%2001001.pdf">ARMv6 Architecture Manual</a> for the Pi1 we see:</p>
<p><strong>Section B3.4</strong> Register 1:Control registers which also descibes the system control register</p>
<p>This control register implements bits in the register we're interested in for enabling L1 cache:</p>
<div class="codehilite"><pre><span></span><code>    I (bit[12])

        If separate L1 caches are used, this is the enable/disable bit for the L1
        instruction cache:

        0 = L1 instruction cache disabled
        1 = L1 instruction cache enabled.

        If an L1 unified cache is used or the L1 instruction cache is not
        implemented, this bit read as 0 and ignores writes. If the L1 instruction
        cache cannot be disabled, this bit reads as 1 and ignores writes.

        The state of this bit does not affect further levels of cache in the
        system.


    Z (bit[11])

        On ARM processors which support branch prediction, this is the
        enable/disable bit for branch prediction:

        0 = Program flow prediction disabled
        1 = Program flow prediction enabled.

        If program flow prediction cannot be disabled, this bit reads as 1 and
        ignores writes.

        Program flow prediction includes all possible forms of speculative change
        of instruction stream prediction. Examples include static prediction,
        dynamic prediction, and return stacks.

        On ARM processors that do not support branch prediction, this bit reads as
        0 and ignores writes.


    C (bit[2])

        If a L1 unified cache is used, this is the enable/disable bit for the
        unified cache. If separate L1 caches are used, this is the enable/disable
        bit for the data cache. In either case:

        0 = L1 unified/data cache disabled
        1 = L1 unified/data cache enabled.

        If the L1 cache is not implemented, this bit reads as 0 and ignores
        writes. If the L1 cache cannot be disabled, this bit reads as 1 and
        ignores writes.

        The state of this bit does not affect other levels of cache in the system.
</code></pre></div>

<p>As can be seen, although the cache system has changed slightly - it is essentially the same for us to use across both RPi1 and RPi2:</p>
<p>Get the value of the System Control Register in R0</p>
<div class="codehilite"><pre><span></span><code>    // Enable L1 Cache -------------------------------------------------------

    // R0 = System Control Register
    mrc p15,0,r0,c1,c0,0
</code></pre></div>

<p>Enable the three cache bits we just identified in the architecture manuals above:</p>
<div class="codehilite"><pre><span></span><code>    // Enable caches and branch prediction
    orr r0,#SCTLR_ENABLE_BRANCH_PREDICTION
    orr r0,#SCTLR_ENABLE_DATA_CACHE
    orr r0,#SCTLR_ENABLE_INSTRUCTION_CACHE
</code></pre></div>

<p>Write the modified value back to the System Control Register:</p>
<div class="codehilite"><pre><span></span><code>    // System Control Register = R0
    mcr p15,0,r0,c1,c0,0
</code></pre></div>

<h4 id="maxmising-the-clock-speed-rpi2">Maxmising the Clock Speed (RPI2)<a class="headerlink" href="#maxmising-the-clock-speed-rpi2" title="Permanent link">&para;</a></h4>
<p>I also added in some more mailbox properties to make the RPI2 run faster. When the RPI2 starts executing code from the ARM the ARM is running at 600MHz which is a way below its 900MHz maximum. Using the mailbox properties interface we can both ask the GPU for the ARMs maximum frequency and then set the ARM frequency to the maximum returned by the GPU:</p>
<div class="codehilite"><pre><span></span><code>    <span class="n">mp</span> <span class="o">=</span> <span class="n">RPI_PropertyGet</span><span class="p">(</span> <span class="n">TAG_GET_MAX_CLOCK_RATE</span> <span class="p">);</span>

    <span class="n">RPI_PropertyInit</span><span class="p">();</span>
    <span class="n">RPI_PropertyAddTag</span><span class="p">(</span> <span class="n">TAG_SET_CLOCK_RATE</span><span class="p">,</span> <span class="n">TAG_CLOCK_ARM</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">buffer_32</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">);</span>
    <span class="n">RPI_PropertyProcess</span><span class="p">();</span>
</code></pre></div>

<p>Both the above are fairly easy pickings for making sure we're getting the best speed available out of the processors, yet it was still a bit of work to get the gains!</p>
<p>Run <strong>armc-015</strong> and see the gains! Here's the FPS results:</p>
<table>
<thead>
<tr>
<th>RPI1</th>
<th>RPI2</th>
</tr>
</thead>
<tbody>
<tr>
<td>9.8</td>
<td>2.9</td>
</tr>
</tbody>
</table>
<p>Wow! A reasonable gain, but still not exactly fast enough to start writing demos or games (Other than text-based games!)</p>
<h4 id="rpi2-performance">RPI2 performance<a class="headerlink" href="#rpi2-performance" title="Permanent link">&para;</a></h4>
<p>At this point the question of why the RPI2 is so much slower than the RPI1 should come to mind! I don't have the answer (Send them on a postcard please!)</p>
<p>The only thing going for the RPI1 is a much simpler memory system. Since the RPI2 introduces a quad-core architecture, things got a whole bunch more complicated on the memory bus.</p>
<p>Anyway, let's see what else we can do.</p>
<h3 id="making-the-compiler-work-for-us">Making the Compiler work for us<a class="headerlink" href="#making-the-compiler-work-for-us" title="Permanent link">&para;</a></h3>
<p>Up until now we've been working with optimisation levels <code>-O0</code>(pre-interrupts) and <code>-01</code>(post-interrupts). The reason for the move to <code>-01</code> was to get rid of the caveat that these tutorials required an earlier version of gcc than the latest that gcc-arm-emedded offered. The issue was down to <a href="https://gcc.gnu.org/bugzilla/show_bug.cgi?id=59602">this gcc bug</a> and as that bug has sat there for at least one minor version, it was time to fix the issue in the code as opposed to waiting for gcc and gcc-arm-embedded to catch up!</p>
<h3 id="armc-016">armc-016<a class="headerlink" href="#armc-016" title="Permanent link">&para;</a></h3>
<p>One simple change to this code to see what gains can be had by the compiler. If we're using a C compiler, we really should take advantage of the fact that a massive part of it's job is to optimise the code it generates to run as fast as possible.</p>
<p>We'll change the optimisation level, from <code>-O1</code> to <code>-O4</code>. Nothing else, let's see what happens to the FPS:</p>
<table>
<thead>
<tr>
<th>RPI1</th>
<th>RPI2</th>
</tr>
</thead>
<tbody>
<tr>
<td>11.2</td>
<td>62</td>
</tr>
</tbody>
</table>
<p>That is 62, not 6.2 in the RPI2. Clearly the compiler has done something essential for the RPI2, and about what I'd expect for the RPI1 target.</p>
<p>What's it done? I don't know, that's for the compiler to know and for me to find out if I can be bothered. Right now I need get on with writing code.</p>
<p>If you're interested in finding out, you can disassemble the code and see if you can see the major difference between an <code>-O1</code> binary and an <code>-O4</code> binary!</p>
<p>I've run out of time, so we'll leave graphics here for now and come back to it in a few tutorials time to do some more advanced stuff. We'll look at using hardware accelerated graphics next time.</p>
<p>For now, I think we need to look at JTAG next - I for one am wearing out the SD Card slots on my RPIs testing and re-testing these tutorials!!</p>
                
                  
                
                

              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../step04-bare-metal-programming-in-cpt4/" title="Part 4 - Interrupts" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Part 4 - Interrupts
              </span>
            </div>
          </a>
        
        
          <a href="../../saltstack/building-a-centos8-salt-master/" title="Building a CentOS8 Salt Master" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Building a CentOS8 Salt Master
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2002-2020 Brian Sidebotham
          </div>
        
        powered by
        <a href="https://www.mkdocs.org" target="_blank" rel="noopener">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application.c33a9706.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../../.."}})</script>
      
        <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
      
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
      
        <script src="../../../valvers-assets/extra.js"></script>
      
    
  </body>
</html>