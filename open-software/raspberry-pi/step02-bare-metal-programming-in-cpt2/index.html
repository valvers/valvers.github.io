



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="https://www.valvers.com/open-software/raspberry-pi/step02-bare-metal-programming-in-cpt2/">
      
      
        <meta name="author" content="Brian Sidebotham">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../img/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.6.3">
      <meta name="google-site-verification" content="gdf4XzjnbaArINbai3d8P0x_W3ugnDeIUyhMuq-wHPs" />
    
    
      
        <title>Part 2 - The C Runtime - valvers.com</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application.adb8469c.css">
      
        <link rel="stylesheet" href="../../../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#546e7a">
      
    
    
      <script src="../../../assets/javascripts/modernizr.86422ebf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    
      <link rel="stylesheet" href="../../../valvers-assets/extra.css">
    
    
      
        
<script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-57476377-1", "valvers.com")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="blue-grey" data-md-color-accent="deep-orange">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#part-2-the-c-runtime" tabindex="0" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://www.valvers.com" title="valvers.com" aria-label="valvers.com" class="md-header-nav__button md-logo">
          
            <img alt="logo" src="https://avatars3.githubusercontent.com/u/5575236?v=4?size=32" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              valvers.com
            </span>
            <span class="md-header-nav__topic">
              
                Part 2 - The C Runtime
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/valvers/valvers.website.src/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="../../.." class="md-tabs__link">
        Home
      </a>
    
  </li>

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../denford-orac/" class="md-tabs__link">
          Denford orac
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../engineering/" class="md-tabs__link">
          Engineering
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../" class="md-tabs__link md-tabs__link--active">
          Open software
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../v6manta/" class="md-tabs__link">
          V6manta
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://www.valvers.com" title="valvers.com" class="md-nav__button md-logo">
      
        <img alt="logo" src="https://avatars3.githubusercontent.com/u/5575236?v=4?size=32" width="48" height="48">
      
    </a>
    valvers.com
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/valvers/valvers.website.src/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Denford orac
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Denford orac
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2009-04-06-my-denford-orac/" title="2009 04 06 my denford orac" class="md-nav__link">
      2009 04 06 my denford orac
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2012-02-17-uprated-spindle-motor/" title="2012 02 17 uprated spindle motor" class="md-nav__link">
      2012 02 17 uprated spindle motor
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2012-03-22-gathering-some-information/" title="2012 03 22 gathering some information" class="md-nav__link">
      2012 03 22 gathering some information
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2012-09-27-750w-motor-sourced/" title="2012 09 27 750w motor sourced" class="md-nav__link">
      2012 09 27 750w motor sourced
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2012-10-01-motor-doesnt-fit/" title="2012 10 01 motor doesnt fit" class="md-nav__link">
      2012 10 01 motor doesnt fit
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2012-10-10-drill-head-disassembly/" title="2012 10 10 drill head disassembly" class="md-nav__link">
      2012 10 10 drill head disassembly
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2012-10-13-more-quill-dismantling/" title="2012 10 13 more quill dismantling" class="md-nav__link">
      2012 10 13 more quill dismantling
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2012-10-17-drill-spindle-is-apart/" title="2012 10 17 drill spindle is apart" class="md-nav__link">
      2012 10 17 drill spindle is apart
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2012-10-29-removing-electrical-cabinet/" title="2012 10 29 removing electrical cabinet" class="md-nav__link">
      2012 10 29 removing electrical cabinet
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2012-10-31-tested-the-drill-head-above-the-lathe/" title="2012 10 31 tested the drill head above the lathe" class="md-nav__link">
      2012 10 31 tested the drill head above the lathe
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2012-11-02-rebuild-of-an-orac/" title="2012 11 02 rebuild of an orac" class="md-nav__link">
      2012 11 02 rebuild of an orac
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2013-03-13-new-motor-fitted/" title="2013 03 13 new motor fitted" class="md-nav__link">
      2013 03 13 new motor fitted
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Engineering
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Engineering
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../engineering/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../engineering/an-and-jic-fittings/" title="AN and JIC Fittings" class="md-nav__link">
      AN and JIC Fittings
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../engineering/bolt-dimensions/" title="Bolt Dimensions" class="md-nav__link">
      Bolt Dimensions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../engineering/linux-cnc-on-beaglebone-black/" title="Linux CNC on Beaglebone Black" class="md-nav__link">
      Linux CNC on Beaglebone Black
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../engineering/making-a-cyr-wheel/" title="Making a Cyr Wheel" class="md-nav__link">
      Making a Cyr Wheel
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      Open software
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Open software
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../" title="Open-Software" class="md-nav__link">
      Open-Software
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../android-car-dash/" title="Android car dash" class="md-nav__link">
      Android car dash
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../logging-with-gcc/" title="Logging with gcc" class="md-nav__link">
      Logging with gcc
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../posix-shell-scripting/" title="Posix Shell Scripting" class="md-nav__link">
      Posix Shell Scripting
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../working-with-the-screen-command/" title="Working with the Screen Command" class="md-nav__link">
      Working with the Screen Command
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-6" type="checkbox" id="nav-4-6">
    
    <label class="md-nav__link" for="nav-4-6">
      Gcc
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-6">
        Gcc
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../gcc/weak-function-attributes/" title="Weak Function Attributes" class="md-nav__link">
      Weak Function Attributes
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-7" type="checkbox" id="nav-4-7">
    
    <label class="md-nav__link" for="nav-4-7">
      Python
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-7">
        Python
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../python/pylab/" title="Pylab" class="md-nav__link">
      Pylab
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-8" type="checkbox" id="nav-4-8" checked>
    
    <label class="md-nav__link" for="nav-4-8">
      Raspberry pi
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-8">
        Raspberry pi
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../" title="Open Software - Raspberry Pi" class="md-nav__link">
      Open Software - Raspberry Pi
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../step01-bare-metal-programming-in-cpt1/" title="Part 1 - Getting Started" class="md-nav__link">
      Part 1 - Getting Started
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Part 2 - The C Runtime
      </label>
    
    <a href="./" title="Part 2 - The C Runtime" class="md-nav__link md-nav__link--active">
      Part 2 - The C Runtime
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#understanding-the-c-runtime-startup" class="md-nav__link">
    Understanding the C-Runtime Startup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#part-2armc05c" class="md-nav__link">
    part-2/armc05.c
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#part-2armc-06c" class="md-nav__link">
    part-2/armc-06.c
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#part-2armc-07" class="md-nav__link">
    part-2/armc-07
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sections-and-c-startup" class="md-nav__link">
    Sections and C Startup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#armc-08-starts" class="md-nav__link">
    armc-08-start.S
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#armc-08-cstartupc" class="md-nav__link">
    armc-08-cstartup.c
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#armc-08c" class="md-nav__link">
    armc-08.c
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-c-library-stubs" class="md-nav__link">
    The C-Library stubs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#armc-09-cstubsc" class="md-nav__link">
    armc-09-cstubs.c
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#armc-09-starts" class="md-nav__link">
    armc-09-start.S
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#armc-09-cstartupc" class="md-nav__link">
    armc-09-cstartup.c
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#part-2armc-09c" class="md-nav__link">
    part-2/armc-09.c
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#part-3" class="md-nav__link">
    Part 3
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../step03-bare-metal-programming-in-cpt3/" title="Introducing CMake" class="md-nav__link">
      Introducing CMake
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../step04-bare-metal-programming-in-cpt4/" title="Part 4 - Interrupts" class="md-nav__link">
      Part 4 - Interrupts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../step05-bare-metal-programming-in-cpt5/" title="Part 5 - Graphics (Basic)" class="md-nav__link">
      Part 5 - Graphics (Basic)
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-9" type="checkbox" id="nav-4-9">
    
    <label class="md-nav__link" for="nav-4-9">
      Saltstack
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-9">
        Saltstack
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../saltstack/building-a-centos8-salt-master/" title="Building a CentOS8 Salt Master" class="md-nav__link">
      Building a CentOS8 Salt Master
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-10" type="checkbox" id="nav-4-10">
    
    <label class="md-nav__link" for="nav-4-10">
      Webstacks
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-10">
        Webstacks
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../webstacks/using-reactjs-and-bulma/" title="Using ReactJS and Bulma" class="md-nav__link">
      Using ReactJS and Bulma
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      V6manta
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        V6manta
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-2" type="checkbox" id="nav-5-2">
    
    <label class="md-nav__link" for="nav-5-2">
      2003
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-2">
        2003
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-07-28-/" title="2003 07 28" class="md-nav__link">
      2003 07 28 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-07-28-brought-a-1.8s-berlinetta/" title="2003 07 28 brought a 1.8s berlinetta" class="md-nav__link">
      2003 07 28 brought a 1.8s berlinetta
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-07-28-stage-rally-opel-manta/" title="2003 07 28 stage rally opel manta" class="md-nav__link">
      2003 07 28 stage rally opel manta
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-08-12-/" title="2003 08 12" class="md-nav__link">
      2003 08 12 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-08-13-/" title="2003 08 13" class="md-nav__link">
      2003 08 13 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-08-23-/" title="2003 08 23" class="md-nav__link">
      2003 08 23 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-09-11-/" title="2003 09 11" class="md-nav__link">
      2003 09 11 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-09-28-/" title="2003 09 28" class="md-nav__link">
      2003 09 28 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-10-07-/" title="2003 10 07" class="md-nav__link">
      2003 10 07 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-10-09-/" title="2003 10 09" class="md-nav__link">
      2003 10 09 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-11-04-/" title="2003 11 04" class="md-nav__link">
      2003 11 04 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-12-16-/" title="2003 12 16" class="md-nav__link">
      2003 12 16 
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-3" type="checkbox" id="nav-5-3">
    
    <label class="md-nav__link" for="nav-5-3">
      2004
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-3">
        2004
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-01-06-/" title="2004 01 06" class="md-nav__link">
      2004 01 06 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-01-07-/" title="2004 01 07" class="md-nav__link">
      2004 01 07 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-01-26-/" title="2004 01 26" class="md-nav__link">
      2004 01 26 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-01-29-/" title="2004 01 29" class="md-nav__link">
      2004 01 29 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-02-09-/" title="2004 02 09" class="md-nav__link">
      2004 02 09 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-02-13-/" title="2004 02 13" class="md-nav__link">
      2004 02 13 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-02-19-/" title="2004 02 19" class="md-nav__link">
      2004 02 19 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-04-20-finally-got-around-to-the-manta/" title="2004 04 20 finally got around to the manta" class="md-nav__link">
      2004 04 20 finally got around to the manta
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-06-17-/" title="2004 06 17" class="md-nav__link">
      2004 06 17 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-06-18-/" title="2004 06 18" class="md-nav__link">
      2004 06 18 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-06-21-/" title="2004 06 21" class="md-nav__link">
      2004 06 21 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-07-26-/" title="2004 07 26" class="md-nav__link">
      2004 07 26 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-08-09-/" title="2004 08 09" class="md-nav__link">
      2004 08 09 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-08-10-/" title="2004 08 10" class="md-nav__link">
      2004 08 10 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-09-03-/" title="2004 09 03" class="md-nav__link">
      2004 09 03 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-09-27-/" title="2004 09 27" class="md-nav__link">
      2004 09 27 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-10-07-/" title="2004 10 07" class="md-nav__link">
      2004 10 07 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-10-08-/" title="2004 10 08" class="md-nav__link">
      2004 10 08 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-10-11-/" title="2004 10 11" class="md-nav__link">
      2004 10 11 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-10-13-/" title="2004 10 13" class="md-nav__link">
      2004 10 13 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-10-15-/" title="2004 10 15" class="md-nav__link">
      2004 10 15 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-10-18-/" title="2004 10 18" class="md-nav__link">
      2004 10 18 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-10-21-/" title="2004 10 21" class="md-nav__link">
      2004 10 21 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-10-22-/" title="2004 10 22" class="md-nav__link">
      2004 10 22 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-10-29-/" title="2004 10 29" class="md-nav__link">
      2004 10 29 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-11-01-/" title="2004 11 01" class="md-nav__link">
      2004 11 01 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-12-10-were-back/" title="2004 12 10 were back" class="md-nav__link">
      2004 12 10 were back
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-4" type="checkbox" id="nav-5-4">
    
    <label class="md-nav__link" for="nav-5-4">
      2005
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-4">
        2005
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-05-16-/" title="2005 05 16" class="md-nav__link">
      2005 05 16 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-08-04-done-something/" title="2005 08 04 done something" class="md-nav__link">
      2005 08 04 done something
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-08-08-/" title="2005 08 08" class="md-nav__link">
      2005 08 08 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-08-10-/" title="2005 08 10" class="md-nav__link">
      2005 08 10 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-08-25-/" title="2005 08 25" class="md-nav__link">
      2005 08 25 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-08-31-/" title="2005 08 31" class="md-nav__link">
      2005 08 31 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-09-05-/" title="2005 09 05" class="md-nav__link">
      2005 09 05 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-09-19-/" title="2005 09 19" class="md-nav__link">
      2005 09 19 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-09-22-/" title="2005 09 22" class="md-nav__link">
      2005 09 22 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-09-23-/" title="2005 09 23" class="md-nav__link">
      2005 09 23 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-11-01-/" title="2005 11 01" class="md-nav__link">
      2005 11 01 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-11-03-/" title="2005 11 03" class="md-nav__link">
      2005 11 03 
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-5" type="checkbox" id="nav-5-5">
    
    <label class="md-nav__link" for="nav-5-5">
      2007
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-5">
        2007
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2007/2007-10-20-/" title="2007 10 20" class="md-nav__link">
      2007 10 20 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2007/2007-10-20-perspex-windows/" title="2007 10 20 perspex windows" class="md-nav__link">
      2007 10 20 perspex windows
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2007/2007-11-13-getting-it-ready-to-paint.../" title="2007 11 13 getting it ready to paint..." class="md-nav__link">
      2007 11 13 getting it ready to paint...
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2007/2007-11-21-almost-started-painting/" title="2007 11 21 almost started painting" class="md-nav__link">
      2007 11 21 almost started painting
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2007/2007-11-28-underneath-is-complete/" title="2007 11 28 underneath is complete" class="md-nav__link">
      2007 11 28 underneath is complete
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2007/2007-12-04-painting-the-inside-and-engine-bay/" title="2007 12 04 painting the inside and engine bay" class="md-nav__link">
      2007 12 04 painting the inside and engine bay
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-6" type="checkbox" id="nav-5-6">
    
    <label class="md-nav__link" for="nav-5-6">
      2008
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-6">
        2008
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-01-14-painting-the-shell-orange/" title="2008 01 14 painting the shell orange" class="md-nav__link">
      2008 01 14 painting the shell orange
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-01-16-out-of-the-booth/" title="2008 01 16 out of the booth" class="md-nav__link">
      2008 01 16 out of the booth
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-01-23-rear-axle-trial-fitting/" title="2008 01 23 rear axle trial fitting" class="md-nav__link">
      2008 01 23 rear axle trial fitting
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-02-24-painted-the-nextel-and-checked-for-wheel-clearance/" title="2008 02 24 painted the nextel and checked for wheel clearance" class="md-nav__link">
      2008 02 24 painted the nextel and checked for wheel clearance
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-03-15-front-suspension-build/" title="2008 03 15 front suspension build" class="md-nav__link">
      2008 03 15 front suspension build
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-03-19-suspension-bushes-are-always-wrong/" title="2008 03 19 suspension bushes are always wrong" class="md-nav__link">
      2008 03 19 suspension bushes are always wrong
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-03-22-diff-bearings-need-replacing/" title="2008 03 22 diff bearings need replacing" class="md-nav__link">
      2008 03 22 diff bearings need replacing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-04-08-fitted-the-rear-windows-and-steering-column/" title="2008 04 08 fitted the rear windows and steering column" class="md-nav__link">
      2008 04 08 fitted the rear windows and steering column
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-04-12-shimmed-up-the-diff,-and-fitted-the-clocks/" title="2008 04 12 shimmed up the diff, and fitted the clocks" class="md-nav__link">
      2008 04 12 shimmed up the diff, and fitted the clocks
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-04-16-rebuilt-the-gearbox-so-i-get-gear-selection/" title="2008 04 16 rebuilt the gearbox so i get gear selection" class="md-nav__link">
      2008 04 16 rebuilt the gearbox so i get gear selection
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-07-08-its-on-its-wheels-at-last/" title="2008 07 08 its on its wheels at last" class="md-nav__link">
      2008 07 08 its on its wheels at last
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-09-02-rebuilt-oil-pump--started-headwork/" title="2008 09 02 rebuilt oil pump started headwork" class="md-nav__link">
      2008 09 02 rebuilt oil pump  started headwork
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-09-04-some-more-headwork/" title="2008 09 04 some more headwork" class="md-nav__link">
      2008 09 04 some more headwork
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-09-25-even-more-headwork/" title="2008 09 25 even more headwork" class="md-nav__link">
      2008 09 25 even more headwork
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-11-09-engine--transmission-fitted/" title="2008 11 09 engine transmission fitted" class="md-nav__link">
      2008 11 09 engine  transmission fitted
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-11-16-engine--gearbox-mounted--steering-column-fitted/" title="2008 11 16 engine gearbox mounted steering column fitted" class="md-nav__link">
      2008 11 16 engine  gearbox mounted  steering column fitted
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-12-14-stripping-the-x25xe-v6-bottom-end/" title="2008 12 14 stripping the x25xe v6 bottom end" class="md-nav__link">
      2008 12 14 stripping the x25xe v6 bottom end
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-7" type="checkbox" id="nav-5-7">
    
    <label class="md-nav__link" for="nav-5-7">
      2009
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-7">
        2009
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2009/2009-06-24-making-the-dry-sump-pan/" title="2009 06 24 making the dry sump pan" class="md-nav__link">
      2009 06 24 making the dry sump pan
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2009/2009-10-05-trialling-the-throttle-bodies--a-few-more-bits-painted/" title="2009 10 05 trialling the throttle bodies a few more bits painted" class="md-nav__link">
      2009 10 05 trialling the throttle bodies  a few more bits painted
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2009/2009-12-18-flywheel-and-clutch/" title="2009 12 18 flywheel and clutch" class="md-nav__link">
      2009 12 18 flywheel and clutch
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-8" type="checkbox" id="nav-5-8">
    
    <label class="md-nav__link" for="nav-5-8">
      2010
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-8">
        2010
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-01-23-done-the-handbrake--sliders/" title="2010 01 23 done the handbrake sliders" class="md-nav__link">
      2010 01 23 done the handbrake  sliders
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-01-27-started-building-the-v6-heads-up/" title="2010 01 27 started building the v6 heads up" class="md-nav__link">
      2010 01 27 started building the v6 heads up
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-01-30-picked-up-another-v6/" title="2010 01 30 picked up another v6" class="md-nav__link">
      2010 01 30 picked up another v6
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-02-01-exhaust-manifolds/" title="2010 02 01 exhaust manifolds" class="md-nav__link">
      2010 02 01 exhaust manifolds
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-02-02-starting-the-v6-build/" title="2010 02 02 starting the v6 build" class="md-nav__link">
      2010 02 02 starting the v6 build
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-02-03-cylinder-head-bolts-torque/" title="2010 02 03 cylinder head bolts torque" class="md-nav__link">
      2010 02 03 cylinder head bolts torque
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-02-03-ordered-the-exhaust-manifold-flanges/" title="2010 02 03 ordered the exhaust manifold flanges" class="md-nav__link">
      2010 02 03 ordered the exhaust manifold flanges
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-02-06-building-the-v6/" title="2010 02 06 building the v6" class="md-nav__link">
      2010 02 06 building the v6
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-02-07-building-the-v6/" title="2010 02 07 building the v6" class="md-nav__link">
      2010 02 07 building the v6
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-02-14-building-the-v6/" title="2010 02 14 building the v6" class="md-nav__link">
      2010 02 14 building the v6
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-03-22-gearbox-sealed-and-release-bearing-fitted/" title="2010 03 22 gearbox sealed and release bearing fitted" class="md-nav__link">
      2010 03 22 gearbox sealed and release bearing fitted
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-04-03-started-on-the-manifolds/" title="2010 04 03 started on the manifolds" class="md-nav__link">
      2010 04 03 started on the manifolds
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-04-05-finished-a-manifold/" title="2010 04 05 finished a manifold" class="md-nav__link">
      2010 04 05 finished a manifold
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-04-07-started-the-second-manifold/" title="2010 04 07 started the second manifold" class="md-nav__link">
      2010 04 07 started the second manifold
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-04-11-need-a-todo-list/" title="2010 04 11 need a todo list" class="md-nav__link">
      2010 04 11 need a todo list
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-04-21-ticking-off-the-boxes/" title="2010 04 21 ticking off the boxes" class="md-nav__link">
      2010 04 21 ticking off the boxes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-04-26-nearly-finished-the-second-manifold/" title="2010 04 26 nearly finished the second manifold" class="md-nav__link">
      2010 04 26 nearly finished the second manifold
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-05-09-got-the-car-rolling/" title="2010 05 09 got the car rolling" class="md-nav__link">
      2010 05 09 got the car rolling
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-05-11-rolling-road-day/" title="2010 05 11 rolling road day" class="md-nav__link">
      2010 05 11 rolling road day
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-05-31-back-from-germany/" title="2010 05 31 back from germany" class="md-nav__link">
      2010 05 31 back from germany
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-06-01-sumps-off/" title="2010 06 01 sumps off" class="md-nav__link">
      2010 06 01 sumps off
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-06-06-done-most-of-the-bits-on-the-v6/" title="2010 06 06 done most of the bits on the v6" class="md-nav__link">
      2010 06 06 done most of the bits on the v6
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-06-12-getting-ready-to-bolt-it-back-in/" title="2010 06 12 getting ready to bolt it back in" class="md-nav__link">
      2010 06 12 getting ready to bolt it back in
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-06-19-almost-ready-to-go-back-in/" title="2010 06 19 almost ready to go back in" class="md-nav__link">
      2010 06 19 almost ready to go back in
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-09-22-lack-of-updates/" title="2010 09 22 lack of updates" class="md-nav__link">
      2010 09 22 lack of updates
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-09-26-few-little-bits/" title="2010 09 26 few little bits" class="md-nav__link">
      2010 09 26 few little bits
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-10-09-v6-oil-problems..../" title="2010 10 09 v6 oil problems...." class="md-nav__link">
      2010 10 09 v6 oil problems....
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-10-12-starting-putting-the-engine-back-together/" title="2010 10 12 starting putting the engine back together" class="md-nav__link">
      2010 10 12 starting putting the engine back together
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-10-23-v6-is-broke/" title="2010 10 23 v6 is broke" class="md-nav__link">
      2010 10 23 v6 is broke
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-10-24-stripping-the-v6/" title="2010 10 24 stripping the v6" class="md-nav__link">
      2010 10 24 stripping the v6
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-10-25-v6-problem/" title="2010 10 25 v6 problem" class="md-nav__link">
      2010 10 25 v6 problem
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-11-03-picked-up-a-replacement-v6/" title="2010 11 03 picked up a replacement v6" class="md-nav__link">
      2010 11 03 picked up a replacement v6
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-12-12-been-busy-building/" title="2010 12 12 been busy building" class="md-nav__link">
      2010 12 12 been busy building
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-9" type="checkbox" id="nav-5-9">
    
    <label class="md-nav__link" for="nav-5-9">
      2011
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-9">
        2011
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-01-01-finally-driven-the-manta-again-today/" title="2011 01 01 finally driven the manta again today" class="md-nav__link">
      2011 01 01 finally driven the manta again today
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-03-13-fitting-some-new-seats/" title="2011 03 13 fitting some new seats" class="md-nav__link">
      2011 03 13 fitting some new seats
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-03-13-the-manta-got-mapped/" title="2011 03 13 the manta got mapped" class="md-nav__link">
      2011 03 13 the manta got mapped
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-03-25-went-to-brands-hatch/" title="2011 03 25 went to brands hatch" class="md-nav__link">
      2011 03 25 went to brands hatch
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-09-04-started-work-on-the-2011-rebuild/" title="2011 09 04 started work on the 2011 rebuild" class="md-nav__link">
      2011 09 04 started work on the 2011 rebuild
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-09-10-built-some-more-of-the-frame/" title="2011 09 10 built some more of the frame" class="md-nav__link">
      2011 09 10 built some more of the frame
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-09-14-started-work-on-the-new-sump-pan/" title="2011 09 14 started work on the new sump pan" class="md-nav__link">
      2011 09 14 started work on the new sump pan
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-09-15-more-subframe-work/" title="2011 09 15 more subframe work" class="md-nav__link">
      2011 09 15 more subframe work
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-09-17-gearbox-back-together/" title="2011 09 17 gearbox back together" class="md-nav__link">
      2011 09 17 gearbox back together
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-09-25-getting-ready-to-spray-the-engine-bay-again.../" title="2011 09 25 getting ready to spray the engine bay again..." class="md-nav__link">
      2011 09 25 getting ready to spray the engine bay again...
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-10-16-moving-along-with-the-rebuild/" title="2011 10 16 moving along with the rebuild" class="md-nav__link">
      2011 10 16 moving along with the rebuild
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-10-18-painted-the-engine-bay/" title="2011 10 18 painted the engine bay" class="md-nav__link">
      2011 10 18 painted the engine bay
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-11-15-dry-sump-work.../" title="2011 11 15 dry sump work..." class="md-nav__link">
      2011 11 15 dry sump work...
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-10" type="checkbox" id="nav-5-10">
    
    <label class="md-nav__link" for="nav-5-10">
      2012
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-10">
        2012
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-01-09-dry-sump-pan-is-welded/" title="2012 01 09 dry sump pan is welded" class="md-nav__link">
      2012 01 09 dry sump pan is welded
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-01-27-more-dry-sump-work/" title="2012 01 27 more dry sump work" class="md-nav__link">
      2012 01 27 more dry sump work
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-02-21-engine-is-back-in.../" title="2012 02 21 engine is back in..." class="md-nav__link">
      2012 02 21 engine is back in...
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-02-24-took-the-engine-back-out-again/" title="2012 02 24 took the engine back out again" class="md-nav__link">
      2012 02 24 took the engine back out again
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-02-27-engine-back-in-again/" title="2012 02 27 engine back in again" class="md-nav__link">
      2012 02 27 engine back in again
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-03-14-mostly-plumbed-back-in/" title="2012 03 14 mostly plumbed back in" class="md-nav__link">
      2012 03 14 mostly plumbed back in
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-04-04-started-her-up-again/" title="2012 04 04 started her up again" class="md-nav__link">
      2012 04 04 started her up again
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-04-16-ready-for-a-test-drive/" title="2012 04 16 ready for a test drive" class="md-nav__link">
      2012 04 16 ready for a test drive
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-05-09-clutch-release-bearing-failure/" title="2012 05 09 clutch release bearing failure" class="md-nav__link">
      2012 05 09 clutch release bearing failure
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-05-17-stripping-the-t5-gearbox/" title="2012 05 17 stripping the t5 gearbox" class="md-nav__link">
      2012 05 17 stripping the t5 gearbox
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-10-13-rebuilt-the-gearbox/" title="2012 10 13 rebuilt the gearbox" class="md-nav__link">
      2012 10 13 rebuilt the gearbox
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-11-11-finally-the-engines-back-in/" title="2012 11 11 finally the engines back in" class="md-nav__link">
      2012 11 11 finally the engines back in
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-11-14-nearly-back-together/" title="2012 11 14 nearly back together" class="md-nav__link">
      2012 11 14 nearly back together
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-11-25-the-finishing-touches/" title="2012 11 25 the finishing touches" class="md-nav__link">
      2012 11 25 the finishing touches
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-11-28-finally-the-v6-manta-up-a-running-again/" title="2012 11 28 finally the v6 manta up a running again" class="md-nav__link">
      2012 11 28 finally the v6 manta up a running again
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-12-30-virtually-back-on-the-road/" title="2012 12 30 virtually back on the road" class="md-nav__link">
      2012 12 30 virtually back on the road
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-11" type="checkbox" id="nav-5-11">
    
    <label class="md-nav__link" for="nav-5-11">
      2013
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-11">
        2013
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2013/2013-01-10-driven-the-manta-again/" title="2013 01 10 driven the manta again" class="md-nav__link">
      2013 01 10 driven the manta again
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2013/2013-01-15-had-a-great-blast-in-the-manta/" title="2013 01 15 had a great blast in the manta" class="md-nav__link">
      2013 01 15 had a great blast in the manta
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#understanding-the-c-runtime-startup" class="md-nav__link">
    Understanding the C-Runtime Startup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#part-2armc05c" class="md-nav__link">
    part-2/armc05.c
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#part-2armc-06c" class="md-nav__link">
    part-2/armc-06.c
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#part-2armc-07" class="md-nav__link">
    part-2/armc-07
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sections-and-c-startup" class="md-nav__link">
    Sections and C Startup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#armc-08-starts" class="md-nav__link">
    armc-08-start.S
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#armc-08-cstartupc" class="md-nav__link">
    armc-08-cstartup.c
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#armc-08c" class="md-nav__link">
    armc-08.c
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-c-library-stubs" class="md-nav__link">
    The C-Library stubs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#armc-09-cstubsc" class="md-nav__link">
    armc-09-cstubs.c
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#armc-09-starts" class="md-nav__link">
    armc-09-start.S
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#armc-09-cstartupc" class="md-nav__link">
    armc-09-cstartup.c
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#part-2armc-09c" class="md-nav__link">
    part-2/armc-09.c
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#part-3" class="md-nav__link">
    Part 3
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset" id="content">
              
                
                  <a href="https://github.com/valvers/valvers.website.src/edit/master/docs/open-software/raspberry-pi/step02-bare-metal-programming-in-cpt2.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <ul class="metadata page-metadata" data-bi-name="page info" lang="en-us" dir="ltr">
                  <li class="last-updated-holder displayDate loading">
                    <span class="last-updated-text">Last updated:</span>
                    <time role="presentation" datetime="2018-10-25T00:00:00.000Z" data-article-date-source="ms.date">2020-02-18</time>
                  </li>
                <!--
                  <li class="readingTime">
                    2 minutes to read
                  </li>
                -->
                  <li class="contributors-holder">
                    <span class="contributors-text">Contributors</span>
                    <ul class="contributors" data-bi-name="contributors"><li><a href="https://github.com/BrianSidebotham" title="Brian Sidebotham" data-bi-name="contributorprofile"><img src="../img/contributor.svg" data-src="https://avatars3.githubusercontent.com/u/5575236?v=4?size=32" alt="Brian Sidebotham"></a></li></ul>
                  </li>
                </ul>
                <h1 id="part-2-the-c-runtime">Part 2 - The C Runtime<a class="headerlink" href="#part-2-the-c-runtime" title="Permanent link">&para;</a></h1>
<p>In this part of the tutorial we'll look deeper into the linker and the C-Library so that we end
up with a working C-Library link. Exciting stuff, huh?! Let's look further into what the compiler
and linker are doing in order to create our bare-metal executable.</p>
<p>The C-Runtime (different to the C-Library!) is currently missing from our code. In a lot of
embedded systems the C-Runtime is essential, or else things break instantly. The most notable
thing that's instantly visible in most embedded systems is that static variables are not
initialised.</p>
<p>This is why in our previous example, we were working without pre-initialised variables. Instead,
we initialise the variable in the code at the start of main from a pre-processor define.</p>
<blockquote>
<p><strong>Github</strong> The code for the tutorials is now on <a href="https://github.com/BrianSidebotham/arm-tutorial-rpi">Github</a>.
You can either browse the code, checkout the code, fork, branch, or download
<a href="https://github.com/BrianSidebotham/arm-tutorial-rpi/archive/master.zip">as a zip</a> from GibHub.</p>
</blockquote>
<h2 id="understanding-the-c-runtime-startup">Understanding the C-Runtime Startup<a class="headerlink" href="#understanding-the-c-runtime-startup" title="Permanent link">&para;</a></h2>
<p>Let's modify and use a pre-initialised variable instead:</p>
<p>part-2/armc-04:</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&quot;rpi-gpio.h&quot;</span><span class="cp"></span>

<span class="cm">/** GPIO Register set */</span>
<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span> <span class="n">gpio</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">GPIO_BASE</span><span class="p">;</span>

<span class="cm">/** Simple loop variable */</span>
<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tim</span><span class="p">;</span>

<span class="cm">/** Main function - we&#39;ll never return from here */</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* Write 1 to the GPIO16 init nibble in the Function Select 1 GPIO</span>
<span class="cm">       peripheral register to enable GPIO16 as an output */</span>
    <span class="n">gpio</span><span class="p">[</span><span class="n">LED_GPFSEL</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">LED_GPFBIT</span><span class="p">);</span>

    <span class="cm">/* Never exit as there is no OS to exit to! */</span>
    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span><span class="n">tim</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tim</span> <span class="o">&lt;</span> <span class="mi">500000</span><span class="p">;</span> <span class="n">tim</span><span class="o">++</span><span class="p">)</span>
            <span class="p">;</span>

        <span class="cm">/* Set the LED GPIO pin low ( Turn OK LED on for original Pi, and off</span>
<span class="cm">           for plus models )*/</span>
        <span class="n">gpio</span><span class="p">[</span><span class="n">LED_GPCLR</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">LED_GPIO_BIT</span><span class="p">);</span>

        <span class="k">for</span><span class="p">(</span><span class="n">tim</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tim</span> <span class="o">&lt;</span> <span class="mi">500000</span><span class="p">;</span> <span class="n">tim</span><span class="o">++</span><span class="p">)</span>
            <span class="p">;</span>

        <span class="cm">/* Set the LED GPIO pin high ( Turn OK LED off for original Pi, and on</span>
<span class="cm">           for plus models )*/</span>
        <span class="n">gpio</span><span class="p">[</span><span class="n">LED_GPSET</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">LED_GPIO_BIT</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Compile it (using the build.sh script):</p>
<div class="codehilite"><pre><span></span><code>part-2/armc-04 $ ./build.sh rpi0
arm-none-eabi-gcc -g -nostartfiles -mfloat-abi<span class="o">=</span>hard -O0 -DRPI0 -mfpu<span class="o">=</span>vfp -march<span class="o">=</span>armv6zk -mtune<span class="o">=</span>arm1176jzf-s /.../part-2/armc-04/*.c -o /.../part-2/armc-04/kernel.armc-04.rpi0.elf
/.../gcc-arm-none-eabi-7-2017-q4-major/bin/../lib/gcc/arm-none-eabi/7.2.1/../../../../arm-none-eabi/bin/ld: warning: cannot find entry symbol _start<span class="p">;</span> defaulting to <span class="m">0000000000008000</span>
arm-none-eabi-objcopy /.../part-2/armc-04/kernel.armc-04.rpi0.elf -O binary /.../part-2/armc-04/kernel.armc-04.rpi0.img
</code></pre></div>

<p>and we notice a few things:</p>
<ul>
<li>The size of the binary image is now 33k, but the previous version of this code was only a
hundred bytes or so!</li>
<li>The code, when written to the SDCARD still works - this isn't really expected without a working
C-Runtime in place to initialise the variable gpio before calling main!?</li>
</ul>
<div class="codehilite"><pre><span></span><code>part-2/armc-04 $ ls -lah
total 40K
drwxr-xr-x <span class="m">2</span> brian brian <span class="m">4</span>.0K Oct <span class="m">11</span> <span class="m">21</span>:07 .
drwxr-xr-x <span class="m">8</span> brian brian <span class="m">4</span>.0K Jan  <span class="m">4</span>  <span class="m">2018</span> ..
-rw-r--r-- <span class="m">1</span> brian brian <span class="m">1</span>.2K Sep <span class="m">21</span> <span class="m">00</span>:19 armc-04.c
-rwxr-xr-x <span class="m">1</span> brian brian <span class="m">2</span>.7K Oct <span class="m">11</span> <span class="m">21</span>:07 build.sh
-rwxr-xr-x <span class="m">1</span> brian brian  <span class="m">108</span> Sep <span class="m">21</span> <span class="m">00</span>:19 disassemble.sh
-rwxr-xr-x <span class="m">1</span> brian brian  35K Oct <span class="m">11</span> <span class="m">21</span>:07 kernel.armc-04.rpi0.elf
-rwxr-xr-x <span class="m">1</span> brian brian  65K Oct <span class="m">11</span> <span class="m">21</span>:07 kernel.armc-04.rpi0.img
-rw-r--r-- <span class="m">1</span> brian brian <span class="m">1</span>.7K Sep <span class="m">21</span> <span class="m">00</span>:19 rpi-gpio.h
</code></pre></div>

<p>In fact, this embedded system is different to a lot because we're loading an entire binary image
into RAM and then executing from RAM. The majority of systems have a non-volatile memory section
(Flash/ROM) where the executable code resides, and a volatile memory section (RAM) where the
variable data resides. Variables exist in RAM, everything has a position in RAM.</p>
<p>When we compile for a target that executes from an image in Flash and uses RAM for variables, we
need a copy of the initial values for the variables from Flash so that every time the system is
started the variables can be initialised to their initial value, and we need the code in Flash to
copy these values into the variables <em>before</em> <code>main()</code> is called.</p>
<p>This is one of the jobs of the C-Runtime code (CRT). This is a code object that is normally
linked in automagically by your tool-chain. This is usually not the only object to get linked
to your code behind your back - usually the Interrupt Vector Table gets linked in too, and a
Linker Script tells the linker how to organise these additional pieces of code in your memory
layout.</p>
<p>Normally of course, this happens without you knowing. In general, you'll select your processor
or embedded system on the command line and the appropriate linker script and C-Runtime is
chosen for you and linked in.</p>
<p>I urge you to go and look at your <code>arm-none-gcc-eabi</code> install now to see some of these files.
Look under the <code>arm-none-eabi</code> sub-directory and then under the lib sub-directory. The C-Runtime
code is a binary object file and is called <code>crt0.o</code>, the C Library for info is an archive of
object files called libc.a (there may be several versions with different names), and then you'll
have some <code>.ld</code> files. Under the ldscripts subdirectory you'll find the standard linker scripts.
It's just worth a look to know they're there. GCC uses a thing called specs files too, which
allow specifying system settings so that you can create a machine specification that allows you
to target a machine easily. You can select a custom specs file with a command line option for
GCC, otherwise gcc uses it's built-in specs.</p>
<p>specs files are considered an advanced subject in the world of the GNU tool-chain, but they
provide an excellent way of supplying machine-specific compilation settings. For the embedded
engineer they're worth knowing about! :D</p>
<p>So, now we've got two questions, why does our code work - because the initialisation isn't present
in the C-Runtime? and, why has our code size jumped from a 100 bytes or so to 64k?</p>
<p>The code works without any initialisation because the variables exist in the same memory space
as the code. The bootloading process results in the raspberry-pi kernel being loaded into RAM
in order to be executed, the GPU bootloader runs before the ARM processor we're targeting runs,
and loads the kernel.img file from disk. Because of this, the variables position within the
binary image becomes their variable memory location. The image is loaded by the boot-loader at
address <code>0x8000</code> and then executed. So the bootloader has essentially done a taskt that the
C-Runtime would normally do, copy the initial values of initialised variables from non-volatile
memory to volatile memory. Cool.</p>
<p>Look at the code produced closer with a disassembler. You've already got a disassembler!
It comes with the toolchain; Welcome to the world of objdump (or in our case <code>arm-non-eabi-objdump</code>).
We disassemble the elf file because then objdump knows what processor the binary was built for.
It also then has knowledge of the different code sections too. There's a <code>disassemble.sh</code> script
so go ahead and disassemble the code to see what the compiler generated. You'll get a <code>kernel*.asm</code>
file that looks similar to if not the same as the following (RPI0) code:</p>
<div class="codehilite"><pre><span></span><code>Disassembly of section .text:

00008000 &lt;main&gt;:
    8000:    e59f30b8     ldr    r3, [pc, #184]    ; 80c0 &lt;main+0xc0&gt;
    8004:    e5933000     ldr    r3, [r3]
    8008:    e2833004     add    r3, r3, #4
    800c:    e5932000     ldr    r2, [r3]
    8010:    e59f30a8     ldr    r3, [pc, #168]    ; 80c0 &lt;main+0xc0&gt;
    8014:    e5933000     ldr    r3, [r3]
    8018:    e2833004     add    r3, r3, #4
    801c:    e3822701     orr    r2, r2, #262144    ; 0x40000
    8020:    e5832000     str    r2, [r3]
    8024:    e59f3098     ldr    r3, [pc, #152]    ; 80c4 &lt;main+0xc4&gt;
    8028:    e3a02000     mov    r2, #0
    802c:    e5832000     str    r2, [r3]
    8030:    ea000004     b    8048 &lt;main+0x48&gt;
    8034:    e59f3088     ldr    r3, [pc, #136]    ; 80c4 &lt;main+0xc4&gt;
    8038:    e5933000     ldr    r3, [r3]
    803c:    e2833001     add    r3, r3, #1
    8040:    e59f207c     ldr    r2, [pc, #124]    ; 80c4 &lt;main+0xc4&gt;
    8044:    e5823000     str    r3, [r2]
    8048:    e59f3074     ldr    r3, [pc, #116]    ; 80c4 &lt;main+0xc4&gt;
    804c:    e5933000     ldr    r3, [r3]
    8050:    e59f2070     ldr    r2, [pc, #112]    ; 80c8 &lt;main+0xc8&gt;
    8054:    e1530002     cmp    r3, r2
    8058:    9afffff5     bls    8034 &lt;main+0x34&gt;
    805c:    e59f305c     ldr    r3, [pc, #92]    ; 80c0 &lt;main+0xc0&gt;
    8060:    e5933000     ldr    r3, [r3]
    8064:    e2833028     add    r3, r3, #40    ; 0x28
    8068:    e3a02801     mov    r2, #65536    ; 0x10000
    806c:    e5832000     str    r2, [r3]
    8070:    e59f304c     ldr    r3, [pc, #76]    ; 80c4 &lt;main+0xc4&gt;
    8074:    e3a02000     mov    r2, #0
    8078:    e5832000     str    r2, [r3]
    807c:    ea000004     b    8094 &lt;main+0x94&gt;
    8080:    e59f303c     ldr    r3, [pc, #60]    ; 80c4 &lt;main+0xc4&gt;
    8084:    e5933000     ldr    r3, [r3]
    8088:    e2833001     add    r3, r3, #1
    808c:    e59f2030     ldr    r2, [pc, #48]    ; 80c4 &lt;main+0xc4&gt;
    8090:    e5823000     str    r3, [r2]
    8094:    e59f3028     ldr    r3, [pc, #40]    ; 80c4 &lt;main+0xc4&gt;
    8098:    e5933000     ldr    r3, [r3]
    809c:    e59f2024     ldr    r2, [pc, #36]    ; 80c8 &lt;main+0xc8&gt;
    80a0:    e1530002     cmp    r3, r2
    80a4:    9afffff5     bls    8080 &lt;main+0x80&gt;
    80a8:    e59f3010     ldr    r3, [pc, #16]    ; 80c0 &lt;main+0xc0&gt;
    80ac:    e5933000     ldr    r3, [r3]
    80b0:    e283301c     add    r3, r3, #28
    80b4:    e3a02801     mov    r2, #65536    ; 0x10000
    80b8:    e5832000     str    r2, [r3]
    80bc:    eaffffd8     b    8024 &lt;main+0x24    &gt;
    80c0:    000180cc     andeq    r8, r1, ip, asr #1
    80c4:    000180d0     ldrdeq    r8, [r1], -r0
    80c8:    0007a11f     andeq    sl, r7, pc, lsl r1

Disassembly of section .data:

000180cc &lt;gpio&gt;:
   180cc:    20200000     eorcs    r0, r0, r0

Disassembly of section .bss:

000180d0 &lt;tim&gt;:
   180d0:    00000000     andeq    r0, r0, r0
</code></pre></div>

<blockquote>
<p><strong>NOTE:</strong> Unless we're using the exact same compiler, your mileage may vary here. So assume the
assembly code above is what's come out of the compiler and follow the text below which goes
through it in detail.</p>
</blockquote>
<p>Let's take it line by line. The toolchain's linker has decided that the entry point for the code
should be at memory address <code>0x8000</code>. We see from the disassembled listing that this is where the
machine code starts. Let's look at what it does.</p>
<div class="codehilite"><pre><span></span><code>00008000 &lt;main&gt;:
    8000:   e59f30b8    ldr r3, [pc, #184]  ; 80c0 &lt;main+0xc0&gt;
</code></pre></div>

<p>This first line loads r3 with the value at the <em>address</em> contained at the Program Counter
(PC) + 184. In this assembler, <code>[]</code> is kind of an equivalent to dereferencing a pointer in C. So
instead of loading r3 with the value <code>80c0</code> it will instead load r3 with the 32-bit value at
memory location <code>0x80c0</code></p>
<p>But wait a minute - if you do the maths of <code>0x8000 + 184</code> you get <code>0x80b8</code>. How come the
disassembler is suggesting the data comes from <code>0x80c0</code>?</p>
<p>Well PC relative addressing works slightly different to what you may expect and really there's a
issue with it, the value of PC is different depending on whether the instruction set is currently
ARM or Thumb. Further information is available on the <a href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.dui0473e/Cacdbfji.html">ARM website</a>.
The important thing to note here is:</p>
<blockquote>
<p>In ARM state, the value of the PC is the address of the current instruction plus 8 bytes.</p>
<p>In Thumb state:</p>
<ul>
<li>
<p>For B, BL, CBNZ, and CBZ instructions, the value of the PC is the address of the current
instruction plus 4 bytes.</p>
</li>
<li>
<p>For all other instructions that use labels, the value of the PC is the address of the current
instruction plus 4 bytes, with bit[1] of the result cleared to 0 to make it word-aligned.</p>
</li>
</ul>
</blockquote>
<p>We're in ARM instruction mode here. If you're not sure about ARM and Thumb instruction sets you can
do some googling. Thumb (there's more than one Thumb mode!) are smaller width instructions to allow
for more compact code which is very useful in heavily embedded systems.</p>
<p>So actually the maths here sound be: <code>0x8000 + 0x8 + 0xb8 = 0x80c0</code> to get us to a memory address.
At <code>0x80c0</code> there's the value <code>0x180cc</code> (<code>0x8000 + 0x80cc</code>):</p>
<div class="codehilite"><pre><span></span><code>    80c0:   000180cc    andeq   r8, r1, ip, asr #1
</code></pre></div>

<p>You can ignore the disassembled version of this value as it's not machine code, instead it's merely
a data value.</p>
<p>The next line of the code loads r3 with the 32-bit value that's in memory at the address currently
contained in r3. In c, this would look a bit horrid, but so you get the idea of what I've just
explained, imagine something like this:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">uint32_t</span> <span class="n">r3</span> <span class="o">=</span> <span class="mh">0x180cc</span><span class="p">;</span>
<span class="n">r3</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">r3</span><span class="p">;</span>
</code></pre></div>

<p>At the address 0x180cc in our disassembled version there's the 32-bit value <code>0x20200000</code> which is
the value we want the variable gpio initialised to (for the RPI1, for the RPI2 this will be
<code>0x3F200000</code>. So this is why the code works without any explicit loading or initialisation, but
let's look at exactly what's going on and find out why it works like this.</p>
<p>The value at the end of our executable image can be viewed by dumping the hex and having a look at
the plain machine code that's in the binary file. The disassemble script does this for you with a
tool called <code>hexdump</code> and puts the result into a <code>kernel*.img.hexdump</code> file. It's a plain text file -
you can go ahead and crack it open in a text editor or <code>cat</code> it.</p>
<div class="codehilite"><pre><span></span><code>0000000 30b8 e59f 3000 e593 3004 e283 2000 e593
0000010 30a8 e59f 3000 e593 3004 e283 2701 e382
0000020 2000 e583 3098 e59f 2000 e3a0 2000 e583
0000030 0004 ea00 3088 e59f 3000 e593 3001 e283
0000040 207c e59f 3000 e582 3074 e59f 3000 e593
0000050 2070 e59f 0002 e153 fff5 9aff 305c e59f
0000060 3000 e593 3028 e283 2801 e3a0 2000 e583
0000070 304c e59f 2000 e3a0 2000 e583 0004 ea00
0000080 303c e59f 3000 e593 3001 e283 2030 e59f
0000090 3000 e582 3028 e59f 3000 e593 2024 e59f
00000a0 0002 e153 fff5 9aff 3010 e59f 3000 e593
00000b0 301c e283 2801 e3a0 2000 e583 ffd8 eaff
00000c0 80cc 0001 80d0 0001 a11f 0007 0000 0000
00000d0 0000 0000 0000 0000 0000 0000 0000 0000
*
00100c0 0000 0000 0000 0000 0000 0000 0000 2020
00100d0
</code></pre></div>

<p>The binary is in little-endian format because the processor is little endian. Adjust the
<code>GPIO_BASE</code> value, recompile and disassemble again so you can see the value change. Sure the
code won't work properly, but you can prove to yourself you're looking (and making sense of) the
right thing.</p>
<p>The thing to note here is that our binary image ends at <code>0x100cf</code>. After the bootloader has placed
this binary image in memory at <code>0x8000</code> the last memory location we touch is <code>0x180cf</code>.</p>
<p>Let's have a quick look at what happens next:</p>
<div class="codehilite"><pre><span></span><code>8008:   e2833004    add r3, r3, #4
</code></pre></div>

<p>Increase the value in r3 from <code>0x20200000</code> to <code>0x20200004</code> and store it in r3. This is part of
the C line:</p>
<div class="codehilite"><pre><span></span><code><span class="n">gpio</span><span class="p">[</span><span class="n">LED_GPFSEL</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">LED_GPFBIT</span><span class="p">);</span>
</code></pre></div>

<p>LED_GPFSEL for this compilation for the RPI Zero is set by:</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#define LED_GPFSEL      GPIO_GPFSEL1</span>
<span class="cp">#define GPIO_GPFSEL1    1</span>
</code></pre></div>

<p>From the definition of <code>gpio</code> as <code>volatile unsigned int*</code> each item pointed to is an unsigned int
which is 32-bit wide. That's 4 bytes, so we increase the pointer into gpio by 4 bytes to get the
register address we require in r3.</p>
<div class="codehilite"><pre><span></span><code>800c:   e5932000    ldr r2, [r3]
</code></pre></div>

<p>Load the value of <code>gpio[LED_GPFSEL]</code> into r2. This is common for read-modify-write operations
such as the <code>|=</code> operator we're using in this example. We need to do exactly that, read the
value, modify the value and then write the new value.</p>
<div class="codehilite"><pre><span></span><code>8010:   e59f30a8    ldr r3, [pc, #168]  ; 80c0 &lt;main+0xc0&gt;
8014:   e5933000    ldr r3, [r3]
8018:   e2833004    add r3, r3, #4
</code></pre></div>

<p>The compiler being rather inefficient here. It's preparing r3 again to be the memory write
destination which is exactly the same read memory location. Any sort of compiler optimisations
should be able to get rid of the above three lines. They're really not required, but we
understand what's going on still.</p>
<p><div class="codehilite"><pre><span></span><code>801c:   e3822701    orr r2, r2, #262144 ; 0x40000
</code></pre></div>
The modify part of <code>|=</code>. In this case <code>(1 &lt;&lt; LED_GPFBIT)</code> has been reduced to a constant.
The original <code>gpio[LED_GPFSEL]</code> value is still in r2. We OR that value with the constant to
set the bit and store the new value in r2. The ARM architecture cannot modify a register value
and store it to a memory location in a single instruction BTW in case you're thinking that
would serve us better.</p>
<div class="codehilite"><pre><span></span><code>8020:   e5832000    str r2, [r3]
</code></pre></div>

<p>Finally, the write part of the read-modify-write operation is to write the new value back to
the destination <code>gpio[LED_GPFSEL]</code></p>
<div class="codehilite"><pre><span></span><code>8024:   e59f3098    ldr r3, [pc, #152]  ; 80c4 &lt;main+0xc4&gt;
...
80c4:   000180d0    ldrdeq  r8, [r1], -r0
</code></pre></div>

<p>Loads the value <code>0x180d0</code> into r3.</p>
<p>This value is a problem! It is outside our binary image space. If we were to use this value it
would be a random value that isn't within our control. How come?</p>
<p>This memory location relates to the C variable <code>tim</code> in our program. This variable is determined
by the C standard to have automatic storage duration and according to the C standard should
therefore have a initialised value of 0, but we know here that this is not the case, instead
we'll have a random value.</p>
<p>Actually what happens in the code next is the <code>for</code> loop starts by setting the <code>tim</code> variable to <code>0</code>.</p>
<div class="codehilite"><pre><span></span><code>8028:   e3a02000    mov r2, #0
802c:   e5832000    str r2, [r3]
</code></pre></div>

<p>Let's do a sanity check and make sure we're right by assuming that this is the <code>tim</code> variable:</p>
<div class="codehilite"><pre><span></span><code>000180d4 B __bss_end__
000180d4 B _bss_end__
000180d0 B __bss_start
000180d0 B __bss_start__
000180cc D __data_start
000180d0 D _edata
000180d4 B _end
000180d4 B __end__
000180cc D gpio
00008000 T main
00080000 N _stack
         U _start
000180d0 B tim
</code></pre></div>

<p>Yep! We're talking the same as <a href="https://sourceware.org/binutils/docs/binutils/nm.html">nm</a>.
That's good at least!</p>
<p>Now let's do an experiment. There's a reason I decoded the value <code>0x100cc</code> which
is the address of the gpio variable as <code>0x8000 + 0x80cc</code> earlier:</p>
<h2 id="part-2armc05c">part-2/armc05.c<a class="headerlink" href="#part-2armc05c" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&quot;rpi-gpio.h&quot;</span><span class="cp"></span>

<span class="cm">/** GPIO Register set */</span>
<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span> <span class="n">gpio</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">GPIO_BASE</span><span class="p">;</span>

<span class="cm">/** Simple loop variable */</span>
<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tim</span><span class="p">;</span>

<span class="cm">/** Main function - we&#39;ll never return from here */</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">__attribute__</span><span class="p">((</span><span class="kr">naked</span><span class="p">));</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* Write 1 to the GPIO16 init nibble in the Function Select 1 GPIO</span>
<span class="cm">       peripheral register to enable GPIO16 as an output */</span>
    <span class="n">gpio</span><span class="p">[</span><span class="n">LED_GPFSEL</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">LED_GPFBIT</span><span class="p">);</span>

    <span class="cm">/* Never exit as there is no OS to exit to! */</span>
    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span><span class="n">tim</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tim</span> <span class="o">&lt;</span> <span class="mi">500000</span><span class="p">;</span> <span class="n">tim</span><span class="o">++</span><span class="p">)</span>
            <span class="p">;</span>

        <span class="cm">/* Set the LED GPIO pin low ( Turn OK LED on for original Pi, and off</span>
<span class="cm">           for plus models )*/</span>
        <span class="n">gpio</span><span class="p">[</span><span class="n">LED_GPCLR</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">LED_GPIO_BIT</span><span class="p">);</span>

        <span class="k">for</span><span class="p">(</span><span class="n">tim</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tim</span> <span class="o">&lt;</span> <span class="mi">500000</span><span class="p">;</span> <span class="n">tim</span><span class="o">++</span><span class="p">)</span>
            <span class="p">;</span>

        <span class="cm">/* Set the LED GPIO pin high ( Turn OK LED off for original Pi, and on</span>
<span class="cm">           for plus models )*/</span>
        <span class="n">gpio</span><span class="p">[</span><span class="n">LED_GPSET</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">LED_GPIO_BIT</span><span class="p">);</span>

        <span class="k">for</span><span class="p">(</span><span class="n">tim</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tim</span> <span class="o">&lt;</span> <span class="mi">500000</span><span class="p">;</span> <span class="n">tim</span><span class="o">++</span><span class="p">)</span>
            <span class="p">;</span>

        <span class="cm">/* Set the LED GPIO pin low ( Turn OK LED on for original Pi, and off</span>
<span class="cm">           for plus models )*/</span>
        <span class="n">gpio</span><span class="p">[</span><span class="n">LED_GPCLR</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">LED_GPIO_BIT</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><code>armc-05.c</code> varies only slightly from <code>armc-04.c</code> in that it adds in some code. When we look at this
with <code>nm</code> we see that the <code>__data_start</code> section shifts by the same amount as the code we've added:</p>
<div class="codehilite"><pre><span></span><code>part-2/armc-05 $ ./build.sh rpi0
...

part-2/armc-05 $ ./disassemble.sh
...

part-2/armc-05 $ cat kernel.armc-05.rpi0.elf.nm
 00018120 B __bss_end__
 00018120 B _bss_end__
 0001811c B __bss_start
 0001811c B __bss_start__
 00018118 D __data_start
 0001811c D _edata
 00018120 B _end
 00018120 B __end__
 00018118 D gpio
 00008000 T main
 00080000 N _stack
          U _start
 0001811c B tim
</code></pre></div>

<p>If we go back to the original disassembled output above, we see that address
<code>0x80cc (0x180cc - (0x8000 * 2))</code> is the next available memory address after the constants data
which is itself immediately after the code section.</p>
<p>I hope you're following this, we're really seeing a "bug" in the linker script. There's no need
for us to have this offset. The offset load is correct because when we load this image in RAM
the data is indeed going to be <code>+ 0x8000</code> because that's where the boot-loader is going to place
the image, but something is spacing the data section away from the constants data.</p>
<p>There's a lot more output when building this code. That's because we've added an option
(<code>-Wl,-verbose</code>) to get verbose output from the linker to see what's going on.</p>
<p>As you see from the start of the ld verbose output:</p>
<div class="codehilite"><pre><span></span><code>GNU ld (GNU Tools for Arm Embedded Processors 7-2017-q4-major) 2.29.51.20171128
  Supported emulations:
   armelf
using internal linker script:
</code></pre></div>

<p>LD is using an internal linker script. That means the linker script it's using is compiled into
the ld executable.</p>
<h2 id="part-2armc-06c">part-2/armc-06.c<a class="headerlink" href="#part-2armc-06c" title="Permanent link">&para;</a></h2>
<p>The code is identical to <code>armc-04.c</code>. (So the original code without the additional loop in
<code>armc-05.c</code>)</p>
<p>However, we add <code>-Wl,-T,rpi.x</code> to the compilation command to instruct LD to use a different
linker script to the one it was using. We've retained <code>-Wl,verbose</code> so we can see what happens.</p>
<p>When passing options to the linker using GCC to compile and link, check
the <a href="http://gcc.gnu.org/onlinedocs/gcc/Link-Options.html">gcc documentation</a> which details the
options you can pass.</p>
<p>Now we have control of the linker script. We can try to find out what's "wrong". I quote wrong,
because technically this works, but we've got an annoying 0x8000 offset. It'll be a pain to
debug one day, I know it. Let's find out what we need to do to fix it instead. You can also see
how complicated a linker script can get when it needs to deal with C++ sections!</p>
<p>I hope you're staying with me! I know this may seem far removed from C development on the
Raspberry-Pi bare-metal, but in fact knowing how your tools work to construct the code is
essential later on down the line - heck you wouldn't be getting it up and running on your own
from scratch unless you knew at least some of this stuff!</p>
<p>Whilst I'm scan-reading the linker script I'm looking for things that stick out. Most of these
sections are not used in our basic example so far, so whatever is messing with us must have a
size set, and must be present only when we have something in the initialised variables section
which we know from our investigations with nm is the <code>__data_start</code> section (it aligns with
the gpio symbol which we initialised).</p>
<p>The "problem" must be between the <code>__data_start</code> section and end of the text section (the
symbol main indicated the start of the text section). After a little bit of hunting, I see a
comment and an alignment pertaining to the data section on line 107:</p>
<div class="codehilite"><pre><span></span><code>/* Adjust the address for the data segment.  We want to adjust up to
     the same address within the page on the next page up.  */
  . = ALIGN(CONSTANT (MAXPAGESIZE)) + (. &amp; (CONSTANT (MAXPAGESIZE) - 1));
</code></pre></div>

<p>Interesting, we apparently "want" to adjust up to the next page. If I comment this out with a
standard C-style comment as can be seen in the rest of the file, we get back down to a size of a
few hundred bytes with initialised data. Check again with the output of:</p>
<div class="codehilite"><pre><span></span><code>part-2/armc-06 $ ll

-rwxr-xr-x 1 brian brian   284 Oct 14 22:17 kernel.armc-06.rpi0.img*
</code></pre></div>

<p>When we disassemble the kernel code, we end up with something similar to the following:</p>
<div class="codehilite"><pre><span></span><code>part-2/armc-06 $ ./disassemble.sh
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Disassembly of section .text:

00008000 &lt;main&gt;:
    8000:   e59f30b8    ldr r3, [pc, #184]  ; 80c0 &lt;main+0xc0&gt;
    8004:   e5933000    ldr r3, [r3]
    8008:   e2833010    add r3, r3, #16
    800c:   e5932000    ldr r2, [r3]
    8010:   e59f30a8    ldr r3, [pc, #168]  ; 80c0 &lt;main+0xc0&gt;
    8014:   e5933000    ldr r3, [r3]
    8018:   e2833010    add r3, r3, #16
    801c:   e3822602    orr r2, r2, #2097152    ; 0x200000
    8020:   e5832000    str r2, [r3]
    8024:   e59f3098    ldr r3, [pc, #152]  ; 80c4 &lt;main+0xc4&gt;
    8028:   e3a02000    mov r2, #0
    802c:   e5832000    str r2, [r3]
    8030:   ea000004    b   8048 &lt;main+0x48&gt;
    8034:   e59f3088    ldr r3, [pc, #136]  ; 80c4 &lt;main+0xc4&gt;
    8038:   e5933000    ldr r3, [r3]
    803c:   e2833001    add r3, r3, #1
    8040:   e59f207c    ldr r2, [pc, #124]  ; 80c4 &lt;main+0xc4&gt;
    8044:   e5823000    str r3, [r2]
    8048:   e59f3074    ldr r3, [pc, #116]  ; 80c4 &lt;main+0xc4&gt;
    804c:   e5933000    ldr r3, [r3]
    8050:   e59f2070    ldr r2, [pc, #112]  ; 80c8 &lt;main+0xc8&gt;
    8054:   e1530002    cmp r3, r2
    8058:   9afffff5    bls 8034 &lt;main+0x34&gt;
    805c:   e59f305c    ldr r3, [pc, #92]   ; 80c0 &lt;main+0xc0&gt;
    8060:   e5933000    ldr r3, [r3]
    8064:   e283302c    add r3, r3, #44 ; 0x2c
    8068:   e3a02902    mov r2, #32768  ; 0x8000
    806c:   e5832000    str r2, [r3]
    8070:   e59f304c    ldr r3, [pc, #76]   ; 80c4 &lt;main+0xc4&gt;
    8074:   e3a02000    mov r2, #0
    8078:   e5832000    str r2, [r3]
    807c:   ea000004    b   8094 &lt;main+0x94&gt;
    8080:   e59f303c    ldr r3, [pc, #60]   ; 80c4 &lt;main+0xc4&gt;
    8084:   e5933000    ldr r3, [r3]
    8088:   e2833001    add r3, r3, #1
    808c:   e59f2030    ldr r2, [pc, #48]   ; 80c4 &lt;main+0xc4&gt;
    8090:   e5823000    str r3, [r2]
    8094:   e59f3028    ldr r3, [pc, #40]   ; 80c4 &lt;main+0xc4&gt;
    8098:   e5933000    ldr r3, [r3]
    809c:   e59f2024    ldr r2, [pc, #36]   ; 80c8 &lt;main+0xc8&gt;
    80a0:   e1530002    cmp r3, r2
    80a4:   9afffff5    bls 8080 &lt;main+0x80&gt;
    80a8:   e59f3010    ldr r3, [pc, #16]   ; 80c0 &lt;main+0xc0&gt;
    80ac:   e5933000    ldr r3, [r3]
    80b0:   e2833020    add r3, r3, #32
    80b4:   e3a02902    mov r2, #32768  ; 0x8000
    80b8:   e5832000    str r2, [r3]
    80bc:   eaffffd8    b   8024 &lt;main+0x24&gt;
    80c0:   000080cc    andeq   r8, r0, ip, asr #1
    80c4:   000080d0    ldrdeq  r8, [r0], -r0
    80c8:   0007a11f    andeq   sl, r7, pc, lsl r1

Disassembly of section .data:

000080cc &lt;gpio&gt;:
    80cc:   20200000    eorcs   r0, r0, r0

Disassembly of section .bss:

000080d0 &lt;tim&gt;:
    80d0:   00000000    andeq   r0, r0, r0
</code></pre></div>

<p>Use the <a href="http://infocenter.arm.com/help/topic/com.arm.doc.qrc0001l/QRC0001_UAL.pdf">ARM instruction set quick reference card</a>
to decypher if you're not familiar with ARM assembler.</p>
<p>By the way, as a quick note - the comment in the linker script is entirely useless as it only
describes what the code is doing, the worst type of comment! There is no <em>WHY</em> in the comment.
Why are we wanting to do this? What's the reason for forcing the alignment? Anyway this alignment
was forcing the <code>0x8000</code> additional offset to our rodata (initialised data) section.</p>
<p>Cool, now the initialised data is tagged immediately on the end of the data and the values
look sane too! I'll leave you to decode the assembly.</p>
<h2 id="part-2armc-07">part-2/armc-07<a class="headerlink" href="#part-2armc-07" title="Permanent link">&para;</a></h2>
<p>The code here is the same as <code>armc-06.c</code>. Nothing has changed, we'll just modify our linker
script. At this point, we can get rid of the annoying _start undefined symbol warning. At the
top of the linker script, on line 9 you'll see a line that says <code>ENTRY(_start)</code></p>
<p>In <code>armc-07</code> we've changed this to read <code>ENTRY(main)</code></p>
<p>The warning will go away at last! But we'll soon learn why we need that <code>_start</code> section
for the C-Runtime anyway!</p>
<p>Have a quick check of the sections with nm again, now there's no Undefined sections!</p>
<div class="codehilite"><pre><span></span><code>part-2/armc-07 $ ./build.sh rpi0
arm-none-eabi-gcc -g -nostartfiles -mfloat-abi=hard -O0 -DRPI0 -mfpu=vfp -march=armv6zk -mtune=arm1176jzf-s part-2/armc-07/*.c -o part-2/armc-07/kernel.armc-07.rpi0.elf
arm-none-eabi-objcopy part-2/armc-07/kernel.armc-07.rpi0.elf -O binary part-2/armc-07/kernel.armc-07.rpi0.img
</code></pre></div>

<div class="codehilite"><pre><span></span><code>part-2/armc-07 $ ./disassemble.sh
</code></pre></div>

<div class="codehilite"><pre><span></span><code>part-2/armc-07 $ cat ./kernel.armc-07.rpi0.elf.nm
000080d4 B __bss_end__
000080d4 B _bss_end__
000080d0 B __bss_start
000080d0 B __bss_start__
000080cc D __data_start
000080d0 D _edata
000080d4 B _end
000080d4 B __end__
000080cc D gpio
00008000 T main
00080000 N _stack
000080d0 B tim
</code></pre></div>

<h2 id="sections-and-c-startup">Sections and C Startup<a class="headerlink" href="#sections-and-c-startup" title="Permanent link">&para;</a></h2>
<p>As we've found out, there are a lot of sections, some which you may not know the meaning of. The
<code>.bss</code> section is used for data that is implicitly initialised to 0 at startup (This is mandated
by the C Standard). This means that all variables that are statically declared are set to zero
initially. Statically declared essentially means global, so local (automatic) variables in a
function that are not marked as static do not get initialised to zero if you do not explicitly
add an initial value. It's easier with an example, take for example the following C file:</p>
<div class="codehilite"><pre><span></span><code>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">var1</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">var2</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">var3</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

    <span class="kt">void</span> <span class="nf">function</span><span class="p">(</span> <span class="kt">void</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">funcvar1</span><span class="p">;</span>
        <span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">funcvar2</span><span class="p">;</span>

        <span class="cm">/* ... */</span>

    <span class="p">}</span>
</code></pre></div>

<p>In the above example var1, var2 and funcvar2 are in the bss section, the rest are not. For more
information on the bss section, see the <a href="http://en.wikipedia.org/wiki/.bss">wikipedia page on it</a></p>
<p>The linker organises the data and sorts it out into the different sections. In the above, var3
for example goes into the data section. The code is compiled into machine code and then put in
the <code>.text</code> section. See <a href="http://en.wikipedia.org/wiki/Code_segment">here</a> for "a little!" more
information about the text section. There can be many text sections and there can be many data
sections too. These sections are wild-carded in the linker script to ensure different sections
can be defined whilst still knowing whether they are code or data sections.</p>
<p>In our current code (armc-07) the bss section is not valid because it is not being initialised.
That's because the C-Startup is missing. This is the importance of the <code>_start</code> symbol!</p>
<p>The <code>_start</code> section is run before the c main() entry point and one of it's jobs is to initialise
the bss section. The linker provides us with a couple of symbols for the sections so we know
where they start and end. In the startup code all we need to do is loop between the addresses
defined by <code>bss_start</code> and <code>bss_end</code> and set all locations to zero. It's easy when you know
what you're meant to do!</p>
<p>The <code>_startup</code> code should also setup the stack pointer. We'll need a working stack to get
anything useful up and working! The stack is temporary memory space available for functions
to use. The compiler tries to use registers for local (automatic) function variables, but if
the size of data required by the local variables exceeds the amount of registers available,
the compiler uses the stack for the local variables.</p>
<p>So lets go ahead and setup the stack pointer to a sane value and initialise the bss section.</p>
<p>Firstly, we'll set the linker script back to standard so the entry point is the <code>_start</code> symbol
again, we'll have to generate this symbol and generally we'll need to do this is assembler. We
need to setup the stack pointer before we enter the C code so that we're safe to write C which
may attempt to use the stack straight away.</p>
<p>Normally the complete startup is done in assembler, including zeroing the bss section, but it
doesn't have to! I prefer to get into C as soon as possible, so let's see how little assembler
we can get away with, and see what trips us up next!</p>
<h2 id="armc-08-starts">armc-08-start.S<a class="headerlink" href="#armc-08-starts" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code>.section &quot;.text.startup&quot;

.global _start

_start:
    // Set the stack pointer, which progresses downwards through memory
    // Set it at 64MB which we know our application will not crash into
    // and we also know will be available to the ARM CPU. No matter what
    // settings we use to split the memory between the GPU and ARM CPU
    ldr     sp, =0x8000

    // Run the c startup function - should not return and will call kernel_main
    b       _cstartup

_inf_loop:
    b       _inf_loop
</code></pre></div>

<p>Not bad! There's not exactly a lot there to set up the stack pointer. The stack is placed at the
start of our program and grows downwards through memory. You don't need a large amount of memory
for the stack.</p>
<p>Some important information about the <code>.section</code> declaration. With the linker script, I can see
in <code>rpi.x</code> that the following text sections are available:</p>
<div class="codehilite"><pre><span></span><code>.text           :
{
  *(.text.unlikely .text.*_unlikely .text.unlikely.*)
  *(.text.exit .text.exit.*)
  *(.text.startup .text.startup.*)
  *(.text.hot .text.hot.*)
  *(.text .stub .text.* .gnu.linkonce.t.*)
  /* .gnu.warning sections are handled specially by elf32.em.  */
  *(.gnu.warning)
  *(.glue_7t) *(.glue_7) *(.vfp11_veneer) *(.v4_bx)
}
</code></pre></div>

<p>This is also the order in which the text section is linked together by the linker. The standard
functions generally go in the standard <code>.text</code> section. Therefore, we can put our <code>_startup</code>
function before the main <code>.text</code> section by putting it in the <code>.text.startup</code> section.
Other than <code>.text.unlikely</code> and <code>text.exit</code> which we won't use, <code>_startup</code> will be the first
thing to go into the text segment which is where execution will start at <code>0x8000</code></p>
<p>Then, we're in C for initialising the bss section by running the <code>cstartup</code> function:</p>
<h2 id="armc-08-cstartupc">armc-08-cstartup.c<a class="headerlink" href="#armc-08-cstartupc" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code><span class="k">extern</span> <span class="kt">int</span> <span class="n">__bss_start__</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">__bss_end__</span><span class="p">;</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="nf">kernel_main</span><span class="p">(</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r0</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r1</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">atags</span> <span class="p">);</span>

<span class="kt">void</span> <span class="nf">_cstartup</span><span class="p">(</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r0</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r1</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r2</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/*__bss_start__ and __bss_end__ are defined in the linker script */</span>
    <span class="kt">int</span><span class="o">*</span> <span class="n">bss</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__bss_start__</span><span class="p">;</span>
    <span class="kt">int</span><span class="o">*</span> <span class="n">bss_end</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__bss_end__</span><span class="p">;</span>

    <span class="cm">/*</span>
<span class="cm">        Clear the BSS section</span>

<span class="cm">        See http://en.wikipedia.org/wiki/.bss for further information on the</span>
<span class="cm">            BSS section</span>

<span class="cm">        See https://sourceware.org/newlib/libc.html#Stubs for further</span>
<span class="cm">            information on the c-library stubs</span>
<span class="cm">    */</span>
    <span class="k">while</span><span class="p">(</span> <span class="n">bss</span> <span class="o">&lt;</span> <span class="n">bss_end</span> <span class="p">)</span>
        <span class="o">*</span><span class="n">bss</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="cm">/* We should never return from main ... */</span>
    <span class="n">kernel_main</span><span class="p">(</span> <span class="n">r0</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span> <span class="p">);</span>

    <span class="cm">/* ... but if we do, safely trap here */</span>
    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="cm">/* EMPTY! */</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Again, not that bad and pretty reasonable. <strong>NOTE:</strong> We've now changed from main to <code>kernel_main</code>,
and there's a reason for this - the bootloader is actually expecting a slightly different entry
definition compared to the standard C main function. So as we're setting up our own C-Runtime
anyway, we can define the correct entry format. The correct bootloader entry point defines a
couple of values which we can check to know what system we're booting.</p>
<p>The actual C code hasn't really changed apart from the <code>kernel_main</code> difference:</p>
<h2 id="armc-08c">armc-08.c<a class="headerlink" href="#armc-08c" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&quot;rpi-gpio.h&quot;</span><span class="cp"></span>

<span class="cm">/** GPIO Register set */</span>
<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span> <span class="n">gpio</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">GPIO_BASE</span><span class="p">;</span>

<span class="cm">/** Simple loop variable */</span>
<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tim</span><span class="p">;</span>

<span class="cm">/** Main function - we&#39;ll never return from here */</span>
<span class="kt">void</span> <span class="nf">kernel_main</span><span class="p">(</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r0</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r1</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">atags</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* Write 1 to the GPIO16 init nibble in the Function Select 1 GPIO</span>
<span class="cm">       peripheral register to enable GPIO16 as an output */</span>
    <span class="n">gpio</span><span class="p">[</span><span class="n">LED_GPFSEL</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">LED_GPFBIT</span><span class="p">);</span>

    <span class="cm">/* Never exit as there is no OS to exit to! */</span>
    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span><span class="n">tim</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tim</span> <span class="o">&lt;</span> <span class="mi">500000</span><span class="p">;</span> <span class="n">tim</span><span class="o">++</span><span class="p">)</span>
            <span class="p">;</span>

        <span class="cm">/* Set the LED GPIO pin low ( Turn OK LED on for original Pi, and off</span>
<span class="cm">           for plus models )*/</span>
        <span class="n">gpio</span><span class="p">[</span><span class="n">LED_GPCLR</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">LED_GPIO_BIT</span><span class="p">);</span>

        <span class="k">for</span><span class="p">(</span><span class="n">tim</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tim</span> <span class="o">&lt;</span> <span class="mi">500000</span><span class="p">;</span> <span class="n">tim</span><span class="o">++</span><span class="p">)</span>
            <span class="p">;</span>

        <span class="cm">/* Set the LED GPIO pin high ( Turn OK LED off for original Pi, and on</span>
<span class="cm">           for plus models )*/</span>
        <span class="n">gpio</span><span class="p">[</span><span class="n">LED_GPSET</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">LED_GPIO_BIT</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>We again confirm with nm that everything is ordered at least something like sensible:</p>
<div class="codehilite"><pre><span></span><code>part-2/armc-08 $ ./build.sh rpi0
arm-none-eabi-gcc -g -nostartfiles -mfloat-abi=hard -O0 -DRPI0 -mfpu=vfp -march=armv6zk -mtune=arm1176jzf-s part-2/armc-08/*.S part-2/armc-08/*.c -o part-2/armc-08/kernel.armc-08.rpi0.elf
arm-none-eabi-objcopy part-2/armc-08/kernel.armc-08.rpi0.elf -O binary part-2/armc-08/kernel.armc-08.rpi0.img
</code></pre></div>

<div class="codehilite"><pre><span></span><code>brian@brian-PH67-UD3-B3 ~/valvers-new/arm-tutorial-rpi/part-2/armc-08 $ ./disassemble.sh
</code></pre></div>

<div class="codehilite"><pre><span></span><code>part-2/armc-08 $ cat ./kernel.armc-08.rpi0.elf.nm

00008164 B __bss_end__
00008164 B _bss_end__
00008160 B __bss_start
00008160 B __bss_start__
0000800c T _cstartup
0000815c D __data_start
00008160 D _edata
00008164 B _end
00008164 B __end__
0000815c D gpio
00008008 t _inf_loop
00008078 T kernel_main
00080000 N _stack
00008000 T _start
00008160 B tim
</code></pre></div>

<p>Yup, looks good - <code>_start</code> is at <code>0x8000</code> where execution will start. Stick it on the card and
make sure the OK LED is blinking still. I appreciate that we're doing a lot of work where you
can't see more interesting results - but it'll get better soon, I promise! For now we're getting
a great foundation for developing in C for the bare metal Raspberry-Pi. Knowing what your tools
are doing is pretty essential!</p>
<div class="codehilite"><pre><span></span><code>part-2/armc-08 $ ./make_card.sh rpi0
part-2/armc-08 $ cat ./card.armc-08.rpi0.img &gt; /dev/sdg &amp;&amp; sync &amp;&amp; eject /dev/sdg
</code></pre></div>

<h2 id="the-c-library-stubs">The C-Library stubs<a class="headerlink" href="#the-c-library-stubs" title="Permanent link">&para;</a></h2>
<p>Now that we've got the C-Runtime pretty much setup, we can implement the C-Library again with
our own C-Runtime startup and C-Library stubs. This is where we want to get to - easy compiling
with the C-Library being linked in so that we can make use of the C-Library functions on the
Raspberry-Pi without an operating system.</p>
<p>We are actually linking against the C-Library, but we're not using anything from within it.
Therefore, the linker disregards the whole of the C-Library because there are no references to
it within the code. Let's jump straight in and malloc some memory as I know that requires a
stub. Compile <code>armc-09</code> without the <code>*-cstubs.c</code> and you'll see the error:</p>
<div class="codehilite"><pre><span></span><code>.../arm-none-eabi/lib/fpu\libg.a(lib_a-sbrkr.o): In function `_sbrk_r&#39;:
sbrkr.c:(.text._sbrk_r+0x18): undefined reference to `_sbrk&#39;
collect2.exe: error: ld returned 1 exit status
</code></pre></div>

<p>So the malloc call is calling something in the c library called <code>_sbrk_r</code> which is a re-entrant
safe (or multi-thread/interrupt safe) C library function all called <code>_sbrk</code>. This is the C-stub
function that we must implement as it is operating-system dependant.</p>
<p>It's worth looking at how other people have implemented these function calls. Look at them
to see what they're doing. Generally you can look at other kernel code, or embedded system
code:</p>
<p><a href="http://www.opensource.apple.com/source/Libc/Libc-763.12/emulated/brk.c">http://www.opensource.apple.com/source/Libc/Libc-763.12/emulated/brk.c</a></p>
<p><a href="http://linux.die.net/man/2/sbrk">http://linux.die.net/man/2/sbrk</a></p>
<p>However, the best place is if examples are in the C-Library you're using! Newlib is well
documented and <a href="https://sourceware.org/newlib/libc.html#Syscalls">includes example minimal systemc calls/stubs</a>.</p>
<p>We implement this in the next tutorial <code>armc-09</code></p>
<h2 id="armc-09-cstubsc">armc-09-cstubs.c<a class="headerlink" href="#armc-09-cstubsc" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp"></span>

<span class="cm">/* A helper function written in assembler to aid us in allocating memory */</span>
<span class="k">extern</span> <span class="n">caddr_t</span> <span class="nf">_get_stack_pointer</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>


<span class="cm">/* Increase program data space. As malloc and related functions depend on this,</span>
<span class="cm">   it is useful to have a working implementation. The following suffices for a</span>
<span class="cm">   standalone system; it exploits the symbol _end automatically defined by the</span>
<span class="cm">   GNU linker. */</span>
<span class="n">caddr_t</span> <span class="nf">_sbrk</span><span class="p">(</span> <span class="kt">int</span> <span class="n">incr</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="k">extern</span> <span class="kt">char</span> <span class="n">_end</span><span class="p">;</span>
    <span class="k">static</span> <span class="kt">char</span><span class="o">*</span> <span class="n">heap_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">prev_heap_end</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">heap_end</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
        <span class="n">heap_end</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">_end</span><span class="p">;</span>

     <span class="n">prev_heap_end</span> <span class="o">=</span> <span class="n">heap_end</span><span class="p">;</span>

     <span class="n">heap_end</span> <span class="o">+=</span> <span class="n">incr</span><span class="p">;</span>
     <span class="k">return</span> <span class="p">(</span><span class="n">caddr_t</span><span class="p">)</span><span class="n">prev_heap_end</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="armc-09-starts">armc-09-start.S<a class="headerlink" href="#armc-09-starts" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code>.section &quot;.text.startup&quot;

.global _start
.global _get_stack_pointer

_start:
    // Set it at 64MB which we know our application will not crash into
    // and we also know will be available to the ARM CPU. No matter what
    // settings we use to split the memory between the GPU and ARM CPU
    // ldr     sp, =0x8000
    ldr     sp, =(64 * 1024 * 1024)

    // Run the c startup function - should not return and will call kernel_main
    b       _cstartup

_inf_loop:
    b       _inf_loop
</code></pre></div>

<h2 id="armc-09-cstartupc">armc-09-cstartup.c<a class="headerlink" href="#armc-09-cstartupc" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code><span class="k">extern</span> <span class="kt">int</span> <span class="n">__bss_start__</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">__bss_end__</span><span class="p">;</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="nf">kernel_main</span><span class="p">(</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r0</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r1</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">atags</span> <span class="p">);</span>

<span class="kt">void</span> <span class="nf">_cstartup</span><span class="p">(</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r0</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r1</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r2</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/*__bss_start__ and __bss_end__ are defined in the linker script */</span>
    <span class="kt">int</span><span class="o">*</span> <span class="n">bss</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__bss_start__</span><span class="p">;</span>
    <span class="kt">int</span><span class="o">*</span> <span class="n">bss_end</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__bss_end__</span><span class="p">;</span>

    <span class="cm">/*</span>
<span class="cm">        Clear the BSS section</span>

<span class="cm">        See http://en.wikipedia.org/wiki/.bss for further information on the</span>
<span class="cm">            BSS section</span>

<span class="cm">        See https://sourceware.org/newlib/libc.html#Stubs for further</span>
<span class="cm">            information on the c-library stubs</span>
<span class="cm">    */</span>
    <span class="k">while</span><span class="p">(</span> <span class="n">bss</span> <span class="o">&lt;</span> <span class="n">bss_end</span> <span class="p">)</span>
        <span class="o">*</span><span class="n">bss</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="cm">/* We should never return from main ... */</span>
    <span class="n">kernel_main</span><span class="p">(</span> <span class="n">r0</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span> <span class="p">);</span>

    <span class="cm">/* ... but if we do, safely trap here */</span>
    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="cm">/* EMPTY! */</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="part-2armc-09c">part-2/armc-09.c<a class="headerlink" href="#part-2armc-09c" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&quot;rpi-gpio.h&quot;</span><span class="cp"></span>

<span class="cm">/** GPIO Register set */</span>
<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span> <span class="n">gpio</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">GPIO_BASE</span><span class="p">;</span>

<span class="cm">/** Main function - we&#39;ll never return from here */</span>
<span class="kt">void</span> <span class="nf">kernel_main</span><span class="p">(</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r0</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r1</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">atags</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">loop</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span> <span class="n">counters</span><span class="p">;</span>

    <span class="cm">/* Set the LED GPIO pin to an output to drive the LED */</span>
    <span class="n">gpio</span><span class="p">[</span><span class="n">LED_GPFSEL</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">LED_GPFBIT</span> <span class="p">);</span>

    <span class="cm">/* Allocate a block of memory for counters */</span>
    <span class="n">counters</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span> <span class="mi">1024</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="p">)</span> <span class="p">);</span>

    <span class="cm">/* Failed to allocate memory! */</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">counters</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">)</span>
        <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>     <span class="n">LED_ON</span><span class="p">();</span><span class="cm">/* Trap here */</span> <span class="p">}</span>

    <span class="k">for</span><span class="p">(</span> <span class="n">loop</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">loop</span><span class="o">&lt;</span><span class="mi">1024</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span> <span class="p">)</span>
        <span class="n">counters</span><span class="p">[</span><span class="n">loop</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="cm">/* Never exit as there is no OS to exit to! */</span>
    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="cm">/* Light the LED */</span>
        <span class="n">LED_ON</span><span class="p">();</span>

        <span class="k">for</span><span class="p">(</span><span class="n">counters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">counters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">500000</span><span class="p">;</span> <span class="n">counters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">)</span>
            <span class="p">;</span>

        <span class="cm">/* Set the GPIO16 output low ( Turn OK LED on )*/</span>
        <span class="n">LED_OFF</span><span class="p">();</span>

        <span class="k">for</span><span class="p">(</span><span class="n">counters</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">counters</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">500000</span><span class="p">;</span> <span class="n">counters</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">++</span><span class="p">)</span>
            <span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Build the example and program, now the counter variable is from malloc'd memory - usually malloc
is the most mysterious of the c library stubs, but as you can see from the example, you can
implement it easily and also implement it in C easily too! Of course occasionally it's necessary
to drop down to assembler to get certain register values or talk to some special hardware
features. Keep the <a href="http://infocenter.arm.com/help/topic/com.arm.doc.qrc0001l/QRC0001_UAL.pdf">cheat-sheet</a>
close at hand while you're working with the C-Stubs.</p>
<h2 id="part-3">Part 3<a class="headerlink" href="#part-3" title="Permanent link">&para;</a></h2>
<p>In the next part of the bare metal tutorial, we'll add on a build system so that we're not using
a silly single command-line, and we can harness the power of a full build system for our
bare-metal environment. We'll then fall back to the Cambridge ASM tutorials and progress to
using the timer for flashing the LED rather than the incrementing loop counter we've used so far.</p>
<p>So, what are you waiting for? Head off to <a href="http://www.valvers.com/embedded-linux/raspberry-pi/step03-bare-metal-programming-in-c-pt3">Part3</a>
now!</p>
                
                  
                
                

              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../step01-bare-metal-programming-in-cpt1/" title="Part 1 - Getting Started" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Part 1 - Getting Started
              </span>
            </div>
          </a>
        
        
          <a href="../step03-bare-metal-programming-in-cpt3/" title="Introducing CMake" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Introducing CMake
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2002-2020 Brian Sidebotham
          </div>
        
        powered by
        <a href="https://www.mkdocs.org" target="_blank" rel="noopener">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application.c33a9706.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../../.."}})</script>
      
        <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
      
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
      
        <script src="../../../valvers-assets/extra.js"></script>
      
    
  </body>
</html>