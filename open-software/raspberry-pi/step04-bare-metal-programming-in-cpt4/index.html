



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="https://www.valvers.com/open-software/raspberry-pi/step04-bare-metal-programming-in-cpt4/">
      
      
        <meta name="author" content="Brian Sidebotham">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../img/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.6.3">
      <meta name="google-site-verification" content="gdf4XzjnbaArINbai3d8P0x_W3ugnDeIUyhMuq-wHPs" />
    
    
      
        <title>Part 4 - Interrupts - valvers.com</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application.adb8469c.css">
      
        <link rel="stylesheet" href="../../../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#546e7a">
      
    
    
      <script src="../../../assets/javascripts/modernizr.86422ebf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    
      <link rel="stylesheet" href="../../../valvers-assets/extra.css">
    
    
      
        
<script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-57476377-1", "valvers.com")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="blue-grey" data-md-color-accent="deep-orange">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#part-4-interrupts" tabindex="0" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://www.valvers.com" title="valvers.com" aria-label="valvers.com" class="md-header-nav__button md-logo">
          
            <img alt="logo" src="https://avatars3.githubusercontent.com/u/5575236?v=4?size=32" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              valvers.com
            </span>
            <span class="md-header-nav__topic">
              
                Part 4 - Interrupts
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/valvers/valvers.website.src/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="../../.." class="md-tabs__link">
        Home
      </a>
    
  </li>

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../denford-orac/" class="md-tabs__link">
          Denford orac
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../engineering/" class="md-tabs__link">
          Engineering
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../" class="md-tabs__link md-tabs__link--active">
          Open software
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../v6manta/" class="md-tabs__link">
          V6manta
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://www.valvers.com" title="valvers.com" class="md-nav__button md-logo">
      
        <img alt="logo" src="https://avatars3.githubusercontent.com/u/5575236?v=4?size=32" width="48" height="48">
      
    </a>
    valvers.com
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/valvers/valvers.website.src/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Denford orac
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Denford orac
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2009-04-06-my-denford-orac/" title="2009 04 06 my denford orac" class="md-nav__link">
      2009 04 06 my denford orac
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2012-02-17-uprated-spindle-motor/" title="2012 02 17 uprated spindle motor" class="md-nav__link">
      2012 02 17 uprated spindle motor
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2012-03-22-gathering-some-information/" title="2012 03 22 gathering some information" class="md-nav__link">
      2012 03 22 gathering some information
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2012-09-27-750w-motor-sourced/" title="2012 09 27 750w motor sourced" class="md-nav__link">
      2012 09 27 750w motor sourced
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2012-10-01-motor-doesnt-fit/" title="2012 10 01 motor doesnt fit" class="md-nav__link">
      2012 10 01 motor doesnt fit
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2012-10-10-drill-head-disassembly/" title="2012 10 10 drill head disassembly" class="md-nav__link">
      2012 10 10 drill head disassembly
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2012-10-13-more-quill-dismantling/" title="2012 10 13 more quill dismantling" class="md-nav__link">
      2012 10 13 more quill dismantling
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2012-10-17-drill-spindle-is-apart/" title="2012 10 17 drill spindle is apart" class="md-nav__link">
      2012 10 17 drill spindle is apart
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2012-10-29-removing-electrical-cabinet/" title="2012 10 29 removing electrical cabinet" class="md-nav__link">
      2012 10 29 removing electrical cabinet
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2012-10-31-tested-the-drill-head-above-the-lathe/" title="2012 10 31 tested the drill head above the lathe" class="md-nav__link">
      2012 10 31 tested the drill head above the lathe
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2012-11-02-rebuild-of-an-orac/" title="2012 11 02 rebuild of an orac" class="md-nav__link">
      2012 11 02 rebuild of an orac
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2013-03-13-new-motor-fitted/" title="2013 03 13 new motor fitted" class="md-nav__link">
      2013 03 13 new motor fitted
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Engineering
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Engineering
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../engineering/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../engineering/an-and-jic-fittings/" title="AN and JIC Fittings" class="md-nav__link">
      AN and JIC Fittings
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../engineering/bolt-dimensions/" title="Bolt Dimensions" class="md-nav__link">
      Bolt Dimensions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../engineering/linux-cnc-on-beaglebone-black/" title="Linux CNC on Beaglebone Black" class="md-nav__link">
      Linux CNC on Beaglebone Black
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../engineering/making-a-cyr-wheel/" title="Making a Cyr Wheel" class="md-nav__link">
      Making a Cyr Wheel
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      Open software
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Open software
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../" title="Open-Software" class="md-nav__link">
      Open-Software
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../android-car-dash/" title="Android car dash" class="md-nav__link">
      Android car dash
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../logging-with-gcc/" title="Logging with gcc" class="md-nav__link">
      Logging with gcc
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../posix-shell-scripting/" title="Posix Shell Scripting" class="md-nav__link">
      Posix Shell Scripting
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../working-with-the-screen-command/" title="Working with the Screen Command" class="md-nav__link">
      Working with the Screen Command
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-6" type="checkbox" id="nav-4-6">
    
    <label class="md-nav__link" for="nav-4-6">
      Gcc
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-6">
        Gcc
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../gcc/weak-function-attributes/" title="Weak Function Attributes" class="md-nav__link">
      Weak Function Attributes
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-7" type="checkbox" id="nav-4-7">
    
    <label class="md-nav__link" for="nav-4-7">
      Python
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-7">
        Python
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../python/pylab/" title="Pylab" class="md-nav__link">
      Pylab
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-8" type="checkbox" id="nav-4-8" checked>
    
    <label class="md-nav__link" for="nav-4-8">
      Raspberry pi
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-8">
        Raspberry pi
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../" title="Open Software - Raspberry Pi" class="md-nav__link">
      Open Software - Raspberry Pi
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../step01-bare-metal-programming-in-cpt1/" title="Part 1 - Getting Started" class="md-nav__link">
      Part 1 - Getting Started
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../step02-bare-metal-programming-in-cpt2/" title="Part 2 - The C Runtime" class="md-nav__link">
      Part 2 - The C Runtime
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../step03-bare-metal-programming-in-cpt3/" title="Introducing CMake" class="md-nav__link">
      Introducing CMake
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Part 4 - Interrupts
      </label>
    
    <a href="./" title="Part 4 - Interrupts" class="md-nav__link md-nav__link--active">
      Part 4 - Interrupts
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#reference-material" class="md-nav__link">
    Reference Material
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-code" class="md-nav__link">
    The Code
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#interrupts" class="md-nav__link">
    Interrupts
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#processor-modes" class="md-nav__link">
    Processor Modes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#coding-interrupt-handlers" class="md-nav__link">
    Coding Interrupt Handlers
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#coding-vector-tables" class="md-nav__link">
    Coding Vector Tables
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#its-all-relative" class="md-nav__link">
    It's all relative
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-interrupt-controller" class="md-nav__link">
    The Interrupt Controller
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-arm-timer-peripheral" class="md-nav__link">
    The ARM Timer Peripheral
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../step05-bare-metal-programming-in-cpt5/" title="Part 5 - Graphics (Basic)" class="md-nav__link">
      Part 5 - Graphics (Basic)
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-9" type="checkbox" id="nav-4-9">
    
    <label class="md-nav__link" for="nav-4-9">
      Saltstack
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-9">
        Saltstack
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../saltstack/building-a-centos8-salt-master/" title="Building a CentOS8 Salt Master" class="md-nav__link">
      Building a CentOS8 Salt Master
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-10" type="checkbox" id="nav-4-10">
    
    <label class="md-nav__link" for="nav-4-10">
      Webstacks
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-10">
        Webstacks
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../webstacks/using-reactjs-and-bulma/" title="Using ReactJS and Bulma" class="md-nav__link">
      Using ReactJS and Bulma
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      V6manta
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        V6manta
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-2" type="checkbox" id="nav-5-2">
    
    <label class="md-nav__link" for="nav-5-2">
      2003
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-2">
        2003
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-07-28-/" title="2003 07 28" class="md-nav__link">
      2003 07 28 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-07-28-brought-a-1.8s-berlinetta/" title="2003 07 28 brought a 1.8s berlinetta" class="md-nav__link">
      2003 07 28 brought a 1.8s berlinetta
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-07-28-stage-rally-opel-manta/" title="2003 07 28 stage rally opel manta" class="md-nav__link">
      2003 07 28 stage rally opel manta
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-08-12-/" title="2003 08 12" class="md-nav__link">
      2003 08 12 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-08-13-/" title="2003 08 13" class="md-nav__link">
      2003 08 13 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-08-23-/" title="2003 08 23" class="md-nav__link">
      2003 08 23 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-09-11-/" title="2003 09 11" class="md-nav__link">
      2003 09 11 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-09-28-/" title="2003 09 28" class="md-nav__link">
      2003 09 28 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-10-07-/" title="2003 10 07" class="md-nav__link">
      2003 10 07 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-10-09-/" title="2003 10 09" class="md-nav__link">
      2003 10 09 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-11-04-/" title="2003 11 04" class="md-nav__link">
      2003 11 04 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-12-16-/" title="2003 12 16" class="md-nav__link">
      2003 12 16 
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-3" type="checkbox" id="nav-5-3">
    
    <label class="md-nav__link" for="nav-5-3">
      2004
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-3">
        2004
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-01-06-/" title="2004 01 06" class="md-nav__link">
      2004 01 06 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-01-07-/" title="2004 01 07" class="md-nav__link">
      2004 01 07 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-01-26-/" title="2004 01 26" class="md-nav__link">
      2004 01 26 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-01-29-/" title="2004 01 29" class="md-nav__link">
      2004 01 29 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-02-09-/" title="2004 02 09" class="md-nav__link">
      2004 02 09 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-02-13-/" title="2004 02 13" class="md-nav__link">
      2004 02 13 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-02-19-/" title="2004 02 19" class="md-nav__link">
      2004 02 19 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-04-20-finally-got-around-to-the-manta/" title="2004 04 20 finally got around to the manta" class="md-nav__link">
      2004 04 20 finally got around to the manta
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-06-17-/" title="2004 06 17" class="md-nav__link">
      2004 06 17 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-06-18-/" title="2004 06 18" class="md-nav__link">
      2004 06 18 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-06-21-/" title="2004 06 21" class="md-nav__link">
      2004 06 21 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-07-26-/" title="2004 07 26" class="md-nav__link">
      2004 07 26 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-08-09-/" title="2004 08 09" class="md-nav__link">
      2004 08 09 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-08-10-/" title="2004 08 10" class="md-nav__link">
      2004 08 10 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-09-03-/" title="2004 09 03" class="md-nav__link">
      2004 09 03 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-09-27-/" title="2004 09 27" class="md-nav__link">
      2004 09 27 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-10-07-/" title="2004 10 07" class="md-nav__link">
      2004 10 07 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-10-08-/" title="2004 10 08" class="md-nav__link">
      2004 10 08 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-10-11-/" title="2004 10 11" class="md-nav__link">
      2004 10 11 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-10-13-/" title="2004 10 13" class="md-nav__link">
      2004 10 13 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-10-15-/" title="2004 10 15" class="md-nav__link">
      2004 10 15 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-10-18-/" title="2004 10 18" class="md-nav__link">
      2004 10 18 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-10-21-/" title="2004 10 21" class="md-nav__link">
      2004 10 21 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-10-22-/" title="2004 10 22" class="md-nav__link">
      2004 10 22 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-10-29-/" title="2004 10 29" class="md-nav__link">
      2004 10 29 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-11-01-/" title="2004 11 01" class="md-nav__link">
      2004 11 01 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-12-10-were-back/" title="2004 12 10 were back" class="md-nav__link">
      2004 12 10 were back
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-4" type="checkbox" id="nav-5-4">
    
    <label class="md-nav__link" for="nav-5-4">
      2005
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-4">
        2005
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-05-16-/" title="2005 05 16" class="md-nav__link">
      2005 05 16 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-08-04-done-something/" title="2005 08 04 done something" class="md-nav__link">
      2005 08 04 done something
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-08-08-/" title="2005 08 08" class="md-nav__link">
      2005 08 08 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-08-10-/" title="2005 08 10" class="md-nav__link">
      2005 08 10 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-08-25-/" title="2005 08 25" class="md-nav__link">
      2005 08 25 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-08-31-/" title="2005 08 31" class="md-nav__link">
      2005 08 31 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-09-05-/" title="2005 09 05" class="md-nav__link">
      2005 09 05 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-09-19-/" title="2005 09 19" class="md-nav__link">
      2005 09 19 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-09-22-/" title="2005 09 22" class="md-nav__link">
      2005 09 22 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-09-23-/" title="2005 09 23" class="md-nav__link">
      2005 09 23 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-11-01-/" title="2005 11 01" class="md-nav__link">
      2005 11 01 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-11-03-/" title="2005 11 03" class="md-nav__link">
      2005 11 03 
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-5" type="checkbox" id="nav-5-5">
    
    <label class="md-nav__link" for="nav-5-5">
      2007
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-5">
        2007
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2007/2007-10-20-/" title="2007 10 20" class="md-nav__link">
      2007 10 20 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2007/2007-10-20-perspex-windows/" title="2007 10 20 perspex windows" class="md-nav__link">
      2007 10 20 perspex windows
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2007/2007-11-13-getting-it-ready-to-paint.../" title="2007 11 13 getting it ready to paint..." class="md-nav__link">
      2007 11 13 getting it ready to paint...
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2007/2007-11-21-almost-started-painting/" title="2007 11 21 almost started painting" class="md-nav__link">
      2007 11 21 almost started painting
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2007/2007-11-28-underneath-is-complete/" title="2007 11 28 underneath is complete" class="md-nav__link">
      2007 11 28 underneath is complete
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2007/2007-12-04-painting-the-inside-and-engine-bay/" title="2007 12 04 painting the inside and engine bay" class="md-nav__link">
      2007 12 04 painting the inside and engine bay
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-6" type="checkbox" id="nav-5-6">
    
    <label class="md-nav__link" for="nav-5-6">
      2008
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-6">
        2008
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-01-14-painting-the-shell-orange/" title="2008 01 14 painting the shell orange" class="md-nav__link">
      2008 01 14 painting the shell orange
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-01-16-out-of-the-booth/" title="2008 01 16 out of the booth" class="md-nav__link">
      2008 01 16 out of the booth
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-01-23-rear-axle-trial-fitting/" title="2008 01 23 rear axle trial fitting" class="md-nav__link">
      2008 01 23 rear axle trial fitting
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-02-24-painted-the-nextel-and-checked-for-wheel-clearance/" title="2008 02 24 painted the nextel and checked for wheel clearance" class="md-nav__link">
      2008 02 24 painted the nextel and checked for wheel clearance
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-03-15-front-suspension-build/" title="2008 03 15 front suspension build" class="md-nav__link">
      2008 03 15 front suspension build
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-03-19-suspension-bushes-are-always-wrong/" title="2008 03 19 suspension bushes are always wrong" class="md-nav__link">
      2008 03 19 suspension bushes are always wrong
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-03-22-diff-bearings-need-replacing/" title="2008 03 22 diff bearings need replacing" class="md-nav__link">
      2008 03 22 diff bearings need replacing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-04-08-fitted-the-rear-windows-and-steering-column/" title="2008 04 08 fitted the rear windows and steering column" class="md-nav__link">
      2008 04 08 fitted the rear windows and steering column
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-04-12-shimmed-up-the-diff,-and-fitted-the-clocks/" title="2008 04 12 shimmed up the diff, and fitted the clocks" class="md-nav__link">
      2008 04 12 shimmed up the diff, and fitted the clocks
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-04-16-rebuilt-the-gearbox-so-i-get-gear-selection/" title="2008 04 16 rebuilt the gearbox so i get gear selection" class="md-nav__link">
      2008 04 16 rebuilt the gearbox so i get gear selection
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-07-08-its-on-its-wheels-at-last/" title="2008 07 08 its on its wheels at last" class="md-nav__link">
      2008 07 08 its on its wheels at last
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-09-02-rebuilt-oil-pump--started-headwork/" title="2008 09 02 rebuilt oil pump started headwork" class="md-nav__link">
      2008 09 02 rebuilt oil pump  started headwork
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-09-04-some-more-headwork/" title="2008 09 04 some more headwork" class="md-nav__link">
      2008 09 04 some more headwork
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-09-25-even-more-headwork/" title="2008 09 25 even more headwork" class="md-nav__link">
      2008 09 25 even more headwork
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-11-09-engine--transmission-fitted/" title="2008 11 09 engine transmission fitted" class="md-nav__link">
      2008 11 09 engine  transmission fitted
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-11-16-engine--gearbox-mounted--steering-column-fitted/" title="2008 11 16 engine gearbox mounted steering column fitted" class="md-nav__link">
      2008 11 16 engine  gearbox mounted  steering column fitted
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-12-14-stripping-the-x25xe-v6-bottom-end/" title="2008 12 14 stripping the x25xe v6 bottom end" class="md-nav__link">
      2008 12 14 stripping the x25xe v6 bottom end
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-7" type="checkbox" id="nav-5-7">
    
    <label class="md-nav__link" for="nav-5-7">
      2009
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-7">
        2009
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2009/2009-06-24-making-the-dry-sump-pan/" title="2009 06 24 making the dry sump pan" class="md-nav__link">
      2009 06 24 making the dry sump pan
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2009/2009-10-05-trialling-the-throttle-bodies--a-few-more-bits-painted/" title="2009 10 05 trialling the throttle bodies a few more bits painted" class="md-nav__link">
      2009 10 05 trialling the throttle bodies  a few more bits painted
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2009/2009-12-18-flywheel-and-clutch/" title="2009 12 18 flywheel and clutch" class="md-nav__link">
      2009 12 18 flywheel and clutch
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-8" type="checkbox" id="nav-5-8">
    
    <label class="md-nav__link" for="nav-5-8">
      2010
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-8">
        2010
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-01-23-done-the-handbrake--sliders/" title="2010 01 23 done the handbrake sliders" class="md-nav__link">
      2010 01 23 done the handbrake  sliders
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-01-27-started-building-the-v6-heads-up/" title="2010 01 27 started building the v6 heads up" class="md-nav__link">
      2010 01 27 started building the v6 heads up
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-01-30-picked-up-another-v6/" title="2010 01 30 picked up another v6" class="md-nav__link">
      2010 01 30 picked up another v6
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-02-01-exhaust-manifolds/" title="2010 02 01 exhaust manifolds" class="md-nav__link">
      2010 02 01 exhaust manifolds
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-02-02-starting-the-v6-build/" title="2010 02 02 starting the v6 build" class="md-nav__link">
      2010 02 02 starting the v6 build
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-02-03-cylinder-head-bolts-torque/" title="2010 02 03 cylinder head bolts torque" class="md-nav__link">
      2010 02 03 cylinder head bolts torque
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-02-03-ordered-the-exhaust-manifold-flanges/" title="2010 02 03 ordered the exhaust manifold flanges" class="md-nav__link">
      2010 02 03 ordered the exhaust manifold flanges
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-02-06-building-the-v6/" title="2010 02 06 building the v6" class="md-nav__link">
      2010 02 06 building the v6
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-02-07-building-the-v6/" title="2010 02 07 building the v6" class="md-nav__link">
      2010 02 07 building the v6
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-02-14-building-the-v6/" title="2010 02 14 building the v6" class="md-nav__link">
      2010 02 14 building the v6
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-03-22-gearbox-sealed-and-release-bearing-fitted/" title="2010 03 22 gearbox sealed and release bearing fitted" class="md-nav__link">
      2010 03 22 gearbox sealed and release bearing fitted
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-04-03-started-on-the-manifolds/" title="2010 04 03 started on the manifolds" class="md-nav__link">
      2010 04 03 started on the manifolds
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-04-05-finished-a-manifold/" title="2010 04 05 finished a manifold" class="md-nav__link">
      2010 04 05 finished a manifold
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-04-07-started-the-second-manifold/" title="2010 04 07 started the second manifold" class="md-nav__link">
      2010 04 07 started the second manifold
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-04-11-need-a-todo-list/" title="2010 04 11 need a todo list" class="md-nav__link">
      2010 04 11 need a todo list
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-04-21-ticking-off-the-boxes/" title="2010 04 21 ticking off the boxes" class="md-nav__link">
      2010 04 21 ticking off the boxes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-04-26-nearly-finished-the-second-manifold/" title="2010 04 26 nearly finished the second manifold" class="md-nav__link">
      2010 04 26 nearly finished the second manifold
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-05-09-got-the-car-rolling/" title="2010 05 09 got the car rolling" class="md-nav__link">
      2010 05 09 got the car rolling
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-05-11-rolling-road-day/" title="2010 05 11 rolling road day" class="md-nav__link">
      2010 05 11 rolling road day
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-05-31-back-from-germany/" title="2010 05 31 back from germany" class="md-nav__link">
      2010 05 31 back from germany
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-06-01-sumps-off/" title="2010 06 01 sumps off" class="md-nav__link">
      2010 06 01 sumps off
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-06-06-done-most-of-the-bits-on-the-v6/" title="2010 06 06 done most of the bits on the v6" class="md-nav__link">
      2010 06 06 done most of the bits on the v6
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-06-12-getting-ready-to-bolt-it-back-in/" title="2010 06 12 getting ready to bolt it back in" class="md-nav__link">
      2010 06 12 getting ready to bolt it back in
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-06-19-almost-ready-to-go-back-in/" title="2010 06 19 almost ready to go back in" class="md-nav__link">
      2010 06 19 almost ready to go back in
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-09-22-lack-of-updates/" title="2010 09 22 lack of updates" class="md-nav__link">
      2010 09 22 lack of updates
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-09-26-few-little-bits/" title="2010 09 26 few little bits" class="md-nav__link">
      2010 09 26 few little bits
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-10-09-v6-oil-problems..../" title="2010 10 09 v6 oil problems...." class="md-nav__link">
      2010 10 09 v6 oil problems....
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-10-12-starting-putting-the-engine-back-together/" title="2010 10 12 starting putting the engine back together" class="md-nav__link">
      2010 10 12 starting putting the engine back together
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-10-23-v6-is-broke/" title="2010 10 23 v6 is broke" class="md-nav__link">
      2010 10 23 v6 is broke
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-10-24-stripping-the-v6/" title="2010 10 24 stripping the v6" class="md-nav__link">
      2010 10 24 stripping the v6
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-10-25-v6-problem/" title="2010 10 25 v6 problem" class="md-nav__link">
      2010 10 25 v6 problem
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-11-03-picked-up-a-replacement-v6/" title="2010 11 03 picked up a replacement v6" class="md-nav__link">
      2010 11 03 picked up a replacement v6
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-12-12-been-busy-building/" title="2010 12 12 been busy building" class="md-nav__link">
      2010 12 12 been busy building
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-9" type="checkbox" id="nav-5-9">
    
    <label class="md-nav__link" for="nav-5-9">
      2011
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-9">
        2011
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-01-01-finally-driven-the-manta-again-today/" title="2011 01 01 finally driven the manta again today" class="md-nav__link">
      2011 01 01 finally driven the manta again today
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-03-13-fitting-some-new-seats/" title="2011 03 13 fitting some new seats" class="md-nav__link">
      2011 03 13 fitting some new seats
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-03-13-the-manta-got-mapped/" title="2011 03 13 the manta got mapped" class="md-nav__link">
      2011 03 13 the manta got mapped
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-03-25-went-to-brands-hatch/" title="2011 03 25 went to brands hatch" class="md-nav__link">
      2011 03 25 went to brands hatch
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-09-04-started-work-on-the-2011-rebuild/" title="2011 09 04 started work on the 2011 rebuild" class="md-nav__link">
      2011 09 04 started work on the 2011 rebuild
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-09-10-built-some-more-of-the-frame/" title="2011 09 10 built some more of the frame" class="md-nav__link">
      2011 09 10 built some more of the frame
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-09-14-started-work-on-the-new-sump-pan/" title="2011 09 14 started work on the new sump pan" class="md-nav__link">
      2011 09 14 started work on the new sump pan
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-09-15-more-subframe-work/" title="2011 09 15 more subframe work" class="md-nav__link">
      2011 09 15 more subframe work
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-09-17-gearbox-back-together/" title="2011 09 17 gearbox back together" class="md-nav__link">
      2011 09 17 gearbox back together
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-09-25-getting-ready-to-spray-the-engine-bay-again.../" title="2011 09 25 getting ready to spray the engine bay again..." class="md-nav__link">
      2011 09 25 getting ready to spray the engine bay again...
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-10-16-moving-along-with-the-rebuild/" title="2011 10 16 moving along with the rebuild" class="md-nav__link">
      2011 10 16 moving along with the rebuild
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-10-18-painted-the-engine-bay/" title="2011 10 18 painted the engine bay" class="md-nav__link">
      2011 10 18 painted the engine bay
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-11-15-dry-sump-work.../" title="2011 11 15 dry sump work..." class="md-nav__link">
      2011 11 15 dry sump work...
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-10" type="checkbox" id="nav-5-10">
    
    <label class="md-nav__link" for="nav-5-10">
      2012
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-10">
        2012
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-01-09-dry-sump-pan-is-welded/" title="2012 01 09 dry sump pan is welded" class="md-nav__link">
      2012 01 09 dry sump pan is welded
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-01-27-more-dry-sump-work/" title="2012 01 27 more dry sump work" class="md-nav__link">
      2012 01 27 more dry sump work
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-02-21-engine-is-back-in.../" title="2012 02 21 engine is back in..." class="md-nav__link">
      2012 02 21 engine is back in...
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-02-24-took-the-engine-back-out-again/" title="2012 02 24 took the engine back out again" class="md-nav__link">
      2012 02 24 took the engine back out again
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-02-27-engine-back-in-again/" title="2012 02 27 engine back in again" class="md-nav__link">
      2012 02 27 engine back in again
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-03-14-mostly-plumbed-back-in/" title="2012 03 14 mostly plumbed back in" class="md-nav__link">
      2012 03 14 mostly plumbed back in
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-04-04-started-her-up-again/" title="2012 04 04 started her up again" class="md-nav__link">
      2012 04 04 started her up again
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-04-16-ready-for-a-test-drive/" title="2012 04 16 ready for a test drive" class="md-nav__link">
      2012 04 16 ready for a test drive
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-05-09-clutch-release-bearing-failure/" title="2012 05 09 clutch release bearing failure" class="md-nav__link">
      2012 05 09 clutch release bearing failure
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-05-17-stripping-the-t5-gearbox/" title="2012 05 17 stripping the t5 gearbox" class="md-nav__link">
      2012 05 17 stripping the t5 gearbox
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-10-13-rebuilt-the-gearbox/" title="2012 10 13 rebuilt the gearbox" class="md-nav__link">
      2012 10 13 rebuilt the gearbox
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-11-11-finally-the-engines-back-in/" title="2012 11 11 finally the engines back in" class="md-nav__link">
      2012 11 11 finally the engines back in
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-11-14-nearly-back-together/" title="2012 11 14 nearly back together" class="md-nav__link">
      2012 11 14 nearly back together
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-11-25-the-finishing-touches/" title="2012 11 25 the finishing touches" class="md-nav__link">
      2012 11 25 the finishing touches
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-11-28-finally-the-v6-manta-up-a-running-again/" title="2012 11 28 finally the v6 manta up a running again" class="md-nav__link">
      2012 11 28 finally the v6 manta up a running again
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-12-30-virtually-back-on-the-road/" title="2012 12 30 virtually back on the road" class="md-nav__link">
      2012 12 30 virtually back on the road
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-11" type="checkbox" id="nav-5-11">
    
    <label class="md-nav__link" for="nav-5-11">
      2013
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-11">
        2013
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2013/2013-01-10-driven-the-manta-again/" title="2013 01 10 driven the manta again" class="md-nav__link">
      2013 01 10 driven the manta again
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2013/2013-01-15-had-a-great-blast-in-the-manta/" title="2013 01 15 had a great blast in the manta" class="md-nav__link">
      2013 01 15 had a great blast in the manta
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#reference-material" class="md-nav__link">
    Reference Material
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-code" class="md-nav__link">
    The Code
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#interrupts" class="md-nav__link">
    Interrupts
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#processor-modes" class="md-nav__link">
    Processor Modes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#coding-interrupt-handlers" class="md-nav__link">
    Coding Interrupt Handlers
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#coding-vector-tables" class="md-nav__link">
    Coding Vector Tables
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#its-all-relative" class="md-nav__link">
    It's all relative
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-interrupt-controller" class="md-nav__link">
    The Interrupt Controller
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-arm-timer-peripheral" class="md-nav__link">
    The ARM Timer Peripheral
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset" id="content">
              
                
                  <a href="https://github.com/valvers/valvers.website.src/edit/master/docs/open-software/raspberry-pi/step04-bare-metal-programming-in-cpt4.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <ul class="metadata page-metadata" data-bi-name="page info" lang="en-us" dir="ltr">
                  <li class="last-updated-holder displayDate loading">
                    <span class="last-updated-text">Last updated:</span>
                    <time role="presentation" datetime="2018-10-25T00:00:00.000Z" data-article-date-source="ms.date">2020-02-18</time>
                  </li>
                <!--
                  <li class="readingTime">
                    2 minutes to read
                  </li>
                -->
                  <li class="contributors-holder">
                    <span class="contributors-text">Contributors</span>
                    <ul class="contributors" data-bi-name="contributors"><li><a href="https://github.com/BrianSidebotham" title="Brian Sidebotham" data-bi-name="contributorprofile"><img src="../img/contributor.svg" data-src="https://avatars3.githubusercontent.com/u/5575236?v=4?size=32" alt="Brian Sidebotham"></a></li></ul>
                  </li>
                </ul>
                <h1 id="part-4-interrupts">Part 4 - Interrupts<a class="headerlink" href="#part-4-interrupts" title="Permanent link">&para;</a></h1>
<p>In this tutorial, we're going to look at using interrupts to generate the LED flash. Interrupts are an essential ingredient in embedded programming. We're going to investigate the BCM2835/6 interrupt process and implement an interrupt for the ARM Timer peripheral to blink the LED. I appreciate that blinking an LED is probably starting to get boring, but small steps are the way to learn a big system, and learning how to handle interrupts will be enough of a learning curve without having to change what we're doing at the same time. In the next tutorial we'll move away from blinking an LED.</p>
<h2 id="reference-material">Reference Material<a class="headerlink" href="#reference-material" title="Permanent link">&para;</a></h2>
<p>We need some reading material for this tutorial - this is how I put the tutorial together, by reading and studying the manuals available for the processor. Yes there's a lot of text and more than one manual - but that's the only way you learn!</p>
<p>The material that's useful:</p>
<ul>
<li><a href="http://infocenter.arm.com/help/topic/com.arm.doc.ddi0301h/DDI0301H_arm1176jzfs_r0p7_trm.pdf">ARM1176JZF-S Technical Reference Manual</a></li>
<li><a href="http://www.raspberrypi.org/wp-content/uploads/2012/02/BCM2835-ARM-Peripherals.pdf">BCM2385 ARM Peripherals</a></li>
<li><a href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.ddi0406c/index.html">ARMv6 Architecture Reference Manual</a>. This requires agreeing to an NDA to get hold of the PDF version of the document, but it's at least free and easy to get! This document also describes the ARMv7 architecture which the Cortex A7 uses in the BCM2836 (Raspberry-pi 2)</li>
</ul>
<p>All of those documents, and an ARM instruction set reference are useful for this tutorial.</p>
<h2 id="the-code">The Code<a class="headerlink" href="#the-code" title="Permanent link">&para;</a></h2>
<p>The code for the tutorial is hosted on <a href="https://github.com/BrianSidebotham/arm-tutorial-rpi">GitHub</a>. The best thing to do to get the code is to clone the repo if you haven't already. Otherwise you can <a href="https://github.com/BrianSidebotham/arm-tutorial-rpi/archive/master.zip">grab the zip</a> of the latest code instead - but you won't be able to get fixes when they're released! ;)</p>
<p>Some of the code that's specific to the tutorial and differs from the last tutorial will be discussed here.</p>
<p>This tutorial only uses the <code>part-4/armc-013</code> folder.</p>
<h2 id="interrupts">Interrupts<a class="headerlink" href="#interrupts" title="Permanent link">&para;</a></h2>
<p>Let's get straight what an interrupt is. In terms of the ARM processor we're using an interrupt is simply a type of exception. An exception in the processor causes the PC (Program Counter) to be set to a pre-defined value. This pre-defined value will cause code execution to be interrupted and for code execution to run an exception handler put the pre-defined position. At the end of this exception handler control is generally returned to the previously executing code. Exception handlers should be quick and concise as they can occur frequently and obviously take time away from the main code.</p>
<p>Interrupt signals are generally created by hardware. The exception we all know, possibly without realising it is the reset signal. If we strobe the reset line the PC is set to 0 and execution starts from this address. Reset is a bit special though, there's no way to return from the reset exception! All other exceptions can be returned from because the previous PC value has been saved.</p>
<p>Although I've stated above that when resetting a processor, execution starts at address 0, this is not always correct. For example in many processors that support bootloaders the reset value can be different so that the application code starts at address 0 and the bootloader code starts somewhere else. Upon strobing the reset line execution will start at the reset vector, which can be different to 0. The important thing here is simply the term <em>vector</em>. A vector is a value that will be loaded into the processors PC when a given condition occurs.</p>
<p>Each exception type has a vector, and these vectors reside next to each other in memory in what's termed the vector table. See, it's all pretty easy really! The base address of the vector table is 0. Vector tables come in a few varieties, either each vector is simply a value to be loaded into the PC to start execution at a linker-determined position, or else the vector is code that will be executed straight away without any need to do another PC load.</p>
<p>For the ARMv6 architecture the vector table is at memory address 0 and is organised like below, from section A2.6 of the ARM Architecture Reference Manual covering ARMv5 and ARMv6. Please note, that on the ARM documentation website all you'll see is a reference to ARMv6-M or ARMv5. ARMv6-M is for the Cortex-M range of processors which are designed to be more heavily embedded than the application processors (The Cortex-A range), so make sure you get the ARMv5 document which also covers the ARMv6 architecture (which is what the ARM1176JZF-S is).</p>
<p>For the Raspberry-pi 2 which uses the Cortex A7 processor the same table can be found in the ARMv7 reference manual in section B1.8.1 (Table B1-3). It is essentially the same.</p>
<table>
<thead>
<tr>
<th align="center">Exception Type</th>
<th align="center">Mode</th>
<th align="center">VE</th>
<th align="center">Normal Address</th>
<th align="center">High Vector Address</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">Reset</td>
<td align="center">Supervisor</td>
<td align="center"></td>
<td align="center">0x00</td>
<td align="center">0xFFFF0000</td>
</tr>
<tr>
<td align="center">Undefined Instruction</td>
<td align="center">Undefined</td>
<td align="center"></td>
<td align="center">0x04</td>
<td align="center">0xFFFF0004</td>
</tr>
<tr>
<td align="center">Software Interrupt (SWI)</td>
<td align="center">Supervisor</td>
<td align="center"></td>
<td align="center">0x08</td>
<td align="center">0xFFFF0008</td>
</tr>
<tr>
<td align="center">Prefetch Abort</td>
<td align="center">Abort</td>
<td align="center"></td>
<td align="center">0x0C</td>
<td align="center">0xFFFF000C</td>
</tr>
<tr>
<td align="center">Data Abort</td>
<td align="center">Abort</td>
<td align="center"></td>
<td align="center">0x10</td>
<td align="center">0xFFFF0010</td>
</tr>
<tr>
<td align="center">IRQ (Interrupt)</td>
<td align="center">IRQ</td>
<td align="center">0</td>
<td align="center">0x18</td>
<td align="center">0xFFFF0018</td>
</tr>
<tr>
<td align="center">IRQ (Interrupt)</td>
<td align="center">IRQ</td>
<td align="center">1</td>
<td align="center">Implementation Defined</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">FIQ (Fast Interrupt)</td>
<td align="center">FIQ</td>
<td align="center">0</td>
<td align="center">0x1C</td>
<td align="center">0xFFFF001C</td>
</tr>
<tr>
<td align="center">FIQ (Fast Interrupt)</td>
<td align="center">FIQ</td>
<td align="center">1</td>
<td align="center">Implementation Defined</td>
<td align="center"></td>
</tr>
</tbody>
</table>
<p>As you can see, as we've been discussing, the reset vector is at address 0. The next vector is for us to deal with an undefined instruction exception, an unlikely scenario, but something we can at least trap and debug at some point. Following that we have the Software Interrupt, Pre-fetch abort, Data Abort, IRQ (Interrupt) and FIQ (Fast Interrupt) exception vectors. The vectors are sequential except between Data Abort and IRQ where there is an 4-byte gap. The note above the table in the document reads:</p>
<p>NOTE: The normal vector at address 0x00000014 and the high vector at address 0xFFFF0014 are reserved for future expansion.</p>
<p>Vectors are only 4-bytes (one 32-bit instruction) apart. We know therefore the reset vector is simply going to be a branch instruction to the start of our actual code so that the undefined instruction exception can be implemented too. In fact, each of these vectors is simply a branch instruction to a handler somewhere else in memory.</p>
<p>The Normal Address is what we're interested in on the Raspberry-Pi. The High Vector Address is selected in hardware, and that hardware doesn't exist, so the vectors reside at the normal addresses. It's useful, as I've said before to have another place to start executing code if we need a different application installed such as another bootloader or something. We can ignore the High Vector Addresses.</p>
<p>Then we have the Mode column - this is going to be very important. If we look at the vector table, the mode listed for the reset vector is Supervisor.</p>
<h2 id="processor-modes">Processor Modes<a class="headerlink" href="#processor-modes" title="Permanent link">&para;</a></h2>
<p>Further back in section A2.2 of the ARM Architecture Reference Manual the documentation covers processors modes. When the processor is reset it is running in Supervisor mode, which is known as a privileged mode. From this operating mode we can write to most of the processors registers and can also change the processors current mode. The only mode that cannot change modes is User - this is designed to execute applications, whereas the privileged modes are meant for operating system tasks.</p>
<p>There is basically a mode per exception. As was mentioned previously we start at the reset vector in Supervisor mode, so far all of our code has operating in that single mode. However, when an exception occurs the processor changes mode to the exception-specific mode. The mode can also be changed in software too if necessary.</p>
<p>The next section of the Architecture Reference Manual describes the registers available. This is again, another important section. Look at Figure A2-1 (Register Organization) and you'll see something interesting...</p>
<p><img alt="ARMv5 Figure A2-1" src="https://github.com/BrianSidebotham/arm-tutorial-rpi/raw/master/part-4/armc-013/img/arm-tutorial-rpi/armv5-figure-a2-1-register-organization.png" /></p>
<p>As seen by the small icon and note at the bottom of the table, some of the registers are mode-specific. This can be useful, for example in the Fast Interrupt exception a lot of registers have been replaced by mode-specific registers. This means that we can use these registers without fear of altering the behaviour of code that was operating in User or Supervisor mode before the Fast Interrupt Exception occurred.</p>
<p>Normally, the first thing we would need to do in an interrupt handler would be to save the registers we're going to use and the last thing we'd do in an interrupt handler would be to restore those registers values to what they were before the interrupt handler executed. The code like this at the start of a function or interrupt handler is called the prologue and the code at the end of the function or handler is known as the epilogue.</p>
<p>The shadow register implementation means that many times there's no need to save and restore registers in a Fast Interrupt service routine.</p>
<h2 id="coding-interrupt-handlers">Coding Interrupt Handlers<a class="headerlink" href="#coding-interrupt-handlers" title="Permanent link">&para;</a></h2>
<p>Providing interrupt handlers can be a bit tricky. It's generally entirely non-portable and you'll have to read the manual for your toolchain in order to understand how to write them. This generally involves informing the compiler that a function you declare should be used to handle a type of interrupt. The toolchain can them fill the vector table with the necessary information. The vector table is usually present in the linker script which defines the memory layout of the target device. because normally these vectors are read-only.</p>
<p>For gcc and ld we can look at the gcc manual on function attributes relating to ARM. <a href="https://gcc.gnu.org/onlinedocs/gcc/Function-Attributes.html">https://gcc.gnu.org/onlinedocs/gcc/Function-Attributes.html</a></p>
<p>It reads:</p>
<blockquote>
<p>Use this attribute on the ARC, ARM, AVR, CR16, ... ports to indicate that
the specified function is an interrupt handler. The compiler generates
function entry and exit sequences suitable for use in an interrupt handler
when this attribute is present.</p>
<p>NOTE, for the ARM, you can specify the kind of interrupt to be handled by
adding an optional parameter to the interrupt attribute like this:</p>
<div class="codehilite"><pre><span></span><code>  void f () __attribute__ ((interrupt (&quot;IRQ&quot;)));
</code></pre></div>


<p>Permissible values for this parameter are: IRQ, FIQ, SWI, ABORT and UNDEF.</p>
</blockquote>
<p>The parameter options align well with the vector table we got from the manual. Reset is an ABORT type, and everything else has a parameter available.</p>
<p>Therefore to write a very basic "undefined instruction" handler we can define declare and implement our handler like this:</p>
<div class="codehilite"><pre><span></span><code>    <span class="cm">/**</span>
<span class="cm">        @brief The undefined instruction interrupt handler</span>

<span class="cm">        If an undefined instruction is encountered, the CPU will start</span>
<span class="cm">        executing this function. Just trap here as a debug solution.</span>
<span class="cm">    */</span>
    <span class="kt">void</span> <span class="nf">__attribute__</span><span class="p">((</span><span class="n">interrupt</span><span class="p">(</span><span class="s">&quot;UNDEF&quot;</span><span class="p">)))</span> <span class="n">undefined_instruction_vector</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">while</span><span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="cm">/* Do Nothing! */</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>

<p>While it looks like this is useless code, it is actually pretty useful. We can set a breakpoint on the while(1) and debug whilst looking out for this breakpoint to trip. Usually then we can do some stack unwinding (manually!) to find where the source of the undefined instruction.</p>
<h2 id="coding-vector-tables">Coding Vector Tables<a class="headerlink" href="#coding-vector-tables" title="Permanent link">&para;</a></h2>
<p>A strange title that, Coding Vector Tables. With many embedded processors there's no coding or runtime setup of vector tables - instead the vector table is defined in the linker script and the toolchain fills in those locations with the address or jump instruction necessary to execute the relevant handler.</p>
<p>The Raspberry-Pi vector table is extremely small, and it can be like this because some extra work is required in the Interrupt handler compared to more embedded processors such as the Cortex M range. No matter what the Interrupt source is, the same function is called. Inside the Interrupt handler we must work out what the source of the interrupt was before handling that interrupt. Essentially you end up with a large switch structure inside the interrupt handler. You can of course call other functions from the interrupt handler, but again think about the cost of the prologue and epilogue before you do!</p>
<p>When the raspberry-pi starts running our code, as we've discovered earlier in the turotials it loads the code from the SD card to RAM at address 0x00008000 and then starts executing the code. So how can we possibly code the vector table and get the correct jump instructions into the vector table?</p>
<p>Well, everything is in RAM and that's the key - this is read/write memory and in supervisor mode we can write to any location we want. So at runtime when our code is being executed we can overwrite the vector table at runtime. All we need is a vector table to write.</p>
<p>Let's have a look at what needs to be done to implement the vector table. It's easiest if we drop down to assembler to do this. It really could do with being done as the very first thing in our code anyway so it's setup right from the start.</p>
<p>Here is some modified assembler for our _statup: label which is where our linker knows we want to start execution. The linker makes sure this is at the start of our binary:</p>
<p>At fist, I thought this was going to be easy - we just hard-code some values into a table and copy that table to the start of RAM where the vector table resides. Here's some initial code:</p>
<div class="codehilite"><pre><span></span><code>    _start:
        ldr pc, =_reset_
        ldr pc, =undefined_instruction_vector
        ldr pc, =software_interrupt_vector
        ldr pc, =prefetch_abort_vector
        ldr pc, =_reset_
        ldr pc, =_reset_
        ldr pc, =interrupt_vector
        ldr pc, =fast_interrupt_vector

    _reset_:
        // Copy the vector table to the active table at 0x00000000
        ldr     r0, =_start
        ldr     r1, #0x0000
        ldmia   r0!,{r2, r3, r4, r5, r6, r7, r8, r9}
        stmia   r1!,{r2, r3, r4, r5, r6, r7, r8, r9}
</code></pre></div>

<p>There are only a few assembler instructions here, so don't panic! The labels refer to C functions that have been implemented with the correct attributes for each exception type. See the file rpi-interrupts.c to see these C functions.</p>
<p>The Loading of addresses to a register with LDR is documented <a href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.dui0473c/Bgbbfgia.html">here</a></p>
<p><em>reset</em> and undefined_instruction_vector, etc. are the labels used as the function addresses. So we have a table at the very start of our code. A neat side-effect of having this table right at the start of our code is that the first thing we do is run the reset vector code which jumps to the <em>reset</em> label and starts the execution of our code, thus jumping the vector table we don't want it to try and execute. Excellent!</p>
<p>The ldmia and stmia instructions can load and store 32 bytes of data at a time, so are quick at shifting data about. Each register can load a 4-byte (32-bit) value, so using eight registers lets us move 32-bytes, and there are 8 32-bit vectors in our table, so one load and one store instruction later we've moved the whole of our vector table to 0x00000000.</p>
<p>See the documentation for this on the <a href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.dui0068b/BABEFCIB.html">ARM website</a></p>
<p>But, before we go too much further, let me show you why this doesn't work!</p>
<h3 id="its-all-relative">It's all relative<a class="headerlink" href="#its-all-relative" title="Permanent link">&para;</a></h3>
<p>Compilation of the vector table is successful, but as always just a successful compilation doesn't get you a working application. Earlier in the tutorials I introduced the online disassembler - a great tool, but there's something else in our toolchain's toolbag already, objdump!</p>
<div class="codehilite"><pre><span></span><code>    arm-none-eabi-objdump --help
</code></pre></div>

<p>That's your friend, and even more friendly is running this from the build directory of the part-4/armc-013/ tutorial folder once you've built the tutorial:</p>
<div class="codehilite"><pre><span></span><code>    arm-none-eabi-objdump -S armc-013 &gt; armc-013.disasm
</code></pre></div>

<p>This tells objdump to disassemble the executable and we then redirect objdumps output to the armc-013.diasm file which we can then look at in a text editor. Here's what we get at the start of that file with the vector table implementation I described above:</p>
<div class="codehilite"><pre><span></span><code>    Disassembly of section .text:

    00008000 &lt;_start&gt;:
        8000:   e59ff064    ldr pc, [pc, #100]  ; 806c &lt;_enable_interrupts+0x10&gt;
        8004:   e59ff064    ldr pc, [pc, #100]  ; 8070 &lt;_enable_interrupts+0x14&gt;
        8008:   e59ff064    ldr pc, [pc, #100]  ; 8074 &lt;_enable_interrupts+0x18&gt;
        800c:   e59ff064    ldr pc, [pc, #100]  ; 8078 &lt;_enable_interrupts+0x1c&gt;
        8010:   e59ff054    ldr pc, [pc, #84]   ; 806c &lt;_enable_interrupts+0x10&gt;
        8014:   e59ff050    ldr pc, [pc, #80]   ; 806c &lt;_enable_interrupts+0x10&gt;
        8018:   e59ff05c    ldr pc, [pc, #92]   ; 807c &lt;_enable_interrupts+0x20&gt;
        801c:   e59ff05c    ldr pc, [pc, #92]   ; 8080 &lt;_enable_interrupts+0x24&gt;

    00008020 &lt;_reset_&gt;:
        8020:   e3a00902    mov r0, #32768  ; 0x8000
</code></pre></div>

<p>Hmmm, well that doesn't look right, what we'd expect from the first line is an equivalent of ldr pc, #0x8020 which is the <em>reset</em> label is. The toolchain appears to be loading a value far away from where we'd expect. Further down the file we can find the location 0x806C:</p>
<div class="codehilite"><pre><span></span><code>    0000805c &lt;_enable_interrupts&gt;:
        805c:   e10f0000    mrs r0, CPSR
        8060:   e3c00080    bic r0, r0, #128    ; 0x80
        8064:   e121f000    msr CPSR_c, r0
        8068:   e1a0f00e    mov pc, lr
        806c:   00008020    .word   0x00008020
        8070:   000085e8    .word   0x000085e8
        8074:   000085f4    .word   0x000085f4
        8078:   00008600    .word   0x00008600
        807c:   00008628    .word   0x00008628
        8080:   0000869c    .word   0x0000869c
</code></pre></div>

<p>Some light at the end of the tunnel, the compiler has inserted some constants which are being loaded into the PC so actually, loading the PC with the value at PC + 0x6C is correct for the vector because the value at that location is 0x8020 which is the location of the <em>reset</em> label.</p>
<p>Again, we think this could work after all. But of course, it doesn't. The first part of our code now moves the code from 0x8000 to 0x0000 and the constants have not moved from 0x806C to 0x006C; Neither can we move these constants easily either because the compiler inserts these at the next available space, there's no position we can predict.</p>
<p>The answer is to keep everything relative, but to create some constants of our own. We can keep these constants relative to the LDR PC instruction so that the relative offset still works. We need to create a table of constant addresses after the vector table loads. This way we can copy both tables and the constants will still be in the same position relative to the LDR instructions.</p>
<p>Let's set that up:</p>
<div class="codehilite"><pre><span></span><code>    _start:
        ldr pc, _reset_h
        ldr pc, _undefined_instruction_vector_h
        ldr pc, _software_interrupt_vector_h
        ldr pc, _prefetch_abort_vector_h
        ldr pc, _data_abort_vector_h
        ldr pc, _unused_handler_h
        ldr pc, _interrupt_vector_h
        ldr pc, _fast_interrupt_vector_h

    _reset_h:                           .word   _reset_
    _undefined_instruction_vector_h:    .word   undefined_instruction_vector
    _software_interrupt_vector_h:       .word   software_interrupt_vector
    _prefetch_abort_vector_h:           .word   prefetch_abort_vector
    _data_abort_vector_h:               .word   data_abort_vector
    _unused_handler_h:                  .word   _reset_
    _interrupt_vector_h:                .word   interrupt_vector
    _fast_interrupt_vector_h:           .word   fast_interrupt_vector

    _reset_:

        mov     r0, #0x8000
        mov     r1, #0x0000
        ldmia   r0!,{r2, r3, r4, r5, r6, r7, r8, r9}
        stmia   r1!,{r2, r3, r4, r5, r6, r7, r8, r9}
        ldmia   r0!,{r2, r3, r4, r5, r6, r7, r8, r9}
        stmia   r1!,{r2, r3, r4, r5, r6, r7, r8, r9}
</code></pre></div>

<p>Note that we've now had to double the amount of data we copy so that we get the constants copied along with the relative PC loads of those constants. This feels like a bit of a cludge but as objdump will show us, this gets the job done and relocates the vector table as required.</p>
<p>The vector table now references the labels directly suffixed to the vector table itself and so the relative position remains constant so long as both are copied as-is.</p>
<p>The output of <code>objdump -S</code> shows us the workable solution:</p>
<div class="codehilite"><pre><span></span><code>    Disassembly of section .text:

    00008000 &lt;_start&gt;:
        8000:   e59ff018    ldr pc, [pc, #24]   ; 8020 &lt;_reset_h&gt;
        8004:   e59ff018    ldr pc, [pc, #24]   ; 8024 &lt;_undefined_instruction_vector_h&gt;
        8008:   e59ff018    ldr pc, [pc, #24]   ; 8028 &lt;_software_interrupt_vector_h&gt;
        800c:   e59ff018    ldr pc, [pc, #24]   ; 802c &lt;_prefetch_abort_vector_h&gt;
        8010:   e59ff018    ldr pc, [pc, #24]   ; 8030 &lt;_data_abort_vector_h&gt;
        8014:   e59ff018    ldr pc, [pc, #24]   ; 8034 &lt;_unused_handler_h&gt;
        8018:   e59ff018    ldr pc, [pc, #24]   ; 8038 &lt;_interrupt_vector_h&gt;
        801c:   e59ff018    ldr pc, [pc, #24]   ; 803c &lt;_fast_interrupt_vector_h&gt;

    00008020 &lt;_reset_h&gt;:
        8020:   00008040    .word   0x00008040

    00008024 &lt;_undefined_instruction_vector_h&gt;:
        8024:   000085f8    .word   0x000085f8

    00008028 &lt;_software_interrupt_vector_h&gt;:
        8028:   00008604    .word   0x00008604

    0000802c &lt;_prefetch_abort_vector_h&gt;:
        802c:   00008610    .word   0x00008610

    00008030 &lt;_data_abort_vector_h&gt;:
        8030:   00008624    .word   0x00008624

    00008034 &lt;_unused_handler_h&gt;:
        8034:   00008040    .word   0x00008040

    00008038 &lt;_interrupt_vector_h&gt;:
        8038:   00008638    .word   0x00008638

    0000803c &lt;_fast_interrupt_vector_h&gt;:
        803c:   000086ac    .word   0x000086ac

    00008040 &lt;_reset_&gt;:
        8040:   e3a00902    mov r0, #32768  ; 0x8000
</code></pre></div>

<p>You can go ahead and see that the armc-013 tutorial is in fact using this solution to provide the exception vector table at run time.</p>
<h2 id="the-interrupt-controller">The Interrupt Controller<a class="headerlink" href="#the-interrupt-controller" title="Permanent link">&para;</a></h2>
<p>So now we have the exception vectors tied to our exception handlers (which are implemented in C) but the processor still doesn't know when to interrupt.</p>
<p>Interrupts on a processor are enabled per interrupt source and then globally enabled and disabled. This way we can select which interrupt sources we're interested in and also whether to allow interrupts or not. Sometimes we want to temporarily disable interrupts to guard a non-atomic memory operation if the same memory is used in an interrupt handler for example.</p>
<p>The Raspberry-Pi ARM has an interrupt controller where we can set up the enable and disable the interrupt sources we're interested in. From the <a href="http://www.raspberrypi.org/wp-content/uploads/2012/02/BCM2835-ARM-Peripherals.pdf">BCM2835 ARM peripherals datasheet</a> we can see section 7 describe the interrupt controller present.</p>
<p>The documentation here is a bit lacking - but see the section that says ARM peripherals interrupts table. These are basically the interrupt sources we have control over.</p>
<p>We're blinking an LED and so we just want to capture the ARM Timer interrupt source. In the tutorial code, we will map a C structure to the address of the interrupt controller to give us access to the registers.</p>
<p>This is how we define the struct for the interrupt controller registers and implement an instance at the base address, again this information is from section 7.5 of the document above:</p>
<p>In rpi-interrupts.h:</p>
<div class="codehilite"><pre><span></span><code>    <span class="cm">/** @brief See Section 7.5 of the BCM2835 ARM Peripherals documentation, the base</span>
<span class="cm">        address of the controller is actually xxxxB000, but there is a 0x200 offset</span>
<span class="cm">        to the first addressable register for the interrupt controller, so offset the</span>
<span class="cm">        base to the first register */</span>
    <span class="cp">#define RPI_INTERRUPT_CONTROLLER_BASE   ( PERIPHERAL_BASE + 0xB200 )</span>

    <span class="cm">/** @brief The interrupt controller memory mapped register set */</span>
    <span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
        <span class="k">volatile</span> <span class="kt">uint32_t</span> <span class="n">IRQ_basic_pending</span><span class="p">;</span>
        <span class="k">volatile</span> <span class="kt">uint32_t</span> <span class="n">IRQ_pending_1</span><span class="p">;</span>
        <span class="k">volatile</span> <span class="kt">uint32_t</span> <span class="n">IRQ_pending_2</span><span class="p">;</span>
        <span class="k">volatile</span> <span class="kt">uint32_t</span> <span class="n">FIQ_control</span><span class="p">;</span>
        <span class="k">volatile</span> <span class="kt">uint32_t</span> <span class="n">Enable_IRQs_1</span><span class="p">;</span>
        <span class="k">volatile</span> <span class="kt">uint32_t</span> <span class="n">Enable_IRQs_2</span><span class="p">;</span>
        <span class="k">volatile</span> <span class="kt">uint32_t</span> <span class="n">Enable_Basic_IRQs</span><span class="p">;</span>
        <span class="k">volatile</span> <span class="kt">uint32_t</span> <span class="n">Disable_IRQs_1</span><span class="p">;</span>
        <span class="k">volatile</span> <span class="kt">uint32_t</span> <span class="n">Disable_IRQs_2</span><span class="p">;</span>
        <span class="k">volatile</span> <span class="kt">uint32_t</span> <span class="n">Disable_Basic_IRQs</span><span class="p">;</span>
        <span class="p">}</span> <span class="n">rpi_irq_controller_t</span><span class="p">;</span>
</code></pre></div>

<p>and in rpi-interrupts.c:</p>
<div class="codehilite"><pre><span></span><code>    <span class="cm">/** @brief The BCM2835 Interupt controller peripheral at it&#39;s base address */</span>
    <span class="k">static</span> <span class="n">rpi_irq_controller_t</span><span class="o">*</span> <span class="n">rpiIRQController</span> <span class="o">=</span>
            <span class="p">(</span><span class="n">rpi_irq_controller_t</span><span class="o">*</span><span class="p">)</span><span class="n">RPI_INTERRUPT_CONTROLLER_BASE</span><span class="p">;</span>


    <span class="cm">/**</span>
<span class="cm">        @brief Return the IRQ Controller register set</span>
<span class="cm">    */</span>
    <span class="n">rpi_irq_controller_t</span><span class="o">*</span> <span class="nf">RPI_GetIrqController</span><span class="p">(</span> <span class="kt">void</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">rpiIRQController</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>

<h2 id="the-arm-timer-peripheral">The ARM Timer Peripheral<a class="headerlink" href="#the-arm-timer-peripheral" title="Permanent link">&para;</a></h2>
<p>The ARM timer is in the Basic interrupt set. So to tell the processor we want to enable interrupts from the ARM Timer peripheral we set the relevant bit in the Basic Interrupt enable register:</p>
<p>Also in rpi-interrupts.h:</p>
<div class="codehilite"><pre><span></span><code>    <span class="cm">/** @brief Bits in the Enable_Basic_IRQs register to enable various interrupts.</span>
<span class="cm">        See the BCM2835 ARM Peripherals manual, section 7.5 */</span>
    <span class="cp">#define RPI_BASIC_ARM_TIMER_IRQ         (1 &lt;&lt; 0)</span>
    <span class="cp">#define RPI_BASIC_ARM_MAILBOX_IRQ       (1 &lt;&lt; 1)</span>
    <span class="cp">#define RPI_BASIC_ARM_DOORBELL_0_IRQ    (1 &lt;&lt; 2)</span>
    <span class="cp">#define RPI_BASIC_ARM_DOORBELL_1_IRQ    (1 &lt;&lt; 3)</span>
    <span class="cp">#define RPI_BASIC_GPU_0_HALTED_IRQ      (1 &lt;&lt; 4)</span>
    <span class="cp">#define RPI_BASIC_GPU_1_HALTED_IRQ      (1 &lt;&lt; 5)</span>
    <span class="cp">#define RPI_BASIC_ACCESS_ERROR_1_IRQ    (1 &lt;&lt; 6)</span>
    <span class="cp">#define RPI_BASIC_ACCESS_ERROR_0_IRQ    (1 &lt;&lt; 7)</span>
</code></pre></div>

<p>and in our main C code to enable the ARM Timer IRQ:</p>
<div class="codehilite"><pre><span></span><code>    <span class="cm">/* Enable the timer interrupt IRQ */</span>
    <span class="n">RPI_GetIrqController</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Enable_Basic_IRQs</span> <span class="o">=</span> <span class="n">RPI_BASIC_ARM_TIMER_IRQ</span><span class="p">;</span>
</code></pre></div>

<p>The ARM Timer interrupt source is now enabled. However, the processor still needs to have interrupts globally enabled for any interrupt to execute the Interrupt handler, and the ARM Timer peripheral also needs to be enabled and configured to generate the interrupts!</p>
<p>The ARM Timer peripheral is documented in the same <a href="http://www.raspberrypi.org/wp-content/uploads/2012/02/BCM2835-ARM-Peripherals.pdf">BCM2835 ARM peripherals datasheet</a> in section 14.</p>
<p>Again, we map the peripherals register set to a C struct to give us access to the registers:</p>
<p>In rpi-armtimer.h:</p>
<div class="codehilite"><pre><span></span><code>    <span class="cm">/** @brief See the documentation for the ARM side timer (Section 14 of the</span>
<span class="cm">        BCM2835 Peripherals PDF) */</span>
    <span class="cp">#define RPI_ARMTIMER_BASE               ( PERIPHERAL_BASE + 0xB400 )</span>

    <span class="cm">/** @brief 0 : 16-bit counters - 1 : 23-bit counter */</span>
    <span class="cp">#define RPI_ARMTIMER_CTRL_23BIT         ( 1 &lt;&lt; 1 )</span>

    <span class="cp">#define RPI_ARMTIMER_CTRL_PRESCALE_1    ( 0 &lt;&lt; 2 )</span>
    <span class="cp">#define RPI_ARMTIMER_CTRL_PRESCALE_16   ( 1 &lt;&lt; 2 )</span>
    <span class="cp">#define RPI_ARMTIMER_CTRL_PRESCALE_256  ( 2 &lt;&lt; 2 )</span>

    <span class="cm">/** @brief 0 : Timer interrupt disabled - 1 : Timer interrupt enabled */</span>
    <span class="cp">#define RPI_ARMTIMER_CTRL_INT_ENABLE    ( 1 &lt;&lt; 5 )</span>
    <span class="cp">#define RPI_ARMTIMER_CTRL_INT_DISABLE   ( 0 &lt;&lt; 5 )</span>

    <span class="cm">/** @brief 0 : Timer disabled - 1 : Timer enabled */</span>
    <span class="cp">#define RPI_ARMTIMER_CTRL_ENABLE        ( 1 &lt;&lt; 7 )</span>
    <span class="cp">#define RPI_ARMTIMER_CTRL_DISABLE       ( 0 &lt;&lt; 7 )</span>

    <span class="cm">/** @brief Section 14.2 of the BCM2835 Peripherals documentation details</span>
<span class="cm">        the register layout for the ARM side timer */</span>
    <span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>

        <span class="cm">/** The timer load register sets the time for the timer to count down.</span>
<span class="cm">            This value is loaded into the timer value register after the load</span>
<span class="cm">            register has been written or if the timer-value register has counted</span>
<span class="cm">            down to 0. */</span>
        <span class="k">volatile</span> <span class="kt">uint32_t</span> <span class="n">Load</span><span class="p">;</span>

        <span class="cm">/** This register holds the current timer value and is counted down when</span>
<span class="cm">            the counter is running. It is counted down each timer clock until the</span>
<span class="cm">            value 0 is reached. Then the value register is re-loaded from the</span>
<span class="cm">            timer load register and the interrupt pending bit is set. The timer</span>
<span class="cm">            count down speed is set by the timer pre-divide register. */</span>
        <span class="k">volatile</span> <span class="kt">uint32_t</span> <span class="n">Value</span><span class="p">;</span>

        <span class="cm">/** The standard SP804 timer control register consist of 8 bits but in the</span>
<span class="cm">            BCM implementation there are more control bits for the extra features.</span>
<span class="cm">            Control bits 0-7 are identical to the SP804 bits, albeit some</span>
<span class="cm">            functionality of the SP804 is not implemented. All new control bits</span>
<span class="cm">            start from bit 8 upwards. */</span>
        <span class="k">volatile</span> <span class="kt">uint32_t</span> <span class="n">Control</span><span class="p">;</span>

        <span class="cm">/** The timer IRQ clear register is write only. When writing this register</span>
<span class="cm">            the interrupt-pending bit is cleared. When reading this register it</span>
<span class="cm">            returns 0x544D5241 which is the ASCII reversed value for &quot;ARMT&quot;. */</span>
        <span class="k">volatile</span> <span class="kt">uint32_t</span> <span class="n">IRQClear</span><span class="p">;</span>

        <span class="cm">/** The raw IRQ register is a read-only register. It shows the status of</span>
<span class="cm">            the interrupt pending bit. 0 : The interrupt pending bits is clear.</span>
<span class="cm">            1 : The interrupt pending bit is set.</span>

<span class="cm">            The interrupt pending bits is set each time the value register is</span>
<span class="cm">            counted down to zero. The interrupt pending bit can not by itself</span>
<span class="cm">            generates interrupts. Interrupts can only be generated if the</span>
<span class="cm">            interrupt enable bit is set. */</span>
        <span class="k">volatile</span> <span class="kt">uint32_t</span> <span class="n">RAWIRQ</span><span class="p">;</span>

        <span class="cm">/** The masked IRQ register is a read-only register. It shows the status</span>
<span class="cm">            of the interrupt signal. It is simply a logical AND of the interrupt</span>
<span class="cm">            pending bit and the interrupt enable bit. 0 : Interrupt line not</span>
<span class="cm">            asserted. 1 :Interrupt line is asserted, (the interrupt pending and</span>
<span class="cm">            the interrupt enable bit are set.)  */</span>
        <span class="k">volatile</span> <span class="kt">uint32_t</span> <span class="n">MaskedIRQ</span><span class="p">;</span>

        <span class="cm">/** This register is a copy of the timer load register. The difference is</span>
<span class="cm">            that a write to this register does not trigger an immediate reload of</span>
<span class="cm">            the timer value register. Instead the timer load register value is</span>
<span class="cm">            only accessed if the value register has finished counting down to</span>
<span class="cm">            zero. */</span>
        <span class="k">volatile</span> <span class="kt">uint32_t</span> <span class="n">Reload</span><span class="p">;</span>

        <span class="cm">/** The Pre-divider register is not present in the SP804. The pre-divider</span>
<span class="cm">            register is 10 bits wide and can be written or read from. This</span>
<span class="cm">            register has been added as the SP804 expects a 1MHz clock which we do</span>
<span class="cm">            not have. Instead the pre-divider takes the APB clock and divides it</span>
<span class="cm">            down according to:</span>

<span class="cm">            timer_clock = apb_clock/(pre_divider+1)</span>

<span class="cm">            The reset value of this register is 0x7D so gives a divide by 126. */</span>
        <span class="k">volatile</span> <span class="kt">uint32_t</span> <span class="n">PreDivider</span><span class="p">;</span>

        <span class="cm">/** The free running counter is not present in the SP804. The free running</span>
<span class="cm">            counter is a 32 bits wide read only register. The register is enabled</span>
<span class="cm">            by setting bit 9 of the Timer control register. The free running</span>
<span class="cm">            counter is incremented immediately after it is enabled. The timer can</span>
<span class="cm">            not be reset but when enabled, will always increment and roll-over.</span>

<span class="cm">            The free running counter is also running from the APB clock and has</span>
<span class="cm">            its own clock pre-divider controlled by bits 16-23 of the timer</span>
<span class="cm">            control register.</span>

<span class="cm">            This register will be halted too if bit 8 of the control register is</span>
<span class="cm">            set and the ARM is in Debug Halt mode. */</span>
        <span class="k">volatile</span> <span class="kt">uint32_t</span> <span class="n">FreeRunningCounter</span><span class="p">;</span>

        <span class="p">}</span> <span class="n">rpi_arm_timer_t</span><span class="p">;</span>
</code></pre></div>

<p>and the same in rpi-armtimer.c:</p>
<div class="codehilite"><pre><span></span><code>    <span class="k">static</span> <span class="n">rpi_arm_timer_t</span><span class="o">*</span> <span class="n">rpiArmTimer</span> <span class="o">=</span> <span class="p">(</span><span class="n">rpi_arm_timer_t</span><span class="o">*</span><span class="p">)</span><span class="n">RPI_ARMTIMER_BASE</span><span class="p">;</span>

    <span class="n">rpi_arm_timer_t</span><span class="o">*</span> <span class="nf">RPI_GetArmTimer</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">rpiArmTimer</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>

<p>Then, we can setup the ARM Timer peripheral from the main C code with something like:</p>
<div class="codehilite"><pre><span></span><code>    <span class="cm">/* Setup the system timer interrupt */</span>
    <span class="cm">/* Timer frequency = Clk/256 * 0x400 */</span>
    <span class="n">RPI_GetArmTimer</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Load</span> <span class="o">=</span> <span class="mh">0x400</span><span class="p">;</span>

    <span class="cm">/* Setup the ARM Timer */</span>
    <span class="n">RPI_GetArmTimer</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Control</span> <span class="o">=</span>
            <span class="n">RPI_ARMTIMER_CTRL_23BIT</span> <span class="o">|</span>
            <span class="n">RPI_ARMTIMER_CTRL_ENABLE</span> <span class="o">|</span>
            <span class="n">RPI_ARMTIMER_CTRL_INT_ENABLE</span> <span class="o">|</span>
            <span class="n">RPI_ARMTIMER_CTRL_PRESCALE_256</span><span class="p">;</span>
</code></pre></div>

<p>As documented the load register is the value loaded into the timer each time the timer elapses. This value is loaded into the Value register either when the register is written, or else when the Value register has counted down to 0. The timer decrements the Value register at a frequency dervied from the system clock.</p>
<p>When the Value register reaches 0 the Value register is re-loaded with the Load value and the interrupt pending bit is set.</p>
<p>It's at this point our interrupt handler should get called. The bits in the Control register that we're setting should be reasonably self-explanatory. Although the documentation says CTRL_23BIT I suspect (as do others) that this is a typo and it's meant to read CTRL_32BIT!</p>
<p>All that's left after configuring the ARM Timer and the Interrupt controller is to globally enable interrupts. This is a function that I wrote in assembler again because the instructions to enable the registers are not available through any C instructions:</p>
<p>In armc-013-start.S:</p>
<div class="codehilite"><pre><span></span><code>    _enable_interrupts:
        mrs     r0, cpsr
        bic     r0, r0, #0x80
        msr     cpsr_c, r0

        mov     pc, lr
</code></pre></div>

<p>This code is pretty straight forward. Section A1.1.3 of the ARM ARM describes the Status registers in the processor and describes the Current Program Status Register (CPSR). Some information is covered in this section and of important note is "The CPSR is accessed with special instructions".</p>
<p>Section A2.5 of the ARM ARM describes the format of the CPSR register in more detail and details the exact layout of the CPSR register.</p>
<p>Section A2.5.6 describes the interrupt disable bits, and that gets us the last bit of information we need.</p>
<p>Section A4.1.38 MRS describes the Move Program Status Register to general purpose register instruction which is the special instruction referred to in Section A1.1.3 of the manual.</p>
<p>So, we copy the contents of the Current Program Status Register into R0.</p>
<p>Then we clear bit 7 ( Remember (1 &lt;&lt; 7) == 0x80 ) in the R0 to enable interrupts. Section A2.5.6 and A2.5 gave us the details for that instruction.</p>
<p>Then we copy r0 back to the Current Program Status Register which is the point at which interrupts become enabled.</p>
<p>Finally we load the Program Counter with the Link Register contents to return from enabling interrupts.</p>
<p>The last thing to do is to write something in the interrupt handler to deal with toggling the LED and to clear the interrupt pending bit. Clearing the interrupt pending bit for the ARM Timer is essential otherwise the processor will not know we have dealt with that interrupt and as soon as it exits from the interrupt handler it will immediately enter it again because the interrupt pending bit of an enabled interrupt source is still set.</p>
<p>The interrupt handler is in rpi-interrupts.c:</p>
<div class="codehilite"><pre><span></span><code>    <span class="cm">/**</span>
<span class="cm">        @brief The IRQ Interrupt handler</span>

<span class="cm">        This handler is run every time an interrupt source is triggered. It&#39;s</span>
<span class="cm">        up to the handler to determine the source of the interrupt and most</span>
<span class="cm">        importantly clear the interrupt flag so that the interrupt won&#39;t</span>
<span class="cm">        immediately put us back into the start of the handler again.</span>
<span class="cm">    */</span>
    <span class="kt">void</span> <span class="nf">__attribute__</span><span class="p">((</span><span class="n">interrupt</span><span class="p">(</span><span class="s">&quot;IRQ&quot;</span><span class="p">)))</span> <span class="n">interrupt_vector</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">static</span> <span class="kt">int</span> <span class="n">lit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="cm">/* Clear the ARM Timer interrupt - it&#39;s the only interrupt we have</span>
<span class="cm">           enabled, so we want don&#39;t have to work out which interrupt source</span>
<span class="cm">           caused us to interrupt */</span>
        <span class="n">RPI_GetArmTimer</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">IRQClear</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

        <span class="cm">/* Flip the LED */</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">lit</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="n">LED_OFF</span><span class="p">();</span>
            <span class="n">lit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">LED_ON</span><span class="p">();</span>
            <span class="n">lit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>

<p>Simples! Our main code now has no code in the main while(1) {} loop because everything is being done in the interrupt handler.</p>
<p>part-4/armc-013/armc-013.c:</p>
<div class="codehilite"><pre><span></span><code>    <span class="cm">/** Main function - we&#39;ll never return from here */</span>
    <span class="kt">void</span> <span class="nf">kernel_main</span><span class="p">(</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r0</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r1</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">atags</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="cm">/* Write 1 to the LED init nibble in the Function Select GPIO</span>
<span class="cm">           peripheral register to enable LED pin as an output */</span>
        <span class="n">RPI_GetGpio</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">LED_GPFSEL</span> <span class="o">|=</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">LED_GPFBIT</span><span class="p">);</span>

        <span class="cm">/* Enable the timer interrupt IRQ */</span>
        <span class="n">RPI_GetIrqController</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Enable_Basic_IRQs</span> <span class="o">=</span> <span class="n">RPI_BASIC_ARM_TIMER_IRQ</span><span class="p">;</span>

        <span class="cm">/* Setup the system timer interrupt */</span>
        <span class="cm">/* Timer frequency = Clk/256 * 0x400 */</span>
        <span class="n">RPI_GetArmTimer</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Load</span> <span class="o">=</span> <span class="mh">0x400</span><span class="p">;</span>

        <span class="cm">/* Setup the ARM Timer */</span>
        <span class="n">RPI_GetArmTimer</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Control</span> <span class="o">=</span>
                <span class="n">RPI_ARMTIMER_CTRL_23BIT</span> <span class="o">|</span>
                <span class="n">RPI_ARMTIMER_CTRL_ENABLE</span> <span class="o">|</span>
                <span class="n">RPI_ARMTIMER_CTRL_INT_ENABLE</span> <span class="o">|</span>
                <span class="n">RPI_ARMTIMER_CTRL_PRESCALE_256</span><span class="p">;</span>

        <span class="cm">/* Enable interrupts! */</span>
        <span class="n">_enable_interrupts</span><span class="p">();</span>

        <span class="cm">/* Never exit as there is no OS to exit to! */</span>
        <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">{</span>

        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>

<p>We now have interrupts up and working and in the exceptions you can do different things with the LED to use them to debug any nasty situations. We'll get onto JTAG debug in a future tutorial, but the next tutorial has to be the mailbox and GPU to get something more interesting happening, and what's more interesting than graphics!?</p>
<p>When you're ready <a href="http://www.valvers.com/open-software/raspberry-pi/step05-bare-metal-programming-in-c-pt5/">head over to Pt5...</a></p>
                
                  
                
                

              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../step03-bare-metal-programming-in-cpt3/" title="Introducing CMake" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Introducing CMake
              </span>
            </div>
          </a>
        
        
          <a href="../step05-bare-metal-programming-in-cpt5/" title="Part 5 - Graphics (Basic)" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Part 5 - Graphics (Basic)
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2002-2020 Brian Sidebotham
          </div>
        
        powered by
        <a href="https://www.mkdocs.org" target="_blank" rel="noopener">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application.c33a9706.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../../.."}})</script>
      
        <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
      
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
      
        <script src="../../../valvers-assets/extra.js"></script>
      
    
  </body>
</html>