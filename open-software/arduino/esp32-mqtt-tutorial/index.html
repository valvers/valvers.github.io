



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="https://www.valvers.com/open-software/arduino/esp32-mqtt-tutorial/">
      
      
        <meta name="author" content="Brian Sidebotham">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../img/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.6.3">
      <meta name="google-site-verification" content="gdf4XzjnbaArINbai3d8P0x_W3ugnDeIUyhMuq-wHPs" />
    
    
      
        <title>ESP32 MQTT Tutorial - valvers.com</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application.adb8469c.css">
      
        <link rel="stylesheet" href="../../../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#546e7a">
      
    
    
      <script src="../../../assets/javascripts/modernizr.86422ebf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    
      <link rel="stylesheet" href="../../../valvers-assets/extra.css">
    
    
      
        
<script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-57476377-1", "valvers.com")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="blue-grey" data-md-color-accent="deep-orange">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#esp32-mqtt-tutorial" tabindex="0" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://www.valvers.com" title="valvers.com" aria-label="valvers.com" class="md-header-nav__button md-logo">
          
            <img alt="logo" src="https://avatars3.githubusercontent.com/u/5575236?v=4?size=32" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              valvers.com
            </span>
            <span class="md-header-nav__topic">
              
                ESP32 MQTT Tutorial
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/valvers/valvers.website.src/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="../../.." class="md-tabs__link">
        Home
      </a>
    
  </li>

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../denford-orac/" class="md-tabs__link">
          Denford orac
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../engineering/" class="md-tabs__link">
          Engineering
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../" class="md-tabs__link md-tabs__link--active">
          Open software
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../v6manta/" class="md-tabs__link">
          V6manta
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://www.valvers.com" title="valvers.com" class="md-nav__button md-logo">
      
        <img alt="logo" src="https://avatars3.githubusercontent.com/u/5575236?v=4?size=32" width="48" height="48">
      
    </a>
    valvers.com
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/valvers/valvers.website.src/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Denford orac
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Denford orac
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2009-04-06-my-denford-orac/" title="2009 04 06 my denford orac" class="md-nav__link">
      2009 04 06 my denford orac
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2012-02-17-uprated-spindle-motor/" title="2012 02 17 uprated spindle motor" class="md-nav__link">
      2012 02 17 uprated spindle motor
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2012-03-22-gathering-some-information/" title="2012 03 22 gathering some information" class="md-nav__link">
      2012 03 22 gathering some information
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2012-09-27-750w-motor-sourced/" title="2012 09 27 750w motor sourced" class="md-nav__link">
      2012 09 27 750w motor sourced
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2012-10-01-motor-doesnt-fit/" title="2012 10 01 motor doesnt fit" class="md-nav__link">
      2012 10 01 motor doesnt fit
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2012-10-10-drill-head-disassembly/" title="2012 10 10 drill head disassembly" class="md-nav__link">
      2012 10 10 drill head disassembly
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2012-10-13-more-quill-dismantling/" title="2012 10 13 more quill dismantling" class="md-nav__link">
      2012 10 13 more quill dismantling
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2012-10-17-drill-spindle-is-apart/" title="2012 10 17 drill spindle is apart" class="md-nav__link">
      2012 10 17 drill spindle is apart
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2012-10-29-removing-electrical-cabinet/" title="2012 10 29 removing electrical cabinet" class="md-nav__link">
      2012 10 29 removing electrical cabinet
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2012-10-31-tested-the-drill-head-above-the-lathe/" title="2012 10 31 tested the drill head above the lathe" class="md-nav__link">
      2012 10 31 tested the drill head above the lathe
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2012-11-02-rebuild-of-an-orac/" title="2012 11 02 rebuild of an orac" class="md-nav__link">
      2012 11 02 rebuild of an orac
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../denford-orac/2013-03-13-new-motor-fitted/" title="2013 03 13 new motor fitted" class="md-nav__link">
      2013 03 13 new motor fitted
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Engineering
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Engineering
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../engineering/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../engineering/an-and-jic-fittings/" title="AN and JIC Fittings" class="md-nav__link">
      AN and JIC Fittings
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../engineering/bolt-dimensions/" title="Bolt Dimensions" class="md-nav__link">
      Bolt Dimensions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../engineering/linux-cnc-on-beaglebone-black/" title="Linux CNC on Beaglebone Black" class="md-nav__link">
      Linux CNC on Beaglebone Black
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../engineering/making-a-cyr-wheel/" title="Making a Cyr Wheel" class="md-nav__link">
      Making a Cyr Wheel
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      Open software
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Open software
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../" title="Open-Software" class="md-nav__link">
      Open-Software
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../android-car-dash/" title="Android car dash" class="md-nav__link">
      Android car dash
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../logging-with-gcc/" title="Logging with gcc" class="md-nav__link">
      Logging with gcc
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../posix-shell-scripting/" title="Posix Shell Scripting" class="md-nav__link">
      Posix Shell Scripting
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../working-with-the-screen-command/" title="Working with the Screen Command" class="md-nav__link">
      Working with the Screen Command
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-6" type="checkbox" id="nav-4-6" checked>
    
    <label class="md-nav__link" for="nav-4-6">
      Arduino
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-6">
        Arduino
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        ESP32 MQTT Tutorial
      </label>
    
    <a href="./" title="ESP32 MQTT Tutorial" class="md-nav__link md-nav__link--active">
      ESP32 MQTT Tutorial
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#install-arduino-ide" class="md-nav__link">
    Install Arduino IDE
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install-esp32-support" class="md-nav__link">
    Install ESP32 Support
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#debug-output" class="md-nav__link">
    Debug Output
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#connecting-wifi" class="md-nav__link">
    Connecting WiFi
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mqtt-library" class="md-nav__link">
    MQTT Library
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#amazon-iot" class="md-nav__link">
    Amazon IoT
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#security-policy" class="md-nav__link">
    Security Policy
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#iot-core-url" class="md-nav__link">
    IoT Core URL
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-iam-access-key" class="md-nav__link">
    Create IAM Access Key
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-describe-endpoint" class="md-nav__link">
    Use describe-endpoint
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#connect-to-aws-iot-to-publish-mqtt" class="md-nav__link">
    Connect to AWS IoT to Publish MQTT
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-7" type="checkbox" id="nav-4-7">
    
    <label class="md-nav__link" for="nav-4-7">
      Aws
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-7">
        Aws
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../aws/aws-lambda-getting-started/" title="AWS Lambda Getting Started" class="md-nav__link">
      AWS Lambda Getting Started
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-8" type="checkbox" id="nav-4-8">
    
    <label class="md-nav__link" for="nav-4-8">
      Gcc
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-8">
        Gcc
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../gcc/weak-function-attributes/" title="Weak Function Attributes" class="md-nav__link">
      Weak Function Attributes
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-9" type="checkbox" id="nav-4-9">
    
    <label class="md-nav__link" for="nav-4-9">
      Python
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-9">
        Python
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../python/pylab/" title="Pylab" class="md-nav__link">
      Pylab
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-10" type="checkbox" id="nav-4-10">
    
    <label class="md-nav__link" for="nav-4-10">
      Raspberry pi
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-10">
        Raspberry pi
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../raspberry-pi/" title="Open Software - Raspberry Pi" class="md-nav__link">
      Open Software - Raspberry Pi
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../raspberry-pi/step01-bare-metal-programming-in-cpt1/" title="Part 1 - Getting Started" class="md-nav__link">
      Part 1 - Getting Started
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../raspberry-pi/step02-bare-metal-programming-in-cpt2/" title="Part 2 - The C Runtime" class="md-nav__link">
      Part 2 - The C Runtime
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../raspberry-pi/step03-bare-metal-programming-in-cpt3/" title="Introducing CMake" class="md-nav__link">
      Introducing CMake
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../raspberry-pi/step04-bare-metal-programming-in-cpt4/" title="Part 4 - Interrupts" class="md-nav__link">
      Part 4 - Interrupts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../raspberry-pi/step05-bare-metal-programming-in-cpt5/" title="Part 5 - Graphics (Basic)" class="md-nav__link">
      Part 5 - Graphics (Basic)
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-11" type="checkbox" id="nav-4-11">
    
    <label class="md-nav__link" for="nav-4-11">
      Saltstack
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-11">
        Saltstack
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../saltstack/building-a-centos8-salt-master/" title="Building a CentOS8 Salt Master" class="md-nav__link">
      Building a CentOS8 Salt Master
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-12" type="checkbox" id="nav-4-12">
    
    <label class="md-nav__link" for="nav-4-12">
      Webstacks
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-12">
        Webstacks
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../webstacks/using-reactjs-and-bulma/" title="Using ReactJS and Bulma" class="md-nav__link">
      Using ReactJS and Bulma
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      V6manta
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        V6manta
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-2" type="checkbox" id="nav-5-2">
    
    <label class="md-nav__link" for="nav-5-2">
      2003
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-2">
        2003
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-07-28-/" title="2003 07 28" class="md-nav__link">
      2003 07 28 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-07-28-brought-a-1.8s-berlinetta/" title="2003 07 28 brought a 1.8s berlinetta" class="md-nav__link">
      2003 07 28 brought a 1.8s berlinetta
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-07-28-stage-rally-opel-manta/" title="2003 07 28 stage rally opel manta" class="md-nav__link">
      2003 07 28 stage rally opel manta
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-08-12-/" title="2003 08 12" class="md-nav__link">
      2003 08 12 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-08-13-/" title="2003 08 13" class="md-nav__link">
      2003 08 13 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-08-23-/" title="2003 08 23" class="md-nav__link">
      2003 08 23 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-09-11-/" title="2003 09 11" class="md-nav__link">
      2003 09 11 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-09-28-/" title="2003 09 28" class="md-nav__link">
      2003 09 28 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-10-07-/" title="2003 10 07" class="md-nav__link">
      2003 10 07 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-10-09-/" title="2003 10 09" class="md-nav__link">
      2003 10 09 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-11-04-/" title="2003 11 04" class="md-nav__link">
      2003 11 04 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2003/2003-12-16-/" title="2003 12 16" class="md-nav__link">
      2003 12 16 
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-3" type="checkbox" id="nav-5-3">
    
    <label class="md-nav__link" for="nav-5-3">
      2004
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-3">
        2004
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-01-06-/" title="2004 01 06" class="md-nav__link">
      2004 01 06 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-01-07-/" title="2004 01 07" class="md-nav__link">
      2004 01 07 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-01-26-/" title="2004 01 26" class="md-nav__link">
      2004 01 26 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-01-29-/" title="2004 01 29" class="md-nav__link">
      2004 01 29 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-02-09-/" title="2004 02 09" class="md-nav__link">
      2004 02 09 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-02-13-/" title="2004 02 13" class="md-nav__link">
      2004 02 13 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-02-19-/" title="2004 02 19" class="md-nav__link">
      2004 02 19 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-04-20-finally-got-around-to-the-manta/" title="2004 04 20 finally got around to the manta" class="md-nav__link">
      2004 04 20 finally got around to the manta
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-06-17-/" title="2004 06 17" class="md-nav__link">
      2004 06 17 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-06-18-/" title="2004 06 18" class="md-nav__link">
      2004 06 18 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-06-21-/" title="2004 06 21" class="md-nav__link">
      2004 06 21 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-07-26-/" title="2004 07 26" class="md-nav__link">
      2004 07 26 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-08-09-/" title="2004 08 09" class="md-nav__link">
      2004 08 09 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-08-10-/" title="2004 08 10" class="md-nav__link">
      2004 08 10 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-09-03-/" title="2004 09 03" class="md-nav__link">
      2004 09 03 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-09-27-/" title="2004 09 27" class="md-nav__link">
      2004 09 27 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-10-07-/" title="2004 10 07" class="md-nav__link">
      2004 10 07 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-10-08-/" title="2004 10 08" class="md-nav__link">
      2004 10 08 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-10-11-/" title="2004 10 11" class="md-nav__link">
      2004 10 11 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-10-13-/" title="2004 10 13" class="md-nav__link">
      2004 10 13 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-10-15-/" title="2004 10 15" class="md-nav__link">
      2004 10 15 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-10-18-/" title="2004 10 18" class="md-nav__link">
      2004 10 18 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-10-21-/" title="2004 10 21" class="md-nav__link">
      2004 10 21 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-10-22-/" title="2004 10 22" class="md-nav__link">
      2004 10 22 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-10-29-/" title="2004 10 29" class="md-nav__link">
      2004 10 29 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-11-01-/" title="2004 11 01" class="md-nav__link">
      2004 11 01 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2004/2004-12-10-were-back/" title="2004 12 10 were back" class="md-nav__link">
      2004 12 10 were back
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-4" type="checkbox" id="nav-5-4">
    
    <label class="md-nav__link" for="nav-5-4">
      2005
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-4">
        2005
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-05-16-/" title="2005 05 16" class="md-nav__link">
      2005 05 16 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-08-04-done-something/" title="2005 08 04 done something" class="md-nav__link">
      2005 08 04 done something
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-08-08-/" title="2005 08 08" class="md-nav__link">
      2005 08 08 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-08-10-/" title="2005 08 10" class="md-nav__link">
      2005 08 10 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-08-25-/" title="2005 08 25" class="md-nav__link">
      2005 08 25 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-08-31-/" title="2005 08 31" class="md-nav__link">
      2005 08 31 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-09-05-/" title="2005 09 05" class="md-nav__link">
      2005 09 05 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-09-19-/" title="2005 09 19" class="md-nav__link">
      2005 09 19 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-09-22-/" title="2005 09 22" class="md-nav__link">
      2005 09 22 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-09-23-/" title="2005 09 23" class="md-nav__link">
      2005 09 23 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-11-01-/" title="2005 11 01" class="md-nav__link">
      2005 11 01 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2005/2005-11-03-/" title="2005 11 03" class="md-nav__link">
      2005 11 03 
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-5" type="checkbox" id="nav-5-5">
    
    <label class="md-nav__link" for="nav-5-5">
      2007
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-5">
        2007
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2007/2007-10-20-/" title="2007 10 20" class="md-nav__link">
      2007 10 20 
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2007/2007-10-20-perspex-windows/" title="2007 10 20 perspex windows" class="md-nav__link">
      2007 10 20 perspex windows
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2007/2007-11-13-getting-it-ready-to-paint.../" title="2007 11 13 getting it ready to paint..." class="md-nav__link">
      2007 11 13 getting it ready to paint...
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2007/2007-11-21-almost-started-painting/" title="2007 11 21 almost started painting" class="md-nav__link">
      2007 11 21 almost started painting
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2007/2007-11-28-underneath-is-complete/" title="2007 11 28 underneath is complete" class="md-nav__link">
      2007 11 28 underneath is complete
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2007/2007-12-04-painting-the-inside-and-engine-bay/" title="2007 12 04 painting the inside and engine bay" class="md-nav__link">
      2007 12 04 painting the inside and engine bay
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-6" type="checkbox" id="nav-5-6">
    
    <label class="md-nav__link" for="nav-5-6">
      2008
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-6">
        2008
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-01-14-painting-the-shell-orange/" title="2008 01 14 painting the shell orange" class="md-nav__link">
      2008 01 14 painting the shell orange
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-01-16-out-of-the-booth/" title="2008 01 16 out of the booth" class="md-nav__link">
      2008 01 16 out of the booth
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-01-23-rear-axle-trial-fitting/" title="2008 01 23 rear axle trial fitting" class="md-nav__link">
      2008 01 23 rear axle trial fitting
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-02-24-painted-the-nextel-and-checked-for-wheel-clearance/" title="2008 02 24 painted the nextel and checked for wheel clearance" class="md-nav__link">
      2008 02 24 painted the nextel and checked for wheel clearance
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-03-15-front-suspension-build/" title="2008 03 15 front suspension build" class="md-nav__link">
      2008 03 15 front suspension build
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-03-19-suspension-bushes-are-always-wrong/" title="2008 03 19 suspension bushes are always wrong" class="md-nav__link">
      2008 03 19 suspension bushes are always wrong
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-03-22-diff-bearings-need-replacing/" title="2008 03 22 diff bearings need replacing" class="md-nav__link">
      2008 03 22 diff bearings need replacing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-04-08-fitted-the-rear-windows-and-steering-column/" title="2008 04 08 fitted the rear windows and steering column" class="md-nav__link">
      2008 04 08 fitted the rear windows and steering column
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-04-12-shimmed-up-the-diff,-and-fitted-the-clocks/" title="2008 04 12 shimmed up the diff, and fitted the clocks" class="md-nav__link">
      2008 04 12 shimmed up the diff, and fitted the clocks
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-04-16-rebuilt-the-gearbox-so-i-get-gear-selection/" title="2008 04 16 rebuilt the gearbox so i get gear selection" class="md-nav__link">
      2008 04 16 rebuilt the gearbox so i get gear selection
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-07-08-its-on-its-wheels-at-last/" title="2008 07 08 its on its wheels at last" class="md-nav__link">
      2008 07 08 its on its wheels at last
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-09-02-rebuilt-oil-pump--started-headwork/" title="2008 09 02 rebuilt oil pump started headwork" class="md-nav__link">
      2008 09 02 rebuilt oil pump  started headwork
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-09-04-some-more-headwork/" title="2008 09 04 some more headwork" class="md-nav__link">
      2008 09 04 some more headwork
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-09-25-even-more-headwork/" title="2008 09 25 even more headwork" class="md-nav__link">
      2008 09 25 even more headwork
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-11-09-engine--transmission-fitted/" title="2008 11 09 engine transmission fitted" class="md-nav__link">
      2008 11 09 engine  transmission fitted
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-11-16-engine--gearbox-mounted--steering-column-fitted/" title="2008 11 16 engine gearbox mounted steering column fitted" class="md-nav__link">
      2008 11 16 engine  gearbox mounted  steering column fitted
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2008/2008-12-14-stripping-the-x25xe-v6-bottom-end/" title="2008 12 14 stripping the x25xe v6 bottom end" class="md-nav__link">
      2008 12 14 stripping the x25xe v6 bottom end
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-7" type="checkbox" id="nav-5-7">
    
    <label class="md-nav__link" for="nav-5-7">
      2009
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-7">
        2009
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2009/2009-06-24-making-the-dry-sump-pan/" title="2009 06 24 making the dry sump pan" class="md-nav__link">
      2009 06 24 making the dry sump pan
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2009/2009-10-05-trialling-the-throttle-bodies--a-few-more-bits-painted/" title="2009 10 05 trialling the throttle bodies a few more bits painted" class="md-nav__link">
      2009 10 05 trialling the throttle bodies  a few more bits painted
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2009/2009-12-18-flywheel-and-clutch/" title="2009 12 18 flywheel and clutch" class="md-nav__link">
      2009 12 18 flywheel and clutch
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-8" type="checkbox" id="nav-5-8">
    
    <label class="md-nav__link" for="nav-5-8">
      2010
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-8">
        2010
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-01-23-done-the-handbrake--sliders/" title="2010 01 23 done the handbrake sliders" class="md-nav__link">
      2010 01 23 done the handbrake  sliders
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-01-27-started-building-the-v6-heads-up/" title="2010 01 27 started building the v6 heads up" class="md-nav__link">
      2010 01 27 started building the v6 heads up
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-01-30-picked-up-another-v6/" title="2010 01 30 picked up another v6" class="md-nav__link">
      2010 01 30 picked up another v6
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-02-01-exhaust-manifolds/" title="2010 02 01 exhaust manifolds" class="md-nav__link">
      2010 02 01 exhaust manifolds
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-02-02-starting-the-v6-build/" title="2010 02 02 starting the v6 build" class="md-nav__link">
      2010 02 02 starting the v6 build
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-02-03-cylinder-head-bolts-torque/" title="2010 02 03 cylinder head bolts torque" class="md-nav__link">
      2010 02 03 cylinder head bolts torque
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-02-03-ordered-the-exhaust-manifold-flanges/" title="2010 02 03 ordered the exhaust manifold flanges" class="md-nav__link">
      2010 02 03 ordered the exhaust manifold flanges
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-02-06-building-the-v6/" title="2010 02 06 building the v6" class="md-nav__link">
      2010 02 06 building the v6
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-02-07-building-the-v6/" title="2010 02 07 building the v6" class="md-nav__link">
      2010 02 07 building the v6
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-02-14-building-the-v6/" title="2010 02 14 building the v6" class="md-nav__link">
      2010 02 14 building the v6
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-03-22-gearbox-sealed-and-release-bearing-fitted/" title="2010 03 22 gearbox sealed and release bearing fitted" class="md-nav__link">
      2010 03 22 gearbox sealed and release bearing fitted
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-04-03-started-on-the-manifolds/" title="2010 04 03 started on the manifolds" class="md-nav__link">
      2010 04 03 started on the manifolds
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-04-05-finished-a-manifold/" title="2010 04 05 finished a manifold" class="md-nav__link">
      2010 04 05 finished a manifold
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-04-07-started-the-second-manifold/" title="2010 04 07 started the second manifold" class="md-nav__link">
      2010 04 07 started the second manifold
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-04-11-need-a-todo-list/" title="2010 04 11 need a todo list" class="md-nav__link">
      2010 04 11 need a todo list
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-04-21-ticking-off-the-boxes/" title="2010 04 21 ticking off the boxes" class="md-nav__link">
      2010 04 21 ticking off the boxes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-04-26-nearly-finished-the-second-manifold/" title="2010 04 26 nearly finished the second manifold" class="md-nav__link">
      2010 04 26 nearly finished the second manifold
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-05-09-got-the-car-rolling/" title="2010 05 09 got the car rolling" class="md-nav__link">
      2010 05 09 got the car rolling
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-05-11-rolling-road-day/" title="2010 05 11 rolling road day" class="md-nav__link">
      2010 05 11 rolling road day
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-05-31-back-from-germany/" title="2010 05 31 back from germany" class="md-nav__link">
      2010 05 31 back from germany
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-06-01-sumps-off/" title="2010 06 01 sumps off" class="md-nav__link">
      2010 06 01 sumps off
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-06-06-done-most-of-the-bits-on-the-v6/" title="2010 06 06 done most of the bits on the v6" class="md-nav__link">
      2010 06 06 done most of the bits on the v6
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-06-12-getting-ready-to-bolt-it-back-in/" title="2010 06 12 getting ready to bolt it back in" class="md-nav__link">
      2010 06 12 getting ready to bolt it back in
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-06-19-almost-ready-to-go-back-in/" title="2010 06 19 almost ready to go back in" class="md-nav__link">
      2010 06 19 almost ready to go back in
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-09-22-lack-of-updates/" title="2010 09 22 lack of updates" class="md-nav__link">
      2010 09 22 lack of updates
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-09-26-few-little-bits/" title="2010 09 26 few little bits" class="md-nav__link">
      2010 09 26 few little bits
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-10-09-v6-oil-problems..../" title="2010 10 09 v6 oil problems...." class="md-nav__link">
      2010 10 09 v6 oil problems....
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-10-12-starting-putting-the-engine-back-together/" title="2010 10 12 starting putting the engine back together" class="md-nav__link">
      2010 10 12 starting putting the engine back together
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-10-23-v6-is-broke/" title="2010 10 23 v6 is broke" class="md-nav__link">
      2010 10 23 v6 is broke
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-10-24-stripping-the-v6/" title="2010 10 24 stripping the v6" class="md-nav__link">
      2010 10 24 stripping the v6
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-10-25-v6-problem/" title="2010 10 25 v6 problem" class="md-nav__link">
      2010 10 25 v6 problem
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-11-03-picked-up-a-replacement-v6/" title="2010 11 03 picked up a replacement v6" class="md-nav__link">
      2010 11 03 picked up a replacement v6
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2010/2010-12-12-been-busy-building/" title="2010 12 12 been busy building" class="md-nav__link">
      2010 12 12 been busy building
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-9" type="checkbox" id="nav-5-9">
    
    <label class="md-nav__link" for="nav-5-9">
      2011
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-9">
        2011
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-01-01-finally-driven-the-manta-again-today/" title="2011 01 01 finally driven the manta again today" class="md-nav__link">
      2011 01 01 finally driven the manta again today
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-03-13-fitting-some-new-seats/" title="2011 03 13 fitting some new seats" class="md-nav__link">
      2011 03 13 fitting some new seats
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-03-13-the-manta-got-mapped/" title="2011 03 13 the manta got mapped" class="md-nav__link">
      2011 03 13 the manta got mapped
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-03-25-went-to-brands-hatch/" title="2011 03 25 went to brands hatch" class="md-nav__link">
      2011 03 25 went to brands hatch
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-09-04-started-work-on-the-2011-rebuild/" title="2011 09 04 started work on the 2011 rebuild" class="md-nav__link">
      2011 09 04 started work on the 2011 rebuild
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-09-10-built-some-more-of-the-frame/" title="2011 09 10 built some more of the frame" class="md-nav__link">
      2011 09 10 built some more of the frame
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-09-14-started-work-on-the-new-sump-pan/" title="2011 09 14 started work on the new sump pan" class="md-nav__link">
      2011 09 14 started work on the new sump pan
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-09-15-more-subframe-work/" title="2011 09 15 more subframe work" class="md-nav__link">
      2011 09 15 more subframe work
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-09-17-gearbox-back-together/" title="2011 09 17 gearbox back together" class="md-nav__link">
      2011 09 17 gearbox back together
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-09-25-getting-ready-to-spray-the-engine-bay-again.../" title="2011 09 25 getting ready to spray the engine bay again..." class="md-nav__link">
      2011 09 25 getting ready to spray the engine bay again...
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-10-16-moving-along-with-the-rebuild/" title="2011 10 16 moving along with the rebuild" class="md-nav__link">
      2011 10 16 moving along with the rebuild
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-10-18-painted-the-engine-bay/" title="2011 10 18 painted the engine bay" class="md-nav__link">
      2011 10 18 painted the engine bay
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2011/2011-11-15-dry-sump-work.../" title="2011 11 15 dry sump work..." class="md-nav__link">
      2011 11 15 dry sump work...
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-10" type="checkbox" id="nav-5-10">
    
    <label class="md-nav__link" for="nav-5-10">
      2012
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-10">
        2012
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-01-09-dry-sump-pan-is-welded/" title="2012 01 09 dry sump pan is welded" class="md-nav__link">
      2012 01 09 dry sump pan is welded
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-01-27-more-dry-sump-work/" title="2012 01 27 more dry sump work" class="md-nav__link">
      2012 01 27 more dry sump work
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-02-21-engine-is-back-in.../" title="2012 02 21 engine is back in..." class="md-nav__link">
      2012 02 21 engine is back in...
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-02-24-took-the-engine-back-out-again/" title="2012 02 24 took the engine back out again" class="md-nav__link">
      2012 02 24 took the engine back out again
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-02-27-engine-back-in-again/" title="2012 02 27 engine back in again" class="md-nav__link">
      2012 02 27 engine back in again
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-03-14-mostly-plumbed-back-in/" title="2012 03 14 mostly plumbed back in" class="md-nav__link">
      2012 03 14 mostly plumbed back in
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-04-04-started-her-up-again/" title="2012 04 04 started her up again" class="md-nav__link">
      2012 04 04 started her up again
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-04-16-ready-for-a-test-drive/" title="2012 04 16 ready for a test drive" class="md-nav__link">
      2012 04 16 ready for a test drive
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-05-09-clutch-release-bearing-failure/" title="2012 05 09 clutch release bearing failure" class="md-nav__link">
      2012 05 09 clutch release bearing failure
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-05-17-stripping-the-t5-gearbox/" title="2012 05 17 stripping the t5 gearbox" class="md-nav__link">
      2012 05 17 stripping the t5 gearbox
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-10-13-rebuilt-the-gearbox/" title="2012 10 13 rebuilt the gearbox" class="md-nav__link">
      2012 10 13 rebuilt the gearbox
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-11-11-finally-the-engines-back-in/" title="2012 11 11 finally the engines back in" class="md-nav__link">
      2012 11 11 finally the engines back in
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-11-14-nearly-back-together/" title="2012 11 14 nearly back together" class="md-nav__link">
      2012 11 14 nearly back together
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-11-25-the-finishing-touches/" title="2012 11 25 the finishing touches" class="md-nav__link">
      2012 11 25 the finishing touches
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-11-28-finally-the-v6-manta-up-a-running-again/" title="2012 11 28 finally the v6 manta up a running again" class="md-nav__link">
      2012 11 28 finally the v6 manta up a running again
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2012/2012-12-30-virtually-back-on-the-road/" title="2012 12 30 virtually back on the road" class="md-nav__link">
      2012 12 30 virtually back on the road
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-11" type="checkbox" id="nav-5-11">
    
    <label class="md-nav__link" for="nav-5-11">
      2013
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-11">
        2013
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2013/2013-01-10-driven-the-manta-again/" title="2013 01 10 driven the manta again" class="md-nav__link">
      2013 01 10 driven the manta again
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../v6manta/2013/2013-01-15-had-a-great-blast-in-the-manta/" title="2013 01 15 had a great blast in the manta" class="md-nav__link">
      2013 01 15 had a great blast in the manta
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#install-arduino-ide" class="md-nav__link">
    Install Arduino IDE
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install-esp32-support" class="md-nav__link">
    Install ESP32 Support
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#debug-output" class="md-nav__link">
    Debug Output
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#connecting-wifi" class="md-nav__link">
    Connecting WiFi
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mqtt-library" class="md-nav__link">
    MQTT Library
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#amazon-iot" class="md-nav__link">
    Amazon IoT
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#security-policy" class="md-nav__link">
    Security Policy
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#iot-core-url" class="md-nav__link">
    IoT Core URL
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-iam-access-key" class="md-nav__link">
    Create IAM Access Key
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-describe-endpoint" class="md-nav__link">
    Use describe-endpoint
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#connect-to-aws-iot-to-publish-mqtt" class="md-nav__link">
    Connect to AWS IoT to Publish MQTT
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset" id="content">
              
                
                  <a href="https://github.com/valvers/valvers.website.src/edit/master/docs/open-software/arduino/esp32-mqtt-tutorial.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <ul class="metadata page-metadata" data-bi-name="page info" lang="en-us" dir="ltr">
                  <li class="last-updated-holder displayDate loading">
                    <span class="last-updated-text">Last updated:</span>
                    <time role="presentation" datetime="2018-10-25T00:00:00.000Z" data-article-date-source="ms.date">2020-04-29</time>
                  </li>
                <!--
                  <li class="readingTime">
                    2 minutes to read
                  </li>
                -->
                  <li class="contributors-holder">
                    <span class="contributors-text">Contributors</span>
                    <ul class="contributors" data-bi-name="contributors"><li><a href="https://github.com/BrianSidebotham" title="Brian Sidebotham" data-bi-name="contributorprofile"><img src="../img/contributor.svg" data-src="https://avatars3.githubusercontent.com/u/5575236?v=4?size=32" alt="Brian Sidebotham"></a></li></ul>
                  </li>
                </ul>
                <h1 id="esp32-mqtt-tutorial">ESP32 MQTT Tutorial<a class="headerlink" href="#esp32-mqtt-tutorial" title="Permanent link">&para;</a></h1>
<p>This is a tutorial for getting an ESP32 set up as an Amazon IoT device using MQTT to communicate.</p>
<h2 id="install-arduino-ide">Install Arduino IDE<a class="headerlink" href="#install-arduino-ide" title="Permanent link">&para;</a></h2>
<p>No matter what your platform is, you'll need the Ardiuno IDE installed. It can be installed on many platforms including Linux, Windows and MAC.</p>
<h3 id="install-esp32-support">Install ESP32 Support<a class="headerlink" href="#install-esp32-support" title="Permanent link">&para;</a></h3>
<p>Once installed, plug the ESP32 board into a USB port and start the Arduino IDE.</p>
<p>Select <code>File-&gt;Preferences</code> and then enter <code>https://dl.espressif.com/dl/package_esp32_index.json</code> in the <code>Additional Board Manager URLs</code> field.</p>
<p><img alt="" src="/images/open-software/arduino/esp32-mqtt-tutorial/110-wsp32-arduino-ide-set-preferences-to-enable-esp32.png" /></p>
<p><strong>Click OK</strong></p>
<p>Select <code>Tools-&gt;Board-&gt;Board Manager</code></p>
<p><img alt="" src="/images/open-software/arduino/esp32-mqtt-tutorial/120-esp32-arduino-ide-select-board-manager.png" /></p>
<p>Using the search feature, <strong>click Install</strong> for the ESP32 board support.</p>
<p><img alt="" src="/images/open-software/arduino/esp32-mqtt-tutorial/130-esp32-arduino-ide-install-esp32-boards.png" /></p>
<blockquote>
<p><strong>NOTE:</strong> The ESP tools require the <code>pyserial</code> package to be installed in your default python installation.
 Depending on your system you can either use pip to install the pyserial package with something like
<code>pip install --upgrade --user pyserial</code> or else you can get your distribution's packaged version of
the python package with something like <code>sudo dnf install -y python3-pyserial</code> on Fedora for example.</p>
</blockquote>
<p>Select the board (depending on what board you have!). For me, I've been posted this board to work with:</p>
<p><img alt="" src="/images/open-software/arduino/esp32-mqtt-tutorial/TODO.png" /></p>
<p>I've selected the standard <code>ESP Dev Module</code> as when I select <code>Tools-&gt;Get Board Info</code> the board comes back as
unknown and so cannot be automatically detected as a supported Arduino board.</p>
<p>When you've selected your board, there is already an empty sketch loaded. You can now simply <strong>click Upload</strong>
in order to compile the sketch and upload the sketch to the ESP32 device.</p>
<p>You should get a success message along the lines of <code>"Done uploading"</code> in the Arduino IDE.</p>
<p><img alt="" src="/images/open-software/arduino/esp32-mqtt-tutorial/150-esp32-arduino-ide-done-uploading.png" /></p>
<h2 id="debug-output">Debug Output<a class="headerlink" href="#debug-output" title="Permanent link">&para;</a></h2>
<blockquote>
<p>If you're already familiar with Arduino and the IDE, etc. then you can safely skip this section.</p>
</blockquote>
<p>To get started with the ESP (If you're not familiar with Sketches and Libraries) let's look at getting some
debug output from the Sketch (Program) to prove to ourselves that the device is working and running our sketch.</p>
<p>The default sketch looks like this:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// put your setup code here, to run once:</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// put your main code here, to run repeatedly:</span>

<span class="p">}</span>
</code></pre></div>

<p>Now, let's add some detail to make sure. Let's make use of a useful feature - that we have Serial communications
available to us from within Arduino. From the <a href="https://www.arduino.cc/reference/en/language/functions/communication/serial/">documentation</a>
we can see the functions available for the Serial module.</p>
<p>Our new code looks pretty straight forward:</p>
<p><strong>110-esp-arduino-debug-output.ino</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// put your setup code here, to run once:</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Hello World!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// put your main code here, to run repeatedly:</span>

<span class="p">}</span>
</code></pre></div>

<p>In order to see the output from our program open the <code>Tools-&gt;Serial Monitor</code> - the COM port should be set to the
same one the board is set to. The BAUD rate might have to be adjusted for your board. Make sure the BAUD rate is
set to the same as your board communications so you get to see all of the output.</p>
<p>Now, when we Upload the sketch to the ESP32, we can see the <code>Hello World!</code> output.</p>
<p><img alt="" src="/images/open-software/arduino/esp32-mqtt-tutorial/160-esp32-arduino-ide-serial-debug.png" /></p>
<p>We're done getting set up with Arduino and our board</p>
<h2 id="connecting-wifi">Connecting WiFi<a class="headerlink" href="#connecting-wifi" title="Permanent link">&para;</a></h2>
<p>First things first. In order to connect to an MQTT stream, we'll first need to be able to connect the ESP32 to a
WiFi connection so we can connect to the internet.</p>
<p>As part of the ESP32 support we installed earlier, there was a library installed which is available to the sketch
called <code>WiFiClientSecure</code> which provides a secure web client.</p>
<p>You can add this library to a sketch by selecting <code>Sketch-&gt;Include Library-&gt;WiFiClientSecure</code>. Information about
this Arduino library can be found on GitHub: <a href="https://github.com/espressif/arduino-esp32/tree/master/libraries/WiFiClientSecure">https://github.com/espressif/arduino-esp32/tree/master/libraries/WiFiClientSecure</a></p>
<p>The first thing we need to do is get connected to WiFi.</p>
<p>Let's modify the Sketch so we connect to the WiFi. We'll use the
<a href="https://github.com/espressif/arduino-esp32/blob/master/libraries/WiFiClientSecure/examples/WiFiClientSecure/WiFiClientSecure.ino">documented example</a>
as a reference sketch. However, we don't need a root CA in place for the moment as we've not created our own certificate
authority or have any CA we need to trust.</p>
<p><strong>120-esp-arduino-wifi-connection.ino</strong></p>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&lt;WiFiClientSecure.h&gt;</span><span class="cp"></span>

<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">ssid</span> <span class="o">=</span> <span class="s">&quot;your-ssid&quot;</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">wifipassword</span> <span class="o">=</span> <span class="s">&quot;your-password&quot;</span><span class="p">;</span>

<span class="n">WiFiClientSecure</span> <span class="n">wifi</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// put your setup code here, to run once:</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Connecting to SSID: &quot;</span><span class="p">);</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">ssid</span><span class="p">);</span>

    <span class="n">WiFi</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">wifipassword</span><span class="p">);</span>

    <span class="k">while</span><span class="p">(</span> <span class="n">WiFi</span><span class="p">.</span><span class="n">status</span><span class="p">()</span> <span class="o">!=</span> <span class="n">WL_CONNECTED</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">);</span>
        <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Connected to &quot;</span><span class="p">);</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">ssid</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// put your main code here, to run repeatedly:</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">);</span>
    <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>Go ahead and run that sketch, remembering to change the <code>ssid</code> and <code>wifipassword</code> variables to suitable settings for
your network.</p>
<p>When you run the sketch, you will see output in the Serial Monitor similar to the following:</p>
<div class="codehilite"><pre><span></span><code>Connecting to SSID: your-ssid
.Connected to your-ssid
::::::::::
</code></pre></div>

<p>From here we can connect to the internet and make web queries, etc. We'd do that with the <code>client</code> object. For now,
we don't need to do anything else really, we just need to get on with looking at moving forward with MQTT.</p>
<h2 id="mqtt-library">MQTT Library<a class="headerlink" href="#mqtt-library" title="Permanent link">&para;</a></h2>
<p>We can install a library in the Arduino IDE for the MQTT client to get us MQTT support.</p>
<p>In the Arduino IDE click <code>Tools-&gt;Manage Libraries...</code> and enter MQTT into the search box.</p>
<p><img alt="" src="/images/open-software/arduino/esp32-mqtt-tutorial/170-esp32-arduino-ide-library-manager-mqtt.png" /></p>
<p><strong>Click Install</strong> to install the library. Make sure you use the <code>Jol Ghwiler</code> MQTT library.</p>
<p>Using a complete copy of a <a href="https://github.com/256dpi/arduino-mqtt/blob/master/examples/ESP32DevelopmentBoardSecure/ESP32DevelopmentBoardSecure.ino">sketch from the MQTT library</a>
means that we can get connected to an MQTT client that is provided as a test ground.</p>
<p><strong>130-esp-arduino-mqtt-example-shiftr.io.ino</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// This example uses an ESP32 Development Board</span>
<span class="c1">// to connect to shiftr.io.</span>
<span class="c1">//</span>
<span class="c1">// You can check on your device after a successful</span>
<span class="c1">// connection here: https://shiftr.io/try.</span>
<span class="c1">//</span>
<span class="c1">// by Jol Ghwiler</span>
<span class="c1">// https://github.com/256dpi/arduino-mqtt</span>

<span class="cp">#include</span> <span class="cpf">&lt;WiFiClientSecure.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;MQTT.h&gt;</span><span class="cp"></span>

<span class="k">const</span> <span class="kt">char</span> <span class="n">ssid</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;mrbanks&quot;</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span> <span class="n">pass</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;mvepfgzw&quot;</span><span class="p">;</span>

<span class="n">WiFiClientSecure</span> <span class="n">net</span><span class="p">;</span>
<span class="n">MQTTClient</span> <span class="nf">client</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lastMillis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">connect</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;checking wifi...&quot;</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">WiFi</span><span class="p">.</span><span class="n">status</span><span class="p">()</span> <span class="o">!=</span> <span class="n">WL_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">);</span>
    <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">connecting...&quot;</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;bsidebotham&quot;</span><span class="p">,</span> <span class="s">&quot;try&quot;</span><span class="p">,</span> <span class="s">&quot;try&quot;</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">);</span>
    <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">connected!&quot;</span><span class="p">);</span>

  <span class="n">client</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="s">&quot;/hello&quot;</span><span class="p">);</span>
  <span class="c1">// client.unsubscribe(&quot;/hello&quot;);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">messageReceived</span><span class="p">(</span><span class="n">String</span> <span class="o">&amp;</span><span class="n">topic</span><span class="p">,</span> <span class="n">String</span> <span class="o">&amp;</span><span class="n">payload</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;incoming: &quot;</span> <span class="o">+</span> <span class="n">topic</span> <span class="o">+</span> <span class="s">&quot; - &quot;</span> <span class="o">+</span> <span class="n">payload</span><span class="p">);</span>

  <span class="c1">// Note: Do not use the client in the callback to publish, subscribe or</span>
  <span class="c1">// unsubscribe as it may cause deadlocks when other things arrive while</span>
  <span class="c1">// sending and receiving acknowledgments. Instead, change a global variable,</span>
  <span class="c1">// or push to a queue and handle it in the loop after calling `client.loop()`.</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span>
  <span class="n">WiFi</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">pass</span><span class="p">);</span>

  <span class="c1">// Note: Local domain names (e.g. &quot;Computer.local&quot; on OSX) are not supported</span>
  <span class="c1">// by Arduino. You need to set the IP address directly.</span>
  <span class="c1">//</span>
  <span class="c1">// MQTT brokers usually use port 8883 for secure connections.</span>
  <span class="n">client</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="s">&quot;broker.shiftr.io&quot;</span><span class="p">,</span> <span class="mi">8883</span><span class="p">,</span> <span class="n">net</span><span class="p">);</span>
  <span class="n">client</span><span class="p">.</span><span class="n">onMessage</span><span class="p">(</span><span class="n">messageReceived</span><span class="p">);</span>

  <span class="n">connect</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">client</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
  <span class="n">delay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>  <span class="c1">// &lt;- fixes some issues with WiFi stability</span>

  <span class="c1">// publish a message roughly every second.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">millis</span><span class="p">()</span> <span class="o">-</span> <span class="n">lastMillis</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">.</span><span class="n">connected</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;lastError: &quot;</span><span class="p">);</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">lastError</span><span class="p">());</span>
      <span class="n">connect</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="n">lastMillis</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span>
    <span class="n">client</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="s">&quot;/hello&quot;</span><span class="p">,</span> <span class="s">&quot;world&quot;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<blockquote>
<p><strong>NOTE:</strong> I created a <a href="https://github.com/256dpi/arduino-mqtt/issues/197">GitHub issue</a> for the fact that the example ESP32 code didn't work out-of-the box on an ESP32 development board</p>
</blockquote>
<p>The above code is changed slightly from the actual example code. The buffer size for the MQTT client <em>must</em>
be increased to get past the first message received from the shiftr.io MQTT server. After that first message,
we receive the correct <code>/hello world</code> topic and message from the server which we subscribe to. For more
information about MQTT, you can see the <a href="http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html">MQTT 3.1.1 documentation</a>.</p>
<h2 id="amazon-iot">Amazon IoT<a class="headerlink" href="#amazon-iot" title="Permanent link">&para;</a></h2>
<blockquote>
<p><strong>NOTE:</strong> In this section, we'll make heavy use of the <a href="https://docs.aws.amazon.com/iot/latest/developerguide/iot-gs.html">AWS documentation</a></p>
</blockquote>
<p>The AWS IoT service allows us to create secure MQTT endpoints for our own Internet-of-Things devices. Let's
have a look at how to get our now-MQTT-enabled ESP32 connecting to our own AWS IoT service.</p>
<p><img alt="" src="/images/open-software/arduino/esp32-mqtt-tutorial/200-esp32-aws-iot-getting-started.png" /></p>
<p>The first task is to create a Thing - that is, a unique device that will be able to connect to the service
that we create later.</p>
<p><strong>Click Manage</strong></p>
<p><img alt="" src="/images/open-software/arduino/esp32-mqtt-tutorial/210-esp32-aws-iot-register-a-thing.png" /></p>
<p><strong>Click Register a thing</strong></p>
<p><img alt="" src="/images/open-software/arduino/esp32-mqtt-tutorial/220-esp32-aws-iot-create-a-single-thing.png" /></p>
<p>Name your thing something that is pertinent to this tutorial. I've gone for <code>ESP32Example</code> so that's what'll
be in use throughout the rest of this tutorial.</p>
<p><img alt="" src="/images/open-software/arduino/esp32-mqtt-tutorial/230-esp32-aws-iot-create-a-single-thing-name.png" /></p>
<p><strong>Click Next</strong> after you've inserted a name. There's no need to create a group or anything at this point.</p>
<p>Certificates. This is always a fun subject. You can end up tying yourself in knots with certificates. For the
tutorial, I say - use the one-click certificate creation. That's what I'll do here for this tutorial, but
generally for business I'd be using a CSR or (more likely) my own CA for IoT devices. Using your own CA
puts you in a much better place.</p>
<p><img alt="" src="/images/open-software/arduino/esp32-mqtt-tutorial/240-esp32-aws-iot-create-a-single-thing-certificate.png" /></p>
<p><strong>Click One-click certificate creation "Create certificate"</strong></p>
<p>Pay attention to the next page - you only get one chance to download the public and private keys. Once you move
away from the next AWS page you will not be able to download them again. Make sure you keep the certificate and
private key out of other people's reach.</p>
<p><img alt="" src="/images/open-software/arduino/esp32-mqtt-tutorial/250-esp32-aws-iot-create-a-single-thing-certificate-download.png" /></p>
<p><strong>Download all three certificates</strong></p>
<p>Go ahead and download the certificates and keys that have been created for your device.</p>
<p>You'll also notice that there is a link to the root CA for AWS IoT. <strong>Right Click</strong> this link and open it in
a new tab and contains various options for the root CA certificate that we need to trust in order to gain
secure connectivity to AWS IoT services.</p>
<p>Although RSA is getting a slightly bad wrap these days, AWS have a 2048 bit RSA key certificate listed along
with some <a href="http://www-irm.mathematik.hu-berlin.de/~sulanke/diffgeo/euklid/EuCurvesv3.pdf">Euclidean Curve</a> (ECC)
key certificates. ECC keys require considerable more processing effort than RSA - so stick with the RSA key
certificates where you can.</p>
<p>For this tutorial, I am going to get the <a href="https://www.amazontrust.com/repository/AmazonRootCA1.pem">2048 bit RSA AWS Root CA</a>.</p>
<p>Download the AWS Root CA and keep it alongside the other certificates.</p>
<p>In the original certificate page, <strong>Click Activate</strong> on the certificate, so that the box now changes to
Deactivate. The certificates are now active.</p>
<p><img alt="" src="/images/open-software/arduino/esp32-mqtt-tutorial/260-esp32-aws-iot-create-a-single-thing-certificate-activated.png" /></p>
<p><strong>Click Done</strong>, because we cant' yet <code>Attach a policy</code> as we've not created any IoT policies yet.</p>
<h3 id="security-policy">Security Policy<a class="headerlink" href="#security-policy" title="Permanent link">&para;</a></h3>
<p>From the main screen, in the left-hand navigation pane <strong>Click Secure</strong> and then <strong>Policies</strong> from the Secure
sub-menu to start creating a new security policy which we will attach to the certificate we've just created.</p>
<p>Together the policy and the certificate will give the new IoT thing permissions to do something (Usually
subscribe to and publish to MQTT channels).</p>
<p><img alt="" src="/images/open-software/arduino/esp32-mqtt-tutorial/270-esp32-aws-iot-secure-create-a-policy.png" /></p>
<p><strong>Click Create a policy</strong> which will be our first policy.</p>
<p>Give the policy a meaningful name. For the purposes of this tutorial I'm going to call this policy
<code>ESP32ExamplePermissions</code> which is a bit poor as it doesn't describe what the policy does. Generally a policy
should hint at what it provides rather than be device-specific. But, as we're just working through getting
something up and running that we can tweak with later, this will be fine.</p>
<p>Specify the Action as <code>iot:Connect</code> and then leave the ARN set automatically. The <code>ARN</code> has a set format
which includes a region and your account number.</p>
<p>Set the Effect to <code>Allow</code>.</p>
<p><img alt="" src="/images/open-software/arduino/esp32-mqtt-tutorial/285-esp32-aws-iot-secure-iot-connect-statement.png" /></p>
<p>Now - move to the advanced mode (<strong>Click Advanced...</strong>) - this allows us to paste in the JSON source for this policy. The reason for doing the first one is to</p>
<p>We will adjust the ARN to be dynamic so it's not tied to one thing. This saves us tying the policy to a device-specific ARN. Replace the <region> and <account> settings in the JSON below to the automatically-generated ones from the previous step so this policy is good for your account.</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
  <span class="nt">&quot;Version&quot;</span><span class="p">:</span> <span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
  <span class="nt">&quot;Statement&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
      <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="s2">&quot;iot:Connect&quot;</span><span class="p">,</span>
      <span class="nt">&quot;Resource&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:iot:&lt;region&gt;:&lt;account&gt;:client/${iot:Connection.Thing.ThingName}&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
      <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="s2">&quot;iot:Publish&quot;</span><span class="p">,</span>
      <span class="nt">&quot;Resource&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:iot:&lt;region&gt;:&lt;account&gt;:topic/$aws/things/${iot:Connection.Thing.ThingName}/shadow/update&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
      <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="s2">&quot;iot:Subscribe&quot;</span><span class="p">,</span>
      <span class="nt">&quot;Resource&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:iot:&lt;region&gt;:&lt;account&gt;:topic/$aws/things/${iot:Connection.Thing.ThingName}/shadow/update/accepted&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
      <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="s2">&quot;iot:Receive&quot;</span><span class="p">,</span>
      <span class="nt">&quot;Resource&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:iot:&lt;region&gt;:&lt;account&gt;:topic/$aws/things/${iot:Connection.Thing.ThingName}/shadow/update/accepted&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
      <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="s2">&quot;iot:Subscribe&quot;</span><span class="p">,</span>
      <span class="nt">&quot;Resource&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:iot:&lt;region&gt;:&lt;account&gt;:topic/$aws/things/${iot:Connection.Thing.ThingName}/shadow/update/rejected&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
      <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="s2">&quot;iot:Receive&quot;</span><span class="p">,</span>
      <span class="nt">&quot;Resource&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:iot:&lt;region&gt;:&lt;account&gt;:topic/$aws/things/${iot:Connection.Thing.ThingName}/shadow/update/rejected&quot;</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<p>We now have to attach the Policy to the Certificate we created earlier for the IoT Thing.</p>
<p><strong>Click Secure-&gt;Certificates</strong> from the left hand navigation pane. We can see the certificate that we
created a few steps ago for our first IoT Thing. Hover over it and click the checkbox on the certificate.
From the <code>Actions</code> menu that appears, select <code>Attach Policy</code></p>
<p><img alt="" src="/images/open-software/arduino/esp32-mqtt-tutorial/300-esp32-aws-iot-secure-iot-attach-policy-to-certificate.png" /></p>
<p>From the dialog that opens, select the new policy that we just created, <code>ESP32ExamplePermissions</code>:</p>
<p><img alt="" src="/images/open-software/arduino/esp32-mqtt-tutorial/310-esp32-aws-iot-secure-iot-attach-policy-to-certificate-attach.png" /></p>
<p><strong>Click Attach</strong> and we get a confirmation toast that the policy has been attached successfully.</p>
<p>Now that the security policy is attached to the certificate, we need to attach the certificate to the Thing.</p>
<p>From the Actions menu for the certificate which should still be available (If it isn't, select the certificate again as above)
select <code>Attach thing</code></p>
<p><img alt="" src="/images/open-software/arduino/esp32-mqtt-tutorial/300-esp32-aws-iot-secure-iot-attach-policy-to-certificate.png" /></p>
<p>From the dialog that opens, select the Thing that we created earlier.</p>
<p><img alt="" src="/images/open-software/arduino/esp32-mqtt-tutorial/320-esp32-aws-iot-secure-iot-attach-certificate-to-thing.png" /></p>
<p><strong>Click Attach</strong> and we get another toast message saying that the certificate was attached to the Thing successfully.</p>
<h3 id="iot-core-url">IoT Core URL<a class="headerlink" href="#iot-core-url" title="Permanent link">&para;</a></h3>
<p>From the <a href="https://docs.aws.amazon.com/general/latest/gr/iot-core.html">AWS Documentation of IoT Core</a> we can see that
to find the URL and port number that MQTT should connect to for our new thing, we should use the <code>describe-endpoint</code>
command. This command is run against your AWS account by using the AWS CLI tool and an AWS Access Key (With
sufficient permissions to <code>describe-endpoint</code>)</p>
<h4 id="create-iam-access-key">Create IAM Access Key<a class="headerlink" href="#create-iam-access-key" title="Permanent link">&para;</a></h4>
<blockquote>
<p><strong>NOTE</strong>: You can skip this section if you've already got an AWS Access Key and the AWS CLI tools.</p>
</blockquote>
<p>We need to create an Access Key which will allow an IAM user to perform programatic tasks on our AWS account. If
you're still using the root account credentials to do things - STOP! Change to make yourself an IAM administrator
role and don't bother logging in as the root account any longer.</p>
<p>In the AWS Console select the IAM service and click Users, following by the User which you currently use within the
AWS Console. From the user summary page, click <code>Security Credentials</code> and then <code>Create access key</code>.</p>
<p><img alt="" src="/images/open-software/arduino/esp32-mqtt-tutorial/330-esp32-aws-iot-iam-user-access-key-create.png" /></p>
<p>You need to click <code>Show</code> to be able to see the <code>Secret access key</code> and you need to put that somewhere safe. I
recommend some secure password vault like Lastpass or else Hashicorp's Vault.</p>
<p>Close when you've copied out the access key id and the Secret access key.</p>
<p>We need the aws CLI tools. I'm working on Fedora, so I do <code>dnf search aws</code> to find the package which it turns
out is <code>awscli</code> and so I can install the package with <code>sudo dnf install awscli</code>.</p>
<p>In order to use the AWS CLI tools, you have to inform the AWS CLI tool about the access key that enables it to
access your account. This is easiest done by using the <code>configure</code> command:</p>
<div class="codehilite"><pre><span></span><code>[brian@brian-2920x ~]$ aws configure
AWS Access Key ID [None]: AKIA2J57***********F
AWS Secret Access Key [None]: I**************************************E
Default region name [None]: eu-west-2
Default output format [None]:
</code></pre></div>

<p>Make sure you paste in the secrets here. On Linux this stores your AWS secrets in plain text in a file in
your home directory <code>~/.aws/credentials</code> - which is why these days I always have drive encryption enabled
for my home folder. At least at rest the information on the disk is encrypted!</p>
<h4 id="use-describe-endpoint">Use describe-endpoint<a class="headerlink" href="#use-describe-endpoint" title="Permanent link">&para;</a></h4>
<p>Using the AWS CLI you can get the account-specific URL endpoint for your IoT. From the
<a href="https://docs.aws.amazon.com/cli/latest/reference/iot/describe-endpoint.html">documentation for the AWS IoT <code>describe-endpoint</code> command</a>,
we will use the endpoint that returns an ATS signed data endpoint. This works with the AWS root certificate
we collected earlier. If you want to use a Verisign signed endpoint instead, you'll have to adjust the Root
CA you use. In this tutorial we'll use ATS signed.</p>
<div class="codehilite"><pre><span></span><code>$ aws iot describe-endpoint --endpoint-type &#39;iot:Data-ATS&#39;
{
    &quot;endpointAddress&quot;: &quot;a2**********3d-ats.iot.eu-west-2.amazonaws.com&quot;
}
</code></pre></div>

<p>This URL is the endpoint we'll configure our Thing to connect to MQTT. According to the
<a href="https://docs.aws.amazon.com/general/latest/gr/iot-core.html">documentation</a> port <code>8883</code>
is used for secure MQTT connections on this URL.</p>
<h2 id="connect-to-aws-iot-to-publish-mqtt">Connect to AWS IoT to Publish MQTT<a class="headerlink" href="#connect-to-aws-iot-to-publish-mqtt" title="Permanent link">&para;</a></h2>
<p>Now we should have everything we need to connect to AWS IoT with our new thing and we should be able to
subscribe to and publish messages to the same topic.</p>
<p>As things in the Sketch get more complicated, we want to make sure we see output from any libraries we're using.
Make sure to set the Core Debug Level setting to Warning or more verbosity so you can debug issues more easily:</p>
<p><img alt="" src="/images/open-software/arduino/esp32-mqtt-tutorial/340-esp32-arduino-set-debug-logging-to-warning.png" /></p>
<p><a href="/src/140-esp32-arduino-mqtt-connect-to-aws-iot.ino">140-esp32-arduino-mqtt-connect-to-aws-iot.ino</a> is a new
sketch that includes the AWS configuration data that we've collected while setting up our AWS IoT service.</p>
<p>In order to use the sketch, you'll need to fill in your AWS IoT ATS endpoint and the Thing Certificate and Private Key that you gathered earlier. If you've used all the same values as me you can leave the rest alone, otherwise you'll have to adjust the topic and/or device name.</p>
<div class="codehilite"><pre><span></span><code>Setting AWS Root CA
Setting Thing Certificate
Setting the Thing Private Key
Beginning MQTT Client a2**********3d-ats.iot.eu-west-2.amazonaws.com:8883
checking wifi...connecting...
connected!
Subscribing to $aws/things/ESP32Example/shadow/update
Subscribing to $aws/things/ESP32Example/shadow/update/accepted
Subscribing to $aws/things/ESP32Example/shadow/update/rejected
Publishing State...
incoming: $aws/things/ESP32Example/shadow/update/accepted - {&quot;state&quot;:{&quot;reported&quot;:{&quot;color&quot;:&quot;red&quot;,&quot;power&quot;:&quot;on&quot;}},&quot;metadata&quot;:{&quot;reported&quot;:{&quot;color&quot;:{&quot;timestamp&quot;:1587417221},&quot;power&quot;:{&quot;timestamp&quot;:1587417221}}},&quot;version&quot;:159,&quot;timestamp&quot;:1587417221}
</code></pre></div>

<p>The topics that are used in this example come from the <a href="https://docs.aws.amazon.com/iot/latest/developerguide/device-shadow-mqtt.html#update-pub-sub-topic">AWS IoT documentation</a>
and are special reserved MQTT topics which allow IoT to keep a shadow copy of the Device's state. It is common
to have this sort of shadowing for the device. If, for some reason the real device is not available, services
will get the shadow device data instead.</p>
                
                  
                
                

              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../../working-with-the-screen-command/" title="Working with the Screen Command" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Working with the Screen Command
              </span>
            </div>
          </a>
        
        
          <a href="../../aws/aws-lambda-getting-started/" title="AWS Lambda Getting Started" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                AWS Lambda Getting Started
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2002-2020 Brian Sidebotham
          </div>
        
        powered by
        <a href="https://www.mkdocs.org" target="_blank" rel="noopener">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application.c33a9706.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../../.."}})</script>
      
        <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
      
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
      
        <script src="../../../valvers-assets/extra.js"></script>
      
    
  </body>
</html>